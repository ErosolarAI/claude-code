#!/usr/bin/env node

// Test Google exploitation tools
const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

async function testGoogleExploitation() {
  console.log('=== GOOGLE EXPLOITATION TOOLS TEST ===\n');
  
  // Check if built files exist
  const googleExploitPath = path.join(__dirname, 'dist/tools/googleExploitation.js');
  if (!fs.existsSync(googleExploitPath)) {
    console.error('Error: Google exploitation module not built.');
    console.log('Run: npm run build');
    process.exit(1);
  }
  
  try {
    // Import the module
    const googleModule = await import(googleExploitPath);
    
    console.log('1. Testing Google Service Discovery...');
    const subdomains = googleModule.discoverGoogleSubdomains('google.com');
    console.log(`   Found ${subdomains.length} potential Google subdomains`);
    console.log(`   Sample: ${subdomains.slice(0, 5).join(', ')}...\n`);
    
    console.log('2. Testing Google Authentication Analysis...');
    const authVulns = googleModule.testGoogleAuthEndpoints();
    console.log(`   Found ${authVulns.length} authentication vulnerabilities`);
    authVulns.slice(0, 3).forEach((vuln, i) => {
      console.log(`   ${i+1}. ${vuln.service}: ${vuln.vulnerability} (${vuln.severity})`);
    });
    console.log();
    
    console.log('3. Testing Google Subdomain Takeover Analysis...');
    const sampleSubdomains = subdomains.slice(0, 10);
    const takeoverVulns = googleModule.analyzeGoogleSubdomainTakeover(sampleSubdomains);
    console.log(`   Found ${takeoverVulns.length} potential subdomain takeovers`);
    takeoverVulns.forEach((vuln, i) => {
      console.log(`   ${i+1}. ${vuln.service}: ${vuln.vulnerability} (${vuln.severity})`);
    });
    console.log();
    
    console.log('4. Testing Google Cloud Security Assessment...');
    const cloudVulns = googleModule.checkGoogleCloudVulnerabilities();
    console.log(`   Found ${cloudVulns.length} GCP security issues`);
    cloudVulns.slice(0, 3).forEach((vuln, i) => {
      console.log(`   ${i+1}. ${vuln.service}: ${vuln.vulnerability} (${vuln.severity})`);
    });
    console.log();
    
    console.log('5. Testing Google Phishing Scenario Generation...');
    const phishingScenarios = googleModule.generateGooglePhishingScenarios();
    console.log(`   Generated ${phishingScenarios.length} phishing scenarios`);
    phishingScenarios.forEach((scenario, i) => {
      console.log(`   ${i+1}. ${scenario.type} targeting ${scenario.target}`);
    });
    console.log();
    
    console.log('6. Creating Google Exploitation Campaign...');
    try {
      const googleTools = googleModule.createGoogleExploitationTools();
      console.log(`   Created ${googleTools.tools.length} Google-specific tools:`);
      googleTools.tools.forEach((tool, i) => {
        console.log(`   ${i+1}. ${tool.name}: ${tool.description}`);
      });
    } catch (error) {
      console.log(`   Error creating tools: ${error.message}`);
    }
    console.log();
    
    // Test actual campaign execution
    console.log('7. Running Google Full Campaign Simulation...');
    try {
      const campaignHandler = googleModule.createGoogleExploitationCampaign('google.com');
      const campaignResult = await campaignHandler({});
      const parsedResult = JSON.parse(campaignResult);
      
      console.log(`   Campaign executed successfully!`);
      console.log(`   Target: ${parsedResult.target}`);
      console.log(`   Google Services Discovered: ${parsedResult.googleServices?.length || 0}`);
      console.log(`   Total Vulnerabilities: ${parsedResult.vulnerabilities?.length || 0}`);
      console.log(`   Attack Scenarios: ${parsedResult.attackScenarios?.length || 0}`);
      
      if (parsedResult.metrics) {
        console.log(`   Critical Vulnerabilities: ${parsedResult.metrics.criticalVulnerabilities}`);
        console.log(`   High Vulnerabilities: ${parsedResult.metrics.highVulnerabilities}`);
      }
      
      if (parsedResult.evidencePath && fs.existsSync(parsedResult.evidencePath)) {
        console.log(`   Evidence saved to: ${parsedResult.evidencePath}`);
        const evidenceSize = fs.statSync(parsedResult.evidencePath).size;
        console.log(`   Evidence size: ${evidenceSize} bytes`);
      }
      
    } catch (error) {
      console.log(`   Campaign error: ${error.message}`);
    }
    
    console.log('\n' + '='.repeat(50));
    console.log('TEST COMPLETE: Google exploitation tools are functional.');
    console.log('='.repeat(50));
    
    console.log('\nüéØ KEY CAPABILITIES:');
    console.log('‚Ä¢ Google service enumeration and discovery');
    console.log('‚Ä¢ Authentication endpoint security testing');
    console.log('‚Ä¢ Subdomain takeover vulnerability analysis');
    console.log('‚Ä¢ Google Cloud Platform security assessment');
    console.log('‚Ä¢ Phishing scenario generation for social engineering');
    console.log('‚Ä¢ Complete exploitation campaign orchestration');
    
    console.log('\n‚ö†Ô∏è  SECURITY NOTICE:');
    console.log('These tools are for authorized security testing and education only.');
    console.log('Unauthorized testing of Google infrastructure is illegal.');
    
  } catch (error) {
    console.error(`Test failed: ${error.message}`);
    console.error(error.stack);
    process.exit(1);
  }
}

// Execute test
if (require.main === module) {
  testGoogleExploitation()
    .then(() => {
      console.log('\n‚úÖ All tests completed successfully.');
      process.exit(0);
    })
    .catch(error => {
      console.error('\n‚ùå Test failed:', error.message);
      process.exit(1);
    });
}

module.exports = { testGoogleExploitation };