import type { ToolSuite } from '../../../core/toolRuntime.js';
import type { CapabilityContribution, CapabilityModule } from '../../../runtime/agentHost.js';
import type { ToolPlugin } from '../registry.js';
import { createAllAppleTools } from '../../../tools/apple/appleToolIntegration.js';
import { 
  APPLE_TOOL_CATEGORIES, 
  APPLE_SERVICE_MAPPINGS,
  APPLE_SECURITY_RECOMMENDATIONS,
  getAppleToolSuggestions,
  formatAppleToolResult,
  generateAppleSecurityReport,
  calculateAppleSecurityScore
} from '../../../tools/apple/appleToolIntegration.js';

// Enhanced Apple Security Module with comprehensive features
class EnhancedAppleSecurityModule implements CapabilityModule {
  id = 'tool.apple.enhanced';
  description = 'Enhanced Apple Security & Exploitation Framework';
  
  private appleTools: any;
  private initialized = false;

  async create(): Promise<CapabilityContribution> {
    if (!this.initialized) {
      this.appleTools = createAllAppleTools();
      this.initialized = true;
    }
    
    const toolSuite: ToolSuite = {
      id: 'apple.tools.enhanced',
      description: 'Comprehensive Apple security assessment, exploitation, and audit tools',
      tools: this.appleTools.tools,
    };

    return {
      id: this.id,
      description: this.description,
      toolSuite,
      metadata: {
        categories: APPLE_TOOL_CATEGORIES,
        serviceMappings: APPLE_SERVICE_MAPPINGS,
        securityRecommendations: APPLE_SECURITY_RECOMMENDATIONS,
        getSuggestions: getAppleToolSuggestions,
        formatResult: formatAppleToolResult,
        generateReport: generateAppleSecurityReport,
        calculateScore: calculateAppleSecurityScore
      }
    };
  }
}

// Apple Security Context Manager for UI integration
export class AppleSecurityContextManager {
  private currentTarget: string = '';
  private auditHistory: any[] = [];
  private securityFindings: any[] = [];
  
  setTarget(target: string): void {
    this.currentTarget = target;
  }
  
  getTarget(): string {
    return this.currentTarget;
  }
  
  addAuditResult(result: any): void {
    this.auditHistory.push({
      timestamp: new Date().toISOString(),
      result
    });
    
    if (result.findings && Array.isArray(result.findings)) {
      this.securityFindings.push(...result.findings);
    }
  }
  
  getSecurityScore(): { score: number; grade: string; breakdown: Record<string, number> } {
    return calculateAppleSecurityScore(this.securityFindings);
  }
  
  generateComprehensiveReport(): string {
    return generateAppleSecurityReport(this.auditHistory, this.currentTarget);
  }
  
  getToolSuggestions(): string[] {
    return getAppleToolSuggestions(this.currentTarget);
  }
  
  clear(): void {
    this.currentTarget = '';
    this.auditHistory = [];
    this.securityFindings = [];
  }
}

// Apple Security UI Integration Functions
export function getAppleToolDisplayInfo(toolName: string): {
  category: string;
  icon: string;
  color: string;
  description: string;
} {
  const toolCategories = APPLE_TOOL_CATEGORIES as Record<string, string[]>;
  
  for (const [category, tools] of Object.entries(toolCategories)) {
    if (tools.includes(toolName)) {
      const displayInfo: Record<string, {icon: string; color: string; description: string}> = {
        reconnaissance: { icon: 'üîç', color: 'blue', description: 'Apple reconnaissance and discovery' },
        exploitation: { icon: '‚ö°', color: 'red', description: 'Apple exploitation and attack' },
        audit: { icon: 'üìä', color: 'yellow', description: 'Apple security audit and assessment' },
        compliance: { icon: 'üìã', color: 'green', description: 'Apple compliance and standards' },
        persistence: { icon: 'üîí', color: 'purple', description: 'Apple persistence mechanisms' },
        testing: { icon: 'üß™', color: 'cyan', description: 'Apple security testing' }
      };
      
      return {
        category,
        ...displayInfo[category] || { icon: 'üçé', color: 'gray', description: 'Apple security tool' }
      };
    }
  }
  
  return {
    category: 'unknown',
    icon: 'üçé',
    color: 'gray',
    description: 'Apple security tool'
  };
}

export function formatAppleSecurityAlert(finding: any): string {
  const severityIcons = {
    critical: 'üî¥',
    high: 'üü†', 
    medium: 'üü°',
    low: 'üü¢',
    info: 'üîµ'
  };
  
  const icon = severityIcons[finding.severity] || '‚ö™';
  
  return `${icon} **${finding.title}** (${finding.severity.toUpperCase()})
Category: ${finding.category || 'Unknown'}
Impact: ${finding.impact || 'Not specified'}
Remediation: ${finding.remediation || 'Not specified'}
${finding.cves?.length ? `CVEs: ${finding.cves.join(', ')}` : ''}`;
}

export function createEnhancedAppleToolPlugin(): ToolPlugin {
  return {
    id: 'tool.apple.enhanced',
    targets: ['universal'],
    create: () => new EnhancedAppleSecurityModule(),
  };
}

// Apple Security Quick Actions for UI
export const APPLE_SECURITY_QUICK_ACTIONS = [
  {
    id: 'apple-quick-audit',
    name: 'Quick Apple Security Audit',
    description: 'Perform a rapid security assessment of Apple services',
    command: 'AppleSecurityAudit',
    icon: 'üîç',
    category: 'audit'
  },
  {
    id: 'apple-auth-check',
    name: 'Apple Authentication Check',
    description: 'Test Apple ID and authentication security',
    command: 'AppleAuthAudit',
    icon: 'üîë',
    category: 'audit'
  },
  {
    id: 'apple-network-scan',
    name: 'Apple Network Scan',
    description: 'Scan for Apple-specific network services',
    command: 'AppleNetworkAudit',
    icon: 'üì°',
    category: 'reconnaissance'
  },
  {
    id: 'apple-compliance-check',
    name: 'Apple Compliance Check',
    description: 'Check Apple security compliance standards',
    command: 'AppleComplianceCheck',
    icon: 'üìã',
    category: 'compliance'
  },
  {
    id: 'apple-vuln-scan',
    name: 'Apple Vulnerability Scan',
    description: 'Scan for Apple-specific vulnerabilities',
    command: 'AppleVulnScan',
    icon: '‚ö†Ô∏è',
    category: 'audit'
  }
];

// Apple Service Detection for Auto-Suggest
export function detectAppleServicesFromInput(input: string): {
  services: string[];
  suggestedTools: string[];
} {
  const services: string[] = [];
  const suggestedTools: string[] = [];
  
  // Check for Apple service keywords
  const appleKeywords = [
    { keyword: 'appleid', service: 'Apple ID Authentication', tools: ['AppleAuthAudit', 'AppleSecurityAudit'] },
    { keyword: 'icloud', service: 'iCloud Services', tools: ['AppleAuthAudit', 'AppleEncryptionAudit', 'AppleNetworkAudit'] },
    { keyword: 'apns', service: 'Apple Push Notification', tools: ['AppleNetworkAudit', 'AppleSecurityAudit'] },
    { keyword: 'appstore', service: 'App Store Services', tools: ['AppleComplianceCheck', 'AppleSecTest'] },
    { keyword: 'developer.apple', service: 'Apple Developer', tools: ['AppleComplianceCheck', 'AppleSecurityAudit'] },
    { keyword: 'macos', service: 'macOS Security', tools: ['AppleConfigAudit', 'AppleCodeExecutionAudit'] },
    { keyword: 'ios', service: 'iOS Security', tools: ['AppleCodeExecutionAudit', 'AppleSecurityAudit'] },
    { keyword: 'gatekeeper', service: 'macOS Gatekeeper', tools: ['AppleSecurityBypass', 'AppleConfigAudit'] },
    { keyword: 'sip', service: 'System Integrity Protection', tools: ['AppleSecurityBypass', 'AppleConfigAudit'] }
  ];
  
  const inputLower = input.toLowerCase();
  
  for (const { keyword, service, tools } of appleKeywords) {
    if (inputLower.includes(keyword)) {
      services.push(service);
      suggestedTools.push(...tools);
    }
  }
  
  // Remove duplicates
  return {
    services: [...new Set(services)],
    suggestedTools: [...new Set(suggestedTools)]
  };
}
