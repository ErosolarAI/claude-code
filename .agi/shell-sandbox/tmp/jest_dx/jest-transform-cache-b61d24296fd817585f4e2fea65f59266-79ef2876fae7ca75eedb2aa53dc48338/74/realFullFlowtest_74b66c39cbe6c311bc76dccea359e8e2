2937ab295d658006c064a60d7bdcc689
"use strict";

var _globals = require("@jest/globals");
function _interopRequireWildcard(e, t) { if ("function" == typeof WeakMap) var r = new WeakMap(), n = new WeakMap(); return (_interopRequireWildcard = function (e, t) { if (!t && e && e.__esModule) return e; var o, i, f = { __proto__: null, default: e }; if (null === e || "object" != typeof e && "function" != typeof e) return f; if (o = t ? n : r) { if (o.has(e)) return o.get(e); o.set(e, f); } for (const t in e) "default" !== t && {}.hasOwnProperty.call(e, t) && ((i = (o = Object.defineProperty) && Object.getOwnPropertyDescriptor(e, t)) && (i.get || i.set) ? o(f, t, i) : f[t] = e[t]); return f; })(e, t); } /**
 * Real full-flow integration test.
 *
 * Uses the shared full-flow runner to drive the CLI with long-form,
 * human-style prompts and asserts that real provider usage and validated
 * completions occur. Only runs when RUN_REAL_LLM_TESTS=1 and a provider
 * key are present to avoid accidental live calls.
 */
const hasProviderKey = Boolean(process.env.ANTHROPIC_API_KEY) || Boolean(process.env.OPENAI_API_KEY) || Boolean(process.env.GOOGLE_GENAI_API_KEY);
const realTestsEnabled = process.env.RUN_REAL_LLM_TESTS === '1' && hasProviderKey;
function parsePrompts(defaultPrompts) {
  if (process.env.PROMPTS) {
    try {
      const parsed = JSON.parse(process.env.PROMPTS);
      if (Array.isArray(parsed) && parsed.every(p => typeof p === 'string')) {
        return parsed.map(p => p.trim()).filter(Boolean);
      }
    } catch {
      // fall back to default prompts
    }
  }
  return defaultPrompts;
}
(0, _globals.describe)('real full-flow CLI run', () => {
  (realTestsEnabled ? _globals.test : _globals.test.skip)('completes long-form prompts end-to-end with validation', async () => {
    _globals.jest.setTimeout(300_000); // allow up to 5 minutes for live provider

    const {
      DEFAULT_PROMPTS,
      runFullFlow,
      validateFullFlow
    } = await Promise.resolve().then(() => _interopRequireWildcard(require('../../scripts/full-flow-runner.js')));
    const prompts = parsePrompts(DEFAULT_PROMPTS);
    const result = await runFullFlow({
      prompts,
      profile: process.env.PROFILE?.trim() || 'erosolar-code',
      provider: process.env.PROVIDER?.trim(),
      model: process.env.MODEL?.trim(),
      sessionId: `real-flow-${Date.now()}`,
      requireReal: true
    });
    const summary = validateFullFlow(result, {
      minMessageChars: 120,
      requireUsage: true,
      rejectSimulation: true,
      minEvents: 2,
      requireRunCount: true
    });
    expect(summary.completedRuns).toBe(prompts.length);
    expect(summary.runsWithUsage).toBeGreaterThanOrEqual(prompts.length);
    expect(summary.session).toBeTruthy();
    expect(result.runs).toHaveLength(prompts.length);
    for (const run of result.runs) {
      expect(run.eventsSeen).toBeGreaterThanOrEqual(2);
    }
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZ2xvYmFscyIsInJlcXVpcmUiLCJfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZCIsImUiLCJ0IiwiV2Vha01hcCIsInIiLCJuIiwiX19lc01vZHVsZSIsIm8iLCJpIiwiZiIsIl9fcHJvdG9fXyIsImRlZmF1bHQiLCJoYXMiLCJnZXQiLCJzZXQiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImhhc1Byb3ZpZGVyS2V5IiwiQm9vbGVhbiIsInByb2Nlc3MiLCJlbnYiLCJBTlRIUk9QSUNfQVBJX0tFWSIsIk9QRU5BSV9BUElfS0VZIiwiR09PR0xFX0dFTkFJX0FQSV9LRVkiLCJyZWFsVGVzdHNFbmFibGVkIiwiUlVOX1JFQUxfTExNX1RFU1RTIiwicGFyc2VQcm9tcHRzIiwiZGVmYXVsdFByb21wdHMiLCJQUk9NUFRTIiwicGFyc2VkIiwiSlNPTiIsInBhcnNlIiwiQXJyYXkiLCJpc0FycmF5IiwiZXZlcnkiLCJwIiwibWFwIiwidHJpbSIsImZpbHRlciIsImRlc2NyaWJlIiwidGVzdCIsInNraXAiLCJqZXN0Iiwic2V0VGltZW91dCIsIkRFRkFVTFRfUFJPTVBUUyIsInJ1bkZ1bGxGbG93IiwidmFsaWRhdGVGdWxsRmxvdyIsIlByb21pc2UiLCJyZXNvbHZlIiwidGhlbiIsInByb21wdHMiLCJyZXN1bHQiLCJwcm9maWxlIiwiUFJPRklMRSIsInByb3ZpZGVyIiwiUFJPVklERVIiLCJtb2RlbCIsIk1PREVMIiwic2Vzc2lvbklkIiwiRGF0ZSIsIm5vdyIsInJlcXVpcmVSZWFsIiwic3VtbWFyeSIsIm1pbk1lc3NhZ2VDaGFycyIsInJlcXVpcmVVc2FnZSIsInJlamVjdFNpbXVsYXRpb24iLCJtaW5FdmVudHMiLCJyZXF1aXJlUnVuQ291bnQiLCJleHBlY3QiLCJjb21wbGV0ZWRSdW5zIiwidG9CZSIsImxlbmd0aCIsInJ1bnNXaXRoVXNhZ2UiLCJ0b0JlR3JlYXRlclRoYW5PckVxdWFsIiwic2Vzc2lvbiIsInRvQmVUcnV0aHkiLCJydW5zIiwidG9IYXZlTGVuZ3RoIiwicnVuIiwiZXZlbnRzU2VlbiJdLCJzb3VyY2VzIjpbInJlYWxGdWxsRmxvdy50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogUmVhbCBmdWxsLWZsb3cgaW50ZWdyYXRpb24gdGVzdC5cbiAqXG4gKiBVc2VzIHRoZSBzaGFyZWQgZnVsbC1mbG93IHJ1bm5lciB0byBkcml2ZSB0aGUgQ0xJIHdpdGggbG9uZy1mb3JtLFxuICogaHVtYW4tc3R5bGUgcHJvbXB0cyBhbmQgYXNzZXJ0cyB0aGF0IHJlYWwgcHJvdmlkZXIgdXNhZ2UgYW5kIHZhbGlkYXRlZFxuICogY29tcGxldGlvbnMgb2NjdXIuIE9ubHkgcnVucyB3aGVuIFJVTl9SRUFMX0xMTV9URVNUUz0xIGFuZCBhIHByb3ZpZGVyXG4gKiBrZXkgYXJlIHByZXNlbnQgdG8gYXZvaWQgYWNjaWRlbnRhbCBsaXZlIGNhbGxzLlxuICovXG5cbmltcG9ydCB7IGRlc2NyaWJlLCB0ZXN0LCBqZXN0IH0gZnJvbSAnQGplc3QvZ2xvYmFscyc7XG5cbmNvbnN0IGhhc1Byb3ZpZGVyS2V5ID1cbiAgQm9vbGVhbihwcm9jZXNzLmVudi5BTlRIUk9QSUNfQVBJX0tFWSkgfHxcbiAgQm9vbGVhbihwcm9jZXNzLmVudi5PUEVOQUlfQVBJX0tFWSkgfHxcbiAgQm9vbGVhbihwcm9jZXNzLmVudi5HT09HTEVfR0VOQUlfQVBJX0tFWSk7XG5cbmNvbnN0IHJlYWxUZXN0c0VuYWJsZWQgPSBwcm9jZXNzLmVudi5SVU5fUkVBTF9MTE1fVEVTVFMgPT09ICcxJyAmJiBoYXNQcm92aWRlcktleTtcblxuZnVuY3Rpb24gcGFyc2VQcm9tcHRzKGRlZmF1bHRQcm9tcHRzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcbiAgaWYgKHByb2Nlc3MuZW52LlBST01QVFMpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcGFyc2VkID0gSlNPTi5wYXJzZShwcm9jZXNzLmVudi5QUk9NUFRTKTtcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KHBhcnNlZCkgJiYgcGFyc2VkLmV2ZXJ5KChwKSA9PiB0eXBlb2YgcCA9PT0gJ3N0cmluZycpKSB7XG4gICAgICAgIHJldHVybiBwYXJzZWQubWFwKChwKSA9PiBwLnRyaW0oKSkuZmlsdGVyKEJvb2xlYW4pO1xuICAgICAgfVxuICAgIH0gY2F0Y2gge1xuICAgICAgLy8gZmFsbCBiYWNrIHRvIGRlZmF1bHQgcHJvbXB0c1xuICAgIH1cbiAgfVxuICByZXR1cm4gZGVmYXVsdFByb21wdHM7XG59XG5cbmRlc2NyaWJlKCdyZWFsIGZ1bGwtZmxvdyBDTEkgcnVuJywgKCkgPT4ge1xuICAocmVhbFRlc3RzRW5hYmxlZCA/IHRlc3QgOiB0ZXN0LnNraXApKCdjb21wbGV0ZXMgbG9uZy1mb3JtIHByb21wdHMgZW5kLXRvLWVuZCB3aXRoIHZhbGlkYXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgamVzdC5zZXRUaW1lb3V0KDMwMF8wMDApOyAvLyBhbGxvdyB1cCB0byA1IG1pbnV0ZXMgZm9yIGxpdmUgcHJvdmlkZXJcblxuICAgIGNvbnN0IHsgREVGQVVMVF9QUk9NUFRTLCBydW5GdWxsRmxvdywgdmFsaWRhdGVGdWxsRmxvdyB9ID0gYXdhaXQgaW1wb3J0KCcuLi8uLi9zY3JpcHRzL2Z1bGwtZmxvdy1ydW5uZXIuanMnKTtcbiAgICBjb25zdCBwcm9tcHRzID0gcGFyc2VQcm9tcHRzKERFRkFVTFRfUFJPTVBUUyk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBydW5GdWxsRmxvdyh7XG4gICAgICBwcm9tcHRzLFxuICAgICAgcHJvZmlsZTogcHJvY2Vzcy5lbnYuUFJPRklMRT8udHJpbSgpIHx8ICdlcm9zb2xhci1jb2RlJyxcbiAgICAgIHByb3ZpZGVyOiBwcm9jZXNzLmVudi5QUk9WSURFUj8udHJpbSgpLFxuICAgICAgbW9kZWw6IHByb2Nlc3MuZW52Lk1PREVMPy50cmltKCksXG4gICAgICBzZXNzaW9uSWQ6IGByZWFsLWZsb3ctJHtEYXRlLm5vdygpfWAsXG4gICAgICByZXF1aXJlUmVhbDogdHJ1ZSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHN1bW1hcnkgPSB2YWxpZGF0ZUZ1bGxGbG93KHJlc3VsdCwge1xuICAgICAgbWluTWVzc2FnZUNoYXJzOiAxMjAsXG4gICAgICByZXF1aXJlVXNhZ2U6IHRydWUsXG4gICAgICByZWplY3RTaW11bGF0aW9uOiB0cnVlLFxuICAgICAgbWluRXZlbnRzOiAyLFxuICAgICAgcmVxdWlyZVJ1bkNvdW50OiB0cnVlLFxuICAgIH0pO1xuXG4gICAgZXhwZWN0KHN1bW1hcnkuY29tcGxldGVkUnVucykudG9CZShwcm9tcHRzLmxlbmd0aCk7XG4gICAgZXhwZWN0KHN1bW1hcnkucnVuc1dpdGhVc2FnZSkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbChwcm9tcHRzLmxlbmd0aCk7XG4gICAgZXhwZWN0KHN1bW1hcnkuc2Vzc2lvbikudG9CZVRydXRoeSgpO1xuICAgIGV4cGVjdChyZXN1bHQucnVucykudG9IYXZlTGVuZ3RoKHByb21wdHMubGVuZ3RoKTtcbiAgICBmb3IgKGNvbnN0IHJ1biBvZiByZXN1bHQucnVucykge1xuICAgICAgZXhwZWN0KHJ1bi5ldmVudHNTZWVuKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDIpO1xuICAgIH1cbiAgfSk7XG59KTtcbiJdLCJtYXBwaW5ncyI6Ijs7QUFTQSxJQUFBQSxRQUFBLEdBQUFDLE9BQUE7QUFBcUQsU0FBQUMsd0JBQUFDLENBQUEsRUFBQUMsQ0FBQSw2QkFBQUMsT0FBQSxNQUFBQyxDQUFBLE9BQUFELE9BQUEsSUFBQUUsQ0FBQSxPQUFBRixPQUFBLFlBQUFILHVCQUFBLFlBQUFBLENBQUFDLENBQUEsRUFBQUMsQ0FBQSxTQUFBQSxDQUFBLElBQUFELENBQUEsSUFBQUEsQ0FBQSxDQUFBSyxVQUFBLFNBQUFMLENBQUEsTUFBQU0sQ0FBQSxFQUFBQyxDQUFBLEVBQUFDLENBQUEsS0FBQUMsU0FBQSxRQUFBQyxPQUFBLEVBQUFWLENBQUEsaUJBQUFBLENB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