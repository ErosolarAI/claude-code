{"version":3,"names":["ToolArgumentValidationError","Error","constructor","toolName","issues","formatMessage","name","exports","TypeGuards","_TypeGuards","isString","value","isNumber","Number","isNaN","isBoolean","isArray","Array","isObject","isNotNull","undefined","isEnum","enumValues","includes","coerceToolArguments","schema","args","type","properties","coerced","key","definition","Object","entries","hasOwn","normalized","coerceBoolean","coerceNumber","trimmed","trim","toLowerCase","isFinite","length","parsed","validateToolArguments","errors","required","property","hasArgument","push","validateSchemaProperty","path","enum","map","entry","join","minLength","minimum","maximum","validateArrayItems","itemSchema","items","index","detail"],"sources":["schemaValidator.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-namespace */\nimport type { JSONSchemaArray, JSONSchemaObject, JSONSchemaProperty } from './types.js';\n\n/**\n * Enhanced validation error with structured error information\n */\nexport class ToolArgumentValidationError extends Error {\n  readonly issues: readonly string[];\n  readonly toolName: string;\n  \n  constructor(toolName: string, issues: string[]) {\n    super(formatMessage(toolName, issues));\n    this.name = 'ToolArgumentValidationError';\n    this.issues = issues;\n    this.toolName = toolName;\n  }\n}\n\n/**\n * Runtime type guards for tool argument validation\n */\nexport namespace TypeGuards {\n  /**\n   * Type guard for string values\n   */\n  export function isString(value: unknown): value is string {\n    return typeof value === 'string';\n  }\n\n  /**\n   * Type guard for number values\n   */\n  export function isNumber(value: unknown): value is number {\n    return typeof value === 'number' && !Number.isNaN(value);\n  }\n\n  /**\n   * Type guard for boolean values\n   */\n  export function isBoolean(value: unknown): value is boolean {\n    return typeof value === 'boolean';\n  }\n\n  /**\n   * Type guard for array values\n   */\n  export function isArray(value: unknown): value is unknown[] {\n    return Array.isArray(value);\n  }\n\n  /**\n   * Type guard for object values\n   */\n  export function isObject(value: unknown): value is Record<string, unknown> {\n    return typeof value === 'object' && value !== null && !Array.isArray(value);\n  }\n\n  /**\n   * Type guard for non-null values\n   */\n  export function isNotNull(value: unknown): value is NonNullable<unknown> {\n    return value !== undefined && value !== null;\n  }\n\n  /**\n   * Type guard for enum values\n   */\n  export function isEnum<T extends string>(value: unknown, enumValues: readonly T[]): value is T {\n    return TypeGuards.isString(value) && enumValues.includes(value as T);\n  }\n}\n\n/**\n * Coerce loosely-typed tool arguments into their declared schema types.\n * This makes tools resilient to providers that emit boolean/number values as strings.\n */\nexport function coerceToolArguments(\n  schema: JSONSchemaObject | undefined,\n  args: Record<string, unknown>\n): Record<string, unknown> {\n  if (!schema || schema.type !== 'object' || !schema.properties) {\n    return args;\n  }\n\n  const coerced: Record<string, unknown> = { ...args };\n\n  for (const [key, definition] of Object.entries(schema.properties)) {\n    if (!Object.hasOwn(args, key)) {\n      continue;\n    }\n    const value = args[key];\n    if (value === undefined || value === null) {\n      continue;\n    }\n\n    switch (definition.type) {\n      case 'boolean': {\n        const normalized = coerceBoolean(value);\n        coerced[key] = normalized;\n        break;\n      }\n      case 'number': {\n        const normalized = coerceNumber(value);\n        coerced[key] = normalized;\n        break;\n      }\n      default:\n        break;\n    }\n  }\n\n  return coerced;\n}\n\nfunction coerceBoolean(value: unknown): unknown {\n  if (typeof value === 'boolean') {\n    return value;\n  }\n  if (typeof value === 'number') {\n    if (value === 1) return true;\n    if (value === 0) return false;\n  }\n  if (typeof value === 'string') {\n    const trimmed = value.trim().toLowerCase();\n    if (trimmed === 'true' || trimmed === '1') return true;\n    if (trimmed === 'false' || trimmed === '0') return false;\n  }\n  return value;\n}\n\nfunction coerceNumber(value: unknown): unknown {\n  if (typeof value === 'number') {\n    // Reject NaN, Infinity, and -Infinity\n    if (!Number.isFinite(value)) {\n      return value; // Return as-is to fail validation\n    }\n    return value;\n  }\n  if (typeof value === 'string' && value.trim().length > 0) {\n    const parsed = Number(value);\n    // Only accept finite numbers\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n  return value;\n}\n\nexport function validateToolArguments(\n  toolName: string,\n  schema: JSONSchemaObject | undefined,\n  args: Record<string, unknown>\n): void {\n  if (!schema || schema.type !== 'object') {\n    return;\n  }\n\n  const errors: string[] = [];\n  const properties = schema.properties ?? {};\n  const required = Array.isArray(schema.required) ? schema.required : [];\n\n  for (const property of required) {\n    if (!hasArgument(args, property)) {\n      errors.push(`Missing required property \"${property}\".`);\n    }\n  }\n\n  for (const [key, value] of Object.entries(args)) {\n    const definition = properties[key];\n    if (!definition) {\n      // Silently ignore unknown properties - models sometimes hallucinate extra params\n      // This is more lenient than strict JSON schema validation but prevents errors\n      // when models pass extra parameters that don't affect tool behavior\n      continue;\n    }\n    validateSchemaProperty(definition, value, key, errors);\n  }\n\n  if (errors.length) {\n    throw new ToolArgumentValidationError(toolName, errors);\n  }\n}\n\nfunction validateSchemaProperty(\n  definition: JSONSchemaProperty,\n  value: unknown,\n  path: string,\n  errors: string[]\n): void {\n  switch (definition.type) {\n    case 'string': {\n      if (typeof value !== 'string') {\n        errors.push(`Argument \"${path}\" must be a string.`);\n        return;\n      }\n      if (definition.enum && !definition.enum.includes(value)) {\n        errors.push(\n          `Argument \"${path}\" must be one of: ${definition.enum.map((entry) => `\"${entry}\"`).join(', ')}.`\n        );\n      }\n      if (typeof definition.minLength === 'number' && value.length < definition.minLength) {\n        errors.push(\n          `Argument \"${path}\" must be at least ${definition.minLength} character${\n            definition.minLength === 1 ? '' : 's'\n          } long.`\n        );\n      }\n      return;\n    }\n    case 'number': {\n      if (typeof value !== 'number' || !Number.isFinite(value)) {\n        errors.push(`Argument \"${path}\" must be a finite number.`);\n        return;\n      }\n      // Validate minimum constraint\n      if (typeof definition.minimum === 'number' && value < definition.minimum) {\n        errors.push(`Argument \"${path}\" must be at least ${definition.minimum}.`);\n      }\n      // Validate maximum constraint\n      if (typeof definition.maximum === 'number' && value > definition.maximum) {\n        errors.push(`Argument \"${path}\" must be at most ${definition.maximum}.`);\n      }\n      return;\n    }\n    case 'boolean': {\n      if (typeof value !== 'boolean') {\n        errors.push(`Argument \"${path}\" must be a boolean.`);\n      }\n      return;\n    }\n    case 'array': {\n      if (!Array.isArray(value)) {\n        errors.push(`Argument \"${path}\" must be an array.`);\n        return;\n      }\n      validateArrayItems(definition, value, path, errors);\n      return;\n    }\n    default:\n      return;\n  }\n}\n\nfunction validateArrayItems(\n  definition: JSONSchemaArray,\n  value: unknown[],\n  path: string,\n  errors: string[]\n): void {\n  const itemSchema = definition.items;\n  if (!itemSchema) {\n    return;\n  }\n\n  for (let index = 0; index < value.length; index += 1) {\n    const entry = value[index];\n    validateSchemaProperty(itemSchema, entry, `${path}[${index}]`, errors);\n  }\n}\n\nfunction hasArgument(args: Record<string, unknown>, key: string): boolean {\n  if (!Object.hasOwn(args, key)) {\n    return false;\n  }\n  const value = args[key];\n  return value !== undefined && value !== null;\n}\n\nfunction formatMessage(toolName: string, issues: string[]): string {\n  const detail = issues.join(' ');\n  return `Invalid arguments for \"${toolName}\": ${detail}`;\n}\n"],"mappings":"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","ignoreList":[]}