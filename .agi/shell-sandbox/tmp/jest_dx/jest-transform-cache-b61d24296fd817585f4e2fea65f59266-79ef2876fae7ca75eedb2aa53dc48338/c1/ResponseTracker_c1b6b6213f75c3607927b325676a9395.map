{"version":3,"names":["cov_22f02z566z","actualCoverage","ResponseTracker","nextId","s","activeId","pendingThought","constructor","telemetry","f","recordThought","thought","normalized","trim","b","recordEvent","id","phase","summary","truncate","length","recordResponse","response","metadata","responseId","thoughtSummary","undefined","source","usage","value","max","slice","trimEnd"],"sources":["ResponseTracker.ts"],"sourcesContent":["import type { UITelemetry } from './UITelemetry.js';\n\nexport interface AssistantResponseMetadata {\n  thought?: string | null;\n  responseId?: number;\n  usage?: unknown;\n  source?: 'final' | 'stream' | 'narrative';\n}\n\n/**\n * Tracks assistant thought/response pairs as single events.\n * Ensures multi-line messages are counted once per response.\n */\nexport class ResponseTracker {\n  private nextId = 0;\n  private activeId: number | null = null;\n  private pendingThought: string | null = null;\n\n  constructor(private readonly telemetry: UITelemetry) {}\n\n  recordThought(thought: string): number | null {\n    const normalized = thought.trim();\n    if (!normalized) return null;\n\n    if (!this.activeId) {\n      this.activeId = this.nextId + 1;\n      this.nextId = this.activeId;\n    }\n\n    this.pendingThought = this.pendingThought\n      ? `${this.pendingThought}\\n${normalized}`\n      : normalized;\n\n    this.telemetry.recordEvent('assistant.thought', {\n      id: this.activeId,\n      phase: 'thought',\n      summary: this.truncate(normalized),\n      length: normalized.length,\n    });\n\n    return this.activeId;\n  }\n\n  recordResponse(response: string, metadata: AssistantResponseMetadata = {}): number | null {\n    const normalized = response.trim();\n    if (!normalized) return null;\n\n    const id = metadata.responseId ?? this.activeId ?? this.nextId + 1;\n    if (id > this.nextId) {\n      this.nextId = id;\n    }\n\n    const thought = metadata.thought?.trim() || this.pendingThought || null;\n\n    this.telemetry.recordEvent('assistant.response', {\n      id,\n      phase: 'response',\n      summary: this.truncate(normalized),\n      length: normalized.length,\n      thoughtSummary: thought ? this.truncate(thought) : undefined,\n      source: metadata.source ?? 'final',\n      usage: metadata.usage ?? null,\n    });\n\n    this.pendingThought = null;\n    this.activeId = null;\n    return id;\n  }\n\n  private truncate(value: string, max: number = 240): string {\n    if (value.length <= max) return value;\n    return `${value.slice(0, max - 3).trimEnd()}...`;\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAeY;IAAAA,cAAA,YAAAA,CAAA;MAAA,OAAAC,cAAA;IAAA;EAAA;EAAA,OAAAA,cAAA;AAAA;AAAAD,cAAA;AANZ;AACA;AACA;AACA;AACA,OAAO,MAAME,eAAe,CAAC;EACnBC,MAAM;EAAA;EAAA,CAAAH,cAAA,GAAAI,CAAA,OAAG,CAAC;EACVC,QAAQ;EAAA;EAAA,CAAAL,cAAA,GAAAI,CAAA,OAAkB,IAAI;EAC9BE,cAAc;EAAA;EAAA,CAAAN,cAAA,GAAAI,CAAA,OAAkB,IAAI;EAE5CG,WAAWA,CAAkBC,SAAsB,EAAE;IAAA;IAAA,KAAxBA,SAAsB,GAAtBA,SAAsB;IAAA;IAAAR,cAAA,GAAAS,CAAA;EAAG;EAEtDC,aAAaA,CAACC,OAAe,EAAiB;IAAA;IAAAX,cAAA,GAAAS,CAAA;IAC5C,MAAMG,UAAU;IAAA;IAAA,CAAAZ,cAAA,GAAAI,CAAA,OAAGO,OAAO,CAACE,IAAI,CAAC,CAAC;IAAC;IAAAb,cAAA,GAAAI,CAAA;IAClC,IAAI,CAACQ,UAAU,EAAE;MAAA;MAAAZ,cAAA,GAAAc,CAAA;MAAAd,cAAA,GAAAI,CAAA;MAAA,OAAO,IAAI;IAAA,CAAC;IAAA;IAAA;MAAAJ,cAAA,GAAAc,CAAA;IAAA;IAAAd,cAAA,GAAAI,CAAA;IAE7B,IAAI,CAAC,IAAI,CAACC,QAAQ,EAAE;MAAA;MAAAL,cAAA,GAAAc,CAAA;MAAAd,cAAA,GAAAI,CAAA;MAClB,IAAI,CAACC,QAAQ,GAAG,IAAI,CAACF,MAAM,GAAG,CAAC;MAAC;MAAAH,cAAA,GAAAI,CAAA;MAChC,IAAI,CAACD,MAAM,GAAG,IAAI,CAACE,QAAQ;IAC7B,CAAC;IAAA;IAAA;MAAAL,cAAA,GAAAc,CAAA;IAAA;IAAAd,cAAA,GAAAI,CAAA;IAED,IAAI,CAACE,cAAc,GAAG,IAAI,CAACA,cAAc;IAAA;IAAA,CAAAN,cAAA,GAAAc,CAAA,UACrC,GAAG,IAAI,CAACR,cAAc,KAAKM,UAAU,EAAE;IAAA;IAAA,CAAAZ,cAAA,GAAAc,CAAA,UACvCF,UAAU;IAAC;IAAAZ,cAAA,GAAAI,CAAA;IAEf,IAAI,CAACI,SAAS,CAACO,WAAW,CAAC,mBAAmB,EAAE;MAC9CC,EAAE,EAAE,IAAI,CAACX,QAAQ;MACjBY,KAAK,EAAE,SAAS;MAChBC,OAAO,EAAE,IAAI,CAACC,QAAQ,CAACP,UAAU,CAAC;MAClCQ,MAAM,EAAER,UAAU,CAACQ;IACrB,CAAC,CAAC;IAAC;IAAApB,cAAA,GAAAI,CAAA;IAEH,OAAO,IAAI,CAACC,QAAQ;EACtB;EAEAgB,cAAcA,CAACC,QAAgB,EAAEC,QAAmC;EAAA;EAAA,CAAAvB,cAAA,GAAAc,CAAA,UAAG,CAAC,CAAC,GAAiB;IAAA;IAAAd,cAAA,GAAAS,CAAA;IACxF,MAAMG,UAAU;IAAA;IAAA,CAAAZ,cAAA,GAAAI,CAAA,QAAGkB,QAAQ,CAACT,IAAI,CAAC,CAAC;IAAC;IAAAb,cAAA,GAAAI,CAAA;IACnC,IAAI,CAACQ,UAAU,EAAE;MAAA;MAAAZ,cAAA,GAAAc,CAAA;MAAAd,cAAA,GAAAI,CAAA;MAAA,OAAO,IAAI;IAAA,CAAC;IAAA;IAAA;MAAAJ,cAAA,GAAAc,CAAA;IAAA;IAE7B,MAAME,EAAE;IAAA;IAAA,CAAAhB,cAAA,GAAAI,CAAA;IAAG;IAAA,CAAAJ,cAAA,GAAAc,CAAA,UAAAS,QAAQ,CAACC,UAAU;IAAA;IAAA,CAAAxB,cAAA,GAAAc,CAAA,UAAI,IAAI,CAACT,QAAQ;IAAA;IAAA,CAAAL,cAAA,GAAAc,CAAA,UAAI,IAAI,CAACX,MAAM,GAAG,CAAC;IAAC;IAAAH,cAAA,GAAAI,CAAA;IACnE,IAAIY,EAAE,GAAG,IAAI,CAACb,MAAM,EAAE;MAAA;MAAAH,cAAA,GAAAc,CAAA;MAAAd,cAAA,GAAAI,CAAA;MACpB,IAAI,CAACD,MAAM,GAAGa,EAAE;IAClB,CAAC;IAAA;IAAA;MAAAhB,cAAA,GAAAc,CAAA;IAAA;IAED,MAAMH,OAAO;IAAA;IAAA,CAAAX,cAAA,GAAAI,CAAA;IAAG;IAAA,CAAAJ,cAAA,GAAAc,CAAA,UAAAS,QAAQ,CAACZ,OAAO,EAAEE,IAAI,CAAC,CAAC;IAAA;IAAA,CAAAb,cAAA,GAAAc,CAAA,UAAI,IAAI,CAACR,cAAc;IAAA;IAAA,CAAAN,cAAA,GAAAc,CAAA,UAAI,IAAI;IAAC;IAAAd,cAAA,GAAAI,CAAA;IAExE,IAAI,CAACI,SAAS,CAACO,WAAW,CAAC,oBAAoB,EAAE;MAC/CC,EAAE;MACFC,KAAK,EAAE,UAAU;MACjBC,OAAO,EAAE,IAAI,CAACC,QAAQ,CAACP,UAAU,CAAC;MAClCQ,MAAM,EAAER,UAAU,CAACQ,MAAM;MACzBK,cAAc,EAAEd,OAAO;MAAA;MAAA,CAAAX,cAAA,GAAAc,CAAA,UAAG,IAAI,CAACK,QAAQ,CAACR,OAAO,CAAC;MAAA;MAAA,CAAAX,cAAA,GAAAc,CAAA,UAAGY,SAAS;MAC5DC,MAAM;MAAE;MAAA,CAAA3B,cAAA,GAAAc,CAAA,UAAAS,QAAQ,CAACI,MAAM;MAAA;MAAA,CAAA3B,cAAA,GAAAc,CAAA,UAAI,OAAO;MAClCc,KAAK;MAAE;MAAA,CAAA5B,cAAA,GAAAc,CAAA,WAAAS,QAAQ,CAACK,KAAK;MAAA;MAAA,CAAA5B,cAAA,GAAAc,CAAA,WAAI,IAAI;IAC/B,CAAC,CAAC;IAAC;IAAAd,cAAA,GAAAI,CAAA;IAEH,IAAI,CAACE,cAAc,GAAG,IAAI;IAAC;IAAAN,cAAA,GAAAI,CAAA;IAC3B,IAAI,CAACC,QAAQ,GAAG,IAAI;IAAC;IAAAL,cAAA,GAAAI,CAAA;IACrB,OAAOY,EAAE;EACX;EAEQG,QAAQA,CAACU,KAAa,EAAEC,GAAW;EAAA;EAAA,CAAA9B,cAAA,GAAAc,CAAA,WAAG,GAAG,GAAU;IAAA;IAAAd,cAAA,GAAAS,CAAA;IAAAT,cAAA,GAAAI,CAAA;IACzD,IAAIyB,KAAK,CAACT,MAAM,IAAIU,GAAG,EAAE;MAAA;MAAA9B,cAAA,GAAAc,CAAA;MAAAd,cAAA,GAAAI,CAAA;MAAA,OAAOyB,KAAK;IAAA,CAAC;IAAA;IAAA;MAAA7B,cAAA,GAAAc,CAAA;IAAA;IAAAd,cAAA,GAAAI,CAAA;IACtC,OAAO,GAAGyB,KAAK,CAACE,KAAK,CAAC,CAAC,EAAED,GAAG,GAAG,CAAC,CAAC,CAACE,OAAO,CAAC,CAAC,KAAK;EAClD;AACF","ignoreList":[]}