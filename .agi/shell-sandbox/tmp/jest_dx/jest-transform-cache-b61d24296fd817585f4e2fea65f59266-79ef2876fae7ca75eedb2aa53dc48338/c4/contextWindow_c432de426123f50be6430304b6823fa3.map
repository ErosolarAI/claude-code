{"version":3,"names":["cov_2m1qq3r1uo","actualCoverage","MODEL_CONTEXT_WINDOWS","s","pattern","contextWindow","targetTokens","DEFAULT_CONTEXT_WINDOW","DEFAULT_TARGET_TOKENS","getModelContextInfo","model","f","b","isDefault","normalized","trim","entry","test","getContextWindowTokens","info","getSafeTargetTokens","calculateContextThresholds","effectiveMax","Math","floor","maxTokens","warningTokens","criticalTokens"],"sources":["contextWindow.ts"],"sourcesContent":["/**\n * Model Context Window Management\n *\n * Maps models to their context window sizes and provides utilities\n * for dynamic context limit configuration.\n */\n\ninterface ModelContextEntry {\n  pattern: RegExp;\n  contextWindow: number;\n  targetTokens: number;  // Safe threshold (70% of context)\n}\n\nconst MODEL_CONTEXT_WINDOWS: ModelContextEntry[] = [\n  // OpenAI GPT-5.x series (200K context)\n  { pattern: /^gpt-5\\.1-?codex/i, contextWindow: 200_000, targetTokens: 140_000 },\n  { pattern: /^gpt-5(?:\\.1|-?pro|-?mini|-?nano|-?max)/i, contextWindow: 200_000, targetTokens: 140_000 },\n  { pattern: /^gpt-5$/i, contextWindow: 200_000, targetTokens: 140_000 },\n\n  // OpenAI GPT-4o series (128K context)\n  { pattern: /^gpt-4o/i, contextWindow: 128_000, targetTokens: 90_000 },\n  { pattern: /^gpt-4-turbo/i, contextWindow: 128_000, targetTokens: 90_000 },\n  { pattern: /^gpt-4-(?:0125|1106)/i, contextWindow: 128_000, targetTokens: 90_000 },\n\n  // OpenAI GPT-4 (8K-32K context)\n  { pattern: /^gpt-4-32k/i, contextWindow: 32_000, targetTokens: 24_000 },\n  { pattern: /^gpt-4(?![o-])/i, contextWindow: 8_192, targetTokens: 6_000 },\n\n  // OpenAI o1/o3 reasoning models (200K context)\n  { pattern: /^o1(?:-pro|-mini)?/i, contextWindow: 200_000, targetTokens: 140_000 },\n  { pattern: /^o3(?:-pro|-mini)?/i, contextWindow: 200_000, targetTokens: 140_000 },\n\n  // OpenAI GPT-3.5 (16K context)\n  { pattern: /^gpt-3\\.5-turbo-16k/i, contextWindow: 16_000, targetTokens: 12_000 },\n  { pattern: /^gpt-3\\.5/i, contextWindow: 4_096, targetTokens: 3_000 },\n\n  // Anthropic Claude 4.x series (200K context)\n  { pattern: /^claude-(?:sonnet|opus|haiku)-4/i, contextWindow: 200_000, targetTokens: 140_000 },\n  { pattern: /^(?:sonnet|opus|haiku)-4/i, contextWindow: 200_000, targetTokens: 140_000 },\n\n  // Anthropic Claude 3.x series (200K context)\n  { pattern: /^claude-3/i, contextWindow: 200_000, targetTokens: 140_000 },\n\n  // Anthropic Claude 2.x (100K context)\n  { pattern: /^claude-2/i, contextWindow: 100_000, targetTokens: 70_000 },\n\n  // Google Gemini Pro (1M+ context, capped at 200K for safety)\n  { pattern: /^gemini-(?:1\\.5|2\\.0)-(?:pro|flash)/i, contextWindow: 1_000_000, targetTokens: 200_000 },\n  { pattern: /^gemini-pro/i, contextWindow: 32_000, targetTokens: 24_000 },\n\n  // DeepSeek (64K-128K context)\n  { pattern: /^deepseek-(?:chat|coder|reasoner)/i, contextWindow: 128_000, targetTokens: 90_000 },\n  { pattern: /^deepseek/i, contextWindow: 64_000, targetTokens: 45_000 },\n\n  // xAI Grok (128K context)\n  { pattern: /^grok/i, contextWindow: 128_000, targetTokens: 90_000 },\n\n  // Ollama/Local models\n  { pattern: /^llama-?3\\.?[12]?:?(?:70b|405b)/i, contextWindow: 128_000, targetTokens: 90_000 },\n  { pattern: /^llama-?3/i, contextWindow: 8_192, targetTokens: 6_000 },\n  { pattern: /^llama-?2/i, contextWindow: 4_096, targetTokens: 3_000 },\n  { pattern: /^mistral/i, contextWindow: 32_000, targetTokens: 24_000 },\n  { pattern: /^mixtral/i, contextWindow: 32_000, targetTokens: 24_000 },\n  { pattern: /^codellama/i, contextWindow: 16_000, targetTokens: 12_000 },\n  { pattern: /^qwen/i, contextWindow: 32_000, targetTokens: 24_000 },\n  { pattern: /^phi/i, contextWindow: 4_096, targetTokens: 3_000 },\n];\n\n// Default fallback values\nconst DEFAULT_CONTEXT_WINDOW = 128_000;\nconst DEFAULT_TARGET_TOKENS = 90_000;\n\nexport interface ModelContextInfo {\n  model: string;\n  contextWindow: number;\n  targetTokens: number;\n  isDefault: boolean;\n}\n\n/**\n * Get context window information for a model.\n */\nexport function getModelContextInfo(model: string | null | undefined): ModelContextInfo {\n  if (!model) {\n    return {\n      model: 'unknown',\n      contextWindow: DEFAULT_CONTEXT_WINDOW,\n      targetTokens: DEFAULT_TARGET_TOKENS,\n      isDefault: true,\n    };\n  }\n\n  const normalized = model.trim();\n\n  for (const entry of MODEL_CONTEXT_WINDOWS) {\n    if (entry.pattern.test(normalized)) {\n      return {\n        model,\n        contextWindow: entry.contextWindow,\n        targetTokens: entry.targetTokens,\n        isDefault: false,\n      };\n    }\n  }\n\n  return {\n    model,\n    contextWindow: DEFAULT_CONTEXT_WINDOW,\n    targetTokens: DEFAULT_TARGET_TOKENS,\n    isDefault: true,\n  };\n}\n\n/**\n * Returns the approximate context window (in tokens) for the provided model id.\n * Falls back to null when the model is unknown so callers can handle gracefully.\n */\nexport function getContextWindowTokens(model: string | null | undefined): number | null {\n  if (!model) {\n    return null;\n  }\n\n  const info = getModelContextInfo(model);\n  return info.isDefault ? null : info.contextWindow;\n}\n\n/**\n * Get safe target token count for a model.\n * This is the threshold at which context pruning should begin.\n */\nexport function getSafeTargetTokens(model: string | null | undefined): number {\n  const info = getModelContextInfo(model);\n  return info.targetTokens;\n}\n\n/**\n * Calculate all context management thresholds for a model.\n *\n * Thresholds are set conservatively to prevent context overflow errors:\n * - targetTokens: Start proactive pruning at 60% to leave ample room\n * - warningTokens: Show warning at 50% so user is aware\n * - criticalTokens: Aggressive pruning at 75%\n * - safetyBuffer: Reserve 5% for API overhead and response tokens\n */\nexport function calculateContextThresholds(model: string | null | undefined): {\n  maxTokens: number;\n  targetTokens: number;\n  warningTokens: number;\n  criticalTokens: number;\n} {\n  const info = getModelContextInfo(model);\n  const contextWindow = info.contextWindow;\n\n  // Apply 5% safety buffer to account for API overhead\n  const effectiveMax = Math.floor(contextWindow * 0.95);\n\n  return {\n    maxTokens: effectiveMax,\n    targetTokens: Math.floor(contextWindow * 0.60),  // Start pruning at 60% (more aggressive)\n    warningTokens: Math.floor(contextWindow * 0.50),  // Warn at 50%\n    criticalTokens: Math.floor(contextWindow * 0.75),  // Critical at 75%\n  };\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAeY;IAAAA,cAAA,YAAAA,CAAA;MAAA,OAAAC,cAAA;IAAA;EAAA;EAAA,OAAAA,cAAA;AAAA;AAAAD,cAAA;AAfZ;AACA;AACA;AACA;AACA;AACA;;AAQA,MAAME,qBAA0C;AAAA;AAAA,CAAAF,cAAA,GAAAG,CAAA,OAAG;AACjD;AACA;EAAEC,OAAO,EAAE,mBAAmB;EAAEC,aAAa,EAAE,OAAO;EAAEC,YAAY,EAAE;AAAQ,CAAC,EAC/E;EAAEF,OAAO,EAAE,0CAA0C;EAAEC,aAAa,EAAE,OAAO;EAAEC,YAAY,EAAE;AAAQ,CAAC,EACtG;EAAEF,OAAO,EAAE,UAAU;EAAEC,aAAa,EAAE,OAAO;EAAEC,YAAY,EAAE;AAAQ,CAAC;AAEtE;AACA;EAAEF,OAAO,EAAE,UAAU;EAAEC,aAAa,EAAE,OAAO;EAAEC,YAAY,EAAE;AAAO,CAAC,EACrE;EAAEF,OAAO,EAAE,eAAe;EAAEC,aAAa,EAAE,OAAO;EAAEC,YAAY,EAAE;AAAO,CAAC,EAC1E;EAAEF,OAAO,EAAE,uBAAuB;EAAEC,aAAa,EAAE,OAAO;EAAEC,YAAY,EAAE;AAAO,CAAC;AAElF;AACA;EAAEF,OAAO,EAAE,aAAa;EAAEC,aAAa,EAAE,MAAM;EAAEC,YAAY,EAAE;AAAO,CAAC,EACvE;EAAEF,OAAO,EAAE,iBAAiB;EAAEC,aAAa,EAAE,KAAK;EAAEC,YAAY,EAAE;AAAM,CAAC;AAEzE;AACA;EAAEF,OAAO,EAAE,qBAAqB;EAAEC,aAAa,EAAE,OAAO;EAAEC,YAAY,EAAE;AAAQ,CAAC,EACjF;EAAEF,OAAO,EAAE,qBAAqB;EAAEC,aAAa,EAAE,OAAO;EAAEC,YAAY,EAAE;AAAQ,CAAC;AAEjF;AACA;EAAEF,OAAO,EAAE,sBAAsB;EAAEC,aAAa,EAAE,MAAM;EAAEC,YAAY,EAAE;AAAO,CAAC,EAChF;EAAEF,OAAO,EAAE,YAAY;EAAEC,aAAa,EAAE,KAAK;EAAEC,YAAY,EAAE;AAAM,CAAC;AAEpE;AACA;EAAEF,OAAO,EAAE,kCAAkC;EAAEC,aAAa,EAAE,OAAO;EAAEC,YAAY,EAAE;AAAQ,CAAC,EAC9F;EAAEF,OAAO,EAAE,2BAA2B;EAAEC,aAAa,EAAE,OAAO;EAAEC,YAAY,EAAE;AAAQ,CAAC;AAEvF;AACA;EAAEF,OAAO,EAAE,YAAY;EAAEC,aAAa,EAAE,OAAO;EAAEC,YAAY,EAAE;AAAQ,CAAC;AAExE;AACA;EAAEF,OAAO,EAAE,YAAY;EAAEC,aAAa,EAAE,OAAO;EAAEC,YAAY,EAAE;AAAO,CAAC;AAEvE;AACA;EAAEF,OAAO,EAAE,sCAAsC;EAAEC,aAAa,EAAE,SAAS;EAAEC,YAAY,EAAE;AAAQ,CAAC,EACpG;EAAEF,OAAO,EAAE,cAAc;EAAEC,aAAa,EAAE,MAAM;EAAEC,YAAY,EAAE;AAAO,CAAC;AAExE;AACA;EAAEF,OAAO,EAAE,oCAAoC;EAAEC,aAAa,EAAE,OAAO;EAAEC,YAAY,EAAE;AAAO,CAAC,EAC/F;EAAEF,OAAO,EAAE,YAAY;EAAEC,aAAa,EAAE,MAAM;EAAEC,YAAY,EAAE;AAAO,CAAC;AAEtE;AACA;EAAEF,OAAO,EAAE,QAAQ;EAAEC,aAAa,EAAE,OAAO;EAAEC,YAAY,EAAE;AAAO,CAAC;AAEnE;AACA;EAAEF,OAAO,EAAE,kCAAkC;EAAEC,aAAa,EAAE,OAAO;EAAEC,YAAY,EAAE;AAAO,CAAC,EAC7F;EAAEF,OAAO,EAAE,YAAY;EAAEC,aAAa,EAAE,KAAK;EAAEC,YAAY,EAAE;AAAM,CAAC,EACpE;EAAEF,OAAO,EAAE,YAAY;EAAEC,aAAa,EAAE,KAAK;EAAEC,YAAY,EAAE;AAAM,CAAC,EACpE;EAAEF,OAAO,EAAE,WAAW;EAAEC,aAAa,EAAE,MAAM;EAAEC,YAAY,EAAE;AAAO,CAAC,EACrE;EAAEF,OAAO,EAAE,WAAW;EAAEC,aAAa,EAAE,MAAM;EAAEC,YAAY,EAAE;AAAO,CAAC,EACrE;EAAEF,OAAO,EAAE,aAAa;EAAEC,aAAa,EAAE,MAAM;EAAEC,YAAY,EAAE;AAAO,CAAC,EACvE;EAAEF,OAAO,EAAE,QAAQ;EAAEC,aAAa,EAAE,MAAM;EAAEC,YAAY,EAAE;AAAO,CAAC,EAClE;EAAEF,OAAO,EAAE,OAAO;EAAEC,aAAa,EAAE,KAAK;EAAEC,YAAY,EAAE;AAAM,CAAC,CAChE;;AAED;AACA,MAAMC,sBAAsB;AAAA;AAAA,CAAAP,cAAA,GAAAG,CAAA,OAAG,OAAO;AACtC,MAAMK,qBAAqB;AAAA;AAAA,CAAAR,cAAA,GAAAG,CAAA,OAAG,MAAM;AASpC;AACA;AACA;AACO,SAASM,mBAAmBA,CAACC,KAAgC,EAAoB;EAAA;EAAAV,cAAA,GAAAW,CAAA;EAAAX,cAAA,GAAAG,CAAA;EACtF,IAAI,CAACO,KAAK,EAAE;IAAA;IAAAV,cAAA,GAAAY,CAAA;IAAAZ,cAAA,GAAAG,CAAA;IACV,OAAO;MACLO,KAAK,EAAE,SAAS;MAChBL,aAAa,EAAEE,sBAAsB;MACrCD,YAAY,EAAEE,qBAAqB;MACnCK,SAAS,EAAE;IACb,CAAC;EACH,CAAC;EAAA;EAAA;IAAAb,cAAA,GAAAY,CAAA;EAAA;EAED,MAAME,UAAU;EAAA;EAAA,CAAAd,cAAA,GAAAG,CAAA,OAAGO,KAAK,CAACK,IAAI,CAAC,CAAC;EAAC;EAAAf,cAAA,GAAAG,CAAA;EAEhC,KAAK,MAAMa,KAAK,IAAId,qBAAqB,EAAE;IAAA;IAAAF,cAAA,GAAAG,CAAA;IACzC,IAAIa,KAAK,CAACZ,OAAO,CAACa,IAAI,CAACH,UAAU,CAAC,EAAE;MAAA;MAAAd,cAAA,GAAAY,CAAA;MAAAZ,cAAA,GAAAG,CAAA;MAClC,OAAO;QACLO,KAAK;QACLL,aAAa,EAAEW,KAAK,CAACX,aAAa;QAClCC,YAAY,EAAEU,KAAK,CAACV,YAAY;QAChCO,SAAS,EAAE;MACb,CAAC;IACH,CAAC;IAAA;IAAA;MAAAb,cAAA,GAAAY,CAAA;IAAA;EACH;EAAC;EAAAZ,cAAA,GAAAG,CAAA;EAED,OAAO;IACLO,KAAK;IACLL,aAAa,EAAEE,sBAAsB;IACrCD,YAAY,EAAEE,qBAAqB;IACnCK,SAAS,EAAE;EACb,CAAC;AACH;;AAEA;AACA;AACA;AACA;AACO,SAASK,sBAAsBA,CAACR,KAAgC,EAAiB;EAAA;EAAAV,cAAA,GAAAW,CAAA;EAAAX,cAAA,GAAAG,CAAA;EACtF,IAAI,CAACO,KAAK,EAAE;IAAA;IAAAV,cAAA,GAAAY,CAAA;IAAAZ,cAAA,GAAAG,CAAA;IACV,OAAO,IAAI;EACb,CAAC;EAAA;EAAA;IAAAH,cAAA,GAAAY,CAAA;EAAA;EAED,MAAMO,IAAI;EAAA;EAAA,CAAAnB,cAAA,GAAAG,CAAA,QAAGM,mBAAmB,CAACC,KAAK,CAAC;EAAC;EAAAV,cAAA,GAAAG,CAAA;EACxC,OAAOgB,IAAI,CAACN,SAAS;EAAA;EAAA,CAAAb,cAAA,GAAAY,CAAA,UAAG,IAAI;EAAA;EAAA,CAAAZ,cAAA,GAAAY,CAAA,UAAGO,IAAI,CAACd,aAAa;AACnD;;AAEA;AACA;AACA;AACA;AACO,SAASe,mBAAmBA,CAACV,KAAgC,EAAU;EAAA;EAAAV,cAAA,GAAAW,CAAA;EAC5E,MAAMQ,IAAI;EAAA;EAAA,CAAAnB,cAAA,GAAAG,CAAA,QAAGM,mBAAmB,CAACC,KAAK,CAAC;EAAC;EAAAV,cAAA,GAAAG,CAAA;EACxC,OAAOgB,IAAI,CAACb,YAAY;AAC1B;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASe,0BAA0BA,CAACX,KAAgC,EAKzE;EAAA;EAAAV,cAAA,GAAAW,CAAA;EACA,MAAMQ,IAAI;EAAA;EAAA,CAAAnB,cAAA,GAAAG,CAAA,QAAGM,mBAAmB,CAACC,KAAK,CAAC;EACvC,MAAML,aAAa;EAAA;EAAA,CAAAL,cAAA,GAAAG,CAAA,QAAGgB,IAAI,CAACd,aAAa;;EAExC;EACA,MAAMiB,YAAY;EAAA;EAAA,CAAAtB,cAAA,GAAAG,CAAA,QAAGoB,IAAI,CAACC,KAAK,CAACnB,aAAa,GAAG,IAAI,CAAC;EAAC;EAAAL,cAAA,GAAAG,CAAA;EAEtD,OAAO;IACLsB,SAAS,EAAEH,YAAY;IACvBhB,YAAY,EAAEiB,IAAI,CAACC,KAAK,CAACnB,aAAa,GAAG,IAAI,CAAC;IAAG;IACjDqB,aAAa,EAAEH,IAAI,CAACC,KAAK,CAACnB,aAAa,GAAG,IAAI,CAAC;IAAG;IAClDsB,cAAc,EAAEJ,IAAI,CAACC,KAAK,CAACnB,aAAa,GAAG,IAAI,CAAC,CAAG;EACrD,CAAC;AACH","ignoreList":[]}