{"version":3,"names":["_globals","require","_nodeFs","_nodePath","_nodeOs","_orchestrationPlugin","_bidirectionalAuditPlugin","_localFilesystemPlugin","_localSearchPlugin","_editPlugin","describe","it","plugin","createOrchestrationToolPlugin","module","create","workingDir","process","cwd","env","contribution","profile","workspaceContext","expect","toolSuite","id","toBe","toolNames","tools","map","t","name","length","toBeGreaterThan","toEqual","arrayContaining","createBidirectionalAuditToolPlugin","suites","toolSuites","flatMap","suite","names","toContain","tempDirs","afterEach","dir","pop","rmSync","recursive","force","loadToolMap","toolDefs","plugins","createLocalFilesystemToolPlugin","createLocalSearchToolPlugin","createEditToolPlugin","created","modules","Array","isArray","contributionResult","contributions","push","reduce","acc","tool","workspace","mkdtempSync","join","tmpdir","toBeDefined","srcDir","mkdirSync","filePath","originalContent","writeFileSync","listFiles","readFile","grep","edit","listing","handler","path","readOutput","grepOutput","pattern","output_mode","editOutput","file_path","old_string","new_string","replace_all","updated","readFileSync"],"sources":["cliIntegration.test.ts"],"sourcesContent":["/**\n * CLI Integration Tests\n * Verifies that the unified orchestration plugins and core tools are wired correctly.\n */\n\nimport { describe, it, expect } from '@jest/globals';\nimport { mkdtempSync, mkdirSync, readFileSync, rmSync, writeFileSync } from 'node:fs';\nimport { join } from 'node:path';\nimport { tmpdir } from 'node:os';\nimport { createOrchestrationToolPlugin } from '../../src/plugins/tools/orchestration/orchestrationPlugin.js';\nimport { createBidirectionalAuditToolPlugin } from '../../src/plugins/tools/bidirectionalAudit/bidirectionalAuditPlugin.js';\nimport { createLocalFilesystemToolPlugin } from '../../src/plugins/tools/filesystem/localFilesystemPlugin.js';\nimport { createLocalSearchToolPlugin } from '../../src/plugins/tools/search/localSearchPlugin.js';\nimport { createEditToolPlugin } from '../../src/plugins/tools/edit/editPlugin.js';\nimport type { ToolDefinition } from '../../src/core/toolRuntime.js';\n\ndescribe('CLI Integration', () => {\n  describe('Unified orchestrator plugin', () => {\n    it('creates the orchestration tool suite with key tools', async () => {\n      const plugin = createOrchestrationToolPlugin();\n      const module = await plugin.create({ workingDir: process.cwd(), env: process.env });\n      const contribution = await module!.create({\n        profile: 'agi-code',\n        workspaceContext: null,\n        workingDir: process.cwd(),\n        env: process.env,\n      });\n\n      expect(contribution?.toolSuite?.id).toBe('orchestration.tools.unified');\n      const toolNames = contribution?.toolSuite?.tools.map((t) => t.name) ?? [];\n      expect(toolNames.length).toBeGreaterThan(0);\n      expect(toolNames).toEqual(\n        expect.arrayContaining(['analyze_errors', 'verify_result', 'hypothesis'])\n      );\n    });\n  });\n\n  describe('Bidirectional audit plugin', () => {\n    it('exposes the bidirectional audit tool', async () => {\n      const plugin = createBidirectionalAuditToolPlugin();\n      const module = await plugin.create({ workingDir: process.cwd(), env: process.env });\n      const contribution = await module!.create({\n        profile: 'agi-code',\n        workspaceContext: null,\n        workingDir: process.cwd(),\n        env: process.env,\n      });\n\n      const suites = contribution?.toolSuites ?? (contribution?.toolSuite ? [contribution.toolSuite] : []);\n      expect(suites.length).toBeGreaterThan(0);\n\n      const tools = suites.flatMap((suite) => suite.tools);\n      const names = tools.map((t) => t.name);\n      expect(names).toContain('BidirectionalAudit');\n    });\n  });\n});\n\ndescribe('Core engineering toolchain integration', () => {\n  const profile = 'agi-code';\n  const tempDirs: string[] = [];\n\n  afterEach(() => {\n    while (tempDirs.length) {\n      const dir = tempDirs.pop();\n      if (dir) {\n        rmSync(dir, { recursive: true, force: true });\n      }\n    }\n  });\n\n  /**\n   * Collect tool definitions from core CLI plugins without invoking an LLM.\n   */\n  async function loadToolMap(workingDir: string): Promise<Record<string, ToolDefinition>> {\n    const toolDefs: ToolDefinition[] = [];\n    const plugins = [\n      createLocalFilesystemToolPlugin(),\n      createLocalSearchToolPlugin(),\n      createEditToolPlugin(),\n    ];\n\n    for (const plugin of plugins) {\n      const created = await plugin.create({ workingDir, env: process.env });\n      const modules = Array.isArray(created) ? created : [created];\n\n      for (const module of modules) {\n        if (!module) continue;\n        const contributionResult = await module.create({\n          profile: profile as any,\n          workspaceContext: null,\n          workingDir,\n          env: process.env,\n        });\n        const contributions = Array.isArray(contributionResult) ? contributionResult : [contributionResult];\n        for (const contribution of contributions) {\n          if (contribution?.toolSuite) {\n            toolDefs.push(...contribution.toolSuite.tools);\n          }\n          if (contribution?.toolSuites?.length) {\n            for (const suite of contribution.toolSuites) {\n              toolDefs.push(...suite.tools);\n            }\n          }\n        }\n      }\n    }\n\n    return toolDefs.reduce<Record<string, ToolDefinition>>((acc, tool) => {\n      acc[tool.name] = tool;\n      return acc;\n    }, {});\n  }\n\n  it('exposes core filesystem/search/edit tools', async () => {\n    const workspace = mkdtempSync(join(tmpdir(), 'erosolar-cli-core-'));\n    tempDirs.push(workspace);\n\n    const tools = await loadToolMap(workspace);\n    expect(tools['list_files']).toBeDefined();\n    expect(tools['read_file']).toBeDefined();\n    expect(tools['Grep']).toBeDefined();\n    expect(tools['Edit']).toBeDefined();\n  });\n\n  it('supports basic read/search/edit workflow', async () => {\n    const workspace = mkdtempSync(join(tmpdir(), 'erosolar-cli-workflow-'));\n    tempDirs.push(workspace);\n\n    const srcDir = join(workspace, 'src');\n    mkdirSync(srcDir, { recursive: true });\n\n    const filePath = join(srcDir, 'example.ts');\n    const originalContent = [\n      'export function hello(name: string) {',\n      '  return `hi ${name}`;',\n      '}',\n      '',\n    ].join('\\n');\n    writeFileSync(filePath, originalContent);\n\n    const tools = await loadToolMap(workspace);\n    const listFiles = tools['list_files'];\n    const readFile = tools['read_file'];\n    const grep = tools['Grep'];\n    const edit = tools['Edit'];\n\n    // List files\n    const listing = await listFiles.handler!({ path: 'src', recursive: true });\n    expect(listing).toContain('example.ts');\n\n    // Read file\n    const readOutput = await readFile.handler!({ path: 'src/example.ts' });\n    expect(readOutput).toContain('hello');\n\n    // Search for content\n    const grepOutput = await grep.handler!({\n      pattern: 'hello',\n      path: workspace,\n      output_mode: 'files_with_matches',\n    });\n    expect(grepOutput).toContain('example.ts');\n\n    // Edit file content\n    const editOutput = await edit.handler!({\n      file_path: filePath,\n      old_string: 'return `hi ${name}`;',\n      new_string: 'return `hello ${name}`;',\n      replace_all: true,\n    });\n    expect(editOutput).toContain('hello');\n\n    const updated = readFileSync(filePath, 'utf-8');\n    expect(updated).toContain('hello ${name}');\n  });\n});\n"],"mappings":"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","ignoreList":[]}