{"version":3,"names":["_asyncUtils","require","RATE_LIMIT_PATTERNS","TRANSIENT_ERROR_PATTERNS","FALLBACK_ELIGIBLE_PATTERNS","isFallbackEligibleError","error","Error","message","toLowerCase","some","pattern","includes","errorWithCode","code","String","type","reason","status","getFallbackReason","isRateLimitError","isTransientError","errorName","name","errorCode","cause","shouldRetry","ResilientProvider","stats","totalRequests","rateLimitHits","retries","circuitBreakerTrips","constructor","provider","config","id","model","maxRequestsPerMinute","maxRetries","baseDelayMs","maxDelayMs","enableCircuitBreaker","circuitBreakerThreshold","circuitBreakerResetMs","rateLimiter","RateLimiter","maxRequests","windowMs","circuitBreaker","failures","lastFailure","isOpen","checkCircuitBreaker","elapsed","Date","now","Math","floor","ceil","recordFailure","_error","recordSuccess","max","executeWithResilience","operation","_operationName","acquire","result","retry","backoffMultiplier","generate","messages","tools","generateStream","response","content","toolCalls","call","toolCall","usage","attempts","lastError","stream","chunk","err","delay","min","pow","sleep","getStats","circuitBreakerOpen","availableTokens","resetStats","exports","withResilience","PROVIDER_RESILIENCE_CONFIGS","anthropic","openai","google","deepseek","xai","ollama","withProviderResilience","providerId","overrides","defaults"],"sources":["resilientProvider.ts"],"sourcesContent":["/**\n * Resilient Provider Wrapper\n *\n * Adds rate limiting, exponential backoff retry, and circuit breaker\n * patterns to any LLM provider for maximum reliability and performance.\n *\n * PERF: Provider-agnostic wrapper that prevents rate limit errors and\n * automatically recovers from transient failures.\n */\n\nimport type {\n  LLMProvider,\n  ConversationMessage,\n  ProviderToolDefinition,\n  ProviderResponse,\n  StreamChunk,\n  ProviderId,\n} from '../core/types.js';\nimport { RateLimiter, retry, sleep } from '../utils/asyncUtils.js';\n\nexport interface ResilientProviderConfig {\n  /** Maximum requests per window (default: 50) */\n  maxRequestsPerMinute?: number;\n  /** Maximum retry attempts (default: 4) */\n  maxRetries?: number;\n  /** Base delay for exponential backoff in ms (default: 1000) */\n  baseDelayMs?: number;\n  /** Maximum delay between retries in ms (default: 32000) */\n  maxDelayMs?: number;\n  /** Enable circuit breaker pattern (default: true) */\n  enableCircuitBreaker?: boolean;\n  /** Number of failures before circuit opens (default: 5) */\n  circuitBreakerThreshold?: number;\n  /** Time before circuit resets in ms (default: 60000) */\n  circuitBreakerResetMs?: number;\n}\n\ninterface CircuitBreakerState {\n  failures: number;\n  lastFailure: number;\n  isOpen: boolean;\n}\n\nconst RATE_LIMIT_PATTERNS = [\n  'rate limit',\n  'rate_limit',\n  'ratelimit',\n  'too many requests',\n  '429',\n  'quota exceeded',\n  'request limit',\n  'throttled',\n  'overloaded',\n  'capacity',\n];\n\nconst TRANSIENT_ERROR_PATTERNS = [\n  'timeout',\n  'timed out',\n  'network',\n  'connection',\n  'econnrefused',\n  'econnreset',\n  'enotfound',\n  'epipe',\n  'econnaborted',\n  'ehostunreach',\n  'enetunreach',\n  'socket',\n  'temporarily unavailable',\n  '502',\n  '503',\n  '504',\n  'bad gateway',\n  'service unavailable',\n  'gateway timeout',\n  'internal server error',\n  '500',\n  // Stream and fetch errors\n  'premature close',\n  'premature end',\n  'unexpected end',\n  'stream',\n  'aborted',\n  'fetcherror',\n  'fetch error',\n  'invalid response body',\n  'response body',\n  'gunzip',\n  'decompress',\n  'zlib',\n  'content-encoding',\n  'chunked encoding',\n  'transfer-encoding',\n  // SSL/TLS errors\n  'ssl',\n  'tls',\n  'certificate',\n  'cert',\n  'handshake',\n];\n\nconst FALLBACK_ELIGIBLE_PATTERNS = [\n  // Quota/billing errors\n  'insufficient_quota',\n  'quota exceeded',\n  'exceeded your current quota',\n  'billing',\n  'payment required',\n  'account suspended',\n  'account disabled',\n  // API key errors\n  'api key expired',\n  'api_key_invalid',\n  'invalid api key',\n  'invalid_api_key',\n  'api key not valid',\n  // Model availability errors\n  'model not found',\n  'model_not_found',\n  'does not exist',\n  'not available',\n  'deprecated',\n  'access denied',\n  'permission denied',\n  'unauthorized',\n  '401',\n  '403',\n  '400',\n  'invalid_argument',\n  // Regional/access restrictions\n  'region',\n  'not supported in your',\n  'country',\n  'restricted',\n];\n\n/**\n * Check if an error warrants trying a different provider (fallback).\n * These are non-transient errors that won't be fixed by retrying the same provider.\n */\nexport function isFallbackEligibleError(error: unknown): boolean {\n  if (!(error instanceof Error)) return false;\n  const message = error.message.toLowerCase();\n\n  // Check message for fallback patterns\n  if (FALLBACK_ELIGIBLE_PATTERNS.some(pattern => message.includes(pattern))) {\n    return true;\n  }\n\n  // Check error code/type/reason if present (OpenAI and Google style errors)\n  const errorWithCode = error as { code?: string | number; type?: string; reason?: string; status?: string };\n  const code = String(errorWithCode.code ?? '').toLowerCase();\n  const type = (errorWithCode.type ?? '').toLowerCase();\n  const reason = (errorWithCode.reason ?? '').toLowerCase();\n  const status = (errorWithCode.status ?? '').toLowerCase();\n\n  // OpenAI style errors\n  if (code === 'insufficient_quota' || type === 'insufficient_quota') {\n    return true;\n  }\n  if (code === 'model_not_found' || type === 'model_not_found') {\n    return true;\n  }\n  if (code === 'invalid_api_key' || type === 'invalid_api_key') {\n    return true;\n  }\n\n  // Google style errors\n  if (reason === 'api_key_invalid' || status === 'invalid_argument') {\n    return true;\n  }\n  if (code === '400' || code === '401' || code === '403') {\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Get a user-friendly description of why fallback is needed\n */\nexport function getFallbackReason(error: unknown): string {\n  if (!(error instanceof Error)) return 'Unknown error';\n  const message = error.message.toLowerCase();\n\n  if (message.includes('quota') || message.includes('billing')) {\n    return 'API quota exceeded or billing issue';\n  }\n  if (message.includes('expired') || message.includes('api_key_invalid') || message.includes('api key')) {\n    return 'API key expired or invalid';\n  }\n  if (message.includes('model') && (message.includes('not found') || message.includes('not exist'))) {\n    return 'Model not available';\n  }\n  if (message.includes('unauthorized') || message.includes('401') || message.includes('invalid_api_key')) {\n    return 'Invalid API key';\n  }\n  if (message.includes('403') || message.includes('permission') || message.includes('access denied')) {\n    return 'Access denied';\n  }\n  if (message.includes('400') || message.includes('invalid_argument')) {\n    return 'Invalid request or API key';\n  }\n  if (message.includes('region') || message.includes('country') || message.includes('restricted')) {\n    return 'Regional restriction';\n  }\n\n  return 'Provider error';\n}\n\nfunction isRateLimitError(error: unknown): boolean {\n  if (!(error instanceof Error)) return false;\n  const message = error.message.toLowerCase();\n  return RATE_LIMIT_PATTERNS.some(pattern => message.includes(pattern));\n}\n\nfunction isTransientError(error: unknown): boolean {\n  if (!(error instanceof Error)) return false;\n\n  // Check message\n  const message = error.message.toLowerCase();\n  if (TRANSIENT_ERROR_PATTERNS.some(pattern => message.includes(pattern))) {\n    return true;\n  }\n\n  // Check error name/type (FetchError, AbortError, etc.)\n  const errorName = error.name?.toLowerCase() ?? '';\n  if (errorName.includes('fetch') || errorName.includes('abort') || errorName.includes('network')) {\n    return true;\n  }\n\n  // Check error code if present (Node.js style)\n  const errorCode = (error as { code?: string }).code?.toLowerCase() ?? '';\n  if (errorCode && TRANSIENT_ERROR_PATTERNS.some(pattern => errorCode.includes(pattern))) {\n    return true;\n  }\n\n  // Check cause chain for nested errors\n  const cause = (error as { cause?: unknown }).cause;\n  if (cause instanceof Error) {\n    return isTransientError(cause);\n  }\n\n  return false;\n}\n\nfunction shouldRetry(error: unknown): boolean {\n  return isRateLimitError(error) || isTransientError(error);\n}\n\n/**\n * Wraps any LLM provider with rate limiting and retry logic\n */\nexport class ResilientProvider implements LLMProvider {\n  readonly id: ProviderId;\n  readonly model: string;\n  private readonly provider: LLMProvider;\n  private readonly rateLimiter: RateLimiter;\n  private readonly config: Required<ResilientProviderConfig>;\n  private readonly circuitBreaker: CircuitBreakerState;\n  private stats = {\n    totalRequests: 0,\n    rateLimitHits: 0,\n    retries: 0,\n    circuitBreakerTrips: 0,\n  };\n\n  constructor(provider: LLMProvider, config: ResilientProviderConfig = {}) {\n    this.provider = provider;\n    this.id = provider.id;\n    this.model = provider.model;\n    this.config = {\n      maxRequestsPerMinute: config.maxRequestsPerMinute ?? 50,\n      maxRetries: config.maxRetries ?? 4,\n      baseDelayMs: config.baseDelayMs ?? 1000,\n      maxDelayMs: config.maxDelayMs ?? 32000,\n      enableCircuitBreaker: config.enableCircuitBreaker ?? true,\n      circuitBreakerThreshold: config.circuitBreakerThreshold ?? 5,\n      circuitBreakerResetMs: config.circuitBreakerResetMs ?? 60000,\n    };\n\n    this.rateLimiter = new RateLimiter({\n      maxRequests: this.config.maxRequestsPerMinute,\n      windowMs: 60000,\n    });\n\n    this.circuitBreaker = {\n      failures: 0,\n      lastFailure: 0,\n      isOpen: false,\n    };\n  }\n\n  /**\n   * Check and potentially reset circuit breaker\n   */\n  private checkCircuitBreaker(): void {\n    if (!this.config.enableCircuitBreaker) return;\n\n    if (this.circuitBreaker.isOpen) {\n      const elapsed = Date.now() - this.circuitBreaker.lastFailure;\n      if (elapsed >= this.config.circuitBreakerResetMs) {\n        // Half-open: allow one request through\n        this.circuitBreaker.isOpen = false;\n        this.circuitBreaker.failures = Math.floor(this.circuitBreaker.failures / 2);\n      } else {\n        throw new Error(\n          `Circuit breaker is open. Too many failures (${this.circuitBreaker.failures}). ` +\n          `Retry in ${Math.ceil((this.config.circuitBreakerResetMs - elapsed) / 1000)}s.`\n        );\n      }\n    }\n  }\n\n  /**\n   * Record a failure for circuit breaker\n   */\n  private recordFailure(_error?: unknown): void {\n    if (!this.config.enableCircuitBreaker) return;\n\n    this.circuitBreaker.failures++;\n    this.circuitBreaker.lastFailure = Date.now();\n\n    if (this.circuitBreaker.failures >= this.config.circuitBreakerThreshold) {\n      this.circuitBreaker.isOpen = true;\n      this.stats.circuitBreakerTrips++;\n    }\n  }\n\n  /**\n   * Record a success to reset circuit breaker\n   */\n  private recordSuccess(): void {\n    if (this.config.enableCircuitBreaker && this.circuitBreaker.failures > 0) {\n      this.circuitBreaker.failures = Math.max(0, this.circuitBreaker.failures - 1);\n    }\n  }\n\n  /**\n   * Execute a request with rate limiting and retry\n   */\n  private async executeWithResilience<T>(\n    operation: () => Promise<T>,\n    _operationName?: string\n  ): Promise<T> {\n    this.stats.totalRequests++;\n\n    // Check circuit breaker\n    this.checkCircuitBreaker();\n\n    // Acquire rate limit token\n    await this.rateLimiter.acquire();\n\n    try {\n      const result = await retry(\n        operation,\n        {\n          maxRetries: this.config.maxRetries,\n          baseDelayMs: this.config.baseDelayMs,\n          maxDelayMs: this.config.maxDelayMs,\n          backoffMultiplier: 2,\n          shouldRetry: (error) => {\n            if (shouldRetry(error)) {\n              this.stats.retries++;\n              if (isRateLimitError(error)) {\n                this.stats.rateLimitHits++;\n              }\n              return true;\n            }\n            return false;\n          },\n        }\n      );\n\n      this.recordSuccess();\n      return result;\n    } catch (error) {\n      this.recordFailure(error);\n      throw error;\n    }\n  }\n\n  /**\n   * Generate a response with resilience\n   */\n  async generate(\n    messages: ConversationMessage[],\n    tools: ProviderToolDefinition[]\n  ): Promise<ProviderResponse> {\n    return this.executeWithResilience(\n      () => this.provider.generate(messages, tools),\n      'generate'\n    );\n  }\n\n  /**\n   * Generate a streaming response with resilience\n   *\n   * Note: Retry logic is limited for streaming - we can only retry\n   * before the stream starts, not mid-stream.\n   */\n  async *generateStream(\n    messages: ConversationMessage[],\n    tools: ProviderToolDefinition[]\n  ): AsyncIterableIterator<StreamChunk> {\n    if (!this.provider.generateStream) {\n      // Fall back to non-streaming\n      const response = await this.generate(messages, tools);\n      if (response.type === 'message') {\n        yield { type: 'content', content: response.content };\n      } else if (response.type === 'tool_calls') {\n        if (response.content) {\n          yield { type: 'content', content: response.content };\n        }\n        if (response.toolCalls) {\n          for (const call of response.toolCalls) {\n            yield { type: 'tool_call', toolCall: call };\n          }\n        }\n      }\n      if (response.usage) {\n        yield { type: 'usage', usage: response.usage };\n      }\n      return;\n    }\n\n    this.stats.totalRequests++;\n\n    // Check circuit breaker\n    this.checkCircuitBreaker();\n\n    // Acquire rate limit token\n    await this.rateLimiter.acquire();\n\n    let attempts = 0;\n    let lastError: unknown;\n\n    while (attempts <= this.config.maxRetries) {\n      try {\n        const stream = this.provider.generateStream(messages, tools);\n        for await (const chunk of stream) {\n          yield chunk;\n        }\n        this.recordSuccess();\n        return;\n      } catch (err) {\n        lastError = err;\n        attempts++;\n\n        if (attempts <= this.config.maxRetries && shouldRetry(err)) {\n          this.stats.retries++;\n          if (isRateLimitError(err)) {\n            this.stats.rateLimitHits++;\n          }\n\n          const delay = Math.min(\n            this.config.baseDelayMs * Math.pow(2, attempts - 1),\n            this.config.maxDelayMs\n          );\n          await sleep(delay);\n          continue;\n        }\n\n        this.recordFailure(err);\n        throw err;\n      }\n    }\n\n    this.recordFailure(lastError);\n    throw lastError;\n  }\n\n  /**\n   * Get resilience statistics\n   */\n  getStats(): {\n    totalRequests: number;\n    rateLimitHits: number;\n    retries: number;\n    circuitBreakerTrips: number;\n    circuitBreakerOpen: boolean;\n    availableTokens: number;\n  } {\n    return {\n      ...this.stats,\n      circuitBreakerOpen: this.circuitBreaker.isOpen,\n      availableTokens: this.rateLimiter.availableTokens,\n    };\n  }\n\n  /**\n   * Reset statistics\n   */\n  resetStats(): void {\n    this.stats = {\n      totalRequests: 0,\n      rateLimitHits: 0,\n      retries: 0,\n      circuitBreakerTrips: 0,\n    };\n  }\n}\n\n/**\n * Wrap any provider with resilience features\n */\nexport function withResilience(\n  provider: LLMProvider,\n  config?: ResilientProviderConfig\n): ResilientProvider {\n  return new ResilientProvider(provider, config);\n}\n\n/**\n * Provider-specific recommended configurations\n */\nexport const PROVIDER_RESILIENCE_CONFIGS: Record<string, ResilientProviderConfig> = {\n  anthropic: {\n    maxRequestsPerMinute: 50,\n    maxRetries: 4,\n    baseDelayMs: 1500,\n    maxDelayMs: 40000,\n  },\n  openai: {\n    maxRequestsPerMinute: 60,\n    maxRetries: 3,\n    baseDelayMs: 1000,\n    maxDelayMs: 30000,\n  },\n  google: {\n    maxRequestsPerMinute: 60,\n    maxRetries: 3,\n    baseDelayMs: 1000,\n    maxDelayMs: 30000,\n  },\n  deepseek: {\n    maxRequestsPerMinute: 30,\n    maxRetries: 4,\n    baseDelayMs: 2000,\n    maxDelayMs: 45000,\n  },\n  xai: {\n    maxRequestsPerMinute: 40,\n    maxRetries: 3,\n    baseDelayMs: 1500,\n    maxDelayMs: 35000,\n  },\n  ollama: {\n    maxRequestsPerMinute: 100,\n    maxRetries: 2,\n    baseDelayMs: 500,\n    maxDelayMs: 10000,\n    enableCircuitBreaker: false, // Local, less likely to need circuit breaker\n  },\n};\n\n/**\n * Wrap a provider with resilience using provider-specific defaults\n */\nexport function withProviderResilience(\n  provider: LLMProvider,\n  providerId: string,\n  overrides?: Partial<ResilientProviderConfig>\n): ResilientProvider {\n  const defaults = PROVIDER_RESILIENCE_CONFIGS[providerId] ?? {};\n  return new ResilientProvider(provider, { ...defaults, ...overrides });\n}\n"],"mappings":"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","ignoreList":[]}