{"version":3,"names":["cov_2bjg00my47","actualCoverage","lockDepth","s","streamingActive","pendingCallbacks","MAX_PENDING_CALLBACKS","LOCK_TIMEOUT_MS","safetyTimer","isStreamingMode","f","b","getLockDepth","enterStreamingMode","setTimeout","console","warn","forceRelease","exitStreamingMode","clearSafetyTimer","flushPendingCallbacks","clearTimeout","length","callback","shift","ifNotStreaming","whenStreamingEnds","push","withStreamLock","installGlobalWriteLock","resetGlobalWriteLock"],"sources":["globalWriteLock.ts"],"sourcesContent":["/**\n * Global Write Lock - Robust streaming-safe output coordination\n *\n * This module provides a thread-safe mechanism to ensure streaming content\n * is not interrupted by other UI components during streaming.\n *\n * Design Principles:\n * - During streaming, ONLY streaming content writes to stdout\n * - All other UI components (status, input area, etc.) wait until streaming ends\n * - Supports nested/re-entrant locking with reference counting\n * - Provides timeout-based automatic unlock for safety\n *\n * This prevents the garbled output and cutoffs that occur when multiple\n * components try to write simultaneously with cursor positioning.\n */\n\n/** Current lock depth for re-entrant locking */\nlet lockDepth = 0;\n\n/** Streaming mode flag (true when actively streaming content) */\nlet streamingActive = false;\n\n/** Queue of callbacks waiting for stream to finish */\nconst pendingCallbacks: Array<() => void> = [];\n\n/** Maximum pending callbacks to prevent memory leaks */\nconst MAX_PENDING_CALLBACKS = 100;\n\n/** Safety timeout to auto-release stuck locks (30 seconds) */\nconst LOCK_TIMEOUT_MS = 30000;\n\n/** Timer for auto-unlock safety mechanism */\nlet safetyTimer: NodeJS.Timeout | null = null;\n\n/**\n * Check if streaming mode is currently active\n */\nexport function isStreamingMode(): boolean {\n  return streamingActive || lockDepth > 0;\n}\n\n/**\n * Get current lock depth (for debugging)\n */\nexport function getLockDepth(): number {\n  return lockDepth;\n}\n\n/**\n * Enter streaming mode - blocks all non-streaming output\n * Supports nested calls with reference counting\n */\nexport function enterStreamingMode(): void {\n  lockDepth++;\n  streamingActive = true;\n\n  // Set safety timer on first lock\n  if (lockDepth === 1 && !safetyTimer) {\n    safetyTimer = setTimeout(() => {\n      if (streamingActive) {\n        // Force release if lock is held too long (safety mechanism)\n        console.warn('[GlobalWriteLock] Safety timeout triggered - forcing release');\n        forceRelease();\n      }\n    }, LOCK_TIMEOUT_MS);\n  }\n}\n\n/**\n * Exit streaming mode - allows normal UI output to resume\n * Only fully exits when all nested locks are released\n */\nexport function exitStreamingMode(): void {\n  if (lockDepth > 0) {\n    lockDepth--;\n  }\n\n  // Only clear streaming mode when all locks are released\n  if (lockDepth === 0) {\n    streamingActive = false;\n    clearSafetyTimer();\n    flushPendingCallbacks();\n  }\n}\n\n/**\n * Force release all locks (emergency/cleanup use)\n */\nexport function forceRelease(): void {\n  lockDepth = 0;\n  streamingActive = false;\n  clearSafetyTimer();\n  flushPendingCallbacks();\n}\n\n/**\n * Clear the safety timer\n */\nfunction clearSafetyTimer(): void {\n  if (safetyTimer) {\n    clearTimeout(safetyTimer);\n    safetyTimer = null;\n  }\n}\n\n/**\n * Flush all pending callbacks\n */\nfunction flushPendingCallbacks(): void {\n  // Process callbacks in order\n  while (pendingCallbacks.length > 0) {\n    const callback = pendingCallbacks.shift();\n    try {\n      callback?.();\n    } catch {\n      // Silently ignore callback errors to prevent cascading failures\n    }\n  }\n}\n\n/**\n * Execute a callback only if not in streaming mode.\n * Returns true if the callback was executed, false if skipped.\n */\nexport function ifNotStreaming(callback: () => void): boolean {\n  if (isStreamingMode()) {\n    return false;\n  }\n  try {\n    callback();\n    return true;\n  } catch {\n    // Silently handle callback errors\n    return false;\n  }\n}\n\n/**\n * Execute a callback when streaming ends (immediately if not streaming)\n * Queues the callback if currently streaming\n */\nexport function whenStreamingEnds(callback: () => void): void {\n  if (!isStreamingMode()) {\n    try {\n      callback();\n    } catch {\n      // Silently handle callback errors\n    }\n    return;\n  }\n\n  // Queue callback for later, with overflow protection\n  if (pendingCallbacks.length < MAX_PENDING_CALLBACKS) {\n    pendingCallbacks.push(callback);\n  }\n}\n\n/**\n * Execute callback with exclusive stream lock\n * Automatically acquires and releases the lock\n */\nexport async function withStreamLock<T>(callback: () => T | Promise<T>): Promise<T> {\n  enterStreamingMode();\n  try {\n    return await callback();\n  } finally {\n    exitStreamingMode();\n  }\n}\n\n/**\n * Legacy: installGlobalWriteLock is now a no-op\n * The old approach of wrapping stdout.write caused nested lock issues.\n * We now use a simpler streaming mode flag instead.\n */\nexport function installGlobalWriteLock(): void {\n  // No-op - we no longer wrap stdout.write\n  // The streaming mode flag handles coordination instead\n}\n\n/**\n * Reset all state (for testing)\n */\nexport function resetGlobalWriteLock(): void {\n  lockDepth = 0;\n  streamingActive = false;\n  clearSafetyTimer();\n  pendingCallbacks.length = 0;\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}