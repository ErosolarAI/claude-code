95bf7218f7e3c4bf6d37183b925eb91c
"use strict";

var _nodeFs = require("node:fs");
var _nodeOs = require("node:os");
var _nodePath = require("node:path");
var _toolPreconditions = require("../src/core/toolPreconditions.js");
describe('validateAIFlowPatterns edit/read requirements', () => {
  it('does not warn when creating a new file without a prior read', () => {
    const warnings = (0, _toolPreconditions.validateAIFlowPatterns)('Edit', {
      file_path: '/tmp/new-file.txt',
      old_string: ''
    }, []);
    expect(warnings.some(warning => warning.code === _toolPreconditions.EDIT_WITHOUT_READ)).toBe(false);
  });
  it('recognizes a prior read when paths differ only by relative vs absolute', () => {
    const tempDir = (0, _nodeFs.mkdtempSync)((0, _nodePath.join)((0, _nodeOs.tmpdir)(), 'preconditions-'));
    const originalCwd = process.cwd();
    try {
      process.chdir(tempDir);
      const relativePath = 'src/example.ts';
      const warnings = (0, _toolPreconditions.validateAIFlowPatterns)('Edit', {
        file_path: (0, _nodePath.join)(tempDir, relativePath),
        old_string: 'const x = 1;'
      }, [{
        toolName: 'read_file',
        args: {
          path: relativePath
        },
        timestamp: Date.now()
      }]);
      expect(warnings.some(warning => warning.code === _toolPreconditions.EDIT_WITHOUT_READ)).toBe(false);
    } finally {
      process.chdir(originalCwd);
      (0, _nodeFs.rmSync)(tempDir, {
        recursive: true,
        force: true
      });
    }
  });
  it('recognizes a prior read when history uses file_path key', () => {
    const warnings = (0, _toolPreconditions.validateAIFlowPatterns)('Edit', {
      file_path: '/tmp/file-path-key.ts',
      old_string: 'const y = 2;'
    }, [{
      toolName: 'read_file',
      args: {
        file_path: '/tmp/file-path-key.ts'
      },
      timestamp: Date.now()
    }]);
    expect(warnings.some(warning => warning.code === _toolPreconditions.EDIT_WITHOUT_READ)).toBe(false);
  });
  it('warns when editing an existing file without any prior read', () => {
    const warnings = (0, _toolPreconditions.validateAIFlowPatterns)('Edit', {
      file_path: '/tmp/existing-file.ts',
      old_string: 'const value = 1;'
    }, []);
    expect(warnings.some(warning => warning.code === _toolPreconditions.EDIT_WITHOUT_READ)).toBe(true);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbm9kZUZzIiwicmVxdWlyZSIsIl9ub2RlT3MiLCJfbm9kZVBhdGgiLCJfdG9vbFByZWNvbmRpdGlvbnMiLCJkZXNjcmliZSIsIml0Iiwid2FybmluZ3MiLCJ2YWxpZGF0ZUFJRmxvd1BhdHRlcm5zIiwiZmlsZV9wYXRoIiwib2xkX3N0cmluZyIsImV4cGVjdCIsInNvbWUiLCJ3YXJuaW5nIiwiY29kZSIsIkVESVRfV0lUSE9VVF9SRUFEIiwidG9CZSIsInRlbXBEaXIiLCJta2R0ZW1wU3luYyIsImpvaW4iLCJ0bXBkaXIiLCJvcmlnaW5hbEN3ZCIsInByb2Nlc3MiLCJjd2QiLCJjaGRpciIsInJlbGF0aXZlUGF0aCIsInRvb2xOYW1lIiwiYXJncyIsInBhdGgiLCJ0aW1lc3RhbXAiLCJEYXRlIiwibm93Iiwicm1TeW5jIiwicmVjdXJzaXZlIiwiZm9yY2UiXSwic291cmNlcyI6WyJ0b29sUHJlY29uZGl0aW9ucy50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG1rZHRlbXBTeW5jLCBybVN5bmMgfSBmcm9tICdub2RlOmZzJztcbmltcG9ydCB7IHRtcGRpciB9IGZyb20gJ25vZGU6b3MnO1xuaW1wb3J0IHsgam9pbiB9IGZyb20gJ25vZGU6cGF0aCc7XG5pbXBvcnQgeyBFRElUX1dJVEhPVVRfUkVBRCwgdmFsaWRhdGVBSUZsb3dQYXR0ZXJucyB9IGZyb20gJy4uL3NyYy9jb3JlL3Rvb2xQcmVjb25kaXRpb25zLmpzJztcblxuZGVzY3JpYmUoJ3ZhbGlkYXRlQUlGbG93UGF0dGVybnMgZWRpdC9yZWFkIHJlcXVpcmVtZW50cycsICgpID0+IHtcbiAgaXQoJ2RvZXMgbm90IHdhcm4gd2hlbiBjcmVhdGluZyBhIG5ldyBmaWxlIHdpdGhvdXQgYSBwcmlvciByZWFkJywgKCkgPT4ge1xuICAgIGNvbnN0IHdhcm5pbmdzID0gdmFsaWRhdGVBSUZsb3dQYXR0ZXJucyhcbiAgICAgICdFZGl0JyxcbiAgICAgIHsgZmlsZV9wYXRoOiAnL3RtcC9uZXctZmlsZS50eHQnLCBvbGRfc3RyaW5nOiAnJyB9LFxuICAgICAgW11cbiAgICApO1xuXG4gICAgZXhwZWN0KHdhcm5pbmdzLnNvbWUoKHdhcm5pbmcpID0+IHdhcm5pbmcuY29kZSA9PT0gRURJVF9XSVRIT1VUX1JFQUQpKS50b0JlKGZhbHNlKTtcbiAgfSk7XG5cbiAgaXQoJ3JlY29nbml6ZXMgYSBwcmlvciByZWFkIHdoZW4gcGF0aHMgZGlmZmVyIG9ubHkgYnkgcmVsYXRpdmUgdnMgYWJzb2x1dGUnLCAoKSA9PiB7XG4gICAgY29uc3QgdGVtcERpciA9IG1rZHRlbXBTeW5jKGpvaW4odG1wZGlyKCksICdwcmVjb25kaXRpb25zLScpKTtcbiAgICBjb25zdCBvcmlnaW5hbEN3ZCA9IHByb2Nlc3MuY3dkKCk7XG5cbiAgICB0cnkge1xuICAgICAgcHJvY2Vzcy5jaGRpcih0ZW1wRGlyKTtcbiAgICAgIGNvbnN0IHJlbGF0aXZlUGF0aCA9ICdzcmMvZXhhbXBsZS50cyc7XG4gICAgICBjb25zdCB3YXJuaW5ncyA9IHZhbGlkYXRlQUlGbG93UGF0dGVybnMoXG4gICAgICAgICdFZGl0JyxcbiAgICAgICAgeyBmaWxlX3BhdGg6IGpvaW4odGVtcERpciwgcmVsYXRpdmVQYXRoKSwgb2xkX3N0cmluZzogJ2NvbnN0IHggPSAxOycgfSxcbiAgICAgICAgW1xuICAgICAgICAgIHsgdG9vbE5hbWU6ICdyZWFkX2ZpbGUnLCBhcmdzOiB7IHBhdGg6IHJlbGF0aXZlUGF0aCB9LCB0aW1lc3RhbXA6IERhdGUubm93KCkgfSxcbiAgICAgICAgXVxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KHdhcm5pbmdzLnNvbWUoKHdhcm5pbmcpID0+IHdhcm5pbmcuY29kZSA9PT0gRURJVF9XSVRIT1VUX1JFQUQpKS50b0JlKGZhbHNlKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgcHJvY2Vzcy5jaGRpcihvcmlnaW5hbEN3ZCk7XG4gICAgICBybVN5bmModGVtcERpciwgeyByZWN1cnNpdmU6IHRydWUsIGZvcmNlOiB0cnVlIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgaXQoJ3JlY29nbml6ZXMgYSBwcmlvciByZWFkIHdoZW4gaGlzdG9yeSB1c2VzIGZpbGVfcGF0aCBrZXknLCAoKSA9PiB7XG4gICAgY29uc3Qgd2FybmluZ3MgPSB2YWxpZGF0ZUFJRmxvd1BhdHRlcm5zKFxuICAgICAgJ0VkaXQnLFxuICAgICAgeyBmaWxlX3BhdGg6ICcvdG1wL2ZpbGUtcGF0aC1rZXkudHMnLCBvbGRfc3RyaW5nOiAnY29uc3QgeSA9IDI7JyB9LFxuICAgICAgW1xuICAgICAgICB7IHRvb2xOYW1lOiAncmVhZF9maWxlJywgYXJnczogeyBmaWxlX3BhdGg6ICcvdG1wL2ZpbGUtcGF0aC1rZXkudHMnIH0sIHRpbWVzdGFtcDogRGF0ZS5ub3coKSB9LFxuICAgICAgXVxuICAgICk7XG5cbiAgICBleHBlY3Qod2FybmluZ3Muc29tZSgod2FybmluZykgPT4gd2FybmluZy5jb2RlID09PSBFRElUX1dJVEhPVVRfUkVBRCkpLnRvQmUoZmFsc2UpO1xuICB9KTtcblxuICBpdCgnd2FybnMgd2hlbiBlZGl0aW5nIGFuIGV4aXN0aW5nIGZpbGUgd2l0aG91dCBhbnkgcHJpb3IgcmVhZCcsICgpID0+IHtcbiAgICBjb25zdCB3YXJuaW5ncyA9IHZhbGlkYXRlQUlGbG93UGF0dGVybnMoXG4gICAgICAnRWRpdCcsXG4gICAgICB7IGZpbGVfcGF0aDogJy90bXAvZXhpc3RpbmctZmlsZS50cycsIG9sZF9zdHJpbmc6ICdjb25zdCB2YWx1ZSA9IDE7JyB9LFxuICAgICAgW11cbiAgICApO1xuXG4gICAgZXhwZWN0KHdhcm5pbmdzLnNvbWUoKHdhcm5pbmcpID0+IHdhcm5pbmcuY29kZSA9PT0gRURJVF9XSVRIT1VUX1JFQUQpKS50b0JlKHRydWUpO1xuICB9KTtcbn0pO1xuIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQUFBLE9BQUEsR0FBQUMsT0FBQTtBQUNBLElBQUFDLE9BQUEsR0FBQUQsT0FBQTtBQUNBLElBQUFFLFNBQUEsR0FBQUYsT0FBQTtB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