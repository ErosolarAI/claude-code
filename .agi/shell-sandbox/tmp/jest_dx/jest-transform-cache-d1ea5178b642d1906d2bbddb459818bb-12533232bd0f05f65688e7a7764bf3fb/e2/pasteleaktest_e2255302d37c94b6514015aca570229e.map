{"version":3,"names":["_globals","require","_nodeStream","_UnifiedUIRenderer","createRenderer","input","PassThrough","isTTY","setRawMode","jest","fn","output","columns","rows","write","chunk","text","toString","prototype","call","renderer","UnifiedUIRenderer","describe","it","testStripToggleSymbols","chars","result","i","length","ch","code","charCodeAt","letter","toLowerCase","includes","expect","toBe","not","toContain","emitPasteBuffer","inEmitPaste","shouldSuppress","collapsedPaste","cleanup","multiLineText","lines","paste","toBeDefined"],"sources":["paste-leak.test.ts"],"sourcesContent":["import { describe, it, expect, jest } from '@jest/globals';\nimport { PassThrough } from 'node:stream';\nimport { UnifiedUIRenderer } from '../src/ui/UnifiedUIRenderer.js';\n\nconst createRenderer = () => {\n  const input = new PassThrough() as unknown as NodeJS.ReadStream;\n  (input as any).isTTY = true;\n  (input as any).setRawMode = jest.fn();\n\n  const output = new PassThrough() as unknown as NodeJS.WriteStream;\n  (output as any).isTTY = true;\n  (output as any).columns = 80;\n  (output as any).rows = 24;\n  (output as any).write = ((chunk: any) => {\n    const text = typeof chunk === 'string' ? chunk : chunk?.toString?.() ?? '';\n    // Preserve write signature used by readline\n    PassThrough.prototype.write.call(output, text);\n    return true;\n  }) as any;\n\n  const renderer = new UnifiedUIRenderer(output, input);\n  return { renderer, input, output };\n};\n\ndescribe('Paste functionality fixes', () => {\n  it('should not leak toggle symbols during paste', () => {\n    // Test the core logic - toggle symbols should be stripped\n    const testStripToggleSymbols = (input: string): string => {\n      const chars = [...input];\n      let result = '';\n      \n      for (let i = 0; i < chars.length; i++) {\n        const ch = chars[i];\n        const code = ch.charCodeAt(0);\n        \n        // Check for toggle characters\n        if (code === 169 || code === 8482) continue; // © ™ (Option+G)\n        if (code === 229 || code === 197) continue;  // å Å (Option+A)\n        if (code === 8706 || code === 8710 || code === 206) continue; // ∂ ∆ Î (Option+D)\n        if (code === 8224 || code === 8225) continue; // † ‡ (Option+T)\n        if (code === 8730) continue; // √ (Option+V)\n        \n        // Check for ESC + toggle letter\n        if (code === 27 && i + 1 < chars.length) {\n          const letter = chars[i + 1].toLowerCase();\n          if (['g', 'a', 'd', 't', 'v'].includes(letter)) {\n            i++;\n            continue;\n          }\n        }\n        \n        result += ch;\n      }\n      \n      return result;\n    };\n    \n    const result = testStripToggleSymbols('Hello©WorldåTest∂Content');\n    expect(result).toBe('HelloWorldTestContent');\n    expect(result).not.toContain('©');\n    expect(result).not.toContain('å');\n    expect(result).not.toContain('∂');\n  });\n\n  it('should suppress render during paste burst', () => {\n    // Test that render is suppressed when emitPasteBuffer is active\n    const { renderer } = createRenderer();\n    try {\n      // Simulate being in a paste burst state\n      (renderer as any).emitPasteBuffer = 'Some paste content';\n      \n      // Check that render suppression works\n      const inEmitPaste = (renderer as any).emitPasteBuffer.length > 0;\n      expect(inEmitPaste).toBe(true);\n      \n      // When collapsedPaste is null, render should be suppressed\n      const shouldSuppress = inEmitPaste && !(renderer as any).collapsedPaste;\n      expect(shouldSuppress).toBe(true);\n      \n    } finally {\n      renderer.cleanup();\n    }\n  });\n\n  it('should auto-expand chat box height for multi-line content', () => {\n    // Test that collapsed paste tracks line count\n    const { renderer } = createRenderer();\n    try {\n      // Create a collapsed paste with multiple lines\n      const multiLineText = 'Line 1\\nLine 2\\nLine 3\\nLine 4';\n      (renderer as any).collapsedPaste = {\n        text: multiLineText,\n        lines: 4,\n        chars: multiLineText.length\n      };\n      \n      // The collapsed paste should track correct line count\n      const paste = (renderer as any).collapsedPaste;\n      expect(paste).toBeDefined();\n      expect(paste.lines).toBe(4);\n      expect(paste.text).toBe(multiLineText);\n      \n    } finally {\n      renderer.cleanup();\n    }\n  });\n\n  it('should maintain toggle state below paste chip', () => {\n    // Test that toggles work even when collapsed paste is active\n    const { renderer } = createRenderer();\n    try {\n      // Create a collapsed paste\n      (renderer as any).collapsedPaste = {\n        text: 'Some pasted content',\n        lines: 1,\n        chars: 18\n      };\n      \n      // Toggle state should still be accessible\n      // The renderer should show both paste chip and toggles\n      expect((renderer as any).collapsedPaste).toBeDefined();\n      \n    } finally {\n      renderer.cleanup();\n    }\n  });\n});"],"mappings":"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","ignoreList":[]}