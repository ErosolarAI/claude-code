{"version":3,"names":["_errorTypes","require","_debugLogger","ABSOLUTE_MAX_CHARS","ABSOLUTE_MAX_LINES","ABSOLUTE_MAX_FILE_ENTRIES","ABSOLUTE_MAX_DOC_CHARS","WARNING_THRESHOLD","estimateTokens","text","Math","ceil","length","validateWorkspaceOptions","options","errors","warnings","treeDepth","undefined","push","maxEntries","docExcerptLimit","valid","stats","totalChars","totalLines","estimatedTokens","fileEntries","docChars","validateWorkspaceContext","content","lines","split","filter","line","trim","startsWith","docMatch","match","join","error","ContextOverflowError","message","ResourceLimitError","round","truncateWorkspaceContext","validation","truncatedLines","charCount","truncatedContent","safeWorkspaceContext","truncate","throwOnError","logDebug","warning","Error"],"sources":["workspace.validator.ts"],"sourcesContent":["/**\n * Workspace Context Validator - Enforces strict safety limits\n *\n * CRITICAL: Prevents context explosion by validating all workspace context\n * before it's sent to the LLM. Multiple safety layers ensure we never\n * exceed token limits.\n */\n\nimport { ContextOverflowError, ResourceLimitError } from './core/errors/errorTypes.js';\nimport { logDebug } from './utils/debugLogger.js';\n\n// ABSOLUTE MAXIMUM LIMITS - Never exceed these under any circumstances\nconst ABSOLUTE_MAX_CHARS = 5000;        // ~1,250 tokens (4 chars per token)\nconst ABSOLUTE_MAX_LINES = 100;         // Maximum lines in any context\nconst ABSOLUTE_MAX_FILE_ENTRIES = 50;   // Maximum files in tree\nconst ABSOLUTE_MAX_DOC_CHARS = 300;     // Maximum chars per priority doc\nconst WARNING_THRESHOLD = 0.7;          // Warn at 70% of max\n\nexport interface ValidationResult {\n  valid: boolean;\n  errors: string[];\n  warnings: string[];\n  stats: ContextStats;\n}\n\nexport interface ContextStats {\n  totalChars: number;\n  totalLines: number;\n  estimatedTokens: number;\n  fileEntries: number;\n  docChars: number;\n}\n\nexport interface WorkspaceContextSafe {\n  content: string;\n  stats: ContextStats;\n}\n\n/**\n * Estimate token count (rough: 1 token â‰ˆ 4 characters)\n */\nfunction estimateTokens(text: string): number {\n  return Math.ceil(text.length / 4);\n}\n\n/**\n * Validate workspace context options BEFORE building context\n */\nexport function validateWorkspaceOptions(options: {\n  treeDepth?: number;\n  maxEntries?: number;\n  docExcerptLimit?: number;\n}): ValidationResult {\n  const errors: string[] = [];\n  const warnings: string[] = [];\n\n  // Validate tree depth\n  if (options.treeDepth !== undefined) {\n    if (options.treeDepth < 0) {\n      errors.push('treeDepth cannot be negative');\n    }\n    if (options.treeDepth > 2) {\n      errors.push(`treeDepth ${options.treeDepth} exceeds maximum of 2`);\n    }\n    if (options.treeDepth > 1) {\n      warnings.push('treeDepth > 1 can significantly increase context size');\n    }\n  }\n\n  // Validate max entries\n  if (options.maxEntries !== undefined) {\n    if (options.maxEntries < 0) {\n      errors.push('maxEntries cannot be negative');\n    }\n    if (options.maxEntries > ABSOLUTE_MAX_FILE_ENTRIES) {\n      errors.push(`maxEntries ${options.maxEntries} exceeds maximum of ${ABSOLUTE_MAX_FILE_ENTRIES}`);\n    }\n    if (options.maxEntries > 40) {\n      warnings.push('maxEntries > 40 may use significant context');\n    }\n  }\n\n  // Validate doc excerpt limit\n  if (options.docExcerptLimit !== undefined) {\n    if (options.docExcerptLimit < 0) {\n      errors.push('docExcerptLimit cannot be negative');\n    }\n    if (options.docExcerptLimit > ABSOLUTE_MAX_DOC_CHARS) {\n      errors.push(`docExcerptLimit ${options.docExcerptLimit} exceeds maximum of ${ABSOLUTE_MAX_DOC_CHARS}`);\n    }\n    if (options.docExcerptLimit > 250) {\n      warnings.push('docExcerptLimit > 250 may use significant context');\n    }\n  }\n\n  return {\n    valid: errors.length === 0,\n    errors,\n    warnings,\n    stats: {\n      totalChars: 0,\n      totalLines: 0,\n      estimatedTokens: 0,\n      fileEntries: options.maxEntries ?? 0,\n      docChars: options.docExcerptLimit ?? 0,\n    },\n  };\n}\n\n/**\n * Validate workspace context AFTER building - CRITICAL SAFETY CHECK\n * This is the final line of defense against context explosion\n */\nexport function validateWorkspaceContext(content: string): ValidationResult {\n  const errors: string[] = [];\n  const warnings: string[] = [];\n\n  // Count basic metrics\n  const totalChars = content.length;\n  const lines = content.split('\\n');\n  const totalLines = lines.length;\n  const estimatedTokens = estimateTokens(content);\n\n  // Count file entries (lines that look like file paths)\n  const fileEntries = lines.filter(line =>\n    line.trim() && !line.startsWith('---') && !line.startsWith('cwd:')\n  ).length;\n\n  // Count chars in priority docs section\n  const docMatch = content.match(/--- .* ---[\\s\\S]*?(?=\\n\\n|$)/g);\n  const docChars = docMatch ? docMatch.join('').length : 0;\n\n  const stats: ContextStats = {\n    totalChars,\n    totalLines,\n    estimatedTokens,\n    fileEntries,\n    docChars,\n  };\n\n  // CRITICAL: Check absolute maximum character limit\n  if (totalChars > ABSOLUTE_MAX_CHARS) {\n    const error = new ContextOverflowError(totalChars, ABSOLUTE_MAX_CHARS, 'chars', true);\n    errors.push(\n      `Context exceeds ABSOLUTE maximum: ${error.message}`\n    );\n  }\n\n  // CRITICAL: Check absolute maximum line limit\n  if (totalLines > ABSOLUTE_MAX_LINES) {\n    const error = new ContextOverflowError(totalLines, ABSOLUTE_MAX_LINES, 'lines', true);\n    errors.push(\n      `Context exceeds ABSOLUTE maximum: ${error.message}`\n    );\n  }\n\n  // CRITICAL: Check absolute maximum file entries\n  if (fileEntries > ABSOLUTE_MAX_FILE_ENTRIES) {\n    const error = new ResourceLimitError('file entries', fileEntries, ABSOLUTE_MAX_FILE_ENTRIES, false);\n    errors.push(\n      `Context exceeds ABSOLUTE maximum: ${error.message}`\n    );\n  }\n\n  // WARNING: Approaching limits\n  if (totalChars > ABSOLUTE_MAX_CHARS * WARNING_THRESHOLD) {\n    warnings.push(\n      `Context size ${totalChars} chars is ${Math.round(totalChars / ABSOLUTE_MAX_CHARS * 100)}% of maximum. ` +\n      `Consider reducing treeDepth, maxEntries, or docExcerptLimit.`\n    );\n  }\n\n  if (estimatedTokens > 1000) {\n    warnings.push(\n      `Estimated ${estimatedTokens} tokens in workspace context. This is high and may impact performance.`\n    );\n  }\n\n  return {\n    valid: errors.length === 0,\n    errors,\n    warnings,\n    stats,\n  };\n}\n\n/**\n * Safe truncation - if content exceeds limits, truncate intelligently\n */\nexport function truncateWorkspaceContext(content: string): WorkspaceContextSafe {\n  const validation = validateWorkspaceContext(content);\n\n  // If valid, return as-is\n  if (validation.valid) {\n    return {\n      content,\n      stats: validation.stats,\n    };\n  }\n\n  // CRITICAL: Content exceeds limits, must truncate\n  const lines = content.split('\\n');\n  const truncatedLines: string[] = [];\n  let charCount = 0;\n\n  // Keep up to absolute maximums\n  for (const line of lines) {\n    if (truncatedLines.length >= ABSOLUTE_MAX_LINES) {\n      break;\n    }\n    if (charCount + line.length > ABSOLUTE_MAX_CHARS) {\n      break;\n    }\n\n    truncatedLines.push(line);\n    charCount += line.length + 1; // +1 for newline\n  }\n\n  // Add truncation notice\n  if (truncatedLines.length < lines.length) {\n    truncatedLines.push('');\n    truncatedLines.push('[Workspace context truncated to prevent context overflow]');\n    truncatedLines.push(`[Showing ${truncatedLines.length} of ${lines.length} lines]`);\n  }\n\n  const truncatedContent = truncatedLines.join('\\n');\n  const stats = validateWorkspaceContext(truncatedContent).stats;\n\n  return {\n    content: truncatedContent,\n    stats,\n  };\n}\n\n/**\n * Validate and enforce limits in a single call - RECOMMENDED USAGE\n */\nexport function safeWorkspaceContext(\n  content: string | null,\n  options?: { truncate?: boolean; throwOnError?: boolean }\n): WorkspaceContextSafe {\n  const { truncate = true, throwOnError = false } = options ?? {};\n\n  if (!content) {\n    return {\n      content: '',\n      stats: {\n        totalChars: 0,\n        totalLines: 0,\n        estimatedTokens: 0,\n        fileEntries: 0,\n        docChars: 0,\n      },\n    };\n  }\n\n  const validation = validateWorkspaceContext(content);\n\n  // Log warnings to debug\n  if (validation.warnings.length > 0) {\n    logDebug('[Workspace Context Validator] Warnings:');\n    for (const warning of validation.warnings) {\n      logDebug(`  - ${warning}`);\n    }\n  }\n\n  // Handle errors\n  if (!validation.valid) {\n    logDebug('[Workspace Context Validator] CRITICAL ERRORS:');\n    for (const error of validation.errors) {\n      logDebug(`  - ${error}`);\n    }\n\n    if (throwOnError) {\n      throw new Error(\n        `Workspace context validation failed:\\n${validation.errors.join('\\n')}`\n      );\n    }\n\n    if (truncate) {\n      logDebug('[Workspace Context Validator] Auto-truncating to safe limits...');\n      return truncateWorkspaceContext(content);\n    }\n  }\n\n  return {\n    content,\n    stats: validation.stats,\n  };\n}\n"],"mappings":"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","ignoreList":[]}