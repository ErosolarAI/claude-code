{"version":3,"names":["_globals","require","_nodeStream","_UnifiedUIRenderer","createRenderer","input","PassThrough","isTTY","setRawMode","jest","fn","output","columns","rows","write","chunk","text","toString","prototype","call","renderer","UnifiedUIRenderer","testStripToggleSymbols","chars","result","i","length","ch","code","charCodeAt","letter","toLowerCase","includes","describe","it","expect","toBe","not","toContain","dataHandler","listeners","toBeDefined","Buffer","from","emitPasteBuffer","commitMethod","commitEmitPasteBuffer","collapsedPaste","lines","cleanup","sanitizePasteContent","sanitized","replace","testCases","expected","forEach","useFakeTimers","renderSpy","spyOn","renderPrompt","toHaveBeenCalled","advanceTimersByTime","useRealTimers"],"sources":["paste-leak.test.ts"],"sourcesContent":["import { describe, it, expect, jest } from '@jest/globals';\nimport { PassThrough } from 'node:stream';\nimport { UnifiedUIRenderer } from '../src/ui/UnifiedUIRenderer.js';\n\nconst createRenderer = () => {\n  const input = new PassThrough() as unknown as NodeJS.ReadStream;\n  (input as any).isTTY = true;\n  (input as any).setRawMode = jest.fn();\n\n  const output = new PassThrough() as unknown as NodeJS.WriteStream;\n  (output as any).isTTY = true;\n  (output as any).columns = 80;\n  (output as any).rows = 24;\n  (output as any).write = ((chunk: any) => {\n    const text = typeof chunk === 'string' ? chunk : chunk?.toString?.() ?? '';\n    // Preserve write signature used by readline\n    PassThrough.prototype.write.call(output, text);\n    return true;\n  }) as any;\n\n  const renderer = new UnifiedUIRenderer(output, input);\n  return { renderer, input, output };\n};\n\n// Helper function to test toggle symbol stripping\nconst testStripToggleSymbols = () => {\n  const chars = [...'Hello©WorldåTest∂Content'];\n  let result = '';\n  \n  for (let i = 0; i < chars.length; i++) {\n    const ch = chars[i];\n    const code = ch.charCodeAt(0);\n    \n    // Check for toggle characters\n    if (code === 169 || code === 8482) continue; // © ™ (Option+G)\n    if (code === 229 || code === 197) continue;  // å Å (Option+A)\n    if (code === 8706 || code === 8710 || code === 206) continue; // ∂ ∆ Î (Option+D)\n    if (code === 8224 || code === 8225) continue; // † ‡ (Option+T)\n    if (code === 8730) continue; // √ (Option+V)\n    \n    // Check for ESC + toggle letter\n    if (code === 27 && i + 1 < chars.length) {\n      const letter = chars[i + 1].toLowerCase();\n      if (['g', 'a', 'd', 't', 'v'].includes(letter)) {\n        i++;\n        continue;\n      }\n    }\n    \n    result += ch;\n  }\n  \n  return result;\n};\n\ndescribe('Paste functionality', () => {\n  it('should not leak toggle symbols during paste', () => {\n    // Test the toggle symbol stripping logic directly\n    const result = testStripToggleSymbols();\n    expect(result).toBe('HelloWorldTestContent');\n    expect(result).not.toContain('©');\n    expect(result).not.toContain('å');\n    expect(result).not.toContain('∂');\n  });\n\n  it('should handle multi-line paste without visual leak', () => {\n    const { renderer, input } = createRenderer();\n    try {\n      // First, write some text to start the paste buffer\n      const dataHandler = (input as any).listeners('data')[0];\n      expect(dataHandler).toBeDefined();\n      \n      // Write a character to start paste detection\n      dataHandler(Buffer.from('L'));\n      \n      // Now write multi-line content\n      dataHandler(Buffer.from('ine 1\\nLine 2\\nLine 3'));\n      \n      // The emit-level paste buffer should capture it\n      const emitPasteBuffer = (renderer as any).emitPasteBuffer;\n      expect(emitPasteBuffer).toBe('Line 1\\nLine 2\\nLine 3');\n      \n      // Manually trigger the commit to create collapsed paste\n      const commitMethod = (renderer as any).commitEmitPasteBuffer;\n      commitMethod.call(renderer);\n      \n      // Should create collapsed paste instead of leaking to screen\n      const collapsedPaste = (renderer as any).collapsedPaste;\n      expect(collapsedPaste).toBeDefined();\n      expect(collapsedPaste.text).toBe('Line 1\\nLine 2\\nLine 3');\n      expect(collapsedPaste.lines).toBe(3);\n      \n    } finally {\n      renderer.cleanup();\n    }\n  });\n\n  it('should strip escape sequences from paste content', () => {\n    // Test sanitizePasteContent logic directly\n    const sanitizePasteContent = (text: string): string => {\n      if (!text) return '';\n      \n      // Remove all ANSI escape sequences\n      // eslint-disable-next-line no-control-regex\n      let sanitized = text.replace(/\\x1b\\[[0-9;]*[A-Za-z~]|\\x1b\\][^\\x07]*\\x07|\\x1b[PX^_][^\\x1b]*\\x1b\\\\|\\x1b./g, '');\n      sanitized = sanitized.replace(/\\[20[01]~/g, '');\n      // eslint-disable-next-line no-control-regex\n      sanitized = sanitized.replace(/^\\x1b+|\\x1b+$/g, '');\n      \n      // Test with various escape sequences\n      const testCases = [\n        { input: '\\x1b[31mRed Text\\x1b[0m', expected: 'Red Text' },\n        { input: 'Normal\\x1b[200~Pasted\\x1b[201~Text', expected: 'NormalPastedText' },\n        { input: '\\x1b[AUp Arrow', expected: 'Up Arrow' },\n      ];\n      \n      testCases.forEach(({ input, expected }) => {\n        const result = sanitizePasteContent(input);\n        expect(result).toBe(expected);\n      });\n      \n      return sanitized;\n    };\n    \n    const testCases = [\n      { input: '\\x1b[31mRed Text\\x1b[0m', expected: 'Red Text' },\n      { input: 'Normal\\x1b[200~Pasted\\x1b[201~Text', expected: 'NormalPastedText' },\n      { input: '\\x1b[AUp Arrow', expected: 'Up Arrow' },\n    ];\n    \n    testCases.forEach(({ input, expected }) => {\n      const result = sanitizePasteContent(input);\n      expect(result).toBe(expected);\n    });\n  });\n\n  it('should suppress render during paste burst to prevent visual leak', () => {\n    const { renderer, input } = createRenderer();\n    try {\n      jest.useFakeTimers();\n      \n      // Start a paste burst\n      const dataHandler = (input as any).listeners('data')[0];\n      dataHandler(Buffer.from('Start'));\n      \n      // Check that we're in a paste state\n      const emitPasteBuffer = (renderer as any).emitPasteBuffer;\n      expect(emitPasteBuffer).toBe('Start');\n      \n      // Set up spy on render method\n      const renderSpy = jest.spyOn(renderer as any, 'renderPromptImmediate');\n      \n      // Render should be suppressed during paste burst\n      renderer.renderPrompt();\n      expect(renderSpy).not.toHaveBeenCalled();\n      \n      // Commit the paste\n      jest.advanceTimersByTime(50);\n      \n      // Now render should work\n      renderer.renderPrompt();\n      expect(renderSpy).toHaveBeenCalled();\n      \n      jest.useRealTimers();\n    } finally {\n      renderer.cleanup();\n    }\n  });\n});"],"mappings":"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","ignoreList":[]}