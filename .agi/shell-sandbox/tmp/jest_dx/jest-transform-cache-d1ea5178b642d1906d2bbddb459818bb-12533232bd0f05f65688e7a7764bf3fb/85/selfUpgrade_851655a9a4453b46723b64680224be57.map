{"version":3,"names":["_nodeChild_process","require","_nodeFs","_nodeOs","_nodePath","_nodeUtil","_nodeEvents","execAsync","promisify","execCallback","DEFAULT_PACKAGE_NAME","DEFAULT_TIMEOUT","SESSION_STATE_FILE","join","homedir","UPGRADE_LOG_FILE","RL_CHECKPOINT_FILE","SelfUpgrade","EventEmitter","config","upgradeInProgress","childProcess","constructor","packageName","global","workingDir","process","cwd","logger","console","log","timeout","autoRestart","sessionState","checkForUpdates","current","getCurrentVersion","latest","getLatestVersion","updateAvailable","compareVersions","releaseNotesUrl","stdout","prefix","globalPrefix","trim","pkgJsonPath","existsSync","pkgJson","JSON","parse","readFileSync","version","result","dependencies","devDependencies","match","RegExp","v1","v2","parts1","replace","split","map","Number","parts2","i","Math","max","length","p1","p2","npmInstallFresh","success","fromVersion","error","restarted","durationMs","startTime","Date","now","emitEvent","targetVersion","saveSessionState","toVersion","timestamp","globalFlag","versionSpec","command","maxBuffer","env","npm_config_loglevel","logUpgrade","launchNewInstance","errorMessage","Error","message","String","resumeSession","cliPath","argv","args","hasPendingSession","push","spawn","execPath","detached","stdio","AGI_UPGRADED","AGI_UPGRADE_FROM","AGI_RESUME_SESSION","unref","setTimeout","exit","state","dir","dirname","mkdirSync","recursive","writeFileSync","stringify","loadSessionState","raw","clearSessionState","rmSync","maxAge","saveRLCheckpoint","context","checkpointTime","loadRLCheckpoint","data","clearRLCheckpoint","calculateRLScoreImpact","preUpgrade","postUpgradeSuccess","impact","iteration","filesModified","min","upgradeWithBuildCheck","buildCommand","buildSuccess","upgradeWithTestCheck","testCommand","testState","passed","failed","stderr","output","parseTestCount","upgradeWithFullVerification","type","parseInt","saveActiveEdits","files","activeEdits","getActiveEdits","entry","logs","slice","event","emit","wasUpgraded","getUpgradeFromVersion","shouldResumeSession","exports","selfUpgradeInstance","getSelfUpgrade","resetSelfUpgrade","upgradeToLatest","options","upgrade","upgradeAndVerify","saveUpgradeState","then","resumeAfterUpgrade"],"sources":["selfUpgrade.ts"],"sourcesContent":["/**\n * Self-Upgrade System for AGI Core\n *\n * Provides the ability to:\n * 1. npm install a fresh version of the CLI\n * 2. Launch a new CLI instance\n * 3. Continue work seamlessly after upgrade\n * 4. Integrate with edits, builds, tests, and RL scoring\n *\n * This module enables true self-improvement through version updates\n * while maintaining session continuity.\n */\n\nimport { exec as execCallback, spawn, type ChildProcess } from 'node:child_process';\nimport { existsSync, mkdirSync, readFileSync, writeFileSync, rmSync } from 'node:fs';\nimport { homedir, tmpdir } from 'node:os';\nimport { join, dirname } from 'node:path';\nimport { promisify } from 'node:util';\nimport { EventEmitter } from 'node:events';\n\nconst execAsync = promisify(execCallback);\n\n// ============================================================================\n// TYPES\n// ============================================================================\n\nexport interface SelfUpgradeConfig {\n  /** Package name to upgrade (default: agi-core-cli) */\n  packageName?: string;\n  /** Whether to run in global mode (default: true) */\n  global?: boolean;\n  /** Working directory for session resumption */\n  workingDir?: string;\n  /** Custom logger function */\n  logger?: (message: string) => void;\n  /** Timeout for npm operations in ms (default: 5 minutes) */\n  timeout?: number;\n  /** Whether to automatically restart after upgrade */\n  autoRestart?: boolean;\n  /** Session state to preserve across upgrade */\n  sessionState?: UpgradeSessionState;\n}\n\nexport interface UpgradeSessionState {\n  /** Current working directory */\n  workingDir: string;\n  /** Pending tasks to continue */\n  pendingTasks?: string[];\n  /** Last user prompt */\n  lastPrompt?: string;\n  /** Context summary for resumption */\n  contextSummary?: string;\n  /** Current version before upgrade */\n  fromVersion: string;\n  /** Target version after upgrade */\n  toVersion?: string;\n  /** Timestamp of upgrade initiation */\n  timestamp: number;\n  /** RL iteration context if applicable */\n  rlContext?: RLUpgradeContext;\n  /** Files being edited before upgrade */\n  activeEdits?: string[];\n  /** Build state before upgrade */\n  buildState?: BuildState;\n  /** Test state before upgrade */\n  testState?: TestState;\n}\n\nexport interface RLUpgradeContext {\n  /** Current iteration number */\n  iteration: number;\n  /** Current agent variant */\n  variant: 'primary' | 'refiner';\n  /** Objective being worked on */\n  objective: string;\n  /** Current score before upgrade */\n  currentScore: number;\n  /** Files modified so far */\n  filesModified: string[];\n}\n\nexport interface BuildState {\n  /** Whether build was successful */\n  success: boolean;\n  /** Build output/errors */\n  output?: string;\n  /** Build command used */\n  command?: string;\n}\n\nexport interface TestState {\n  /** Number of tests passed */\n  passed: number;\n  /** Number of tests failed */\n  failed: number;\n  /** Test output */\n  output?: string;\n  /** Test command used */\n  command?: string;\n}\n\nexport interface UpgradeResult {\n  /** Whether upgrade was successful */\n  success: boolean;\n  /** Previous version */\n  fromVersion: string;\n  /** New version (if successful) */\n  toVersion?: string;\n  /** Error message if failed */\n  error?: string;\n  /** Whether CLI was restarted */\n  restarted: boolean;\n  /** Duration of upgrade in ms */\n  durationMs: number;\n  /** RL score impact (if applicable) */\n  rlScoreImpact?: number;\n}\n\nexport interface VersionInfo {\n  /** Current installed version */\n  current: string;\n  /** Latest available version */\n  latest: string;\n  /** Whether update is available */\n  updateAvailable: boolean;\n  /** Release notes URL */\n  releaseNotesUrl?: string;\n}\n\nexport type UpgradeEventType =\n  | 'upgrade:start'\n  | 'upgrade:download'\n  | 'upgrade:install'\n  | 'upgrade:complete'\n  | 'upgrade:error'\n  | 'upgrade:restart'\n  | 'upgrade:resume'\n  | 'upgrade:rl-checkpoint';\n\nexport interface UpgradeEvent {\n  type: UpgradeEventType;\n  timestamp: number;\n  data?: Record<string, unknown>;\n}\n\n// ============================================================================\n// CONSTANTS\n// ============================================================================\n\nconst DEFAULT_PACKAGE_NAME = 'agi-core-cli';\nconst DEFAULT_TIMEOUT = 5 * 60 * 1000; // 5 minutes\nconst SESSION_STATE_FILE = join(homedir(), '.agi', 'upgrade-session.json');\nconst UPGRADE_LOG_FILE = join(homedir(), '.agi', 'upgrade-log.json');\nconst RL_CHECKPOINT_FILE = join(homedir(), '.agi', 'rl-checkpoint.json');\n\n// ============================================================================\n// SELF-UPGRADE CLASS\n// ============================================================================\n\nexport class SelfUpgrade extends EventEmitter {\n  private config: Required<Omit<SelfUpgradeConfig, 'sessionState'>> & { sessionState?: UpgradeSessionState };\n  private upgradeInProgress = false;\n  private childProcess: ChildProcess | null = null;\n\n  constructor(config: SelfUpgradeConfig = {}) {\n    super();\n    this.config = {\n      packageName: config.packageName ?? DEFAULT_PACKAGE_NAME,\n      global: config.global ?? true,\n      workingDir: config.workingDir ?? process.cwd(),\n      logger: config.logger ?? console.log,\n      timeout: config.timeout ?? DEFAULT_TIMEOUT,\n      autoRestart: config.autoRestart ?? true,\n      sessionState: config.sessionState,\n    };\n  }\n\n  // ==========================================================================\n  // VERSION CHECKING\n  // ==========================================================================\n\n  /**\n   * Check for available updates\n   */\n  async checkForUpdates(): Promise<VersionInfo> {\n    const current = await this.getCurrentVersion();\n    const latest = await this.getLatestVersion();\n\n    return {\n      current,\n      latest,\n      updateAvailable: this.compareVersions(latest, current) > 0,\n      releaseNotesUrl: `https://github.com/anthropics/claude-code/releases/tag/v${latest}`,\n    };\n  }\n\n  /**\n   * Get currently installed version\n   */\n  async getCurrentVersion(): Promise<string> {\n    // Method 1: Try to read from global node_modules package.json\n    try {\n      const { stdout: prefix } = await execAsync('npm config get prefix', { timeout: 5000 });\n      const globalPrefix = prefix.trim();\n      const pkgJsonPath = join(globalPrefix, 'lib', 'node_modules', this.config.packageName, 'package.json');\n      if (existsSync(pkgJsonPath)) {\n        const pkgJson = JSON.parse(readFileSync(pkgJsonPath, 'utf8'));\n        if (pkgJson.version) {\n          return pkgJson.version;\n        }\n      }\n    } catch {\n      // Fall through to next method\n    }\n\n    // Method 2: Try npm list with proper parsing\n    try {\n      const { stdout } = await execAsync(`npm list -g ${this.config.packageName} --depth=0 --json`, {\n        timeout: 10000,\n      });\n      const result = JSON.parse(stdout);\n      // Check multiple possible locations in the JSON structure\n      const version =\n        result.dependencies?.[this.config.packageName]?.version ||\n        result.devDependencies?.[this.config.packageName]?.version ||\n        result.version;\n      if (version && version !== '0.0.0') {\n        return version;\n      }\n    } catch {\n      // Fall through to next method\n    }\n\n    // Method 3: Try parsing npm list text output\n    try {\n      const { stdout } = await execAsync(`npm list -g ${this.config.packageName} --depth=0`, {\n        timeout: 10000,\n      });\n      // Output format: \"└── agi-core-cli@1.1.44\" or similar\n      const match = stdout.match(new RegExp(`${this.config.packageName}@([\\\\d.]+)`));\n      if (match?.[1]) {\n        return match[1];\n      }\n    } catch {\n      // Fall through\n    }\n\n    return '0.0.0';\n  }\n\n  /**\n   * Get latest available version from npm registry\n   */\n  async getLatestVersion(): Promise<string> {\n    try {\n      const { stdout } = await execAsync(`npm view ${this.config.packageName} version`, {\n        timeout: 10000,\n      });\n      return stdout.trim();\n    } catch {\n      return '0.0.0';\n    }\n  }\n\n  /**\n   * Compare two semver versions\n   * Returns: 1 if v1 > v2, -1 if v1 < v2, 0 if equal\n   */\n  private compareVersions(v1: string, v2: string): number {\n    const parts1 = v1.replace(/^v/, '').split('.').map(Number);\n    const parts2 = v2.replace(/^v/, '').split('.').map(Number);\n\n    for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {\n      const p1 = parts1[i] || 0;\n      const p2 = parts2[i] || 0;\n      if (p1 > p2) return 1;\n      if (p1 < p2) return -1;\n    }\n    return 0;\n  }\n\n  // ==========================================================================\n  // UPGRADE EXECUTION\n  // ==========================================================================\n\n  /**\n   * Perform npm install of fresh version\n   */\n  async npmInstallFresh(version?: string): Promise<UpgradeResult> {\n    if (this.upgradeInProgress) {\n      return {\n        success: false,\n        fromVersion: await this.getCurrentVersion(),\n        error: 'Upgrade already in progress',\n        restarted: false,\n        durationMs: 0,\n      };\n    }\n\n    this.upgradeInProgress = true;\n    const startTime = Date.now();\n    const fromVersion = await this.getCurrentVersion();\n\n    this.emitEvent('upgrade:start', { fromVersion, targetVersion: version || 'latest' });\n\n    try {\n      // Save session state before upgrade\n      if (this.config.sessionState) {\n        this.saveSessionState({\n          ...this.config.sessionState,\n          fromVersion,\n          toVersion: version,\n          timestamp: Date.now(),\n        });\n      }\n\n      // Build install command\n      const globalFlag = this.config.global ? '-g ' : '';\n      const versionSpec = version ? `@${version}` : '@latest';\n      const command = `npm install ${globalFlag}${this.config.packageName}${versionSpec}`;\n\n      this.config.logger(`Installing ${this.config.packageName}${versionSpec}...`);\n      this.emitEvent('upgrade:download', { command });\n\n      // Execute npm install\n      await execAsync(command, {\n        timeout: this.config.timeout,\n        maxBuffer: 10 * 1024 * 1024,\n        env: {\n          ...process.env,\n          npm_config_loglevel: 'warn',\n        },\n      });\n\n      this.emitEvent('upgrade:install', { success: true });\n\n      const toVersion = await this.getLatestVersion();\n      const durationMs = Date.now() - startTime;\n\n      // Log upgrade\n      this.logUpgrade({\n        success: true,\n        fromVersion,\n        toVersion,\n        durationMs,\n        timestamp: Date.now(),\n      });\n\n      this.config.logger(`Upgrade complete: ${fromVersion} -> ${toVersion}`);\n      this.emitEvent('upgrade:complete', { fromVersion, toVersion, durationMs });\n\n      // Auto-restart if configured\n      if (this.config.autoRestart) {\n        await this.launchNewInstance();\n        return {\n          success: true,\n          fromVersion,\n          toVersion,\n          restarted: true,\n          durationMs,\n        };\n      }\n\n      return {\n        success: true,\n        fromVersion,\n        toVersion,\n        restarted: false,\n        durationMs,\n      };\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : String(error);\n      this.config.logger(`Upgrade failed: ${errorMessage}`);\n      this.emitEvent('upgrade:error', { error: errorMessage });\n\n      return {\n        success: false,\n        fromVersion,\n        error: errorMessage,\n        restarted: false,\n        durationMs: Date.now() - startTime,\n      };\n    } finally {\n      this.upgradeInProgress = false;\n    }\n  }\n\n  /**\n   * Launch a new CLI instance and optionally continue work\n   */\n  async launchNewInstance(resumeSession = true): Promise<boolean> {\n    try {\n      const cliPath = process.argv[1] || 'agi';\n      const args: string[] = [];\n\n      // Add resume flag if we have session state\n      if (resumeSession && this.hasPendingSession()) {\n        args.push('--resume');\n      }\n\n      // Add working directory\n      if (this.config.workingDir) {\n        args.push('--cwd', this.config.workingDir);\n      }\n\n      this.config.logger('Launching new CLI instance...');\n      this.emitEvent('upgrade:restart', { cliPath, args });\n\n      // Spawn new process\n      this.childProcess = spawn(process.execPath, [cliPath, ...args], {\n        detached: true,\n        stdio: 'inherit',\n        cwd: this.config.workingDir,\n        env: {\n          ...process.env,\n          AGI_UPGRADED: 'true',\n          AGI_UPGRADE_FROM: await this.getCurrentVersion(),\n          AGI_RESUME_SESSION: resumeSession ? 'true' : 'false',\n        },\n      });\n\n      // Unref to allow parent to exit\n      if (this.childProcess.unref) {\n        this.childProcess.unref();\n      }\n\n      // Exit current process after short delay\n      setTimeout(() => {\n        process.exit(0);\n      }, 500);\n\n      return true;\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : String(error);\n      this.config.logger(`Failed to launch new instance: ${errorMessage}`);\n      return false;\n    }\n  }\n\n  // ==========================================================================\n  // SESSION MANAGEMENT\n  // ==========================================================================\n\n  /**\n   * Save session state for resumption after upgrade\n   */\n  saveSessionState(state: UpgradeSessionState): void {\n    try {\n      const dir = dirname(SESSION_STATE_FILE);\n      if (!existsSync(dir)) {\n        mkdirSync(dir, { recursive: true });\n      }\n      writeFileSync(SESSION_STATE_FILE, JSON.stringify(state, null, 2));\n    } catch {\n      // Best-effort\n    }\n  }\n\n  /**\n   * Load session state after upgrade\n   */\n  loadSessionState(): UpgradeSessionState | null {\n    try {\n      if (!existsSync(SESSION_STATE_FILE)) {\n        return null;\n      }\n      const raw = readFileSync(SESSION_STATE_FILE, 'utf8');\n      return JSON.parse(raw) as UpgradeSessionState;\n    } catch {\n      return null;\n    }\n  }\n\n  /**\n   * Clear session state after successful resumption\n   */\n  clearSessionState(): void {\n    try {\n      if (existsSync(SESSION_STATE_FILE)) {\n        rmSync(SESSION_STATE_FILE);\n      }\n    } catch {\n      // Best-effort\n    }\n  }\n\n  /**\n   * Check if there's a pending session to resume\n   */\n  hasPendingSession(): boolean {\n    const state = this.loadSessionState();\n    if (!state || !state.timestamp) return false;\n    // Session valid if less than 24 hours old\n    const maxAge = 24 * 60 * 60 * 1000;\n    return Date.now() - state.timestamp < maxAge;\n  }\n\n  // ==========================================================================\n  // RL INTEGRATION\n  // ==========================================================================\n\n  /**\n   * Save RL checkpoint before upgrade (for RL scoring continuity)\n   */\n  saveRLCheckpoint(context: RLUpgradeContext): void {\n    try {\n      const dir = dirname(RL_CHECKPOINT_FILE);\n      if (!existsSync(dir)) {\n        mkdirSync(dir, { recursive: true });\n      }\n      writeFileSync(RL_CHECKPOINT_FILE, JSON.stringify({\n        ...context,\n        checkpointTime: Date.now(),\n      }, null, 2));\n      this.emitEvent('upgrade:rl-checkpoint', { context });\n    } catch {\n      // Best-effort\n    }\n  }\n\n  /**\n   * Load RL checkpoint after upgrade\n   */\n  loadRLCheckpoint(): RLUpgradeContext | null {\n    try {\n      if (!existsSync(RL_CHECKPOINT_FILE)) {\n        return null;\n      }\n      const raw = readFileSync(RL_CHECKPOINT_FILE, 'utf8');\n      const data = JSON.parse(raw);\n      // Checkpoint valid if less than 1 hour old\n      if (Date.now() - data.checkpointTime > 60 * 60 * 1000) {\n        return null;\n      }\n      return data as RLUpgradeContext;\n    } catch {\n      return null;\n    }\n  }\n\n  /**\n   * Clear RL checkpoint after successful resumption\n   */\n  clearRLCheckpoint(): void {\n    try {\n      if (existsSync(RL_CHECKPOINT_FILE)) {\n        rmSync(RL_CHECKPOINT_FILE);\n      }\n    } catch {\n      // Best-effort\n    }\n  }\n\n  /**\n   * Calculate RL score impact from upgrade\n   * Positive impact if upgrade improves capability\n   */\n  calculateRLScoreImpact(preUpgrade: RLUpgradeContext, postUpgradeSuccess: boolean): number {\n    if (!postUpgradeSuccess) {\n      return -0.1; // Penalty for failed upgrade attempt\n    }\n\n    // Base positive impact for successful upgrade\n    let impact = 0.05;\n\n    // Bonus for upgrading during active RL iteration\n    if (preUpgrade.iteration > 0) {\n      impact += 0.02;\n    }\n\n    // Bonus if files were modified (upgrade during active work)\n    if (preUpgrade.filesModified.length > 0) {\n      impact += 0.01 * Math.min(preUpgrade.filesModified.length, 5);\n    }\n\n    return impact;\n  }\n\n  // ==========================================================================\n  // BUILD/TEST INTEGRATION\n  // ==========================================================================\n\n  /**\n   * Upgrade with build verification\n   */\n  async upgradeWithBuildCheck(version?: string, buildCommand = 'npm run build'): Promise<UpgradeResult & { buildSuccess: boolean }> {\n    const result = await this.npmInstallFresh(version);\n\n    if (!result.success) {\n      return { ...result, buildSuccess: false };\n    }\n\n    // Run build to verify upgrade didn't break anything\n    try {\n      await execAsync(buildCommand, {\n        cwd: this.config.workingDir,\n        timeout: this.config.timeout,\n      });\n      return { ...result, buildSuccess: true };\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : String(error);\n      this.config.logger(`Post-upgrade build failed: ${errorMessage}`);\n      return { ...result, buildSuccess: false };\n    }\n  }\n\n  /**\n   * Upgrade with test verification\n   */\n  async upgradeWithTestCheck(version?: string, testCommand = 'npm test'): Promise<UpgradeResult & { testState: TestState }> {\n    const result = await this.npmInstallFresh(version);\n\n    if (!result.success) {\n      return { ...result, testState: { passed: 0, failed: 0 } };\n    }\n\n    // Run tests to verify upgrade\n    try {\n      const { stdout, stderr } = await execAsync(testCommand, {\n        cwd: this.config.workingDir,\n        timeout: this.config.timeout,\n      });\n      const output = stdout + stderr;\n      const passed = this.parseTestCount(output, 'pass');\n      const failed = this.parseTestCount(output, 'fail');\n\n      return {\n        ...result,\n        testState: { passed, failed, output, command: testCommand },\n      };\n    } catch (error) {\n      const output = error instanceof Error ? (error as any).stdout + (error as any).stderr : '';\n      const passed = this.parseTestCount(output, 'pass');\n      const failed = this.parseTestCount(output, 'fail');\n\n      return {\n        ...result,\n        testState: { passed, failed, output, command: testCommand },\n      };\n    }\n  }\n\n  /**\n   * Full upgrade with build and test verification\n   */\n  async upgradeWithFullVerification(\n    version?: string,\n    buildCommand = 'npm run build',\n    testCommand = 'npm test'\n  ): Promise<UpgradeResult & { buildSuccess: boolean; testState: TestState }> {\n    const result = await this.npmInstallFresh(version);\n\n    if (!result.success) {\n      return { ...result, buildSuccess: false, testState: { passed: 0, failed: 0 } };\n    }\n\n    // Run build\n    let buildSuccess = false;\n    try {\n      await execAsync(buildCommand, {\n        cwd: this.config.workingDir,\n        timeout: this.config.timeout,\n      });\n      buildSuccess = true;\n    } catch {\n      this.config.logger('Post-upgrade build failed');\n    }\n\n    // Run tests\n    let testState: TestState = { passed: 0, failed: 0 };\n    try {\n      const { stdout, stderr } = await execAsync(testCommand, {\n        cwd: this.config.workingDir,\n        timeout: this.config.timeout,\n      });\n      const output = stdout + stderr;\n      testState = {\n        passed: this.parseTestCount(output, 'pass'),\n        failed: this.parseTestCount(output, 'fail'),\n        output,\n        command: testCommand,\n      };\n    } catch (error) {\n      const output = error instanceof Error ? (error as any).stdout + (error as any).stderr : '';\n      testState = {\n        passed: this.parseTestCount(output, 'pass'),\n        failed: this.parseTestCount(output, 'fail'),\n        output,\n        command: testCommand,\n      };\n    }\n\n    return { ...result, buildSuccess, testState };\n  }\n\n  private parseTestCount(output: string, type: 'pass' | 'fail'): number {\n    const match = output.match(new RegExp(`(\\\\d+)\\\\s*${type}`, 'i'));\n    return match ? parseInt(match[1], 10) : 0;\n  }\n\n  // ==========================================================================\n  // EDIT INTEGRATION\n  // ==========================================================================\n\n  /**\n   * Save active edits before upgrade for continuity\n   */\n  saveActiveEdits(files: string[]): void {\n    const state = this.loadSessionState() || {\n      workingDir: this.config.workingDir,\n      fromVersion: '0.0.0',\n      timestamp: Date.now(),\n    };\n\n    this.saveSessionState({\n      ...state,\n      activeEdits: files,\n    });\n  }\n\n  /**\n   * Get active edits to resume after upgrade\n   */\n  getActiveEdits(): string[] {\n    const state = this.loadSessionState();\n    return state?.activeEdits || [];\n  }\n\n  // ==========================================================================\n  // LOGGING\n  // ==========================================================================\n\n  private logUpgrade(entry: {\n    success: boolean;\n    fromVersion: string;\n    toVersion?: string;\n    durationMs: number;\n    timestamp: number;\n    error?: string;\n  }): void {\n    try {\n      const dir = dirname(UPGRADE_LOG_FILE);\n      if (!existsSync(dir)) {\n        mkdirSync(dir, { recursive: true });\n      }\n\n      let logs: typeof entry[] = [];\n      if (existsSync(UPGRADE_LOG_FILE)) {\n        try {\n          logs = JSON.parse(readFileSync(UPGRADE_LOG_FILE, 'utf8'));\n        } catch {\n          logs = [];\n        }\n      }\n\n      logs.push(entry);\n      // Keep last 100 entries\n      if (logs.length > 100) {\n        logs = logs.slice(-100);\n      }\n\n      writeFileSync(UPGRADE_LOG_FILE, JSON.stringify(logs, null, 2));\n    } catch {\n      // Best-effort\n    }\n  }\n\n  private emitEvent(type: UpgradeEventType, data?: Record<string, unknown>): void {\n    const event: UpgradeEvent = {\n      type,\n      timestamp: Date.now(),\n      data,\n    };\n    this.emit(type, event);\n    this.emit('upgrade', event);\n  }\n\n  // ==========================================================================\n  // STATIC UTILITIES\n  // ==========================================================================\n\n  /**\n   * Check if this process was started after an upgrade\n   */\n  static wasUpgraded(): boolean {\n    return process.env['AGI_UPGRADED'] === 'true';\n  }\n\n  /**\n   * Get the version we upgraded from\n   */\n  static getUpgradeFromVersion(): string | null {\n    return process.env['AGI_UPGRADE_FROM'] || null;\n  }\n\n  /**\n   * Check if we should resume a session\n   */\n  static shouldResumeSession(): boolean {\n    return process.env['AGI_RESUME_SESSION'] === 'true';\n  }\n}\n\n// ============================================================================\n// SINGLETON EXPORT\n// ============================================================================\n\nlet selfUpgradeInstance: SelfUpgrade | null = null;\n\nexport function getSelfUpgrade(config?: SelfUpgradeConfig): SelfUpgrade {\n  if (!selfUpgradeInstance || config) {\n    selfUpgradeInstance = new SelfUpgrade(config);\n  }\n  return selfUpgradeInstance;\n}\n\nexport function resetSelfUpgrade(): void {\n  selfUpgradeInstance = null;\n}\n\n// ============================================================================\n// CONVENIENCE FUNCTIONS\n// ============================================================================\n\n/**\n * Quick upgrade to latest version with session continuity\n */\nexport async function upgradeToLatest(options: {\n  autoRestart?: boolean;\n  workingDir?: string;\n  logger?: (message: string) => void;\n} = {}): Promise<UpgradeResult> {\n  const upgrade = getSelfUpgrade({\n    autoRestart: options.autoRestart ?? true,\n    workingDir: options.workingDir,\n    logger: options.logger,\n  });\n  return upgrade.npmInstallFresh();\n}\n\n/**\n * Upgrade with full verification (build + tests)\n */\nexport async function upgradeAndVerify(options: {\n  version?: string;\n  buildCommand?: string;\n  testCommand?: string;\n  workingDir?: string;\n  logger?: (message: string) => void;\n} = {}): Promise<UpgradeResult & { buildSuccess: boolean; testState: TestState }> {\n  const upgrade = getSelfUpgrade({\n    workingDir: options.workingDir,\n    logger: options.logger,\n    autoRestart: false, // Don't auto-restart, let caller decide after verification\n  });\n  return upgrade.upgradeWithFullVerification(\n    options.version,\n    options.buildCommand,\n    options.testCommand\n  );\n}\n\n/**\n * Save current work state for upgrade resumption\n */\nexport function saveUpgradeState(state: Omit<UpgradeSessionState, 'timestamp' | 'fromVersion'>): void {\n  const upgrade = getSelfUpgrade();\n  upgrade.getCurrentVersion().then((fromVersion) => {\n    upgrade.saveSessionState({\n      ...state,\n      fromVersion,\n      timestamp: Date.now(),\n    });\n  });\n}\n\n/**\n * Resume work after upgrade\n */\nexport function resumeAfterUpgrade(): UpgradeSessionState | null {\n  const upgrade = getSelfUpgrade();\n  const state = upgrade.loadSessionState();\n  if (state) {\n    upgrade.clearSessionState();\n  }\n  return state;\n}\n"],"mappings":"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","ignoreList":[]}