{"version":3,"names":["cov_2pzpkizpsh","actualCoverage","resolveWorkspaceRoot","variant","context","f","s","b","variantWorkspaceRoots","primary","canRunVariantsParallel","modeDefinition","parallelVariants","primaryRoot","refinerRoot","refiner","Boolean","executeVariants","options","module","step","mode","executeVariant","emit","variantResults","type","timestamp","Date","now","data","moduleId","id","stepId","variants","results","Promise","all","map","result","previousResult","undefined","workspaceRoot","repoPolicy","entry","primaryResult"],"sources":["variantExecution.ts"],"sourcesContent":["import type {\n  RepoUpgradeMode,\n  RepoUpgradeModeDefinition,\n  RepoUpgradeModule,\n  RepoUpgradeStep,\n  UpgradeStepExecutionInput,\n  UpgradeStepResult,\n  UpgradeVariant,\n} from './repoUpgradeOrchestrator.js';\n\nexport interface VariantExecutionContext {\n  parallelVariants?: boolean;\n  variantWorkspaceRoots?: Partial<Record<UpgradeVariant, string>>;\n  repoPolicy?: string;\n}\n\nexport interface VariantExecutionOptions {\n  module: RepoUpgradeModule;\n  step: RepoUpgradeStep;\n  mode: RepoUpgradeMode;\n  modeDefinition: RepoUpgradeModeDefinition;\n  context: VariantExecutionContext;\n  executeVariant: (input: UpgradeStepExecutionInput) => Promise<UpgradeStepResult>;\n  emit?: (event: { type: string; timestamp: number; data?: Record<string, unknown> }) => void;\n}\n\nexport function resolveWorkspaceRoot(\n  variant: UpgradeVariant,\n  context: VariantExecutionContext\n): string | undefined {\n  return context.variantWorkspaceRoots?.[variant] ?? context.variantWorkspaceRoots?.primary;\n}\n\nexport function canRunVariantsParallel(\n  modeDefinition: RepoUpgradeModeDefinition,\n  context: VariantExecutionContext\n): boolean {\n  if (!modeDefinition.parallelVariants || !context.parallelVariants) {\n    return false;\n  }\n  const primaryRoot = context.variantWorkspaceRoots?.primary;\n  const refinerRoot = context.variantWorkspaceRoots?.refiner;\n  return Boolean(primaryRoot && refinerRoot && primaryRoot !== refinerRoot);\n}\n\nexport async function executeVariants(\n  options: VariantExecutionOptions\n): Promise<Partial<Record<UpgradeVariant, UpgradeStepResult>>> {\n  const { module, step, mode, modeDefinition, context, executeVariant, emit } = options;\n  const variantResults: Partial<Record<UpgradeVariant, UpgradeStepResult>> = {};\n\n  if (canRunVariantsParallel(modeDefinition, context)) {\n    emit?.({\n      type: 'upgrade.step.variants.parallel',\n      timestamp: Date.now(),\n      data: { moduleId: module.id, stepId: step.id, variants: modeDefinition.variants },\n    });\n\n    const results = await Promise.all(\n      modeDefinition.variants.map(async (variant) => {\n        const result = await executeVariant({\n          module,\n          step,\n          mode,\n          variant,\n          previousResult: undefined,\n          workspaceRoot: resolveWorkspaceRoot(variant, context),\n          repoPolicy: context.repoPolicy,\n        });\n        return { variant, result };\n      })\n    );\n    for (const entry of results) {\n      variantResults[entry.variant] = entry.result;\n    }\n  } else {\n    let primaryResult: UpgradeStepResult | undefined;\n    for (const variant of modeDefinition.variants) {\n      const previousResult = variant === 'refiner' ? primaryResult : undefined;\n      const result = await executeVariant({\n        module,\n        step,\n        mode,\n        variant,\n        previousResult,\n        workspaceRoot: resolveWorkspaceRoot(variant, context),\n        repoPolicy: context.repoPolicy,\n      });\n      variantResults[variant] = result;\n      if (variant === 'primary') {\n        primaryResult = result;\n      }\n    }\n  }\n\n  return variantResults;\n}\n"],"mappings":"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","ignoreList":[]}