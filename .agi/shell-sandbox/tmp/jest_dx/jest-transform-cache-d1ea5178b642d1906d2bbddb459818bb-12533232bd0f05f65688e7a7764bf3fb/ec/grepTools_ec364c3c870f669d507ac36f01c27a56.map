{"version":3,"names":["_nodeFs","require","_nodePath","IGNORED_DIRS","Set","MAX_FILE_SIZE","createGrepTools","workingDir","name","description","parameters","type","properties","pattern","path","output_mode","enum","ignore_case","i","line_numbers","n","required","additionalProperties","handler","args","trim","outputMode","ignoreCase","includeLineNumbers","searchRootInput","searchRoot","isAbsolute","join","regex","RegExp","undefined","matches","filesWithMatches","walk","dir","entries","readdirSync","withFileTypes","entry","has","fullPath","isDirectory","stats","statSync","isFile","size","content","readFileSync","lines","split","index","length","line","test","relativePath","relative","add","lineNumber","push","MAX_DISPLAY_LINES","files","Array","from","sort","slice"],"sources":["grepTools.ts"],"sourcesContent":["import { readdirSync, readFileSync, statSync } from 'node:fs';\nimport { join, relative, isAbsolute } from 'node:path';\nimport type { ToolDefinition } from '../core/toolRuntime.js';\n\nconst IGNORED_DIRS = new Set([\n  '.git',\n  'node_modules',\n  'dist',\n  '.next',\n  'build',\n  'coverage',\n  '.turbo',\n  '.cache',\n]);\n\nconst MAX_FILE_SIZE = 2 * 1024 * 1024; // 2MB guard rail to avoid OOM\n\nexport function createGrepTools(workingDir: string): ToolDefinition[] {\n  return [\n    {\n      name: 'Grep',\n      description: 'Search file contents for a pattern with optional flags (case-insensitive, line numbers).',\n      parameters: {\n        type: 'object',\n        properties: {\n          pattern: { type: 'string', description: 'Regex or plain text pattern to search for.' },\n          path: { type: 'string', description: 'Directory or file to search (defaults to working directory).' },\n          output_mode: {\n            type: 'string',\n            enum: ['content', 'files_with_matches', 'count'],\n            description: 'How to return results: full content, file list, or match count.',\n          },\n          ignore_case: { type: 'boolean', description: 'Case-insensitive search (alias: i).' },\n          i: { type: 'boolean', description: 'Alias for ignore_case.' },\n          line_numbers: { type: 'boolean', description: 'Include line numbers (alias: n).' },\n          n: { type: 'boolean', description: 'Alias for line_numbers.' },\n        },\n        required: ['pattern'],\n        additionalProperties: true,\n      },\n      handler: async (args) => {\n        const pattern = typeof args['pattern'] === 'string' ? args['pattern'] : '';\n        if (!pattern.trim()) {\n          return 'Error: pattern is required';\n        }\n\n        const outputMode = (args['output_mode'] as string) || 'content';\n        const ignoreCase = args['ignore_case'] === true || args['i'] === true;\n        const includeLineNumbers = args['line_numbers'] === true || args['n'] === true;\n        const searchRootInput = typeof args['path'] === 'string' && args['path'].trim()\n          ? args['path'].trim()\n          : workingDir;\n        const searchRoot = isAbsolute(searchRootInput)\n          ? searchRootInput\n          : join(workingDir, searchRootInput);\n\n        const regex = new RegExp(pattern, ignoreCase ? 'i' : undefined);\n        const matches: string[] = [];\n        const filesWithMatches = new Set<string>();\n\n        function walk(dir: string): void {\n          let entries;\n          try {\n            entries = readdirSync(dir, { withFileTypes: true });\n          } catch {\n            return;\n          }\n\n          for (const entry of entries) {\n            if (IGNORED_DIRS.has(entry.name)) continue;\n            const fullPath = join(dir, entry.name);\n            if (entry.isDirectory()) {\n              walk(fullPath);\n              continue;\n            }\n\n            let stats;\n            try {\n              stats = statSync(fullPath);\n            } catch {\n              continue;\n            }\n\n            if (!stats.isFile() || stats.size > MAX_FILE_SIZE) {\n              continue;\n            }\n\n            let content: string;\n            try {\n              content = readFileSync(fullPath, 'utf-8');\n            } catch {\n              continue;\n            }\n\n            const lines = content.split(/\\r?\\n/);\n            for (let index = 0; index < lines.length; index++) {\n              const line = lines[index] ?? '';\n              if (!regex.test(line)) {\n                continue;\n              }\n\n              const relativePath = relative(workingDir, fullPath);\n              filesWithMatches.add(relativePath);\n\n              if (outputMode === 'files_with_matches') {\n                // Only need the filename once\n                break;\n              }\n\n              const lineNumber = includeLineNumbers ? `${index + 1}:` : '';\n              matches.push(`${relativePath}:${lineNumber}${line}`);\n            }\n          }\n        }\n\n        walk(searchRoot);\n\n        const MAX_DISPLAY_LINES = 5;\n\n        if (outputMode === 'files_with_matches') {\n          if (!filesWithMatches.size) {\n            return 'No matches found';\n          }\n          const files = Array.from(filesWithMatches).sort();\n          if (files.length <= MAX_DISPLAY_LINES) {\n            return files.join('\\n');\n          }\n          return `${files.slice(0, MAX_DISPLAY_LINES).join('\\n')}\\n... +${files.length - MAX_DISPLAY_LINES} more files`;\n        }\n\n        if (outputMode === 'count') {\n          return `Matches: ${matches.length}`;\n        }\n\n        if (!matches.length) return 'No matches found';\n        if (matches.length <= MAX_DISPLAY_LINES) {\n          return matches.join('\\n');\n        }\n        return `${matches.slice(0, MAX_DISPLAY_LINES).join('\\n')}\\n... +${matches.length - MAX_DISPLAY_LINES} more matches`;\n      },\n    },\n  ];\n}\n"],"mappings":"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","ignoreList":[]}