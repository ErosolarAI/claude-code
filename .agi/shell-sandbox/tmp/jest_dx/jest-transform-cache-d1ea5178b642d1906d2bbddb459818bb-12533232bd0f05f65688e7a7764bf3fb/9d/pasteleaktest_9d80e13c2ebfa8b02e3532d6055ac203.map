{"version":3,"names":["_globals","require","_nodeStream","_UnifiedUIRenderer","createRenderer","input","PassThrough","isTTY","setRawMode","jest","fn","output","columns","rows","write","chunk","text","toString","prototype","call","renderer","UnifiedUIRenderer","describe","it","testPaste","dataHandler","listeners","expect","toBeDefined","writeSpy","spyOn","Buffer","from","getBuffer","not","toContain","cleanup","multiLinePaste","emitPasteBuffer","toBe","commitMethod","commitEmitPasteBuffer","collapsedPaste","lines","sanitizeMethod","sanitizePasteContent","testCases","expected","forEach","result","renderSpy","runAllTimers","inEmitPaste","length","renderPrompt","toHaveBeenCalled"],"sources":["paste-leak.test.ts"],"sourcesContent":["import { describe, it, expect, jest } from '@jest/globals';\nimport { PassThrough } from 'node:stream';\nimport { UnifiedUIRenderer } from '../src/ui/UnifiedUIRenderer.js';\n\nconst createRenderer = () => {\n  const input = new PassThrough() as unknown as NodeJS.ReadStream;\n  (input as any).isTTY = true;\n  (input as any).setRawMode = jest.fn();\n\n  const output = new PassThrough() as unknown as NodeJS.WriteStream;\n  (output as any).isTTY = true;\n  (output as any).columns = 80;\n  (output as any).rows = 24;\n  (output as any).write = ((chunk: any) => {\n    const text = typeof chunk === 'string' ? chunk : chunk?.toString?.() ?? '';\n    // Preserve write signature used by readline\n    PassThrough.prototype.write.call(output, text);\n    return true;\n  }) as any;\n\n  const renderer = new UnifiedUIRenderer(output, input);\n  return { renderer, input, output };\n};\n\ndescribe('Paste functionality', () => {\n  it('should not leak toggle symbols during paste', () => {\n    const { renderer, input } = createRenderer();\n    try {\n      // Simulate a paste with toggle symbols mixed in\n      const testPaste = 'Hello©WorldåTest∂Content';\n      \n      // Trigger raw data handler directly\n      const dataHandler = (input as any).listeners('data')[0];\n      expect(dataHandler).toBeDefined();\n      \n      // Write data that includes toggle symbols\n      const writeSpy = jest.spyOn(input, 'write');\n      dataHandler(Buffer.from(testPaste));\n      \n      // Check that toggle symbols were stripped\n      expect(renderer.getBuffer()).not.toContain('©');\n      expect(renderer.getBuffer()).not.toContain('å');\n      expect(renderer.getBuffer()).not.toContain('∂');\n      \n    } finally {\n      renderer.cleanup();\n    }\n  });\n\n  it('should handle multi-line paste without visual leak', () => {\n    const { renderer, input } = createRenderer();\n    try {\n      // Simulate a multi-line paste\n      const multiLinePaste = 'Line 1\\nLine 2\\nLine 3';\n      \n      // Trigger raw data handler\n      const dataHandler = (input as any).listeners('data')[0];\n      expect(dataHandler).toBeDefined();\n      \n      // Write multi-line content\n      dataHandler(Buffer.from(multiLinePaste));\n      \n      // The emit-level paste buffer should capture it\n      const emitPasteBuffer = (renderer as any).emitPasteBuffer;\n      expect(emitPasteBuffer).toBe(multiLinePaste);\n      \n      // Manually trigger the commit to create collapsed paste\n      const commitMethod = (renderer as any).commitEmitPasteBuffer;\n      commitMethod.call(renderer);\n      \n      // Should create collapsed paste instead of leaking to screen\n      const collapsedPaste = (renderer as any).collapsedPaste;\n      expect(collapsedPaste).toBeDefined();\n      expect(collapsedPaste.text).toBe(multiLinePaste);\n      expect(collapsedPaste.lines).toBe(3);\n      \n    } finally {\n      renderer.cleanup();\n    }\n  });\n\n  it('should strip escape sequences from paste content', () => {\n    const { renderer } = createRenderer();\n    try {\n      const sanitizeMethod = (renderer as any).sanitizePasteContent;\n      \n      // Test with various escape sequences\n      const testCases = [\n        { input: '\\x1b[31mRed Text\\x1b[0m', expected: 'Red Text' },\n        { input: 'Normal\\x1b[200~Pasted\\x1b[201~Text', expected: 'NormalPastedText' },\n        { input: '\\x1b[AUp Arrow', expected: 'Up Arrow' },\n      ];\n      \n      testCases.forEach(({ input, expected }) => {\n        const result = sanitizeMethod(input);\n        expect(result).toBe(expected);\n      });\n      \n    } finally {\n      renderer.cleanup();\n    }\n  });\n\n  it('should suppress render during paste burst to prevent visual leak', () => {\n    const { renderer, input } = createRenderer();\n    try {\n      // Set up spy on render method\n      const renderSpy = jest.spyOn(renderer as any, 'renderPromptImmediate');\n      \n      // Start a paste burst\n      const dataHandler = (input as any).listeners('data')[0];\n      dataHandler(Buffer.from('Start of paste'));\n      \n      // Wait a bit for the timer to be set\n      jest.runAllTimers();\n      \n      // The actual render should be suppressed due to paste burst\n      // Check that we're in a paste state\n      const inEmitPaste = (renderer as any).emitPasteBuffer.length > 0;\n      expect(inEmitPaste).toBe(true);\n      \n      // Render should be suppressed\n      renderer.renderPrompt();\n      expect(renderSpy).not.toHaveBeenCalled();\n      \n    } finally {\n      renderer.cleanup();\n    }\n  });\n});"],"mappings":"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","ignoreList":[]}