03977e5b88d47b9cffb62459325a6e0a
"use strict";

var _nodeChild_process = require("node:child_process");
function runResolveProfile(envOverrides) {
  const env = {
    ...process.env
  };
  for (const [key, value] of Object.entries(envOverrides)) {
    if (value === undefined) {
      delete env[key];
    } else {
      env[key] = value;
    }
  }
  return (0, _nodeChild_process.spawnSync)('node', ['--loader', 'ts-node/esm', '-e', `
        import { resolveProfileConfig } from './src/config.js';
        const cfg = resolveProfileConfig('agi-code', null);
        console.log(JSON.stringify({ provider: cfg.provider, model: cfg.model, providerLocked: cfg.providerLocked }));
      `], {
    cwd: process.cwd(),
    env,
    encoding: 'utf8'
  });
}
describe('resolveProfileConfig model/provider alignment (ts-node)', () => {
  it('infers provider from model when provider env is absent', () => {
    const result = runResolveProfile({
      AGI_CODE_MODEL: 'gpt-4o',
      AGI_CODE_PROVIDER: undefined
    });
    expect(result.status).toBe(0);
    const payload = JSON.parse(result.stdout.trim());
    expect(payload.model).toBe('gpt-4o');
    expect(payload.provider).toBe('openai');
    expect(payload.providerLocked).toBe(false);
  });
  it('overrides mismatched provider env when model belongs to another provider', () => {
    const result = runResolveProfile({
      AGI_CODE_MODEL: 'claude-3-5-sonnet-20241022',
      AGI_CODE_PROVIDER: 'deepseek'
    });
    expect(result.status).toBe(0);
    const payload = JSON.parse(result.stdout.trim());
    expect(payload.provider).toBe('anthropic');
    expect(payload.model).toBe('claude-3-5-sonnet-20241022');
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbm9kZUNoaWxkX3Byb2Nlc3MiLCJyZXF1aXJlIiwicnVuUmVzb2x2ZVByb2ZpbGUiLCJlbnZPdmVycmlkZXMiLCJlbnYiLCJwcm9jZXNzIiwia2V5IiwidmFsdWUiLCJPYmplY3QiLCJlbnRyaWVzIiwidW5kZWZpbmVkIiwic3Bhd25TeW5jIiwiY3dkIiwiZW5jb2RpbmciLCJkZXNjcmliZSIsIml0IiwicmVzdWx0IiwiQUdJX0NPREVfTU9ERUwiLCJBR0lfQ09ERV9QUk9WSURFUiIsImV4cGVjdCIsInN0YXR1cyIsInRvQmUiLCJwYXlsb2FkIiwiSlNPTiIsInBhcnNlIiwic3Rkb3V0IiwidHJpbSIsIm1vZGVsIiwicHJvdmlkZXIiLCJwcm92aWRlckxvY2tlZCJdLCJzb3VyY2VzIjpbImNvbmZpZy5tb2RlbFNlbGVjdGlvbi50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHNwYXduU3luYywgdHlwZSBTcGF3blN5bmNSZXR1cm5zIH0gZnJvbSAnbm9kZTpjaGlsZF9wcm9jZXNzJztcblxuZnVuY3Rpb24gcnVuUmVzb2x2ZVByb2ZpbGUoZW52T3ZlcnJpZGVzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCB1bmRlZmluZWQ+KTogU3Bhd25TeW5jUmV0dXJuczxzdHJpbmc+IHtcbiAgY29uc3QgZW52ID0geyAuLi5wcm9jZXNzLmVudiB9O1xuICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhlbnZPdmVycmlkZXMpKSB7XG4gICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGRlbGV0ZSBlbnZba2V5XTtcbiAgICB9IGVsc2Uge1xuICAgICAgZW52W2tleV0gPSB2YWx1ZTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gc3Bhd25TeW5jKFxuICAgICdub2RlJyxcbiAgICBbXG4gICAgICAnLS1sb2FkZXInLFxuICAgICAgJ3RzLW5vZGUvZXNtJyxcbiAgICAgICctZScsXG4gICAgICBgXG4gICAgICAgIGltcG9ydCB7IHJlc29sdmVQcm9maWxlQ29uZmlnIH0gZnJvbSAnLi9zcmMvY29uZmlnLmpzJztcbiAgICAgICAgY29uc3QgY2ZnID0gcmVzb2x2ZVByb2ZpbGVDb25maWcoJ2FnaS1jb2RlJywgbnVsbCk7XG4gICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHsgcHJvdmlkZXI6IGNmZy5wcm92aWRlciwgbW9kZWw6IGNmZy5tb2RlbCwgcHJvdmlkZXJMb2NrZWQ6IGNmZy5wcm92aWRlckxvY2tlZCB9KSk7XG4gICAgICBgLFxuICAgIF0sXG4gICAge1xuICAgICAgY3dkOiBwcm9jZXNzLmN3ZCgpLFxuICAgICAgZW52LFxuICAgICAgZW5jb2Rpbmc6ICd1dGY4JyxcbiAgICB9XG4gICk7XG59XG5cbmRlc2NyaWJlKCdyZXNvbHZlUHJvZmlsZUNvbmZpZyBtb2RlbC9wcm92aWRlciBhbGlnbm1lbnQgKHRzLW5vZGUpJywgKCkgPT4ge1xuICBpdCgnaW5mZXJzIHByb3ZpZGVyIGZyb20gbW9kZWwgd2hlbiBwcm92aWRlciBlbnYgaXMgYWJzZW50JywgKCkgPT4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IHJ1blJlc29sdmVQcm9maWxlKHtcbiAgICAgIEFHSV9DT0RFX01PREVMOiAnZ3B0LTRvJyxcbiAgICAgIEFHSV9DT0RFX1BST1ZJREVSOiB1bmRlZmluZWQsXG4gICAgfSk7XG5cbiAgICBleHBlY3QocmVzdWx0LnN0YXR1cykudG9CZSgwKTtcbiAgICBjb25zdCBwYXlsb2FkID0gSlNPTi5wYXJzZShyZXN1bHQuc3Rkb3V0LnRyaW0oKSkgYXMgeyBwcm92aWRlcjogc3RyaW5nOyBtb2RlbDogc3RyaW5nOyBwcm92aWRlckxvY2tlZDogYm9vbGVhbiB9O1xuICAgIGV4cGVjdChwYXlsb2FkLm1vZGVsKS50b0JlKCdncHQtNG8nKTtcbiAgICBleHBlY3QocGF5bG9hZC5wcm92aWRlcikudG9CZSgnb3BlbmFpJyk7XG4gICAgZXhwZWN0KHBheWxvYWQucHJvdmlkZXJMb2NrZWQpLnRvQmUoZmFsc2UpO1xuICB9KTtcblxuICBpdCgnb3ZlcnJpZGVzIG1pc21hdGNoZWQgcHJvdmlkZXIgZW52IHdoZW4gbW9kZWwgYmVsb25ncyB0byBhbm90aGVyIHByb3ZpZGVyJywgKCkgPT4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IHJ1blJlc29sdmVQcm9maWxlKHtcbiAgICAgIEFHSV9DT0RFX01PREVMOiAnY2xhdWRlLTMtNS1zb25uZXQtMjAyNDEwMjInLFxuICAgICAgQUdJX0NPREVfUFJPVklERVI6ICdkZWVwc2VlaycsXG4gICAgfSk7XG5cbiAgICBleHBlY3QocmVzdWx0LnN0YXR1cykudG9CZSgwKTtcbiAgICBjb25zdCBwYXlsb2FkID0gSlNPTi5wYXJzZShyZXN1bHQuc3Rkb3V0LnRyaW0oKSkgYXMgeyBwcm92aWRlcjogc3RyaW5nOyBtb2RlbDogc3RyaW5nOyBwcm92aWRlckxvY2tlZDogYm9vbGVhbiB9O1xuICAgIGV4cGVjdChwYXlsb2FkLnByb3ZpZGVyKS50b0JlKCdhbnRocm9waWMnKTtcbiAgICBleHBlY3QocGF5bG9hZC5tb2RlbCkudG9CZSgnY2xhdWRlLTMtNS1zb25uZXQtMjAyNDEwMjInKTtcbiAgfSk7XG59KTtcbiJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFBQSxrQkFBQSxHQUFBQyxPQUFBO0FBRUEsU0FBU0MsaUJBQWlCQSxDQUFDQyxZQUFnRCxFQUE0QjtFQUNyRyxNQUFNQyxHQUFHLEdBQUc7SUFBRSxHQUFHQyxPQUFPLENBQUNEO0VBQUksQ0FBQztFQUM5QixLQUFLLE1BQU0sQ0FBQ0UsR0FBRyxFQUFFQyxLQUFLLENBQUMsSUFBSUMsTUFBTSxDQUFDQyxPQUFPLENBQUNOLFlBQVksQ0FBQyxFQUFFO0lBQ3ZELElBQUlJLEtBQUssS0FBS0csU0FBUyxFQUFFO01BQ3ZCLE9BQU9OLEdBQUcsQ0FBQ0UsR0FBRyxDQUFDO0lBQ2pCLENBQUMsTUFBTTtNQUNMRixHQUFHLENBQUNFLEdBQUcsQ0FBQyxHQUFHQyxLQUFLO0lBQ2xCO0VBQ0Y7RUFFQSxPQUFPLElBQUFJLDRCQUFTLEVBQ2QsTUFBTSxFQUNOLENBQ0UsVUFBVSxFQUNWLGFBQWEsRUFDYixJQUFJLEVBQ0o7QUFDTjtBQUNBO0FBQ0E7QUFDQSxPQUFPLENBQ0YsRUFDRDtJQUNFQyxHQUFHLEVBQUVQLE9BQU8sQ0FBQ08sR0FBRyxDQUFDLENBQUM7SUFDbEJSLEdBQUc7SUFDSFMsUUFBUSxFQUFFO0VBQ1osQ0FDRixDQUFDO0FBQ0g7QUFFQUMsUUFBUSxDQUFDLHlEQUF5RCxFQUFFLE1BQU07RUFDeEVDLEVBQUUsQ0FBQyx3REFBd0QsRUFBRSxNQUFNO0lBQ2pFLE1BQU1DLE1BQU0sR0FBR2QsaUJBQWlCLENBQUM7TUFDL0JlLGNBQWMsRUFBRSxRQUFRO01BQ3hCQyxpQkFBaUIsRUFBRVI7SUFDckIsQ0FBQyxDQUFDO0lBRUZTLE1BQU0sQ0FBQ0gsTUFBTSxDQUFDSSxNQUFNLENBQUMsQ0FBQ0MsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUM3QixNQUFNQyxPQUFPLEdBQUdDLElBQUksQ0FBQ0MsS0FBSyxDQUFDUixNQUFNLENBQUNTLE1BQU0sQ0FBQ0MsSUFBSSxDQUFDLENBQUMsQ0FBaUU7SUFDaEhQLE1BQU0sQ0FBQ0csT0FBTyxDQUFDSyxLQUFLLENBQUMsQ0FBQ04sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUNwQ0YsTUFBTSxDQUFDRyxPQUFPLENBQUNNLFFBQVEsQ0FBQyxDQUFDUCxJQUFJLENBQUMsUUFBUSxDQUFDO0lBQ3ZDRixNQUFNLENBQUNHLE9BQU8sQ0FBQ08sY0FBYyxDQUFDLENBQUNSLElBQUksQ0FBQyxLQUFLLENBQUM7RUFDNUMsQ0FBQyxDQUFDO0VBRUZOLEVBQUUsQ0FBQywwRUFBMEUsRUFBRSxNQUFNO0lBQ25GLE1BQU1DLE1BQU0sR0FBR2QsaUJBQWlCLENBQUM7TUFDL0JlLGNBQWMsRUFBRSw0QkFBNEI7TUFDNUNDLGlCQUFpQixFQUFFO0lBQ3JCLENBQUMsQ0FBQztJQUVGQyxNQUFNLENBQUNILE1BQU0sQ0FBQ0ksTUFBTSxDQUFDLENBQUNDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDN0IsTUFBTUMsT0FBTyxHQUFHQyxJQUFJLENBQUNDLEtBQUssQ0FBQ1IsTUFBTSxDQUFDUyxNQUFNLENBQUNDLElBQUksQ0FBQyxDQUFDLENBQWlFO0lBQ2hIUCxNQUFNLENBQUNHLE9BQU8sQ0FBQ00sUUFBUSxDQUFDLENBQUNQLElBQUksQ0FBQyxXQUFXLENBQUM7SUFDMUNGLE1BQU0sQ0FBQ0csT0FBTyxDQUFDSyxLQUFLLENBQUMsQ0FBQ04sSUFBSSxDQUFDLDRCQUE0QixDQUFDO0VBQzFELENBQUMsQ0FBQztBQUNKLENBQUMsQ0FBQyIsImlnbm9yZUxpc3QiOltdfQ==