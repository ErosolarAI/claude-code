818eafb2866c2fe27a3f363c28ec678b
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getContentWidth = getContentWidth;
exports.getTerminalColumns = getTerminalColumns;
exports.isUltraNarrowMode = isUltraNarrowMode;
exports.measure = measure;
exports.normalizePanelWidth = normalizePanelWidth;
exports.padLine = padLine;
exports.renderPanel = renderPanel;
exports.stripAnsi = stripAnsi;
exports.truncate = truncate;
exports.wrapParagraph = wrapParagraph;
exports.wrapPreformatted = wrapPreformatted;
var _theme = require("./theme.js");
var _outputMode = require("./outputMode.js");
/**
 * Layout constants for terminal rendering
 * These ensure consistent behavior across all terminal sizes
 */
const MIN_WIDTH = 20; // Minimum usable width (reduced from 42 for narrow terminals)
const MAX_WIDTH = 120; // Maximum content width for readability
const ULTRA_NARROW_WIDTH = 30; // Below this, use compact mode
const DEFAULT_WIDTH = 80; // Standard terminal width fallback

// eslint-disable-next-line no-control-regex
const ANSI_REGEX = /\u001B\[[0-9;]*m/g;

/**
 * Get terminal columns with robust fallback handling
 * Handles edge cases: undefined stdout, non-TTY, invalid values
 */
function getTerminalColumns(defaultWidth = DEFAULT_WIDTH) {
  try {
    // Check if stdout exists and has columns
    if (process.stdout && typeof process.stdout.columns === 'number' && Number.isFinite(process.stdout.columns) && process.stdout.columns > 0) {
      return process.stdout.columns;
    }

    // Fallback: try COLUMNS env variable (used in some terminals)
    const envColumns = process.env['COLUMNS'];
    if (envColumns) {
      const parsed = parseInt(envColumns, 10);
      if (Number.isFinite(parsed) && parsed > 0) {
        return parsed;
      }
    }
  } catch {
    // Silently handle any errors (e.g., in restricted environments)
  }
  return defaultWidth;
}

/**
 * Check if we're in ultra-narrow terminal mode
 */
function isUltraNarrowMode() {
  return getTerminalColumns() < ULTRA_NARROW_WIDTH;
}
function getContentWidth() {
  const columns = getTerminalColumns();
  const usable = typeof columns === 'number' && Number.isFinite(columns) ? columns - 6 : MAX_WIDTH;
  return clampWidth(usable, columns);
}
function wrapParagraph(text, width) {
  const words = text.split(/\s+/).filter(Boolean);
  if (!words.length) {
    return [''];
  }
  const lines = [];
  let current = words.shift();
  for (const word of words) {
    if (measure(`${current} ${word}`) > width) {
      lines.push(current);
      current = word;
    } else {
      current += ` ${word}`;
    }
  }
  lines.push(current);
  return lines;
}
function wrapPreformatted(text, width) {
  if (!text) {
    return [''];
  }
  const result = [];
  let remaining = text;
  while (measure(remaining) > width) {
    result.push(remaining.slice(0, width));
    remaining = remaining.slice(width);
  }
  if (remaining) {
    result.push(remaining);
  }
  return result.length ? result : [''];
}
function normalizePanelWidth(width) {
  if (typeof width === 'number' && Number.isFinite(width)) {
    return clampWidth(width, getTerminalColumns());
  }
  return clampWidth(getContentWidth(), getTerminalColumns());
}
function renderPanel(lines, options = {}) {
  // Check if plain output mode is enabled for clipboard-friendly text
  if ((0, _outputMode.isPlainOutputMode)()) {
    return renderPlainPanel(lines, options);
  }
  const width = normalizePanelWidth(options.width);
  const accent = options.accentColor ?? _theme.theme.primary;
  const iconSegment = options.icon ? `${options.icon} ` : '';
  const titleText = options.title ? `${iconSegment}${options.title}` : '';
  const output = [];

  // Add empty line for spacing
  output.push('');
  if (titleText) {
    const paddedTitle = padLine(accent(truncate(titleText, width)), width);
    output.push(paddedTitle);
    output.push('');
  }
  if (!lines.length) {
    lines = [''];
  }
  for (const line of lines) {
    const padded = padLine(line, width);
    output.push(padded);
  }

  // Add empty line for spacing
  output.push('');
  return output.join('\n');
}

/**
 * Renders a panel in plain text mode without box-drawing characters.
 * Outputs clean text that's clipboard-friendly.
 */
function renderPlainPanel(lines, options = {}) {
  const accent = options.accentColor ?? _theme.theme.primary;
  const iconSegment = options.icon ? `${options.icon} ` : '';
  const titleText = options.title ? `${iconSegment}${options.title}` : '';
  const output = [];
  if (titleText) {
    output.push(`[${accent(titleText)}]`);
    output.push('');
  }
  if (!lines.length) {
    lines = [''];
  }
  for (const line of lines) {
    output.push(line.trimEnd());
  }
  return output.join('\n');
}
function measure(text) {
  return stripAnsi(text).length;
}
function stripAnsi(text) {
  return text.replace(ANSI_REGEX, '');
}

/**
 * Clamp width to valid bounds with robust error handling
 * Ensures we never return invalid dimensions that could break rendering
 */
function clampWidth(value, columns) {
  // Handle invalid inputs gracefully
  if (!Number.isFinite(value) || value < 0) {
    value = DEFAULT_WIDTH;
  }

  // Calculate max width based on terminal size
  const terminalMax = typeof columns === 'number' && Number.isFinite(columns) && columns > 0 ? Math.max(MIN_WIDTH, Math.floor(columns - 4)) // Leave margin for borders
  : MAX_WIDTH;

  // Ensure min doesn't exceed max
  const effectiveMin = Math.min(MIN_WIDTH, terminalMax);
  const effectiveMax = Math.min(MAX_WIDTH, terminalMax);

  // Clamp to valid range
  const normalized = Math.floor(value);
  return Math.max(effectiveMin, Math.min(normalized, effectiveMax));
}
function padLine(text, width) {
  const visible = measure(text);
  if (visible === width) {
    return text;
  }
  if (visible > width) {
    return truncate(text, width);
  }
  return `${text}${' '.repeat(width - visible)}`;
}
function truncate(text, width) {
  const visible = stripAnsi(text);
  if (visible.length <= width) {
    return text;
  }
  const truncated = visible.slice(0, Math.max(1, width - 1));
  return `${truncated}â€¦`;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfdGhlbWUiLCJyZXF1aXJlIiwiX291dHB1dE1vZGUiLCJNSU5fV0lEVEgiLCJNQVhfV0lEVEgiLCJVTFRSQV9OQVJST1dfV0lEVEgiLCJERUZBVUxUX1dJRFRIIiwiQU5TSV9SRUdFWCIsImdldFRlcm1pbmFsQ29sdW1ucyIsImRlZmF1bHRXaWR0aCIsInByb2Nlc3MiLCJzdGRvdXQiLCJjb2x1bW5zIiwiTnVtYmVyIiwiaXNGaW5pdGUiLCJlbnZDb2x1bW5zIiwiZW52IiwicGFyc2VkIiwicGFyc2VJbnQiLCJpc1VsdHJhTmFycm93TW9kZSIsImdldENvbnRlbnRXaWR0aCIsInVzYWJsZSIsImNsYW1wV2lkdGgiLCJ3cmFwUGFyYWdyYXBoIiwidGV4dCIsIndpZHRoIiwid29yZHMiLCJzcGxpdCIsImZpbHRlciIsIkJvb2xlYW4iLCJsZW5ndGgiLCJsaW5lcyIsImN1cnJlbnQiLCJzaGlmdCIsIndvcmQiLCJtZWFzdXJlIiwicHVzaCIsIndyYXBQcmVmb3JtYXR0ZWQiLCJyZXN1bHQiLCJyZW1haW5pbmciLCJzbGljZSIsIm5vcm1hbGl6ZVBhbmVsV2lkdGgiLCJyZW5kZXJQYW5lbCIsIm9wdGlvbnMiLCJpc1BsYWluT3V0cHV0TW9kZSIsInJlbmRlclBsYWluUGFuZWwiLCJhY2NlbnQiLCJhY2NlbnRDb2xvciIsInRoZW1lIiwicHJpbWFyeSIsImljb25TZWdtZW50IiwiaWNvbiIsInRpdGxlVGV4dCIsInRpdGxlIiwib3V0cHV0IiwicGFkZGVkVGl0bGUiLCJwYWRMaW5lIiwidHJ1bmNhdGUiLCJsaW5lIiwicGFkZGVkIiwiam9pbiIsInRyaW1FbmQiLCJzdHJpcEFuc2kiLCJyZXBsYWNlIiwidmFsdWUiLCJ0ZXJtaW5hbE1heCIsIk1hdGgiLCJtYXgiLCJmbG9vciIsImVmZmVjdGl2ZU1pbiIsIm1pbiIsImVmZmVjdGl2ZU1heCIsIm5vcm1hbGl6ZWQiLCJ2aXNpYmxlIiwicmVwZWF0IiwidHJ1bmNhdGVkIl0sInNvdXJjZXMiOlsibGF5b3V0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHRoZW1lIH0gZnJvbSAnLi90aGVtZS5qcyc7XG5pbXBvcnQgeyBpc1BsYWluT3V0cHV0TW9kZSB9IGZyb20gJy4vb3V0cHV0TW9kZS5qcyc7XG5cbi8qKlxuICogTGF5b3V0IGNvbnN0YW50cyBmb3IgdGVybWluYWwgcmVuZGVyaW5nXG4gKiBUaGVzZSBlbnN1cmUgY29uc2lzdGVudCBiZWhhdmlvciBhY3Jvc3MgYWxsIHRlcm1pbmFsIHNpemVzXG4gKi9cbmNvbnN0IE1JTl9XSURUSCA9IDIwOyAvLyBNaW5pbXVtIHVzYWJsZSB3aWR0aCAocmVkdWNlZCBmcm9tIDQyIGZvciBuYXJyb3cgdGVybWluYWxzKVxuY29uc3QgTUFYX1dJRFRIID0gMTIwOyAvLyBNYXhpbXVtIGNvbnRlbnQgd2lkdGggZm9yIHJlYWRhYmlsaXR5XG5jb25zdCBVTFRSQV9OQVJST1dfV0lEVEggPSAzMDsgLy8gQmVsb3cgdGhpcywgdXNlIGNvbXBhY3QgbW9kZVxuY29uc3QgREVGQVVMVF9XSURUSCA9IDgwOyAvLyBTdGFuZGFyZCB0ZXJtaW5hbCB3aWR0aCBmYWxsYmFja1xuXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29udHJvbC1yZWdleFxuY29uc3QgQU5TSV9SRUdFWCA9IC9cXHUwMDFCXFxbWzAtOTtdKm0vZztcblxuLyoqXG4gKiBHZXQgdGVybWluYWwgY29sdW1ucyB3aXRoIHJvYnVzdCBmYWxsYmFjayBoYW5kbGluZ1xuICogSGFuZGxlcyBlZGdlIGNhc2VzOiB1bmRlZmluZWQgc3Rkb3V0LCBub24tVFRZLCBpbnZhbGlkIHZhbHVlc1xuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0VGVybWluYWxDb2x1bW5zKGRlZmF1bHRXaWR0aCA9IERFRkFVTFRfV0lEVEgpOiBudW1iZXIge1xuICB0cnkge1xuICAgIC8vIENoZWNrIGlmIHN0ZG91dCBleGlzdHMgYW5kIGhhcyBjb2x1bW5zXG4gICAgaWYgKFxuICAgICAgcHJvY2Vzcy5zdGRvdXQgJiZcbiAgICAgIHR5cGVvZiBwcm9jZXNzLnN0ZG91dC5jb2x1bW5zID09PSAnbnVtYmVyJyAmJlxuICAgICAgTnVtYmVyLmlzRmluaXRlKHByb2Nlc3Muc3Rkb3V0LmNvbHVtbnMpICYmXG4gICAgICBwcm9jZXNzLnN0ZG91dC5jb2x1bW5zID4gMFxuICAgICkge1xuICAgICAgcmV0dXJuIHByb2Nlc3Muc3Rkb3V0LmNvbHVtbnM7XG4gICAgfVxuXG4gICAgLy8gRmFsbGJhY2s6IHRyeSBDT0xVTU5TIGVudiB2YXJpYWJsZSAodXNlZCBpbiBzb21lIHRlcm1pbmFscylcbiAgICBjb25zdCBlbnZDb2x1bW5zID0gcHJvY2Vzcy5lbnZbJ0NPTFVNTlMnXTtcbiAgICBpZiAoZW52Q29sdW1ucykge1xuICAgICAgY29uc3QgcGFyc2VkID0gcGFyc2VJbnQoZW52Q29sdW1ucywgMTApO1xuICAgICAgaWYgKE51bWJlci5pc0Zpbml0ZShwYXJzZWQpICYmIHBhcnNlZCA+IDApIHtcbiAgICAgICAgcmV0dXJuIHBhcnNlZDtcbiAgICAgIH1cbiAgICB9XG4gIH0gY2F0Y2gge1xuICAgIC8vIFNpbGVudGx5IGhhbmRsZSBhbnkgZXJyb3JzIChlLmcuLCBpbiByZXN0cmljdGVkIGVudmlyb25tZW50cylcbiAgfVxuICByZXR1cm4gZGVmYXVsdFdpZHRoO1xufVxuXG4vKipcbiAqIENoZWNrIGlmIHdlJ3JlIGluIHVsdHJhLW5hcnJvdyB0ZXJtaW5hbCBtb2RlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc1VsdHJhTmFycm93TW9kZSgpOiBib29sZWFuIHtcbiAgcmV0dXJuIGdldFRlcm1pbmFsQ29sdW1ucygpIDwgVUxUUkFfTkFSUk9XX1dJRFRIO1xufVxuXG5leHBvcnQgdHlwZSBDb2xvcml6ZSA9ICh2YWx1ZTogc3RyaW5nKSA9PiBzdHJpbmc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGFuZWxPcHRpb25zIHtcbiAgdGl0bGU/OiBzdHJpbmc7XG4gIGljb24/OiBzdHJpbmc7XG4gIGFjY2VudENvbG9yPzogQ29sb3JpemU7XG4gIGJvcmRlckNvbG9yPzogQ29sb3JpemU7XG4gIHdpZHRoPzogbnVtYmVyO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q29udGVudFdpZHRoKCk6IG51bWJlciB7XG4gIGNvbnN0IGNvbHVtbnMgPSBnZXRUZXJtaW5hbENvbHVtbnMoKTtcbiAgY29uc3QgdXNhYmxlID0gdHlwZW9mIGNvbHVtbnMgPT09ICdudW1iZXInICYmIE51bWJlci5pc0Zpbml0ZShjb2x1bW5zKSA/IGNvbHVtbnMgLSA2IDogTUFYX1dJRFRIO1xuICByZXR1cm4gY2xhbXBXaWR0aCh1c2FibGUsIGNvbHVtbnMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gd3JhcFBhcmFncmFwaCh0ZXh0OiBzdHJpbmcsIHdpZHRoOiBudW1iZXIpOiBzdHJpbmdbXSB7XG4gIGNvbnN0IHdvcmRzID0gdGV4dC5zcGxpdCgvXFxzKy8pLmZpbHRlcihCb29sZWFuKTtcbiAgaWYgKCF3b3Jkcy5sZW5ndGgpIHtcbiAgICByZXR1cm4gWycnXTtcbiAgfVxuXG4gIGNvbnN0IGxpbmVzOiBzdHJpbmdbXSA9IFtdO1xuICBsZXQgY3VycmVudCA9IHdvcmRzLnNoaWZ0KCkhO1xuXG4gIGZvciAoY29uc3Qgd29yZCBvZiB3b3Jkcykge1xuICAgIGlmIChtZWFzdXJlKGAke2N1cnJlbnR9ICR7d29yZH1gKSA+IHdpZHRoKSB7XG4gICAgICBsaW5lcy5wdXNoKGN1cnJlbnQpO1xuICAgICAgY3VycmVudCA9IHdvcmQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGN1cnJlbnQgKz0gYCAke3dvcmR9YDtcbiAgICB9XG4gIH1cblxuICBsaW5lcy5wdXNoKGN1cnJlbnQpO1xuICByZXR1cm4gbGluZXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB3cmFwUHJlZm9ybWF0dGVkKHRleHQ6IHN0cmluZywgd2lkdGg6IG51bWJlcik6IHN0cmluZ1tdIHtcbiAgaWYgKCF0ZXh0KSB7XG4gICAgcmV0dXJuIFsnJ107XG4gIH1cblxuICBjb25zdCByZXN1bHQ6IHN0cmluZ1tdID0gW107XG4gIGxldCByZW1haW5pbmcgPSB0ZXh0O1xuXG4gIHdoaWxlIChtZWFzdXJlKHJlbWFpbmluZykgPiB3aWR0aCkge1xuICAgIHJlc3VsdC5wdXNoKHJlbWFpbmluZy5zbGljZSgwLCB3aWR0aCkpO1xuICAgIHJlbWFpbmluZyA9IHJlbWFpbmluZy5zbGljZSh3aWR0aCk7XG4gIH1cblxuICBpZiAocmVtYWluaW5nKSB7XG4gICAgcmVzdWx0LnB1c2gocmVtYWluaW5nKTtcbiAgfVxuXG4gIHJldHVybiByZXN1bHQubGVuZ3RoID8gcmVzdWx0IDogWycnXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG5vcm1hbGl6ZVBhbmVsV2lkdGgod2lkdGg/OiBudW1iZXIpOiBudW1iZXIge1xuICBpZiAodHlwZW9mIHdpZHRoID09PSAnbnVtYmVyJyAmJiBOdW1iZXIuaXNGaW5pdGUod2lkdGgpKSB7XG4gICAgcmV0dXJuIGNsYW1wV2lkdGgod2lkdGgsIGdldFRlcm1pbmFsQ29sdW1ucygpKTtcbiAgfVxuICByZXR1cm4gY2xhbXBXaWR0aChnZXRDb250ZW50V2lkdGgoKSwgZ2V0VGVybWluYWxDb2x1bW5zKCkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVuZGVyUGFuZWwobGluZXM6IHN0cmluZ1tdLCBvcHRpb25zOiBQYW5lbE9wdGlvbnMgPSB7fSk6IHN0cmluZyB7XG4gIC8vIENoZWNrIGlmIHBsYWluIG91dHB1dCBtb2RlIGlzIGVuYWJsZWQgZm9yIGNsaXBib2FyZC1mcmllbmRseSB0ZXh0XG4gIGlmIChpc1BsYWluT3V0cHV0TW9kZSgpKSB7XG4gICAgcmV0dXJuIHJlbmRlclBsYWluUGFuZWwobGluZXMsIG9wdGlvbnMpO1xuICB9XG5cbiAgY29uc3Qgd2lkdGggPSBub3JtYWxpemVQYW5lbFdpZHRoKG9wdGlvbnMud2lkdGgpO1xuICBjb25zdCBhY2NlbnQgPSBvcHRpb25zLmFjY2VudENvbG9yID8/IHRoZW1lLnByaW1hcnk7XG4gIGNvbnN0IGljb25TZWdtZW50ID0gb3B0aW9ucy5pY29uID8gYCR7b3B0aW9ucy5pY29ufSBgIDogJyc7XG4gIGNvbnN0IHRpdGxlVGV4dCA9IG9wdGlvbnMudGl0bGUgPyBgJHtpY29uU2VnbWVudH0ke29wdGlvbnMudGl0bGV9YCA6ICcnO1xuXG4gIGNvbnN0IG91dHB1dDogc3RyaW5nW10gPSBbXTtcblxuICAvLyBBZGQgZW1wdHkgbGluZSBmb3Igc3BhY2luZ1xuICBvdXRwdXQucHVzaCgnJyk7XG5cbiAgaWYgKHRpdGxlVGV4dCkge1xuICAgIGNvbnN0IHBhZGRlZFRpdGxlID0gcGFkTGluZShhY2NlbnQodHJ1bmNhdGUodGl0bGVUZXh0LCB3aWR0aCkpLCB3aWR0aCk7XG4gICAgb3V0cHV0LnB1c2gocGFkZGVkVGl0bGUpO1xuICAgIG91dHB1dC5wdXNoKCcnKTtcbiAgfVxuXG4gIGlmICghbGluZXMubGVuZ3RoKSB7XG4gICAgbGluZXMgPSBbJyddO1xuICB9XG5cbiAgZm9yIChjb25zdCBsaW5lIG9mIGxpbmVzKSB7XG4gICAgY29uc3QgcGFkZGVkID0gcGFkTGluZShsaW5lLCB3aWR0aCk7XG4gICAgb3V0cHV0LnB1c2gocGFkZGVkKTtcbiAgfVxuXG4gIC8vIEFkZCBlbXB0eSBsaW5lIGZvciBzcGFjaW5nXG4gIG91dHB1dC5wdXNoKCcnKTtcblxuICByZXR1cm4gb3V0cHV0LmpvaW4oJ1xcbicpO1xufVxuXG4vKipcbiAqIFJlbmRlcnMgYSBwYW5lbCBpbiBwbGFpbiB0ZXh0IG1vZGUgd2l0aG91dCBib3gtZHJhd2luZyBjaGFyYWN0ZXJzLlxuICogT3V0cHV0cyBjbGVhbiB0ZXh0IHRoYXQncyBjbGlwYm9hcmQtZnJpZW5kbHkuXG4gKi9cbmZ1bmN0aW9uIHJlbmRlclBsYWluUGFuZWwobGluZXM6IHN0cmluZ1tdLCBvcHRpb25zOiBQYW5lbE9wdGlvbnMgPSB7fSk6IHN0cmluZyB7XG4gIGNvbnN0IGFjY2VudCA9IG9wdGlvbnMuYWNjZW50Q29sb3IgPz8gdGhlbWUucHJpbWFyeTtcbiAgY29uc3QgaWNvblNlZ21lbnQgPSBvcHRpb25zLmljb24gPyBgJHtvcHRpb25zLmljb259IGAgOiAnJztcbiAgY29uc3QgdGl0bGVUZXh0ID0gb3B0aW9ucy50aXRsZSA/IGAke2ljb25TZWdtZW50fSR7b3B0aW9ucy50aXRsZX1gIDogJyc7XG5cbiAgY29uc3Qgb3V0cHV0OiBzdHJpbmdbXSA9IFtdO1xuXG4gIGlmICh0aXRsZVRleHQpIHtcbiAgICBvdXRwdXQucHVzaChgWyR7YWNjZW50KHRpdGxlVGV4dCl9XWApO1xuICAgIG91dHB1dC5wdXNoKCcnKTtcbiAgfVxuXG4gIGlmICghbGluZXMubGVuZ3RoKSB7XG4gICAgbGluZXMgPSBbJyddO1xuICB9XG5cbiAgZm9yIChjb25zdCBsaW5lIG9mIGxpbmVzKSB7XG4gICAgb3V0cHV0LnB1c2gobGluZS50cmltRW5kKCkpO1xuICB9XG5cbiAgcmV0dXJuIG91dHB1dC5qb2luKCdcXG4nKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1lYXN1cmUodGV4dDogc3RyaW5nKTogbnVtYmVyIHtcbiAgcmV0dXJuIHN0cmlwQW5zaSh0ZXh0KS5sZW5ndGg7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdHJpcEFuc2kodGV4dDogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIHRleHQucmVwbGFjZShBTlNJX1JFR0VYLCAnJyk7XG59XG5cbi8qKlxuICogQ2xhbXAgd2lkdGggdG8gdmFsaWQgYm91bmRzIHdpdGggcm9idXN0IGVycm9yIGhhbmRsaW5nXG4gKiBFbnN1cmVzIHdlIG5ldmVyIHJldHVybiBpbnZhbGlkIGRpbWVuc2lvbnMgdGhhdCBjb3VsZCBicmVhayByZW5kZXJpbmdcbiAqL1xuZnVuY3Rpb24gY2xhbXBXaWR0aCh2YWx1ZTogbnVtYmVyLCBjb2x1bW5zPzogbnVtYmVyKTogbnVtYmVyIHtcbiAgLy8gSGFuZGxlIGludmFsaWQgaW5wdXRzIGdyYWNlZnVsbHlcbiAgaWYgKCFOdW1iZXIuaXNGaW5pdGUodmFsdWUpIHx8IHZhbHVlIDwgMCkge1xuICAgIHZhbHVlID0gREVGQVVMVF9XSURUSDtcbiAgfVxuXG4gIC8vIENhbGN1bGF0ZSBtYXggd2lkdGggYmFzZWQgb24gdGVybWluYWwgc2l6ZVxuICBjb25zdCB0ZXJtaW5hbE1heCA9XG4gICAgdHlwZW9mIGNvbHVtbnMgPT09ICdudW1iZXInICYmIE51bWJlci5pc0Zpbml0ZShjb2x1bW5zKSAmJiBjb2x1bW5zID4gMFxuICAgICAgPyBNYXRoLm1heChNSU5fV0lEVEgsIE1hdGguZmxvb3IoY29sdW1ucyAtIDQpKSAvLyBMZWF2ZSBtYXJnaW4gZm9yIGJvcmRlcnNcbiAgICAgIDogTUFYX1dJRFRIO1xuXG4gIC8vIEVuc3VyZSBtaW4gZG9lc24ndCBleGNlZWQgbWF4XG4gIGNvbnN0IGVmZmVjdGl2ZU1pbiA9IE1hdGgubWluKE1JTl9XSURUSCwgdGVybWluYWxNYXgpO1xuICBjb25zdCBlZmZlY3RpdmVNYXggPSBNYXRoLm1pbihNQVhfV0lEVEgsIHRlcm1pbmFsTWF4KTtcblxuICAvLyBDbGFtcCB0byB2YWxpZCByYW5nZVxuICBjb25zdCBub3JtYWxpemVkID0gTWF0aC5mbG9vcih2YWx1ZSk7XG4gIHJldHVybiBNYXRoLm1heChlZmZlY3RpdmVNaW4sIE1hdGgubWluKG5vcm1hbGl6ZWQsIGVmZmVjdGl2ZU1heCkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFkTGluZSh0ZXh0OiBzdHJpbmcsIHdpZHRoOiBudW1iZXIpOiBzdHJpbmcge1xuICBjb25zdCB2aXNpYmxlID0gbWVhc3VyZSh0ZXh0KTtcbiAgaWYgKHZpc2libGUgPT09IHdpZHRoKSB7XG4gICAgcmV0dXJuIHRleHQ7XG4gIH1cblxuICBpZiAodmlzaWJsZSA+IHdpZHRoKSB7XG4gICAgcmV0dXJuIHRydW5jYXRlKHRleHQsIHdpZHRoKTtcbiAgfVxuXG4gIHJldHVybiBgJHt0ZXh0fSR7JyAnLnJlcGVhdCh3aWR0aCAtIHZpc2libGUpfWA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0cnVuY2F0ZSh0ZXh0OiBzdHJpbmcsIHdpZHRoOiBudW1iZXIpOiBzdHJpbmcge1xuICBjb25zdCB2aXNpYmxlID0gc3RyaXBBbnNpKHRleHQpO1xuICBpZiAodmlzaWJsZS5sZW5ndGggPD0gd2lkdGgpIHtcbiAgICByZXR1cm4gdGV4dDtcbiAgfVxuXG4gIGNvbnN0IHRydW5jYXRlZCA9IHZpc2libGUuc2xpY2UoMCwgTWF0aC5tYXgoMSwgd2lkdGggLSAxKSk7XG4gIHJldHVybiBgJHt0cnVuY2F0ZWR94oCmYDtcbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLElBQUFBLE1BQUEsR0FBQUMsT0FBQTtBQUNBLElBQUFDLFdBQUEsR0FBQUQsT0FBQTtBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUFBTUUsU0FBUyxHQUFHLEVBQUUsQ0FBQyxDQUFDO0FBQ3RCLE1BQU1DLFNBQVMsR0FBRyxHQUFHLENBQUMsQ0FBQztBQUN2QixNQUFNQyxrQkFBa0IsR0FBRyxFQUFFLENBQUMsQ0FBQztBQUMvQixNQUFNQyxhQUFhLEdBQUcsRUFBRSxDQUFDLENBQUM7O0FBRTFCO0FBQ0EsTUFBTUMsVUFBVSxHQUFHLG1CQUFtQjs7QUFFdEM7QUFDQTtBQUNBO0FBQ0E7QUFDTyxTQUFTQyxrQkFBa0JBLENBQUNDLFlBQVksR0FBR0gsYUFBYSxFQUFVO0VBQ3ZFLElBQUk7SUFDRjtJQUNBLElBQ0VJLE9BQU8sQ0FBQ0MsTUFBTSxJQUNkLE9BQU9ELE9BQU8sQ0FBQ0MsTUFBTSxDQUFDQyxPQUFPLEtBQUssUUFBUSxJQUMxQ0MsTUFBTSxDQUFDQyxRQUFRLENBQUNKLE9BQU8sQ0FBQ0MsTUFBTSxDQUFDQyxPQUFPLENBQUMsSUFDdkNGLE9BQU8sQ0FBQ0MsTUFBTSxDQUFDQyxPQUFPLEdBQUcsQ0FBQyxFQUMxQjtNQUNBLE9BQU9GLE9BQU8sQ0FBQ0MsTUFBTSxDQUFDQyxPQUFPO0lBQy9COztJQUVBO0lBQ0EsTUFBTUcsVUFBVSxHQUFHTCxPQUFPLENBQUNNLEdBQUcsQ0FBQyxTQUFTLENBQUM7SUFDekMsSUFBSUQsVUFBVSxFQUFFO01BQ2QsTUFBTUUsTUFBTSxHQUFHQyxRQUFRLENBQUNILFVBQVUsRUFBRSxFQUFFLENBQUM7TUFDdkMsSUFBSUYsTUFBTSxDQUFDQyxRQUFRLENBQUNHLE1BQU0sQ0FBQyxJQUFJQSxNQUFNLEdBQUcsQ0FBQyxFQUFFO1FBQ3pDLE9BQU9BLE1BQU07TUFDZjtJQUNGO0VBQ0YsQ0FBQyxDQUFDLE1BQU07SUFDTjtFQUFBO0VBRUYsT0FBT1IsWUFBWTtBQUNyQjs7QUFFQTtBQUNBO0FBQ0E7QUFDTyxTQUFTVSxpQkFBaUJBLENBQUEsRUFBWTtFQUMzQyxPQUFPWCxrQkFBa0IsQ0FBQyxDQUFDLEdBQUdILGtCQUFrQjtBQUNsRDtBQVlPLFNBQVNlLGVBQWVBLENBQUEsRUFBVztFQUN4QyxNQUFNUixPQUFPLEdBQUdKLGtCQUFrQixDQUFDLENBQUM7RUFDcEMsTUFBTWEsTUFBTSxHQUFHLE9BQU9ULE9BQU8sS0FBSyxRQUFRLElBQUlDLE1BQU0sQ0FBQ0MsUUFBUSxDQUFDRixPQUFPLENBQUMsR0FBR0EsT0FBTyxHQUFHLENBQUMsR0FBR1IsU0FBUztFQUNoRyxPQUFPa0IsVUFBVSxDQUFDRCxNQUFNLEVBQUVULE9BQU8sQ0FBQztBQUNwQztBQUVPLFNBQVNXLGFBQWFBLENBQUNDLElBQVksRUFBRUMsS0FBYSxFQUFZO0VBQ25FLE1BQU1DLEtBQUssR0FBR0YsSUFBSSxDQUFDRyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUNDLE1BQU0sQ0FBQ0MsT0FBTyxDQUFDO0VBQy9DLElBQUksQ0FBQ0gsS0FBSyxDQUFDSSxNQUFNLEVBQUU7SUFDakIsT0FBTyxDQUFDLEVBQUUsQ0FBQztFQUNiO0VBRUEsTUFBTUMsS0FBZSxHQUFHLEVBQUU7RUFDMUIsSUFBSUMsT0FBTyxHQUFHTixLQUFLLENBQUNPLEtBQUssQ0FBQyxDQUFFO0VBRTVCLEtBQUssTUFBTUMsSUFBSSxJQUFJUixLQUFLLEVBQUU7SUFDeEIsSUFBSVMsT0FBTyxDQUFDLEdBQUdILE9BQU8sSUFBSUUsSUFBSSxFQUFFLENBQUMsR0FBR1QsS0FBSyxFQUFFO01BQ3pDTSxLQUFLLENBQUNLLElBQUksQ0FBQ0osT0FBTyxDQUFDO01BQ25CQSxPQUFPLEdBQUdFLElBQUk7SUFDaEIsQ0FBQyxNQUFNO01BQ0xGLE9BQU8sSUFBSSxJQUFJRSxJQUFJLEVBQUU7SUFDdkI7RUFDRjtFQUVBSCxLQUFLLENBQUNLLElBQUksQ0FBQ0osT0FBTyxDQUFDO0VBQ25CLE9BQU9ELEtBQUs7QUFDZDtBQUVPLFNBQVNNLGdCQUFnQkEsQ0FBQ2IsSUFBWSxFQUFFQyxLQUFhLEVBQVk7RUFDdEUsSUFBSSxDQUFDRCxJQUFJLEVBQUU7SUFDVCxPQUFPLENBQUMsRUFBRSxDQUFDO0VBQ2I7RUFFQSxNQUFNYyxNQUFnQixHQUFHLEVBQUU7RUFDM0IsSUFBSUMsU0FBUyxHQUFHZixJQUFJO0VBRXBCLE9BQU9XLE9BQU8sQ0FBQ0ksU0FBUyxDQUFDLEdBQUdkLEtBQUssRUFBRTtJQUNqQ2EsTUFBTSxDQUFDRixJQUFJLENBQUNHLFNBQVMsQ0FBQ0MsS0FBSyxDQUFDLENBQUMsRUFBRWYsS0FBSyxDQUFDLENBQUM7SUFDdENjLFNBQVMsR0FBR0EsU0FBUyxDQUFDQyxLQUFLLENBQUNmLEtBQUssQ0FBQztFQUNwQztFQUVBLElBQUljLFNBQVMsRUFBRTtJQUNiRCxNQUFNLENBQUNGLElBQUksQ0FBQ0csU0FBUyxDQUFDO0VBQ3hCO0VBRUEsT0FBT0QsTUFBTSxDQUFDUixNQUFNLEdBQUdRLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztBQUN0QztBQUVPLFNBQVNHLG1CQUFtQkEsQ0FBQ2hCLEtBQWMsRUFBVTtFQUMxRCxJQUFJLE9BQU9BLEtBQUssS0FBSyxRQUFRLElBQUlaLE1BQU0sQ0FBQ0MsUUFBUSxDQUFDVyxLQUFLLENBQUMsRUFBRTtJQUN2RCxPQUFPSCxVQUFVLENBQUNHLEtBQUssRUFBRWpCLGtCQUFrQixDQUFDLENBQUMsQ0FBQztFQUNoRDtFQUNBLE9BQU9jLFVBQVUsQ0FBQ0YsZUFBZSxDQUFDLENBQUMsRUFBRVosa0JBQWtCLENBQUMsQ0FBQyxDQUFDO0FBQzVEO0FBRU8sU0FBU2tDLFdBQVdBLENBQUNYLEtBQWUsRUFBRVksT0FBcUIsR0FBRyxDQUFDLENBQUMsRUFBVTtFQUMvRTtFQUNBLElBQUksSUFBQUMsNkJBQWlCLEVBQUMsQ0FBQyxFQUFFO0lBQ3ZCLE9BQU9DLGdCQUFnQixDQUFDZCxLQUFLLEVBQUVZLE9BQU8sQ0FBQztFQUN6QztFQUVBLE1BQU1sQixLQUFLLEdBQUdnQixtQkFBbUIsQ0FBQ0UsT0FBTyxDQUFDbEIsS0FBSyxDQUFDO0VBQ2hELE1BQU1xQixNQUFNLEdBQUdILE9BQU8sQ0FBQ0ksV0FBVyxJQUFJQyxZQUFLLENBQUNDLE9BQU87RUFDbkQsTUFBTUMsV0FBVyxHQUFHUCxPQUFPLENBQUNRLElBQUksR0FBRyxHQUFHUixPQUFPLENBQUNRLElBQUksR0FBRyxHQUFHLEVBQUU7RUFDMUQsTUFBTUMsU0FBUyxHQUFHVCxPQUFPLENBQUNVLEtBQUssR0FBRyxHQUFHSCxXQUFXLEdBQUdQLE9BQU8sQ0FBQ1UsS0FBSyxFQUFFLEdBQUcsRUFBRTtFQUV2RSxNQUFNQyxNQUFnQixHQUFHLEVBQUU7O0VBRTNCO0VBQ0FBLE1BQU0sQ0FBQ2xCLElBQUksQ0FBQyxFQUFFLENBQUM7RUFFZixJQUFJZ0IsU0FBUyxFQUFFO0lBQ2IsTUFBTUcsV0FBVyxHQUFHQyxPQUFPLENBQUNWLE1BQU0sQ0FBQ1csUUFBUSxDQUFDTCxTQUFTLEVBQUUzQixLQUFLLENBQUMsQ0FBQyxFQUFFQSxLQUFLLENBQUM7SUFDdEU2QixNQUFNLENBQUNsQixJQUFJLENBQUNtQixXQUFXLENBQUM7SUFDeEJELE1BQU0sQ0FBQ2xCLElBQUksQ0FBQyxFQUFFLENBQUM7RUFDakI7RUFFQSxJQUFJLENBQUNMLEtBQUssQ0FBQ0QsTUFBTSxFQUFFO0lBQ2pCQyxLQUFLLEdBQUcsQ0FBQyxFQUFFLENBQUM7RUFDZDtFQUVBLEtBQUssTUFBTTJCLElBQUksSUFBSTNCLEtBQUssRUFBRTtJQUN4QixNQUFNNEIsTUFBTSxHQUFHSCxPQUFPLENBQUNFLElBQUksRUFBRWpDLEtBQUssQ0FBQztJQUNuQzZCLE1BQU0sQ0FBQ2xCLElBQUksQ0FBQ3VCLE1BQU0sQ0FBQztFQUNyQjs7RUFFQTtFQUNBTCxNQUFNLENBQUNsQixJQUFJLENBQUMsRUFBRSxDQUFDO0VBRWYsT0FBT2tCLE1BQU0sQ0FBQ00sSUFBSSxDQUFDLElBQUksQ0FBQztBQUMxQjs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVNmLGdCQUFnQkEsQ0FBQ2QsS0FBZSxFQUFFWSxPQUFxQixHQUFHLENBQUMsQ0FBQyxFQUFVO0VBQzdFLE1BQU1HLE1BQU0sR0FBR0gsT0FBTyxDQUFDSSxXQUFXLElBQUlDLFlBQUssQ0FBQ0MsT0FBTztFQUNuRCxNQUFNQyxXQUFXLEdBQUdQLE9BQU8sQ0FBQ1EsSUFBSSxHQUFHLEdBQUdSLE9BQU8sQ0FBQ1EsSUFBSSxHQUFHLEdBQUcsRUFBRTtFQUMxRCxNQUFNQyxTQUFTLEdBQUdULE9BQU8sQ0FBQ1UsS0FBSyxHQUFHLEdBQUdILFdBQVcsR0FBR1AsT0FBTyxDQUFDVSxLQUFLLEVBQUUsR0FBRyxFQUFFO0VBRXZFLE1BQU1DLE1BQWdCLEdBQUcsRUFBRTtFQUUzQixJQUFJRixTQUFTLEVBQUU7SUFDYkUsTUFBTSxDQUFDbEIsSUFBSSxDQUFDLElBQUlVLE1BQU0sQ0FBQ00sU0FBUyxDQUFDLEdBQUcsQ0FBQztJQUNyQ0UsTUFBTSxDQUFDbEIsSUFBSSxDQUFDLEVBQUUsQ0FBQztFQUNqQjtFQUVBLElBQUksQ0FBQ0wsS0FBSyxDQUFDRCxNQUFNLEVBQUU7SUFDakJDLEtBQUssR0FBRyxDQUFDLEVBQUUsQ0FBQztFQUNkO0VBRUEsS0FBSyxNQUFNMkIsSUFBSSxJQUFJM0IsS0FBSyxFQUFFO0lBQ3hCdUIsTUFBTSxDQUFDbEIsSUFBSSxDQUFDc0IsSUFBSSxDQUFDRyxPQUFPLENBQUMsQ0FBQyxDQUFDO0VBQzdCO0VBRUEsT0FBT1AsTUFBTSxDQUFDTSxJQUFJLENBQUMsSUFBSSxDQUFDO0FBQzFCO0FBRU8sU0FBU3pCLE9BQU9BLENBQUNYLElBQVksRUFBVTtFQUM1QyxPQUFPc0MsU0FBUyxDQUFDdEMsSUFBSSxDQUFDLENBQUNNLE1BQU07QUFDL0I7QUFFTyxTQUFTZ0MsU0FBU0EsQ0FBQ3RDLElBQVksRUFBVTtFQUM5QyxPQUFPQSxJQUFJLENBQUN1QyxPQUFPLENBQUN4RCxVQUFVLEVBQUUsRUFBRSxDQUFDO0FBQ3JDOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBU2UsVUFBVUEsQ0FBQzBDLEtBQWEsRUFBRXBELE9BQWdCLEVBQVU7RUFDM0Q7RUFDQSxJQUFJLENBQUNDLE1BQU0sQ0FBQ0MsUUFBUSxDQUFDa0QsS0FBSyxDQUFDLElBQUlBLEtBQUssR0FBRyxDQUFDLEVBQUU7SUFDeENBLEtBQUssR0FBRzFELGFBQWE7RUFDdkI7O0VBRUE7RUFDQSxNQUFNMkQsV0FBVyxHQUNmLE9BQU9yRCxPQUFPLEtBQUssUUFBUSxJQUFJQyxNQUFNLENBQUNDLFFBQVEsQ0FBQ0YsT0FBTyxDQUFDLElBQUlBLE9BQU8sR0FBRyxDQUFDLEdBQ2xFc0QsSUFBSSxDQUFDQyxHQUFHLENBQUNoRSxTQUFTLEVBQUUrRCxJQUFJLENBQUNFLEtBQUssQ0FBQ3hELE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0VBQUEsRUFDN0NSLFNBQVM7O0VBRWY7RUFDQSxNQUFNaUUsWUFBWSxHQUFHSCxJQUFJLENBQUNJLEdBQUcsQ0FBQ25FLFNBQVMsRUFBRThELFdBQVcsQ0FBQztFQUNyRCxNQUFNTSxZQUFZLEdBQUdMLElBQUksQ0FBQ0ksR0FBRyxDQUFDbEUsU0FBUyxFQUFFNkQsV0FBVyxDQUFDOztFQUVyRDtFQUNBLE1BQU1PLFVBQVUsR0FBR04sSUFBSSxDQUFDRSxLQUFLLENBQUNKLEtBQUssQ0FBQztFQUNwQyxPQUFPRSxJQUFJLENBQUNDLEdBQUcsQ0FBQ0UsWUFBWSxFQUFFSCxJQUFJLENBQUNJLEdBQUcsQ0FBQ0UsVUFBVSxFQUFFRCxZQUFZLENBQUMsQ0FBQztBQUNuRTtBQUVPLFNBQVNmLE9BQU9BLENBQUNoQyxJQUFZLEVBQUVDLEtBQWEsRUFBVTtFQUMzRCxNQUFNZ0QsT0FBTyxHQUFHdEMsT0FBTyxDQUFDWCxJQUFJLENBQUM7RUFDN0IsSUFBSWlELE9BQU8sS0FBS2hELEtBQUssRUFBRTtJQUNyQixPQUFPRCxJQUFJO0VBQ2I7RUFFQSxJQUFJaUQsT0FBTyxHQUFHaEQsS0FBSyxFQUFFO0lBQ25CLE9BQU9nQyxRQUFRLENBQUNqQyxJQUFJLEVBQUVDLEtBQUssQ0FBQztFQUM5QjtFQUVBLE9BQU8sR0FBR0QsSUFBSSxHQUFHLEdBQUcsQ0FBQ2tELE1BQU0sQ0FBQ2pELEtBQUssR0FBR2dELE9BQU8sQ0FBQyxFQUFFO0FBQ2hEO0FBRU8sU0FBU2hCLFFBQVFBLENBQUNqQyxJQUFZLEVBQUVDLEtBQWEsRUFBVTtFQUM1RCxNQUFNZ0QsT0FBTyxHQUFHWCxTQUFTLENBQUN0QyxJQUFJLENBQUM7RUFDL0IsSUFBSWlELE9BQU8sQ0FBQzNDLE1BQU0sSUFBSUwsS0FBSyxFQUFFO0lBQzNCLE9BQU9ELElBQUk7RUFDYjtFQUVBLE1BQU1tRCxTQUFTLEdBQUdGLE9BQU8sQ0FBQ2pDLEtBQUssQ0FBQyxDQUFDLEVBQUUwQixJQUFJLENBQUNDLEdBQUcsQ0FBQyxDQUFDLEVBQUUxQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7RUFDMUQsT0FBTyxHQUFHa0QsU0FBUyxHQUFHO0FBQ3hCIiwiaWdub3JlTGlzdCI6W119