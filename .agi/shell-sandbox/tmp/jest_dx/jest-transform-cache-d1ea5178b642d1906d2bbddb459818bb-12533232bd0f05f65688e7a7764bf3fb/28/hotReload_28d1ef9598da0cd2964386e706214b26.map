{"version":3,"names":["_nodeEvents","require","_nodeFs","_nodeOs","_nodePath","_nodeChild_process","_nodeUtil","_selfUpgrade","_interopRequireWildcard","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","execAsync","promisify","execCallback","STATE_FILE","join","homedir","DEFAULT_CHECK_INTERVAL","HOT_SWAPPABLE_MODULES","RESTART_REQUIRED_MODULES","HotReload","EventEmitter","config","state","checkTimer","watchingFiles","constructor","autoCheck","checkInterval","enableHotSwap","logger","console","log","workingDir","process","cwd","loadState","startAutoCheck","existsSync","JSON","parse","readFileSync","currentVersion","lastCheck","pendingReload","hotSwappableModules","preservedState","saveState","dir","dirname","mkdirSync","recursive","writeFileSync","stringify","clearInterval","setInterval","checkForUpdates","catch","stopAutoCheck","emitEvent","Date","now","selfUpgrade","getSelfUpgrade","versionInfo","updateAvailable","strategy","determineReloadStrategy","current","latest","latestVersion","available","version","error","errorMessage","Error","message","String","targetVersion","currentMajor","parseInt","split","targetMajor","canHotSwap","requiresRestart","hotSwappable","estimatedDowntimeMs","stdout","timeout","trim","currentMinor","targetMinor","slice","performHotReload","options","updateCheck","success","preserveState","rlContext","saveRLCheckpoint","activeEdits","length","saveActiveEdits","hotSwapModules","modules","performFullRestart","modulePath","fullPath","cache","specifier","Promise","then","s","reason","autoRestart","sessionState","fromVersion","timestamp","result","npmInstallFresh","toVersion","watchFiles","files","unwatchFiles","file","watchFile","interval","emit","push","unwatchFile","key","value","getPreservedState","clearPreservedState","type","data","event","dispose","removeAllListeners","shouldResume","keys","getResumeState","exports","hotReloadInstance","getHotReload","resetHotReload","checkAndReload","hotReload","enableAutoCheck","intervalMs","disableAutoCheck"],"sources":["hotReload.ts"],"sourcesContent":["/**\n * Hot Reload System for AGI Core\n *\n * Enables seamless version transitions by:\n * 1. Detecting when a new version is available\n * 2. Hot-swapping modules where possible\n * 3. Gracefully restarting when full reload is needed\n * 4. Preserving state across reloads\n *\n * Integrated with the self-upgrade system for continuous improvement.\n */\n\nimport { EventEmitter } from 'node:events';\nimport { existsSync, readFileSync, writeFileSync, mkdirSync, watchFile, unwatchFile } from 'node:fs';\nimport { homedir } from 'node:os';\nimport { join, dirname } from 'node:path';\nimport { exec as execCallback } from 'node:child_process';\nimport { promisify } from 'node:util';\nimport { getSelfUpgrade, type UpgradeSessionState, type RLUpgradeContext } from './selfUpgrade.js';\n\nconst execAsync = promisify(execCallback);\n\n// ============================================================================\n// TYPES\n// ============================================================================\n\nexport interface HotReloadConfig {\n  /** Enable automatic version checking */\n  autoCheck?: boolean;\n  /** Check interval in ms (default: 5 minutes) */\n  checkInterval?: number;\n  /** Enable hot-swap where possible (default: true) */\n  enableHotSwap?: boolean;\n  /** Logger function */\n  logger?: (message: string) => void;\n  /** Working directory */\n  workingDir?: string;\n}\n\nexport interface HotReloadState {\n  /** Current version */\n  currentVersion: string;\n  /** Last check timestamp */\n  lastCheck: number;\n  /** Pending reload */\n  pendingReload: boolean;\n  /** Modules that can be hot-swapped */\n  hotSwappableModules: string[];\n  /** State to preserve across reload */\n  preservedState: Record<string, unknown>;\n}\n\nexport type HotReloadEventType =\n  | 'hotReload:check'\n  | 'hotReload:available'\n  | 'hotReload:swap'\n  | 'hotReload:restart'\n  | 'hotReload:complete'\n  | 'hotReload:error';\n\nexport interface HotReloadEvent {\n  type: HotReloadEventType;\n  timestamp: number;\n  data?: Record<string, unknown>;\n}\n\nexport interface ReloadStrategy {\n  /** Whether hot-swap is possible */\n  canHotSwap: boolean;\n  /** Modules that need full reload */\n  requiresRestart: string[];\n  /** Modules that can be hot-swapped */\n  hotSwappable: string[];\n  /** Estimated downtime */\n  estimatedDowntimeMs: number;\n}\n\n// ============================================================================\n// CONSTANTS\n// ============================================================================\n\nconst STATE_FILE = join(homedir(), '.agi', 'hot-reload-state.json');\nconst DEFAULT_CHECK_INTERVAL = 5 * 60 * 1000; // 5 minutes\n\n// Modules that can be hot-swapped without restart\nconst HOT_SWAPPABLE_MODULES = [\n  'ui/theme',\n  'ui/layout',\n  'core/preferences',\n  'shell/commandRegistry',\n];\n\n// Core modules that require full restart\nconst RESTART_REQUIRED_MODULES = [\n  'core/agiCore',\n  'core/selfUpgrade',\n  'core/updateChecker',\n  'headless/interactiveShell',\n  'bin/agi',\n];\n\n// ============================================================================\n// HOT RELOAD CLASS\n// ============================================================================\n\nexport class HotReload extends EventEmitter {\n  private config: Required<HotReloadConfig>;\n  private state: HotReloadState;\n  private checkTimer: ReturnType<typeof setInterval> | null = null;\n  private watchingFiles: string[] = [];\n\n  constructor(config: HotReloadConfig = {}) {\n    super();\n    this.config = {\n      autoCheck: config.autoCheck ?? false,\n      checkInterval: config.checkInterval ?? DEFAULT_CHECK_INTERVAL,\n      enableHotSwap: config.enableHotSwap ?? true,\n      logger: config.logger ?? console.log,\n      workingDir: config.workingDir ?? process.cwd(),\n    };\n\n    this.state = this.loadState();\n\n    // Start auto-check if enabled\n    if (this.config.autoCheck) {\n      this.startAutoCheck();\n    }\n  }\n\n  // ==========================================================================\n  // STATE MANAGEMENT\n  // ==========================================================================\n\n  private loadState(): HotReloadState {\n    try {\n      if (existsSync(STATE_FILE)) {\n        return JSON.parse(readFileSync(STATE_FILE, 'utf8'));\n      }\n    } catch {\n      // Start fresh\n    }\n    return {\n      currentVersion: '0.0.0',\n      lastCheck: 0,\n      pendingReload: false,\n      hotSwappableModules: HOT_SWAPPABLE_MODULES,\n      preservedState: {},\n    };\n  }\n\n  private saveState(): void {\n    try {\n      const dir = dirname(STATE_FILE);\n      if (!existsSync(dir)) {\n        mkdirSync(dir, { recursive: true });\n      }\n      writeFileSync(STATE_FILE, JSON.stringify(this.state, null, 2));\n    } catch {\n      // Best-effort\n    }\n  }\n\n  // ==========================================================================\n  // VERSION CHECKING\n  // ==========================================================================\n\n  /**\n   * Start automatic version checking\n   */\n  startAutoCheck(): void {\n    if (this.checkTimer) {\n      clearInterval(this.checkTimer);\n    }\n    this.checkTimer = setInterval(() => {\n      this.checkForUpdates().catch(() => {});\n    }, this.config.checkInterval);\n  }\n\n  /**\n   * Stop automatic version checking\n   */\n  stopAutoCheck(): void {\n    if (this.checkTimer) {\n      clearInterval(this.checkTimer);\n      this.checkTimer = null;\n    }\n  }\n\n  /**\n   * Check for available updates\n   */\n  async checkForUpdates(): Promise<{ available: boolean; version?: string; strategy?: ReloadStrategy }> {\n    this.emitEvent('hotReload:check', {});\n    this.state.lastCheck = Date.now();\n    this.saveState();\n\n    try {\n      const selfUpgrade = getSelfUpgrade();\n      const versionInfo = await selfUpgrade.checkForUpdates();\n\n      if (versionInfo.updateAvailable) {\n        const strategy = await this.determineReloadStrategy(versionInfo.current, versionInfo.latest);\n        this.state.pendingReload = true;\n        this.saveState();\n\n        this.emitEvent('hotReload:available', {\n          currentVersion: versionInfo.current,\n          latestVersion: versionInfo.latest,\n          strategy,\n        });\n\n        return {\n          available: true,\n          version: versionInfo.latest,\n          strategy,\n        };\n      }\n\n      return { available: false };\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : String(error);\n      this.emitEvent('hotReload:error', { error: errorMessage });\n      return { available: false };\n    }\n  }\n\n  /**\n   * Determine the best reload strategy for a version update\n   */\n  async determineReloadStrategy(currentVersion: string, targetVersion: string): Promise<ReloadStrategy> {\n    // For major version bumps, always require restart\n    const currentMajor = parseInt(currentVersion.split('.')[0] || '0', 10);\n    const targetMajor = parseInt(targetVersion.split('.')[0] || '0', 10);\n\n    if (targetMajor > currentMajor) {\n      return {\n        canHotSwap: false,\n        requiresRestart: RESTART_REQUIRED_MODULES,\n        hotSwappable: [],\n        estimatedDowntimeMs: 3000,\n      };\n    }\n\n    // For minor/patch updates, check what changed\n    try {\n      const { stdout } = await execAsync(\n        `npm view agi-core-cli@${targetVersion} dist.tarball`,\n        { timeout: 10000 }\n      );\n\n      // If we can't determine changes, assume restart needed\n      if (!stdout.trim()) {\n        return {\n          canHotSwap: false,\n          requiresRestart: RESTART_REQUIRED_MODULES,\n          hotSwappable: [],\n          estimatedDowntimeMs: 2000,\n        };\n      }\n\n      // For now, assume patch updates can be hot-swapped for UI modules\n      const currentMinor = parseInt(currentVersion.split('.')[1] || '0', 10);\n      const targetMinor = parseInt(targetVersion.split('.')[1] || '0', 10);\n\n      if (targetMinor === currentMinor) {\n        // Patch update - try hot-swap\n        return {\n          canHotSwap: this.config.enableHotSwap,\n          requiresRestart: [],\n          hotSwappable: HOT_SWAPPABLE_MODULES,\n          estimatedDowntimeMs: 500,\n        };\n      }\n\n      // Minor update - partial hot-swap\n      return {\n        canHotSwap: this.config.enableHotSwap,\n        requiresRestart: RESTART_REQUIRED_MODULES.slice(0, 2),\n        hotSwappable: HOT_SWAPPABLE_MODULES,\n        estimatedDowntimeMs: 1500,\n      };\n    } catch {\n      return {\n        canHotSwap: false,\n        requiresRestart: RESTART_REQUIRED_MODULES,\n        hotSwappable: [],\n        estimatedDowntimeMs: 2000,\n      };\n    }\n  }\n\n  // ==========================================================================\n  // HOT RELOAD EXECUTION\n  // ==========================================================================\n\n  /**\n   * Perform hot reload with state preservation\n   */\n  async performHotReload(options: {\n    preserveState?: Record<string, unknown>;\n    rlContext?: RLUpgradeContext;\n    activeEdits?: string[];\n  } = {}): Promise<{ success: boolean; strategy: 'hot-swap' | 'restart'; error?: string }> {\n    const updateCheck = await this.checkForUpdates();\n\n    if (!updateCheck.available || !updateCheck.strategy) {\n      return { success: false, strategy: 'hot-swap', error: 'No update available' };\n    }\n\n    const strategy = updateCheck.strategy;\n\n    // Preserve state\n    if (options.preserveState) {\n      this.state.preservedState = {\n        ...this.state.preservedState,\n        ...options.preserveState,\n      };\n      this.saveState();\n    }\n\n    // Save RL context if provided\n    if (options.rlContext) {\n      const selfUpgrade = getSelfUpgrade();\n      selfUpgrade.saveRLCheckpoint(options.rlContext);\n    }\n\n    // Save active edits\n    if (options.activeEdits && options.activeEdits.length > 0) {\n      const selfUpgrade = getSelfUpgrade();\n      selfUpgrade.saveActiveEdits(options.activeEdits);\n    }\n\n    if (strategy.canHotSwap && strategy.hotSwappable.length > 0 && strategy.requiresRestart.length === 0) {\n      // Attempt hot-swap\n      try {\n        await this.hotSwapModules(strategy.hotSwappable);\n        this.state.pendingReload = false;\n        this.saveState();\n        this.emitEvent('hotReload:swap', { modules: strategy.hotSwappable });\n        return { success: true, strategy: 'hot-swap' };\n      } catch (error) {\n        const errorMessage = error instanceof Error ? error.message : String(error);\n        this.config.logger(`Hot-swap failed, falling back to restart: ${errorMessage}`);\n      }\n    }\n\n    // Full restart required\n    return this.performFullRestart(options);\n  }\n\n  /**\n   * Hot-swap specific modules without restart\n   */\n  private async hotSwapModules(modules: string[]): Promise<void> {\n    for (const modulePath of modules) {\n      try {\n        // Clear module from cache\n        const fullPath = join(this.config.workingDir, 'dist', modulePath + '.js');\n        if (typeof require !== 'undefined' && require.cache) {\n          delete require.cache[fullPath];\n        }\n\n        // Dynamic import to reload\n        await import(fullPath + `?t=${Date.now()}`);\n        this.config.logger(`Hot-swapped: ${modulePath}`);\n      } catch (error) {\n        throw new Error(`Failed to hot-swap ${modulePath}: ${error}`);\n      }\n    }\n  }\n\n  /**\n   * Perform full restart with state preservation\n   */\n  private async performFullRestart(options: {\n    preserveState?: Record<string, unknown>;\n    rlContext?: RLUpgradeContext;\n    activeEdits?: string[];\n  } = {}): Promise<{ success: boolean; strategy: 'restart'; error?: string }> {\n    this.emitEvent('hotReload:restart', { reason: 'full-reload-required' });\n\n    const selfUpgrade = getSelfUpgrade({\n      workingDir: this.config.workingDir,\n      logger: this.config.logger,\n      autoRestart: true,\n      sessionState: {\n        workingDir: this.config.workingDir,\n        fromVersion: this.state.currentVersion,\n        timestamp: Date.now(),\n        activeEdits: options.activeEdits,\n        rlContext: options.rlContext,\n      },\n    });\n\n    const result = await selfUpgrade.npmInstallFresh();\n\n    if (result.success) {\n      this.state.pendingReload = false;\n      this.state.currentVersion = result.toVersion || this.state.currentVersion;\n      this.saveState();\n      this.emitEvent('hotReload:complete', { version: result.toVersion });\n      return { success: true, strategy: 'restart' };\n    }\n\n    return { success: false, strategy: 'restart', error: result.error };\n  }\n\n  // ==========================================================================\n  // FILE WATCHING\n  // ==========================================================================\n\n  /**\n   * Watch for local file changes (development mode)\n   */\n  watchFiles(files: string[]): void {\n    // Unwatch existing\n    this.unwatchFiles();\n\n    for (const file of files) {\n      if (existsSync(file)) {\n        watchFile(file, { interval: 1000 }, () => {\n          this.config.logger(`File changed: ${file}`);\n          this.emit('fileChange', { file });\n        });\n        this.watchingFiles.push(file);\n      }\n    }\n  }\n\n  /**\n   * Stop watching files\n   */\n  unwatchFiles(): void {\n    for (const file of this.watchingFiles) {\n      unwatchFile(file);\n    }\n    this.watchingFiles = [];\n  }\n\n  // ==========================================================================\n  // STATE PRESERVATION\n  // ==========================================================================\n\n  /**\n   * Preserve state for reload\n   */\n  preserveState(key: string, value: unknown): void {\n    this.state.preservedState[key] = value;\n    this.saveState();\n  }\n\n  /**\n   * Get preserved state\n   */\n  getPreservedState<T>(key: string): T | undefined {\n    return this.state.preservedState[key] as T | undefined;\n  }\n\n  /**\n   * Clear preserved state\n   */\n  clearPreservedState(): void {\n    this.state.preservedState = {};\n    this.saveState();\n  }\n\n  // ==========================================================================\n  // EVENT EMITTING\n  // ==========================================================================\n\n  private emitEvent(type: HotReloadEventType, data?: Record<string, unknown>): void {\n    const event: HotReloadEvent = {\n      type,\n      timestamp: Date.now(),\n      data,\n    };\n    this.emit(type, event);\n    this.emit('hotReload', event);\n  }\n\n  // ==========================================================================\n  // CLEANUP\n  // ==========================================================================\n\n  /**\n   * Cleanup resources\n   */\n  dispose(): void {\n    this.stopAutoCheck();\n    this.unwatchFiles();\n    this.removeAllListeners();\n  }\n\n  // ==========================================================================\n  // STATIC UTILITIES\n  // ==========================================================================\n\n  /**\n   * Check if we should resume from a hot reload\n   */\n  static shouldResume(): boolean {\n    try {\n      if (!existsSync(STATE_FILE)) return false;\n      const state = JSON.parse(readFileSync(STATE_FILE, 'utf8')) as HotReloadState;\n      return Object.keys(state.preservedState || {}).length > 0;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Get preserved state from previous session\n   */\n  static getResumeState(): Record<string, unknown> | null {\n    try {\n      if (!existsSync(STATE_FILE)) return null;\n      const state = JSON.parse(readFileSync(STATE_FILE, 'utf8')) as HotReloadState;\n      return state.preservedState || null;\n    } catch {\n      return null;\n    }\n  }\n}\n\n// ============================================================================\n// SINGLETON EXPORT\n// ============================================================================\n\nlet hotReloadInstance: HotReload | null = null;\n\nexport function getHotReload(config?: HotReloadConfig): HotReload {\n  if (!hotReloadInstance || config) {\n    hotReloadInstance = new HotReload(config);\n  }\n  return hotReloadInstance;\n}\n\nexport function resetHotReload(): void {\n  if (hotReloadInstance) {\n    hotReloadInstance.dispose();\n  }\n  hotReloadInstance = null;\n}\n\n// ============================================================================\n// CONVENIENCE FUNCTIONS\n// ============================================================================\n\n/**\n * Quick check and reload if update available\n */\nexport async function checkAndReload(options: {\n  preserveState?: Record<string, unknown>;\n  rlContext?: RLUpgradeContext;\n  logger?: (message: string) => void;\n} = {}): Promise<boolean> {\n  const hotReload = getHotReload({ logger: options.logger });\n  const result = await hotReload.performHotReload(options);\n  return result.success;\n}\n\n/**\n * Enable auto-checking for updates\n */\nexport function enableAutoCheck(intervalMs?: number): void {\n  const hotReload = getHotReload({\n    autoCheck: true,\n    checkInterval: intervalMs,\n  });\n  hotReload.startAutoCheck();\n}\n\n/**\n * Disable auto-checking for updates\n */\nexport function disableAutoCheck(): void {\n  const hotReload = getHotReload();\n  hotReload.stopAutoCheck();\n}\n"],"mappings":"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","ignoreList":[]}