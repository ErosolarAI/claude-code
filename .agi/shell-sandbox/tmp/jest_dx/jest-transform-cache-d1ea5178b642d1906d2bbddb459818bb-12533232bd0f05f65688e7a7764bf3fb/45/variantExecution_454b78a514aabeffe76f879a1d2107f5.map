{"version":3,"names":["resolveWorkspaceRoot","variant","context","variantWorkspaceRoots","primary","canRunVariantsParallel","modeDefinition","parallelVariants","primaryRoot","refinerRoot","refiner","Boolean","executeVariants","options","module","step","mode","executeVariant","emit","variantResults","type","timestamp","Date","now","data","moduleId","id","stepId","variants","results","Promise","all","map","result","previousResult","undefined","workspaceRoot","repoPolicy","entry","primaryResult"],"sources":["variantExecution.ts"],"sourcesContent":["import type {\n  RepoUpgradeMode,\n  RepoUpgradeModeDefinition,\n  RepoUpgradeModule,\n  RepoUpgradeStep,\n  UpgradeStepExecutionInput,\n  UpgradeStepResult,\n  UpgradeVariant,\n} from './repoUpgradeOrchestrator.js';\n\nexport interface VariantExecutionContext {\n  parallelVariants?: boolean;\n  variantWorkspaceRoots?: Partial<Record<UpgradeVariant, string>>;\n  repoPolicy?: string;\n}\n\nexport interface VariantExecutionOptions {\n  module: RepoUpgradeModule;\n  step: RepoUpgradeStep;\n  mode: RepoUpgradeMode;\n  modeDefinition: RepoUpgradeModeDefinition;\n  context: VariantExecutionContext;\n  executeVariant: (input: UpgradeStepExecutionInput) => Promise<UpgradeStepResult>;\n  emit?: (event: { type: string; timestamp: number; data?: Record<string, unknown> }) => void;\n}\n\nexport function resolveWorkspaceRoot(\n  variant: UpgradeVariant,\n  context: VariantExecutionContext\n): string | undefined {\n  return context.variantWorkspaceRoots?.[variant] ?? context.variantWorkspaceRoots?.primary;\n}\n\nexport function canRunVariantsParallel(\n  modeDefinition: RepoUpgradeModeDefinition,\n  context: VariantExecutionContext\n): boolean {\n  if (!modeDefinition.parallelVariants || !context.parallelVariants) {\n    return false;\n  }\n  const primaryRoot = context.variantWorkspaceRoots?.primary;\n  const refinerRoot = context.variantWorkspaceRoots?.refiner;\n  return Boolean(primaryRoot && refinerRoot && primaryRoot !== refinerRoot);\n}\n\nexport async function executeVariants(\n  options: VariantExecutionOptions\n): Promise<Partial<Record<UpgradeVariant, UpgradeStepResult>>> {\n  const { module, step, mode, modeDefinition, context, executeVariant, emit } = options;\n  const variantResults: Partial<Record<UpgradeVariant, UpgradeStepResult>> = {};\n\n  if (canRunVariantsParallel(modeDefinition, context)) {\n    emit?.({\n      type: 'upgrade.step.variants.parallel',\n      timestamp: Date.now(),\n      data: { moduleId: module.id, stepId: step.id, variants: modeDefinition.variants },\n    });\n\n    const results = await Promise.all(\n      modeDefinition.variants.map(async (variant) => {\n        const result = await executeVariant({\n          module,\n          step,\n          mode,\n          variant,\n          previousResult: undefined,\n          workspaceRoot: resolveWorkspaceRoot(variant, context),\n          repoPolicy: context.repoPolicy,\n        });\n        return { variant, result };\n      })\n    );\n    for (const entry of results) {\n      variantResults[entry.variant] = entry.result;\n    }\n  } else {\n    let primaryResult: UpgradeStepResult | undefined;\n    for (const variant of modeDefinition.variants) {\n      const previousResult = variant === 'refiner' ? primaryResult : undefined;\n      const result = await executeVariant({\n        module,\n        step,\n        mode,\n        variant,\n        previousResult,\n        workspaceRoot: resolveWorkspaceRoot(variant, context),\n        repoPolicy: context.repoPolicy,\n      });\n      variantResults[variant] = result;\n      if (variant === 'primary') {\n        primaryResult = result;\n      }\n    }\n  }\n\n  return variantResults;\n}\n"],"mappings":";;;;;;;;AA0BO,SAASA,oBAAoBA,CAClCC,OAAuB,EACvBC,OAAgC,EACZ;EACpB,OAAOA,OAAO,CAACC,qBAAqB,GAAGF,OAAO,CAAC,IAAIC,OAAO,CAACC,qBAAqB,EAAEC,OAAO;AAC3F;AAEO,SAASC,sBAAsBA,CACpCC,cAAyC,EACzCJ,OAAgC,EACvB;EACT,IAAI,CAACI,cAAc,CAACC,gBAAgB,IAAI,CAACL,OAAO,CAACK,gBAAgB,EAAE;IACjE,OAAO,KAAK;EACd;EACA,MAAMC,WAAW,GAAGN,OAAO,CAACC,qBAAqB,EAAEC,OAAO;EAC1D,MAAMK,WAAW,GAAGP,OAAO,CAACC,qBAAqB,EAAEO,OAAO;EAC1D,OAAOC,OAAO,CAACH,WAAW,IAAIC,WAAW,IAAID,WAAW,KAAKC,WAAW,CAAC;AAC3E;AAEO,eAAeG,eAAeA,CACnCC,OAAgC,EAC6B;EAC7D,MAAM;IAAEC,MAAM;IAAEC,IAAI;IAAEC,IAAI;IAAEV,cAAc;IAAEJ,OAAO;IAAEe,cAAc;IAAEC;EAAK,CAAC,GAAGL,OAAO;EACrF,MAAMM,cAAkE,GAAG,CAAC,CAAC;EAE7E,IAAId,sBAAsB,CAACC,cAAc,EAAEJ,OAAO,CAAC,EAAE;IACnDgB,IAAI,GAAG;MACLE,IAAI,EAAE,gCAAgC;MACtCC,SAAS,EAAEC,IAAI,CAACC,GAAG,CAAC,CAAC;MACrBC,IAAI,EAAE;QAAEC,QAAQ,EAAEX,MAAM,CAACY,EAAE;QAAEC,MAAM,EAAEZ,IAAI,CAACW,EAAE;QAAEE,QAAQ,EAAEtB,cAAc,CAACsB;MAAS;IAClF,CAAC,CAAC;IAEF,MAAMC,OAAO,GAAG,MAAMC,OAAO,CAACC,GAAG,CAC/BzB,cAAc,CAACsB,QAAQ,CAACI,GAAG,CAAC,MAAO/B,OAAO,IAAK;MAC7C,MAAMgC,MAAM,GAAG,MAAMhB,cAAc,CAAC;QAClCH,MAAM;QACNC,IAAI;QACJC,IAAI;QACJf,OAAO;QACPiC,cAAc,EAAEC,SAAS;QACzBC,aAAa,EAAEpC,oBAAoB,CAACC,OAAO,EAAEC,OAAO,CAAC;QACrDmC,UAAU,EAAEnC,OAAO,CAACmC;MACtB,CAAC,CAAC;MACF,OAAO;QAAEpC,OAAO;QAAEgC;MAAO,CAAC;IAC5B,CAAC,CACH,CAAC;IACD,KAAK,MAAMK,KAAK,IAAIT,OAAO,EAAE;MAC3BV,cAAc,CAACmB,KAAK,CAACrC,OAAO,CAAC,GAAGqC,KAAK,CAACL,MAAM;IAC9C;EACF,CAAC,MAAM;IACL,IAAIM,aAA4C;IAChD,KAAK,MAAMtC,OAAO,IAAIK,cAAc,CAACsB,QAAQ,EAAE;MAC7C,MAAMM,cAAc,GAAGjC,OAAO,KAAK,SAAS,GAAGsC,aAAa,GAAGJ,SAAS;MACxE,MAAMF,MAAM,GAAG,MAAMhB,cAAc,CAAC;QAClCH,MAAM;QACNC,IAAI;QACJC,IAAI;QACJf,OAAO;QACPiC,cAAc;QACdE,aAAa,EAAEpC,oBAAoB,CAACC,OAAO,EAAEC,OAAO,CAAC;QACrDmC,UAAU,EAAEnC,OAAO,CAACmC;MACtB,CAAC,CAAC;MACFlB,cAAc,CAAClB,OAAO,CAAC,GAAGgC,MAAM;MAChC,IAAIhC,OAAO,KAAK,SAAS,EAAE;QACzBsC,aAAa,GAAGN,MAAM;MACxB;IACF;EACF;EAEA,OAAOd,cAAc;AACvB","ignoreList":[]}