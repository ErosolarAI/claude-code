4b06af0f742097ae047f536e39924a96
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.canRunVariantsParallel = canRunVariantsParallel;
exports.executeVariants = executeVariants;
exports.resolveWorkspaceRoot = resolveWorkspaceRoot;
function resolveWorkspaceRoot(variant, context) {
  return context.variantWorkspaceRoots?.[variant] ?? context.variantWorkspaceRoots?.primary;
}
function canRunVariantsParallel(modeDefinition, context) {
  if (!modeDefinition.parallelVariants || !context.parallelVariants) {
    return false;
  }
  const primaryRoot = context.variantWorkspaceRoots?.primary;
  const refinerRoot = context.variantWorkspaceRoots?.refiner;
  return Boolean(primaryRoot && refinerRoot && primaryRoot !== refinerRoot);
}
async function executeVariants(options) {
  const {
    module,
    step,
    mode,
    modeDefinition,
    context,
    executeVariant,
    emit
  } = options;
  const variantResults = {};
  if (canRunVariantsParallel(modeDefinition, context)) {
    emit?.({
      type: 'upgrade.step.variants.parallel',
      timestamp: Date.now(),
      data: {
        moduleId: module.id,
        stepId: step.id,
        variants: modeDefinition.variants
      }
    });
    const results = await Promise.all(modeDefinition.variants.map(async variant => {
      const result = await executeVariant({
        module,
        step,
        mode,
        variant,
        previousResult: undefined,
        workspaceRoot: resolveWorkspaceRoot(variant, context),
        repoPolicy: context.repoPolicy
      });
      return {
        variant,
        result
      };
    }));
    for (const entry of results) {
      variantResults[entry.variant] = entry.result;
    }
  } else {
    let primaryResult;
    for (const variant of modeDefinition.variants) {
      const previousResult = variant === 'refiner' ? primaryResult : undefined;
      const result = await executeVariant({
        module,
        step,
        mode,
        variant,
        previousResult,
        workspaceRoot: resolveWorkspaceRoot(variant, context),
        repoPolicy: context.repoPolicy
      });
      variantResults[variant] = result;
      if (variant === 'primary') {
        primaryResult = result;
      }
    }
  }
  return variantResults;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJyZXNvbHZlV29ya3NwYWNlUm9vdCIsInZhcmlhbnQiLCJjb250ZXh0IiwidmFyaWFudFdvcmtzcGFjZVJvb3RzIiwicHJpbWFyeSIsImNhblJ1blZhcmlhbnRzUGFyYWxsZWwiLCJtb2RlRGVmaW5pdGlvbiIsInBhcmFsbGVsVmFyaWFudHMiLCJwcmltYXJ5Um9vdCIsInJlZmluZXJSb290IiwicmVmaW5lciIsIkJvb2xlYW4iLCJleGVjdXRlVmFyaWFudHMiLCJvcHRpb25zIiwibW9kdWxlIiwic3RlcCIsIm1vZGUiLCJleGVjdXRlVmFyaWFudCIsImVtaXQiLCJ2YXJpYW50UmVzdWx0cyIsInR5cGUiLCJ0aW1lc3RhbXAiLCJEYXRlIiwibm93IiwiZGF0YSIsIm1vZHVsZUlkIiwiaWQiLCJzdGVwSWQiLCJ2YXJpYW50cyIsInJlc3VsdHMiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwicmVzdWx0IiwicHJldmlvdXNSZXN1bHQiLCJ1bmRlZmluZWQiLCJ3b3Jrc3BhY2VSb290IiwicmVwb1BvbGljeSIsImVudHJ5IiwicHJpbWFyeVJlc3VsdCJdLCJzb3VyY2VzIjpbInZhcmlhbnRFeGVjdXRpb24udHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUge1xuICBSZXBvVXBncmFkZU1vZGUsXG4gIFJlcG9VcGdyYWRlTW9kZURlZmluaXRpb24sXG4gIFJlcG9VcGdyYWRlTW9kdWxlLFxuICBSZXBvVXBncmFkZVN0ZXAsXG4gIFVwZ3JhZGVTdGVwRXhlY3V0aW9uSW5wdXQsXG4gIFVwZ3JhZGVTdGVwUmVzdWx0LFxuICBVcGdyYWRlVmFyaWFudCxcbn0gZnJvbSAnLi9yZXBvVXBncmFkZU9yY2hlc3RyYXRvci5qcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVmFyaWFudEV4ZWN1dGlvbkNvbnRleHQge1xuICBwYXJhbGxlbFZhcmlhbnRzPzogYm9vbGVhbjtcbiAgdmFyaWFudFdvcmtzcGFjZVJvb3RzPzogUGFydGlhbDxSZWNvcmQ8VXBncmFkZVZhcmlhbnQsIHN0cmluZz4+O1xuICByZXBvUG9saWN5Pzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFZhcmlhbnRFeGVjdXRpb25PcHRpb25zIHtcbiAgbW9kdWxlOiBSZXBvVXBncmFkZU1vZHVsZTtcbiAgc3RlcDogUmVwb1VwZ3JhZGVTdGVwO1xuICBtb2RlOiBSZXBvVXBncmFkZU1vZGU7XG4gIG1vZGVEZWZpbml0aW9uOiBSZXBvVXBncmFkZU1vZGVEZWZpbml0aW9uO1xuICBjb250ZXh0OiBWYXJpYW50RXhlY3V0aW9uQ29udGV4dDtcbiAgZXhlY3V0ZVZhcmlhbnQ6IChpbnB1dDogVXBncmFkZVN0ZXBFeGVjdXRpb25JbnB1dCkgPT4gUHJvbWlzZTxVcGdyYWRlU3RlcFJlc3VsdD47XG4gIGVtaXQ/OiAoZXZlbnQ6IHsgdHlwZTogc3RyaW5nOyB0aW1lc3RhbXA6IG51bWJlcjsgZGF0YT86IFJlY29yZDxzdHJpbmcsIHVua25vd24+IH0pID0+IHZvaWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXNvbHZlV29ya3NwYWNlUm9vdChcbiAgdmFyaWFudDogVXBncmFkZVZhcmlhbnQsXG4gIGNvbnRleHQ6IFZhcmlhbnRFeGVjdXRpb25Db250ZXh0XG4pOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICByZXR1cm4gY29udGV4dC52YXJpYW50V29ya3NwYWNlUm9vdHM/Llt2YXJpYW50XSA/PyBjb250ZXh0LnZhcmlhbnRXb3Jrc3BhY2VSb290cz8ucHJpbWFyeTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNhblJ1blZhcmlhbnRzUGFyYWxsZWwoXG4gIG1vZGVEZWZpbml0aW9uOiBSZXBvVXBncmFkZU1vZGVEZWZpbml0aW9uLFxuICBjb250ZXh0OiBWYXJpYW50RXhlY3V0aW9uQ29udGV4dFxuKTogYm9vbGVhbiB7XG4gIGlmICghbW9kZURlZmluaXRpb24ucGFyYWxsZWxWYXJpYW50cyB8fCAhY29udGV4dC5wYXJhbGxlbFZhcmlhbnRzKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIGNvbnN0IHByaW1hcnlSb290ID0gY29udGV4dC52YXJpYW50V29ya3NwYWNlUm9vdHM/LnByaW1hcnk7XG4gIGNvbnN0IHJlZmluZXJSb290ID0gY29udGV4dC52YXJpYW50V29ya3NwYWNlUm9vdHM/LnJlZmluZXI7XG4gIHJldHVybiBCb29sZWFuKHByaW1hcnlSb290ICYmIHJlZmluZXJSb290ICYmIHByaW1hcnlSb290ICE9PSByZWZpbmVyUm9vdCk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBleGVjdXRlVmFyaWFudHMoXG4gIG9wdGlvbnM6IFZhcmlhbnRFeGVjdXRpb25PcHRpb25zXG4pOiBQcm9taXNlPFBhcnRpYWw8UmVjb3JkPFVwZ3JhZGVWYXJpYW50LCBVcGdyYWRlU3RlcFJlc3VsdD4+PiB7XG4gIGNvbnN0IHsgbW9kdWxlLCBzdGVwLCBtb2RlLCBtb2RlRGVmaW5pdGlvbiwgY29udGV4dCwgZXhlY3V0ZVZhcmlhbnQsIGVtaXQgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHZhcmlhbnRSZXN1bHRzOiBQYXJ0aWFsPFJlY29yZDxVcGdyYWRlVmFyaWFudCwgVXBncmFkZVN0ZXBSZXN1bHQ+PiA9IHt9O1xuXG4gIGlmIChjYW5SdW5WYXJpYW50c1BhcmFsbGVsKG1vZGVEZWZpbml0aW9uLCBjb250ZXh0KSkge1xuICAgIGVtaXQ/Lih7XG4gICAgICB0eXBlOiAndXBncmFkZS5zdGVwLnZhcmlhbnRzLnBhcmFsbGVsJyxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIGRhdGE6IHsgbW9kdWxlSWQ6IG1vZHVsZS5pZCwgc3RlcElkOiBzdGVwLmlkLCB2YXJpYW50czogbW9kZURlZmluaXRpb24udmFyaWFudHMgfSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIG1vZGVEZWZpbml0aW9uLnZhcmlhbnRzLm1hcChhc3luYyAodmFyaWFudCkgPT4ge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBleGVjdXRlVmFyaWFudCh7XG4gICAgICAgICAgbW9kdWxlLFxuICAgICAgICAgIHN0ZXAsXG4gICAgICAgICAgbW9kZSxcbiAgICAgICAgICB2YXJpYW50LFxuICAgICAgICAgIHByZXZpb3VzUmVzdWx0OiB1bmRlZmluZWQsXG4gICAgICAgICAgd29ya3NwYWNlUm9vdDogcmVzb2x2ZVdvcmtzcGFjZVJvb3QodmFyaWFudCwgY29udGV4dCksXG4gICAgICAgICAgcmVwb1BvbGljeTogY29udGV4dC5yZXBvUG9saWN5LFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHsgdmFyaWFudCwgcmVzdWx0IH07XG4gICAgICB9KVxuICAgICk7XG4gICAgZm9yIChjb25zdCBlbnRyeSBvZiByZXN1bHRzKSB7XG4gICAgICB2YXJpYW50UmVzdWx0c1tlbnRyeS52YXJpYW50XSA9IGVudHJ5LnJlc3VsdDtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbGV0IHByaW1hcnlSZXN1bHQ6IFVwZ3JhZGVTdGVwUmVzdWx0IHwgdW5kZWZpbmVkO1xuICAgIGZvciAoY29uc3QgdmFyaWFudCBvZiBtb2RlRGVmaW5pdGlvbi52YXJpYW50cykge1xuICAgICAgY29uc3QgcHJldmlvdXNSZXN1bHQgPSB2YXJpYW50ID09PSAncmVmaW5lcicgPyBwcmltYXJ5UmVzdWx0IDogdW5kZWZpbmVkO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZXhlY3V0ZVZhcmlhbnQoe1xuICAgICAgICBtb2R1bGUsXG4gICAgICAgIHN0ZXAsXG4gICAgICAgIG1vZGUsXG4gICAgICAgIHZhcmlhbnQsXG4gICAgICAgIHByZXZpb3VzUmVzdWx0LFxuICAgICAgICB3b3Jrc3BhY2VSb290OiByZXNvbHZlV29ya3NwYWNlUm9vdCh2YXJpYW50LCBjb250ZXh0KSxcbiAgICAgICAgcmVwb1BvbGljeTogY29udGV4dC5yZXBvUG9saWN5LFxuICAgICAgfSk7XG4gICAgICB2YXJpYW50UmVzdWx0c1t2YXJpYW50XSA9IHJlc3VsdDtcbiAgICAgIGlmICh2YXJpYW50ID09PSAncHJpbWFyeScpIHtcbiAgICAgICAgcHJpbWFyeVJlc3VsdCA9IHJlc3VsdDtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gdmFyaWFudFJlc3VsdHM7XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBMEJPLFNBQVNBLG9CQUFvQkEsQ0FDbENDLE9BQXVCLEVBQ3ZCQyxPQUFnQyxFQUNaO0VBQ3BCLE9BQU9BLE9BQU8sQ0FBQ0MscUJBQXFCLEdBQUdGLE9BQU8sQ0FBQyxJQUFJQyxPQUFPLENBQUNDLHFCQUFxQixFQUFFQyxPQUFPO0FBQzNGO0FBRU8sU0FBU0Msc0JBQXNCQSxDQUNwQ0MsY0FBeUMsRUFDekNKLE9BQWdDLEVBQ3ZCO0VBQ1QsSUFBSSxDQUFDSSxjQUFjLENBQUNDLGdCQUFnQixJQUFJLENBQUNMLE9BQU8sQ0FBQ0ssZ0JBQWdCLEVBQUU7SUFDakUsT0FBTyxLQUFLO0VBQ2Q7RUFDQSxNQUFNQyxXQUFXLEdBQUdOLE9BQU8sQ0FBQ0MscUJBQXFCLEVBQUVDLE9BQU87RUFDMUQsTUFBTUssV0FBVyxHQUFHUCxPQUFPLENBQUNDLHFCQUFxQixFQUFFTyxPQUFPO0VBQzFELE9BQU9DLE9BQU8sQ0FBQ0gsV0FBVyxJQUFJQyxXQUFXLElBQUlELFdBQVcsS0FBS0MsV0FBVyxDQUFDO0FBQzNFO0FBRU8sZUFBZUcsZUFBZUEsQ0FDbkNDLE9BQWdDLEVBQzZCO0VBQzdELE1BQU07SUFBRUMsTUFBTTtJQUFFQyxJQUFJO0lBQUVDLElBQUk7SUFBRVYsY0FBYztJQUFFSixPQUFPO0lBQUVlLGNBQWM7SUFBRUM7RUFBSyxDQUFDLEdBQUdMLE9BQU87RUFDckYsTUFBTU0sY0FBa0UsR0FBRyxDQUFDLENBQUM7RUFFN0UsSUFBSWQsc0JBQXNCLENBQUNDLGNBQWMsRUFBRUosT0FBTyxDQUFDLEVBQUU7SUFDbkRnQixJQUFJLEdBQUc7TUFDTEUsSUFBSSxFQUFFLGdDQUFnQztNQUN0Q0MsU0FBUyxFQUFFQyxJQUFJLENBQUNDLEdBQUcsQ0FBQyxDQUFDO01BQ3JCQyxJQUFJLEVBQUU7UUFBRUMsUUFBUSxFQUFFWCxNQUFNLENBQUNZLEVBQUU7UUFBRUMsTUFBTSxFQUFFWixJQUFJLENBQUNXLEVBQUU7UUFBRUUsUUFBUSxFQUFFdEIsY0FBYyxDQUFDc0I7TUFBUztJQUNsRixDQUFDLENBQUM7SUFFRixNQUFNQyxPQUFPLEdBQUcsTUFBTUMsT0FBTyxDQUFDQyxHQUFHLENBQy9CekIsY0FBYyxDQUFDc0IsUUFBUSxDQUFDSSxHQUFHLENBQUMsTUFBTy9CLE9BQU8sSUFBSztNQUM3QyxNQUFNZ0MsTUFBTSxHQUFHLE1BQU1oQixjQUFjLENBQUM7UUFDbENILE1BQU07UUFDTkMsSUFBSTtRQUNKQyxJQUFJO1FBQ0pmLE9BQU87UUFDUGlDLGNBQWMsRUFBRUMsU0FBUztRQUN6QkMsYUFBYSxFQUFFcEMsb0JBQW9CLENBQUNDLE9BQU8sRUFBRUMsT0FBTyxDQUFDO1FBQ3JEbUMsVUFBVSxFQUFFbkMsT0FBTyxDQUFDbUM7TUFDdEIsQ0FBQyxDQUFDO01BQ0YsT0FBTztRQUFFcEMsT0FBTztRQUFFZ0M7TUFBTyxDQUFDO0lBQzVCLENBQUMsQ0FDSCxDQUFDO0lBQ0QsS0FBSyxNQUFNSyxLQUFLLElBQUlULE9BQU8sRUFBRTtNQUMzQlYsY0FBYyxDQUFDbUIsS0FBSyxDQUFDckMsT0FBTyxDQUFDLEdBQUdxQyxLQUFLLENBQUNMLE1BQU07SUFDOUM7RUFDRixDQUFDLE1BQU07SUFDTCxJQUFJTSxhQUE0QztJQUNoRCxLQUFLLE1BQU10QyxPQUFPLElBQUlLLGNBQWMsQ0FBQ3NCLFFBQVEsRUFBRTtNQUM3QyxNQUFNTSxjQUFjLEdBQUdqQyxPQUFPLEtBQUssU0FBUyxHQUFHc0MsYUFBYSxHQUFHSixTQUFTO01BQ3hFLE1BQU1GLE1BQU0sR0FBRyxNQUFNaEIsY0FBYyxDQUFDO1FBQ2xDSCxNQUFNO1FBQ05DLElBQUk7UUFDSkMsSUFBSTtRQUNKZixPQUFPO1FBQ1BpQyxjQUFjO1FBQ2RFLGFBQWEsRUFBRXBDLG9CQUFvQixDQUFDQyxPQUFPLEVBQUVDLE9BQU8sQ0FBQztRQUNyRG1DLFVBQVUsRUFBRW5DLE9BQU8sQ0FBQ21DO01BQ3RCLENBQUMsQ0FBQztNQUNGbEIsY0FBYyxDQUFDbEIsT0FBTyxDQUFDLEdBQUdnQyxNQUFNO01BQ2hDLElBQUloQyxPQUFPLEtBQUssU0FBUyxFQUFFO1FBQ3pCc0MsYUFBYSxHQUFHTixNQUFNO01BQ3hCO0lBQ0Y7RUFDRjtFQUVBLE9BQU9kLGNBQWM7QUFDdkIiLCJpZ25vcmVMaXN0IjpbXX0=