{"version":3,"names":["_globals","require","_nodeFs","_nodePath","_nodeOs","_hooks","createTempDir","dir","mkdtempSync","join","tmpdir","mkdirSync","recursive","writeHookSettings","root","settingsPath","hooks","UserPromptSubmit","type","prompt","matcher","PreToolUse","writeFileSync","JSON","stringify","tempDirs","afterEach","length","pop","rmSync","force","describe","test","push","manager","createHooksManager","allowed","results","executeUserPromptHooks","expect","toBe","decision","output","toContain","executePreToolHooks","command","blocked","reason","toMatch"],"sources":["hooks.promptHooks.test.ts"],"sourcesContent":["import { afterEach, describe, expect, test } from '@jest/globals';\nimport { mkdirSync, mkdtempSync, rmSync, writeFileSync } from 'node:fs';\nimport { join } from 'node:path';\nimport { tmpdir } from 'node:os';\nimport { createHooksManager } from '../src/core/hooks.js';\n\nfunction createTempDir(): string {\n  const dir = mkdtempSync(join(tmpdir(), 'hooks-'));\n  mkdirSync(join(dir, '.erosolar'), { recursive: true });\n  return dir;\n}\n\nfunction writeHookSettings(root: string) {\n  const settingsPath = join(root, '.erosolar', 'settings.json');\n  const hooks = {\n    hooks: {\n      UserPromptSubmit: [\n        {\n          type: 'prompt',\n          prompt: 'Assess user prompts with AGI and block risky intent',\n          matcher: '.*',\n        },\n      ],\n      PreToolUse: [\n        {\n          type: 'prompt',\n          prompt: 'Evaluate command safety with AGI',\n          matcher: '.*',\n        },\n      ],\n    },\n  };\n  writeFileSync(settingsPath, JSON.stringify(hooks, null, 2));\n}\n\nconst tempDirs: string[] = [];\n\nafterEach(() => {\n  while (tempDirs.length) {\n    const dir = tempDirs.pop();\n    if (dir) {\n      rmSync(dir, { recursive: true, force: true });\n    }\n  }\n});\n\ndescribe('Prompt hooks with AGI backing', () => {\n  test('allows normal user prompts and records AGI analysis', async () => {\n    const root = createTempDir();\n    tempDirs.push(root);\n    writeHookSettings(root);\n\n    const manager = createHooksManager(root);\n    const { allowed, results } = await manager.executeUserPromptHooks('summarize the logs and suggest next steps');\n\n    expect(allowed).toBe(true);\n    expect(results[0]?.decision).toBe('continue');\n    expect(results[0]?.output).toContain('Interpretation');\n    expect(results[0]?.output).toContain('Risk:');\n  });\n\n  test('blocks destructive commands during pre-tool checks', async () => {\n    const root = createTempDir();\n    tempDirs.push(root);\n    writeHookSettings(root);\n\n    const manager = createHooksManager(root);\n    const { allowed, results } = await manager.executePreToolHooks('Bash', { command: 'rm -rf /tmp/kill-everything' });\n\n    expect(allowed).toBe(false);\n    expect(results[0]?.decision).toBe('deny');\n    expect(results[0]?.blocked).toBe(true);\n    expect(results[0]?.reason).toMatch(/High-risk content detected/);\n  });\n});\n"],"mappings":"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","ignoreList":[]}