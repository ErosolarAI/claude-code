{"version":3,"names":["_globals","require","describe","consoleOutput","originalStdoutWrite","beforeEach","process","stdout","write","str","push","afterEach","jest","clearAllTimers","it","mockPromptController","setInlinePanel","fn","clearInlinePanel","setStatusMessage","scheduleInlinePanelDismiss","expect","toHaveBeenCalledWith","arrayContaining","not","toHaveBeenCalled","dismissInlinePanel","useFakeTimers","dismissTimer","clearTimeout","setTimeout","advanceTimersByTime","useRealTimers"],"sources":["inline-panel.test.ts"],"sourcesContent":["/**\n * Test inline panel behavior for /secrets and /help commands\n */\n\nimport { describe, it, expect, jest, beforeEach, afterEach } from '@jest/globals';\n\ndescribe('Inline Panel Behavior', () => {\n  let consoleOutput: string[] = [];\n  let originalStdoutWrite: typeof process.stdout.write;\n\n  beforeEach(() => {\n    consoleOutput = [];\n    originalStdoutWrite = process.stdout.write;\n    // Capture stdout\n    process.stdout.write = ((str: string) => {\n      consoleOutput.push(str);\n      return true;\n    }) as typeof process.stdout.write;\n  });\n\n  afterEach(() => {\n    process.stdout.write = originalStdoutWrite;\n    jest.clearAllTimers();\n  });\n\n  it('should show secrets panel when /secrets is submitted', async () => {\n    // This test verifies that the inline panel is set and not immediately dismissed\n    // when the /secrets command is submitted\n\n    const mockPromptController = {\n      setInlinePanel: jest.fn(),\n      clearInlinePanel: jest.fn(),\n      setStatusMessage: jest.fn(),\n    };\n\n    // Simulate the /secrets command flow\n    const scheduleInlinePanelDismiss = jest.fn();\n\n    // Call setInlinePanel (what showSecrets does)\n    mockPromptController.setInlinePanel(['API Keys:', 'ANTHROPIC_API_KEY: ✓ set']);\n\n    // Schedule auto-dismiss (what showSecrets does)\n    scheduleInlinePanelDismiss();\n\n    // Verify panel was set\n    expect(mockPromptController.setInlinePanel).toHaveBeenCalledWith(\n      expect.arrayContaining(['API Keys:', 'ANTHROPIC_API_KEY: ✓ set'])\n    );\n\n    // Verify panel was NOT cleared immediately\n    expect(mockPromptController.clearInlinePanel).not.toHaveBeenCalled();\n\n    // Verify auto-dismiss was scheduled\n    expect(scheduleInlinePanelDismiss).toHaveBeenCalled();\n  });\n\n  it('should show help panel when /help is submitted', async () => {\n    const mockPromptController = {\n      setInlinePanel: jest.fn(),\n      clearInlinePanel: jest.fn(),\n      setStatusMessage: jest.fn(),\n    };\n\n    const scheduleInlinePanelDismiss = jest.fn();\n\n    // Call setInlinePanel (what showHelp does)\n    mockPromptController.setInlinePanel(['Available Commands:', '/secrets - Manage API keys']);\n\n    // Schedule auto-dismiss (what showHelp does)\n    scheduleInlinePanelDismiss();\n\n    // Verify panel was set\n    expect(mockPromptController.setInlinePanel).toHaveBeenCalledWith(\n      expect.arrayContaining(['Available Commands:', '/secrets - Manage API keys'])\n    );\n\n    // Verify panel was NOT cleared immediately\n    expect(mockPromptController.clearInlinePanel).not.toHaveBeenCalled();\n\n    // Verify auto-dismiss was scheduled\n    expect(scheduleInlinePanelDismiss).toHaveBeenCalled();\n  });\n\n  it('should dismiss panel when regular prompt is submitted', async () => {\n    const mockPromptController = {\n      clearInlinePanel: jest.fn(),\n    };\n\n    const dismissInlinePanel = () => {\n      mockPromptController.clearInlinePanel();\n    };\n\n    // Simulate submitting a regular prompt (not a slash command)\n    dismissInlinePanel();\n\n    // Verify panel was dismissed\n    expect(mockPromptController.clearInlinePanel).toHaveBeenCalled();\n  });\n\n  it('should not dismiss panel on onChange after /secrets', async () => {\n    const mockPromptController = {\n      setInlinePanel: jest.fn(),\n      clearInlinePanel: jest.fn(),\n    };\n\n    // Simulate the /secrets command flow\n    mockPromptController.setInlinePanel(['API Keys:', 'ANTHROPIC_API_KEY: ✓ set']);\n\n    // Simulate onChange callback (which happens when input is cleared after submit)\n    // Before the fix, this would call dismissInlinePanel()\n    // After the fix, onChange no longer dismisses the panel\n\n    // Verify panel was NOT cleared on onChange\n    expect(mockPromptController.clearInlinePanel).not.toHaveBeenCalled();\n  });\n\n  it('should auto-dismiss panel after 8 seconds', async () => {\n    jest.useFakeTimers();\n\n    const mockPromptController = {\n      setInlinePanel: jest.fn(),\n      clearInlinePanel: jest.fn(),\n    };\n\n    let dismissTimer: NodeJS.Timeout | null = null;\n\n    const scheduleInlinePanelDismiss = () => {\n      if (dismissTimer) {\n        clearTimeout(dismissTimer);\n      }\n      dismissTimer = setTimeout(() => {\n        mockPromptController.clearInlinePanel();\n        dismissTimer = null;\n      }, 8000);\n    };\n\n    // Show the panel\n    mockPromptController.setInlinePanel(['API Keys:', 'ANTHROPIC_API_KEY: ✓ set']);\n    scheduleInlinePanelDismiss();\n\n    // Verify panel not dismissed yet\n    expect(mockPromptController.clearInlinePanel).not.toHaveBeenCalled();\n\n    // Fast-forward time by 7 seconds\n    jest.advanceTimersByTime(7000);\n    expect(mockPromptController.clearInlinePanel).not.toHaveBeenCalled();\n\n    // Fast-forward to 8 seconds\n    jest.advanceTimersByTime(1000);\n    expect(mockPromptController.clearInlinePanel).toHaveBeenCalled();\n\n    jest.useRealTimers();\n  });\n});\n"],"mappings":"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","ignoreList":[]}