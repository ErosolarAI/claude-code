3e6f2c05ffa9bcaef0e1f703b5743803
"use strict";

// Mock modules that rely on import.meta or heavy runtime wiring
_getJestObj().mock('../../src/runtime/node.js', () => ({
  createNodeRuntime: _globals.jest.fn(() => {
    throw new Error('createNodeRuntime should not be called in unit tests');
  })
}));
_getJestObj().mock('../../src/config.js', () => ({
  resolveProfileConfig: _globals.jest.fn(() => ({
    provider: 'test-provider',
    model: 'test-model',
    temperature: 0,
    maxTokens: 128,
    systemPrompt: 'sys'
  }))
}));
var _globals = require("@jest/globals");
var _agentController = require("../../src/runtime/agentController.js");
function _getJestObj() {
  const {
    jest
  } = require("@jest/globals");
  _getJestObj = () => jest;
  return jest;
}
function makeFakeSession(sendImpl) {
  return {
    profileConfig: {
      provider: 'test-provider',
      model: 'test-model',
      temperature: 0,
      maxTokens: 128,
      systemPrompt: 'sys'
    },
    createAgent: (_selection, callbacks) => {
      let history = [];
      return {
        send: sendImpl,
        loadHistory: h => {
          history = h;
        },
        getHistory: () => history,
        onToolCall: callbacks?.onToolCall
      };
    }
  };
}
(0, _globals.afterEach)(() => {
  delete process.env.AGI_AGENT_RUN_TIMEOUT_MS;
});
(0, _globals.describe)('AgentController cancellation and timeout (core-first)', () => {
  (0, _globals.test)('cancel stops an in-flight run and fails the stream', async () => {
    let resolveSend = null;
    const sendImpl = () => new Promise(resolve => {
      resolveSend = resolve;
    });
    const controller = new _agentController.AgentController({
      runtime: {
        session: makeFakeSession(sendImpl)
      },
      sinkRef: {
        current: null
      }
    });
    const iterator = controller.send('hello');
    const first = await iterator.next();
    (0, _globals.expect)(first.value?.type).toBe('message.start');
    controller.cancel('stop now');
    await (0, _globals.expect)(iterator.next()).rejects.toThrow(/stop now/i);
    resolveSend?.();
  });
  (0, _globals.test)('times out when run exceeds configured limit', async () => {
    process.env.AGI_AGENT_RUN_TIMEOUT_MS = '10';
    const sendImpl = () => new Promise(resolve => setTimeout(resolve, 50));
    const controller = new _agentController.AgentController({
      runtime: {
        session: makeFakeSession(sendImpl)
      },
      sinkRef: {
        current: null
      }
    });
    const iterator = controller.send('hello');
    const first = await iterator.next();
    (0, _globals.expect)(first.value?.type).toBe('message.start');
    await (0, _globals.expect)(iterator.next()).rejects.toThrow(/timed out/i);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZ2V0SmVzdE9iaiIsIm1vY2siLCJjcmVhdGVOb2RlUnVudGltZSIsImplc3QiLCJmbiIsIkVycm9yIiwicmVzb2x2ZVByb2ZpbGVDb25maWciLCJwcm92aWRlciIsIm1vZGVsIiwidGVtcGVyYXR1cmUiLCJtYXhUb2tlbnMiLCJzeXN0ZW1Qcm9tcHQiLCJfZ2xvYmFscyIsInJlcXVpcmUiLCJfYWdlbnRDb250cm9sbGVyIiwibWFrZUZha2VTZXNzaW9uIiwic2VuZEltcGwiLCJwcm9maWxlQ29uZmlnIiwiY3JlYXRlQWdlbnQiLCJfc2VsZWN0aW9uIiwiY2FsbGJhY2tzIiwiaGlzdG9yeSIsInNlbmQiLCJsb2FkSGlzdG9yeSIsImgiLCJnZXRIaXN0b3J5Iiwib25Ub29sQ2FsbCIsImFmdGVyRWFjaCIsInByb2Nlc3MiLCJlbnYiLCJBR0lfQUdFTlRfUlVOX1RJTUVPVVRfTVMiLCJkZXNjcmliZSIsInRlc3QiLCJyZXNvbHZlU2VuZCIsIlByb21pc2UiLCJyZXNvbHZlIiwiY29udHJvbGxlciIsIkFnZW50Q29udHJvbGxlciIsInJ1bnRpbWUiLCJzZXNzaW9uIiwic2lua1JlZiIsImN1cnJlbnQiLCJpdGVyYXRvciIsImZpcnN0IiwibmV4dCIsImV4cGVjdCIsInZhbHVlIiwidHlwZSIsInRvQmUiLCJjYW5jZWwiLCJyZWplY3RzIiwidG9UaHJvdyIsInNldFRpbWVvdXQiXSwic291cmNlcyI6WyJhZ2VudENvbnRyb2xsZXIuY2FuY2VsLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGVzY3JpYmUsIGV4cGVjdCwgdGVzdCwgYWZ0ZXJFYWNoLCBqZXN0IH0gZnJvbSAnQGplc3QvZ2xvYmFscyc7XG5cbi8vIE1vY2sgbW9kdWxlcyB0aGF0IHJlbHkgb24gaW1wb3J0Lm1ldGEgb3IgaGVhdnkgcnVudGltZSB3aXJpbmdcbmplc3QubW9jaygnLi4vLi4vc3JjL3J1bnRpbWUvbm9kZS5qcycsICgpID0+ICh7XG4gIGNyZWF0ZU5vZGVSdW50aW1lOiBqZXN0LmZuKCgpID0+IHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ2NyZWF0ZU5vZGVSdW50aW1lIHNob3VsZCBub3QgYmUgY2FsbGVkIGluIHVuaXQgdGVzdHMnKTtcbiAgfSksXG59KSk7XG5cbmplc3QubW9jaygnLi4vLi4vc3JjL2NvbmZpZy5qcycsICgpID0+ICh7XG4gIHJlc29sdmVQcm9maWxlQ29uZmlnOiBqZXN0LmZuKCgpID0+ICh7XG4gICAgcHJvdmlkZXI6ICd0ZXN0LXByb3ZpZGVyJyxcbiAgICBtb2RlbDogJ3Rlc3QtbW9kZWwnLFxuICAgIHRlbXBlcmF0dXJlOiAwLFxuICAgIG1heFRva2VuczogMTI4LFxuICAgIHN5c3RlbVByb21wdDogJ3N5cycsXG4gIH0pKSxcbn0pKTtcblxuaW1wb3J0IHsgQWdlbnRDb250cm9sbGVyIH0gZnJvbSAnLi4vLi4vc3JjL3J1bnRpbWUvYWdlbnRDb250cm9sbGVyLmpzJztcbmltcG9ydCB0eXBlIHsgQWdlbnRTZXNzaW9uIH0gZnJvbSAnLi4vLi4vc3JjL3J1bnRpbWUvYWdlbnRTZXNzaW9uLmpzJztcblxuZnVuY3Rpb24gbWFrZUZha2VTZXNzaW9uKHNlbmRJbXBsOiAobWVzc2FnZTogc3RyaW5nLCBhbGxvd1Rvb2xzOiBib29sZWFuKSA9PiBQcm9taXNlPHZvaWQ+KTogQWdlbnRTZXNzaW9uIHtcbiAgcmV0dXJuIHtcbiAgICBwcm9maWxlQ29uZmlnOiB7XG4gICAgICBwcm92aWRlcjogJ3Rlc3QtcHJvdmlkZXInLFxuICAgICAgbW9kZWw6ICd0ZXN0LW1vZGVsJyxcbiAgICAgIHRlbXBlcmF0dXJlOiAwLFxuICAgICAgbWF4VG9rZW5zOiAxMjgsXG4gICAgICBzeXN0ZW1Qcm9tcHQ6ICdzeXMnLFxuICAgIH0sXG4gICAgY3JlYXRlQWdlbnQ6IChfc2VsZWN0aW9uLCBjYWxsYmFja3MpID0+IHtcbiAgICAgIGxldCBoaXN0b3J5OiBhbnlbXSA9IFtdO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc2VuZDogc2VuZEltcGwsXG4gICAgICAgIGxvYWRIaXN0b3J5OiAoaDogYW55W10pID0+IHtcbiAgICAgICAgICBoaXN0b3J5ID0gaDtcbiAgICAgICAgfSxcbiAgICAgICAgZ2V0SGlzdG9yeTogKCkgPT4gaGlzdG9yeSxcbiAgICAgICAgb25Ub29sQ2FsbDogY2FsbGJhY2tzPy5vblRvb2xDYWxsLFxuICAgICAgfSBhcyBhbnk7XG4gICAgfSxcbiAgfSBhcyB1bmtub3duIGFzIEFnZW50U2Vzc2lvbjtcbn1cblxuYWZ0ZXJFYWNoKCgpID0+IHtcbiAgZGVsZXRlIHByb2Nlc3MuZW52LkFHSV9BR0VOVF9SVU5fVElNRU9VVF9NUztcbn0pO1xuXG5kZXNjcmliZSgnQWdlbnRDb250cm9sbGVyIGNhbmNlbGxhdGlvbiBhbmQgdGltZW91dCAoY29yZS1maXJzdCknLCAoKSA9PiB7XG4gIHRlc3QoJ2NhbmNlbCBzdG9wcyBhbiBpbi1mbGlnaHQgcnVuIGFuZCBmYWlscyB0aGUgc3RyZWFtJywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCByZXNvbHZlU2VuZDogKCgpID0+IHZvaWQpIHwgbnVsbCA9IG51bGw7XG4gICAgY29uc3Qgc2VuZEltcGwgPSAoKSA9PlxuICAgICAgbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUpID0+IHtcbiAgICAgICAgcmVzb2x2ZVNlbmQgPSByZXNvbHZlO1xuICAgICAgfSk7XG5cbiAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IEFnZW50Q29udHJvbGxlcih7XG4gICAgICBydW50aW1lOiB7IHNlc3Npb246IG1ha2VGYWtlU2Vzc2lvbihzZW5kSW1wbCkgfSBhcyBhbnksXG4gICAgICBzaW5rUmVmOiB7IGN1cnJlbnQ6IG51bGwgfSxcbiAgICB9KTtcblxuICAgIGNvbnN0IGl0ZXJhdG9yID0gY29udHJvbGxlci5zZW5kKCdoZWxsbycpO1xuICAgIGNvbnN0IGZpcnN0ID0gYXdhaXQgaXRlcmF0b3IubmV4dCgpO1xuICAgIGV4cGVjdChmaXJzdC52YWx1ZT8udHlwZSkudG9CZSgnbWVzc2FnZS5zdGFydCcpO1xuXG4gICAgY29udHJvbGxlci5jYW5jZWwoJ3N0b3Agbm93Jyk7XG4gICAgYXdhaXQgZXhwZWN0KGl0ZXJhdG9yLm5leHQoKSkucmVqZWN0cy50b1Rocm93KC9zdG9wIG5vdy9pKTtcblxuICAgIHJlc29sdmVTZW5kPy4oKTtcbiAgfSk7XG5cbiAgdGVzdCgndGltZXMgb3V0IHdoZW4gcnVuIGV4Y2VlZHMgY29uZmlndXJlZCBsaW1pdCcsIGFzeW5jICgpID0+IHtcbiAgICBwcm9jZXNzLmVudi5BR0lfQUdFTlRfUlVOX1RJTUVPVVRfTVMgPSAnMTAnO1xuICAgIGNvbnN0IHNlbmRJbXBsID0gKCkgPT4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgNTApKTtcblxuICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgQWdlbnRDb250cm9sbGVyKHtcbiAgICAgIHJ1bnRpbWU6IHsgc2Vzc2lvbjogbWFrZUZha2VTZXNzaW9uKHNlbmRJbXBsKSB9IGFzIGFueSxcbiAgICAgIHNpbmtSZWY6IHsgY3VycmVudDogbnVsbCB9LFxuICAgIH0pO1xuXG4gICAgY29uc3QgaXRlcmF0b3IgPSBjb250cm9sbGVyLnNlbmQoJ2hlbGxvJyk7XG4gICAgY29uc3QgZmlyc3QgPSBhd2FpdCBpdGVyYXRvci5uZXh0KCk7XG4gICAgZXhwZWN0KGZpcnN0LnZhbHVlPy50eXBlKS50b0JlKCdtZXNzYWdlLnN0YXJ0Jyk7XG5cbiAgICBhd2FpdCBleHBlY3QoaXRlcmF0b3IubmV4dCgpKS5yZWplY3RzLnRvVGhyb3coL3RpbWVkIG91dC9pKTtcbiAgfSk7XG59KTtcbiJdLCJtYXBwaW5ncyI6Ijs7QUFFQTtBQUNBQSxXQUFBLEdBQUtDLElBQUksQ0FBQywyQkFBMkIsRUFBRSxPQUFPO0VBQzVDQyxpQkFBaUIsRUFBRUMsYUFBSSxDQUFDQyxFQUFFLENBQUMsTUFBTTtJQUMvQixNQUFNLElBQUlDLEtBQUssQ0FBQyxzREFBc0QsQ0FBQztFQUN6RSxDQUFDO0FBQ0gsQ0FBQyxDQUFDLENB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