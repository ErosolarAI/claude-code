{"version":3,"names":["_variantExecution","require","_repoUpgradeOrchestrator","modeDefinition","REPO_UPGRADE_MODE_DEFINITIONS","moduleStub","id","label","scope","steps","stepStub","intent","description","describe","it","expect","canRunVariantsParallel","parallelVariants","variantWorkspaceRoots","primary","refiner","toBe","calls","executor","jest","fn","input","push","success","summary","variant","detail","score","results","executeVariants","module","step","mode","context","executeVariant","toHaveBeenCalledTimes","previousResult","toBeUndefined","emit","toHaveBeenCalledWith","objectContaining","type","data","moduleId","stepId","mock","resolveWorkspaceRoot"],"sources":["variantExecution.test.ts"],"sourcesContent":["import { executeVariants, canRunVariantsParallel, resolveWorkspaceRoot } from '../../src/core/variantExecution.js';\nimport {\n  REPO_UPGRADE_MODE_DEFINITIONS,\n  type RepoUpgradeModule,\n  type RepoUpgradeStep,\n  type UpgradeStepResult,\n  type UpgradeStepExecutionInput,\n} from '../../src/core/repoUpgradeOrchestrator.js';\n\nconst modeDefinition = REPO_UPGRADE_MODE_DEFINITIONS['dual-rl-tournament'];\nconst moduleStub: RepoUpgradeModule = {\n  id: 'mod',\n  label: 'Module',\n  scope: ['src/**/*'],\n  steps: [],\n};\nconst stepStub: RepoUpgradeStep = {\n  id: 'mod-upgrade',\n  intent: 'upgrade',\n  description: 'Upgrade module',\n};\n\ndescribe('canRunVariantsParallel', () => {\n  it('requires refiner root different from primary root', () => {\n    expect(\n      canRunVariantsParallel(modeDefinition, {\n        parallelVariants: true,\n        variantWorkspaceRoots: { primary: '/tmp/a', refiner: '/tmp/b' },\n      })\n    ).toBe(true);\n\n    expect(\n      canRunVariantsParallel(modeDefinition, {\n        parallelVariants: true,\n        variantWorkspaceRoots: { primary: '/tmp/a', refiner: '/tmp/a' },\n      })\n    ).toBe(false);\n  });\n});\n\ndescribe('executeVariants', () => {\n  it('runs sequentially and passes primary result to refiner', async () => {\n    const calls: UpgradeStepExecutionInput[] = [];\n    const executor = jest.fn<Promise<UpgradeStepResult>, [UpgradeStepExecutionInput]>(async (input) => {\n      calls.push(input);\n      return {\n        success: true,\n        summary: `${input.variant}-done`,\n        detail: '',\n        score: input.variant === 'primary' ? 1 : 0.8,\n      };\n    });\n\n    const results = await executeVariants({\n      module: moduleStub,\n      step: stepStub,\n      mode: 'dual-rl-tournament',\n      modeDefinition,\n      context: {\n        parallelVariants: false,\n        variantWorkspaceRoots: { primary: '/tmp/work', refiner: '/tmp/work' },\n      },\n      executeVariant: executor,\n    });\n\n    expect(executor).toHaveBeenCalledTimes(2);\n    expect(calls[0]?.variant).toBe('primary');\n    expect(calls[0]?.previousResult).toBeUndefined();\n    expect(calls[1]?.variant).toBe('refiner');\n    expect(calls[1]?.previousResult?.summary).toBe('primary-done');\n    expect(results.refiner?.summary).toBe('refiner-done');\n  });\n\n  it('runs in parallel when roots differ and emits parallel event', async () => {\n    const executor = jest.fn<Promise<UpgradeStepResult>, [UpgradeStepExecutionInput]>(async (input) => ({\n      success: true,\n      summary: `${input.variant}-done`,\n      detail: '',\n      score: input.variant === 'primary' ? 1 : 0.9,\n    }));\n    const emit = jest.fn();\n\n    const results = await executeVariants({\n      module: moduleStub,\n      step: stepStub,\n      mode: 'dual-rl-tournament',\n      modeDefinition,\n      context: {\n        parallelVariants: true,\n        variantWorkspaceRoots: { primary: '/tmp/primary', refiner: '/tmp/refiner' },\n      },\n      executeVariant: executor,\n      emit,\n    });\n\n    expect(emit).toHaveBeenCalledWith(\n      expect.objectContaining({\n        type: 'upgrade.step.variants.parallel',\n        data: expect.objectContaining({ moduleId: 'mod', stepId: 'mod-upgrade' }),\n      })\n    );\n    expect(executor).toHaveBeenCalledTimes(2);\n    expect(executor.mock.calls[0]?.[0].previousResult).toBeUndefined();\n    expect(executor.mock.calls[1]?.[0].previousResult).toBeUndefined();\n    expect(results.primary?.summary).toBe('primary-done');\n    expect(results.refiner?.summary).toBe('refiner-done');\n  });\n});\n\ndescribe('resolveWorkspaceRoot', () => {\n  it('prefers variant root and falls back to primary', () => {\n    const context = {\n      parallelVariants: true,\n      variantWorkspaceRoots: { primary: '/tmp/primary', refiner: '/tmp/refiner' },\n    };\n    expect(resolveWorkspaceRoot('refiner', context)).toBe('/tmp/refiner');\n    expect(resolveWorkspaceRoot('primary', context)).toBe('/tmp/primary');\n  });\n});\n"],"mappings":";;AAAA,IAAAA,iBAAA,GAAAC,OAAA;AACA,IAAAC,wBAAA,GAAAD,OAAA;AAQA,MAAME,cAAc,GAAGC,sDAA6B,CAAC,oBAAoB,CAAC;AAC1E,MAAMC,UAA6B,GAAG;EACpCC,EAAE,EAAE,KAAK;EACTC,KAAK,EAAE,QAAQ;EACfC,KAAK,EAAE,CAAC,UAAU,CAAC;EACnBC,KAAK,EAAE;AACT,CAAC;AACD,MAAMC,QAAyB,GAAG;EAChCJ,EAAE,EAAE,aAAa;EACjBK,MAAM,EAAE,SAAS;EACjBC,WAAW,EAAE;AACf,CAAC;AAEDC,QAAQ,CAAC,wBAAwB,EAAE,MAAM;EACvCC,EAAE,CAAC,mDAAmD,EAAE,MAAM;IAC5DC,MAAM,CACJ,IAAAC,wCAAsB,EAACb,cAAc,EAAE;MACrCc,gBAAgB,EAAE,IAAI;MACtBC,qBAAqB,EAAE;QAAEC,OAAO,EAAE,QAAQ;QAAEC,OAAO,EAAE;MAAS;IAChE,CAAC,CACH,CAAC,CAACC,IAAI,CAAC,IAAI,CAAC;IAEZN,MAAM,CACJ,IAAAC,wCAAsB,EAACb,cAAc,EAAE;MACrCc,gBAAgB,EAAE,IAAI;MACtBC,qBAAqB,EAAE;QAAEC,OAAO,EAAE,QAAQ;QAAEC,OAAO,EAAE;MAAS;IAChE,CAAC,CACH,CAAC,CAACC,IAAI,CAAC,KAAK,CAAC;EACf,CAAC,CAAC;AACJ,CAAC,CAAC;AAEFR,QAAQ,CAAC,iBAAiB,EAAE,MAAM;EAChCC,EAAE,CAAC,wDAAwD,EAAE,YAAY;IACvE,MAAMQ,KAAkC,GAAG,EAAE;IAC7C,MAAMC,QAAQ,GAAGC,IAAI,CAACC,EAAE,CAA0D,MAAOC,KAAK,IAAK;MACjGJ,KAAK,CAACK,IAAI,CAACD,KAAK,CAAC;MACjB,OAAO;QACLE,OAAO,EAAE,IAAI;QACbC,OAAO,EAAE,GAAGH,KAAK,CAACI,OAAO,OAAO;QAChCC,MAAM,EAAE,EAAE;QACVC,KAAK,EAAEN,KAAK,CAACI,OAAO,KAAK,SAAS,GAAG,CAAC,GAAG;MAC3C,CAAC;IACH,CAAC,CAAC;IAEF,MAAMG,OAAO,GAAG,MAAM,IAAAC,iCAAe,EAAC;MACpCC,MAAM,EAAE9B,UAAU;MAClB+B,IAAI,EAAE1B,QAAQ;MACd2B,IAAI,EAAE,oBAAoB;MAC1BlC,cAAc;MACdmC,OAAO,EAAE;QACPrB,gBAAgB,EAAE,KAAK;QACvBC,qBAAqB,EAAE;UAAEC,OAAO,EAAE,WAAW;UAAEC,OAAO,EAAE;QAAY;MACtE,CAAC;MACDmB,cAAc,EAAEhB;IAClB,CAAC,CAAC;IAEFR,MAAM,CAACQ,QAAQ,CAAC,CAACiB,qBAAqB,CAAC,CAAC,CAAC;IACzCzB,MAAM,CAACO,KAAK,CAAC,CAAC,CAAC,EAAEQ,OAAO,CAAC,CAACT,IAAI,CAAC,SAAS,CAAC;IACzCN,MAAM,CAACO,KAAK,CAAC,CAAC,CAAC,EAAEmB,cAAc,CAAC,CAACC,aAAa,CAAC,CAAC;IAChD3B,MAAM,CAACO,KAAK,CAAC,CAAC,CAAC,EAAEQ,OAAO,CAAC,CAACT,IAAI,CAAC,SAAS,CAAC;IACzCN,MAAM,CAACO,KAAK,CAAC,CAAC,CAAC,EAAEmB,cAAc,EAAEZ,OAAO,CAAC,CAACR,IAAI,CAAC,cAAc,CAAC;IAC9DN,MAAM,CAACkB,OAAO,CAACb,OAAO,EAAES,OAAO,CAAC,CAACR,IAAI,CAAC,cAAc,CAAC;EACvD,CAAC,CAAC;EAEFP,EAAE,CAAC,6DAA6D,EAAE,YAAY;IAC5E,MAAMS,QAAQ,GAAGC,IAAI,CAACC,EAAE,CAA0D,MAAOC,KAAK,KAAM;MAClGE,OAAO,EAAE,IAAI;MACbC,OAAO,EAAE,GAAGH,KAAK,CAACI,OAAO,OAAO;MAChCC,MAAM,EAAE,EAAE;MACVC,KAAK,EAAEN,KAAK,CAACI,OAAO,KAAK,SAAS,GAAG,CAAC,GAAG;IAC3C,CAAC,CAAC,CAAC;IACH,MAAMa,IAAI,GAAGnB,IAAI,CAACC,EAAE,CAAC,CAAC;IAEtB,MAAMQ,OAAO,GAAG,MAAM,IAAAC,iCAAe,EAAC;MACpCC,MAAM,EAAE9B,UAAU;MAClB+B,IAAI,EAAE1B,QAAQ;MACd2B,IAAI,EAAE,oBAAoB;MAC1BlC,cAAc;MACdmC,OAAO,EAAE;QACPrB,gBAAgB,EAAE,IAAI;QACtBC,qBAAqB,EAAE;UAAEC,OAAO,EAAE,cAAc;UAAEC,OAAO,EAAE;QAAe;MAC5E,CAAC;MACDmB,cAAc,EAAEhB,QAAQ;MACxBoB;IACF,CAAC,CAAC;IAEF5B,MAAM,CAAC4B,IAAI,CAAC,CAACC,oBAAoB,CAC/B7B,MAAM,CAAC8B,gBAAgB,CAAC;MACtBC,IAAI,EAAE,gCAAgC;MACtCC,IAAI,EAAEhC,MAAM,CAAC8B,gBAAgB,CAAC;QAAEG,QAAQ,EAAE,KAAK;QAAEC,MAAM,EAAE;MAAc,CAAC;IAC1E,CAAC,CACH,CAAC;IACDlC,MAAM,CAACQ,QAAQ,CAAC,CAACiB,qBAAqB,CAAC,CAAC,CAAC;IACzCzB,MAAM,CAACQ,QAAQ,CAAC2B,IAAI,CAAC5B,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAACmB,cAAc,CAAC,CAACC,aAAa,CAAC,CAAC;IAClE3B,MAAM,CAACQ,QAAQ,CAAC2B,IAAI,CAAC5B,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAACmB,cAAc,CAAC,CAACC,aAAa,CAAC,CAAC;IAClE3B,MAAM,CAACkB,OAAO,CAACd,OAAO,EAAEU,OAAO,CAAC,CAACR,IAAI,CAAC,cAAc,CAAC;IACrDN,MAAM,CAACkB,OAAO,CAACb,OAAO,EAAES,OAAO,CAAC,CAACR,IAAI,CAAC,cAAc,CAAC;EACvD,CAAC,CAAC;AACJ,CAAC,CAAC;AAEFR,QAAQ,CAAC,sBAAsB,EAAE,MAAM;EACrCC,EAAE,CAAC,gDAAgD,EAAE,MAAM;IACzD,MAAMwB,OAAO,GAAG;MACdrB,gBAAgB,EAAE,IAAI;MACtBC,qBAAqB,EAAE;QAAEC,OAAO,EAAE,cAAc;QAAEC,OAAO,EAAE;MAAe;IAC5E,CAAC;IACDL,MAAM,CAAC,IAAAoC,sCAAoB,EAAC,SAAS,EAAEb,OAAO,CAAC,CAAC,CAACjB,IAAI,CAAC,cAAc,CAAC;IACrEN,MAAM,CAAC,IAAAoC,sCAAoB,EAAC,SAAS,EAAEb,OAAO,CAAC,CAAC,CAACjB,IAAI,CAAC,cAAc,CAAC;EACvE,CAAC,CAAC;AACJ,CAAC,CAAC","ignoreList":[]}