{"version":3,"names":["_repoUpgradeOrchestrator","require","moduleStub","id","label","scope","steps","intent","description","makeExecutor","behavior","input","describe","it","calls","executor","push","score","variant","success","summary","detail","orchestrator","RepoUpgradeOrchestrator","modeDefinition","REPO_UPGRADE_MODE_DEFINITIONS","report","run","modules","mode","continueOnFailure","parallelVariants","variantWorkspaceRoots","primary","expect","map","c","toEqual","winnerVariant","toBeDefined","variants","refiner","Set"],"sources":["repoUpgradeOrchestrator.test.ts"],"sourcesContent":["import { RepoUpgradeOrchestrator, type RepoUpgradeModule, type RepoUpgradeStep, type UpgradeStepExecutionInput, type UpgradeStepResult } from '../../src/core/repoUpgradeOrchestrator.js';\nimport { REPO_UPGRADE_MODE_DEFINITIONS } from '../../src/core/repoUpgradeOrchestrator.js';\n\nconst moduleStub: RepoUpgradeModule = {\n  id: 'mod',\n  label: 'Module',\n  scope: ['src/**/*'],\n  steps: [\n    { id: 'mod-analyze', intent: 'analyze', description: 'analyze' },\n  ] as RepoUpgradeStep[],\n};\n\nfunction makeExecutor(behavior: (input: UpgradeStepExecutionInput) => UpgradeStepResult) {\n  return async (input: UpgradeStepExecutionInput): Promise<UpgradeStepResult> => {\n    return behavior(input);\n  };\n}\n\ndescribe('RepoUpgradeOrchestrator (core flow)', () => {\n  it('runs sequential variants when no refiner workspace is provided', async () => {\n    const calls: UpgradeStepExecutionInput[] = [];\n    const executor = makeExecutor((input) => {\n      calls.push(input);\n      const score = input.variant === 'primary' ? 0.6 : 0.7;\n      return { success: true, summary: `${input.variant}-ok`, detail: '', score };\n    });\n\n    const orchestrator = new RepoUpgradeOrchestrator(executor);\n    const modeDefinition = REPO_UPGRADE_MODE_DEFINITIONS['dual-rl-tournament'];\n\n    const report = await orchestrator.run(\n      { modules: [moduleStub] },\n      {\n        mode: 'dual-rl-tournament',\n        continueOnFailure: true,\n        parallelVariants: false,\n        variantWorkspaceRoots: { primary: '/tmp/work' },\n      }\n    );\n\n    expect(calls.map((c) => c.variant)).toEqual(['primary', 'refiner']);\n    // Tournament might bias primary; ensure both ran and winner recorded\n    expect(report.modules[0]?.steps[0]?.winnerVariant).toBeDefined();\n  });\n\n  it('runs variants in parallel when distinct workspaces are provided', async () => {\n    const variants: string[] = [];\n    const executor = makeExecutor((input) => {\n      variants.push(input.variant);\n      return { success: true, summary: `${input.variant}-ok`, detail: '', score: 0.5 };\n    });\n\n    const orchestrator = new RepoUpgradeOrchestrator(executor);\n    const report = await orchestrator.run(\n      { modules: [moduleStub] },\n      {\n        mode: 'dual-rl-tournament',\n        continueOnFailure: true,\n        parallelVariants: true,\n        variantWorkspaceRoots: { primary: '/tmp/p', refiner: '/tmp/r' },\n      }\n    );\n\n    expect(new Set(variants)).toEqual(new Set(['primary', 'refiner']));\n    expect(report.modules[0]?.steps[0]?.winnerVariant).toBeDefined();\n  });\n});\n"],"mappings":"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","ignoreList":[]}