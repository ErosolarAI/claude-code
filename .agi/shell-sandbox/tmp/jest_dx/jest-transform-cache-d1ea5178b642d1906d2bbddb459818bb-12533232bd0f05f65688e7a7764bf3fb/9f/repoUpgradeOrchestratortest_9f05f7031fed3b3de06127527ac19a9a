aab09889e21ef8248f1fa9ea8420c0d4
"use strict";

var _repoUpgradeOrchestrator = require("../../src/core/repoUpgradeOrchestrator.js");
const moduleStub = {
  id: 'mod',
  label: 'Module',
  scope: ['src/**/*'],
  steps: [{
    id: 'mod-analyze',
    intent: 'analyze',
    description: 'analyze'
  }]
};
function makeExecutor(behavior) {
  return async input => {
    return behavior(input);
  };
}
describe('RepoUpgradeOrchestrator (core flow)', () => {
  it('runs sequential variants when no refiner workspace is provided', async () => {
    const calls = [];
    const executor = makeExecutor(input => {
      calls.push(input);
      const score = input.variant === 'primary' ? 0.6 : 0.7;
      return {
        success: true,
        summary: `${input.variant}-ok`,
        detail: '',
        score
      };
    });
    const orchestrator = new _repoUpgradeOrchestrator.RepoUpgradeOrchestrator(executor);
    const modeDefinition = _repoUpgradeOrchestrator.REPO_UPGRADE_MODE_DEFINITIONS['dual-rl-tournament'];
    const report = await orchestrator.run({
      modules: [moduleStub]
    }, {
      mode: 'dual-rl-tournament',
      continueOnFailure: true,
      parallelVariants: false,
      variantWorkspaceRoots: {
        primary: '/tmp/work'
      }
    });
    expect(calls.map(c => c.variant)).toEqual(['primary', 'refiner']);
    // Tournament might bias primary; ensure both ran and winner recorded
    expect(report.modules[0]?.steps[0]?.winnerVariant).toBeDefined();
  });
  it('runs variants in parallel when distinct workspaces are provided', async () => {
    const variants = [];
    const executor = makeExecutor(input => {
      variants.push(input.variant);
      return {
        success: true,
        summary: `${input.variant}-ok`,
        detail: '',
        score: 0.5
      };
    });
    const orchestrator = new _repoUpgradeOrchestrator.RepoUpgradeOrchestrator(executor);
    const report = await orchestrator.run({
      modules: [moduleStub]
    }, {
      mode: 'dual-rl-tournament',
      continueOnFailure: true,
      parallelVariants: true,
      variantWorkspaceRoots: {
        primary: '/tmp/p',
        refiner: '/tmp/r'
      }
    });
    expect(new Set(variants)).toEqual(new Set(['primary', 'refiner']));
    expect(report.modules[0]?.steps[0]?.winnerVariant).toBeDefined();
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfcmVwb1VwZ3JhZGVPcmNoZXN0cmF0b3IiLCJyZXF1aXJlIiwibW9kdWxlU3R1YiIsImlkIiwibGFiZWwiLCJzY29wZSIsInN0ZXBzIiwiaW50ZW50IiwiZGVzY3JpcHRpb24iLCJtYWtlRXhlY3V0b3IiLCJiZWhhdmlvciIsImlucHV0IiwiZGVzY3JpYmUiLCJpdCIsImNhbGxzIiwiZXhlY3V0b3IiLCJwdXNoIiwic2NvcmUiLCJ2YXJpYW50Iiwic3VjY2VzcyIsInN1bW1hcnkiLCJkZXRhaWwiLCJvcmNoZXN0cmF0b3IiLCJSZXBvVXBncmFkZU9yY2hlc3RyYXRvciIsIm1vZGVEZWZpbml0aW9uIiwiUkVQT19VUEdSQURFX01PREVfREVGSU5JVElPTlMiLCJyZXBvcnQiLCJydW4iLCJtb2R1bGVzIiwibW9kZSIsImNvbnRpbnVlT25GYWlsdXJlIiwicGFyYWxsZWxWYXJpYW50cyIsInZhcmlhbnRXb3Jrc3BhY2VSb290cyIsInByaW1hcnkiLCJleHBlY3QiLCJtYXAiLCJjIiwidG9FcXVhbCIsIndpbm5lclZhcmlhbnQiLCJ0b0JlRGVmaW5lZCIsInZhcmlhbnRzIiwicmVmaW5lciIsIlNldCJdLCJzb3VyY2VzIjpbInJlcG9VcGdyYWRlT3JjaGVzdHJhdG9yLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVwb1VwZ3JhZGVPcmNoZXN0cmF0b3IsIHR5cGUgUmVwb1VwZ3JhZGVNb2R1bGUsIHR5cGUgUmVwb1VwZ3JhZGVTdGVwLCB0eXBlIFVwZ3JhZGVTdGVwRXhlY3V0aW9uSW5wdXQsIHR5cGUgVXBncmFkZVN0ZXBSZXN1bHQgfSBmcm9tICcuLi8uLi9zcmMvY29yZS9yZXBvVXBncmFkZU9yY2hlc3RyYXRvci5qcyc7XG5pbXBvcnQgeyBSRVBPX1VQR1JBREVfTU9ERV9ERUZJTklUSU9OUyB9IGZyb20gJy4uLy4uL3NyYy9jb3JlL3JlcG9VcGdyYWRlT3JjaGVzdHJhdG9yLmpzJztcblxuY29uc3QgbW9kdWxlU3R1YjogUmVwb1VwZ3JhZGVNb2R1bGUgPSB7XG4gIGlkOiAnbW9kJyxcbiAgbGFiZWw6ICdNb2R1bGUnLFxuICBzY29wZTogWydzcmMvKiovKiddLFxuICBzdGVwczogW1xuICAgIHsgaWQ6ICdtb2QtYW5hbHl6ZScsIGludGVudDogJ2FuYWx5emUnLCBkZXNjcmlwdGlvbjogJ2FuYWx5emUnIH0sXG4gIF0gYXMgUmVwb1VwZ3JhZGVTdGVwW10sXG59O1xuXG5mdW5jdGlvbiBtYWtlRXhlY3V0b3IoYmVoYXZpb3I6IChpbnB1dDogVXBncmFkZVN0ZXBFeGVjdXRpb25JbnB1dCkgPT4gVXBncmFkZVN0ZXBSZXN1bHQpIHtcbiAgcmV0dXJuIGFzeW5jIChpbnB1dDogVXBncmFkZVN0ZXBFeGVjdXRpb25JbnB1dCk6IFByb21pc2U8VXBncmFkZVN0ZXBSZXN1bHQ+ID0+IHtcbiAgICByZXR1cm4gYmVoYXZpb3IoaW5wdXQpO1xuICB9O1xufVxuXG5kZXNjcmliZSgnUmVwb1VwZ3JhZGVPcmNoZXN0cmF0b3IgKGNvcmUgZmxvdyknLCAoKSA9PiB7XG4gIGl0KCdydW5zIHNlcXVlbnRpYWwgdmFyaWFudHMgd2hlbiBubyByZWZpbmVyIHdvcmtzcGFjZSBpcyBwcm92aWRlZCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBjYWxsczogVXBncmFkZVN0ZXBFeGVjdXRpb25JbnB1dFtdID0gW107XG4gICAgY29uc3QgZXhlY3V0b3IgPSBtYWtlRXhlY3V0b3IoKGlucHV0KSA9PiB7XG4gICAgICBjYWxscy5wdXNoKGlucHV0KTtcbiAgICAgIGNvbnN0IHNjb3JlID0gaW5wdXQudmFyaWFudCA9PT0gJ3ByaW1hcnknID8gMC42IDogMC43O1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgc3VtbWFyeTogYCR7aW5wdXQudmFyaWFudH0tb2tgLCBkZXRhaWw6ICcnLCBzY29yZSB9O1xuICAgIH0pO1xuXG4gICAgY29uc3Qgb3JjaGVzdHJhdG9yID0gbmV3IFJlcG9VcGdyYWRlT3JjaGVzdHJhdG9yKGV4ZWN1dG9yKTtcbiAgICBjb25zdCBtb2RlRGVmaW5pdGlvbiA9IFJFUE9fVVBHUkFERV9NT0RFX0RFRklOSVRJT05TWydkdWFsLXJsLXRvdXJuYW1lbnQnXTtcblxuICAgIGNvbnN0IHJlcG9ydCA9IGF3YWl0IG9yY2hlc3RyYXRvci5ydW4oXG4gICAgICB7IG1vZHVsZXM6IFttb2R1bGVTdHViXSB9LFxuICAgICAge1xuICAgICAgICBtb2RlOiAnZHVhbC1ybC10b3VybmFtZW50JyxcbiAgICAgICAgY29udGludWVPbkZhaWx1cmU6IHRydWUsXG4gICAgICAgIHBhcmFsbGVsVmFyaWFudHM6IGZhbHNlLFxuICAgICAgICB2YXJpYW50V29ya3NwYWNlUm9vdHM6IHsgcHJpbWFyeTogJy90bXAvd29yaycgfSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgZXhwZWN0KGNhbGxzLm1hcCgoYykgPT4gYy52YXJpYW50KSkudG9FcXVhbChbJ3ByaW1hcnknLCAncmVmaW5lciddKTtcbiAgICAvLyBUb3VybmFtZW50IG1pZ2h0IGJpYXMgcHJpbWFyeTsgZW5zdXJlIGJvdGggcmFuIGFuZCB3aW5uZXIgcmVjb3JkZWRcbiAgICBleHBlY3QocmVwb3J0Lm1vZHVsZXNbMF0/LnN0ZXBzWzBdPy53aW5uZXJWYXJpYW50KS50b0JlRGVmaW5lZCgpO1xuICB9KTtcblxuICBpdCgncnVucyB2YXJpYW50cyBpbiBwYXJhbGxlbCB3aGVuIGRpc3RpbmN0IHdvcmtzcGFjZXMgYXJlIHByb3ZpZGVkJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHZhcmlhbnRzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IGV4ZWN1dG9yID0gbWFrZUV4ZWN1dG9yKChpbnB1dCkgPT4ge1xuICAgICAgdmFyaWFudHMucHVzaChpbnB1dC52YXJpYW50KTtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIHN1bW1hcnk6IGAke2lucHV0LnZhcmlhbnR9LW9rYCwgZGV0YWlsOiAnJywgc2NvcmU6IDAuNSB9O1xuICAgIH0pO1xuXG4gICAgY29uc3Qgb3JjaGVzdHJhdG9yID0gbmV3IFJlcG9VcGdyYWRlT3JjaGVzdHJhdG9yKGV4ZWN1dG9yKTtcbiAgICBjb25zdCByZXBvcnQgPSBhd2FpdCBvcmNoZXN0cmF0b3IucnVuKFxuICAgICAgeyBtb2R1bGVzOiBbbW9kdWxlU3R1Yl0gfSxcbiAgICAgIHtcbiAgICAgICAgbW9kZTogJ2R1YWwtcmwtdG91cm5hbWVudCcsXG4gICAgICAgIGNvbnRpbnVlT25GYWlsdXJlOiB0cnVlLFxuICAgICAgICBwYXJhbGxlbFZhcmlhbnRzOiB0cnVlLFxuICAgICAgICB2YXJpYW50V29ya3NwYWNlUm9vdHM6IHsgcHJpbWFyeTogJy90bXAvcCcsIHJlZmluZXI6ICcvdG1wL3InIH0sXG4gICAgICB9XG4gICAgKTtcblxuICAgIGV4cGVjdChuZXcgU2V0KHZhcmlhbnRzKSkudG9FcXVhbChuZXcgU2V0KFsncHJpbWFyeScsICdyZWZpbmVyJ10pKTtcbiAgICBleHBlY3QocmVwb3J0Lm1vZHVsZXNbMF0/LnN0ZXBzWzBdPy53aW5uZXJWYXJpYW50KS50b0JlRGVmaW5lZCgpO1xuICB9KTtcbn0pO1xuIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQUFBLHdCQUFBLEdBQUFDLE9BQUE7QUFHQSxNQUFNQyxVQUE2QixHQUFHO0VBQ3BDQyxFQUFFLEVBQUUsS0FBSztFQUNUQyxLQUFLLEVBQUUsUUFBUTtFQUNmQyxLQUFLLEVBQUUsQ0FBQyxVQUFVLENBQUM7RUFDbkJDLEtBQUssRUFBRSxDQUNMO0lBQUVILEVBQUUsRUFBRSxhQUFhO0lBQUVJLE1BQU0sRUFBRSxTQUFTO0lBQUVDLFdBQVcsRUFBRTtFQUFVLENBQUM7QUFFcEUsQ0FBQztBQUVELFNBQVNDLFlBQVlBLENBQUNDLFFBQWlFLEVBQUU7RUFDdkYsT0FBTyxNQUFPQyxLQUFnQyxJQUFpQztJQUM3RSxPQUFPRCxRQUFRLENBQUNDLEtBQUssQ0FBQztFQUN4QixDQUFDO0FBQ0g7QUFFQUMsUUFBUSxDQUFDLHFDQUFxQyxFQUFFLE1BQU07RUFDcERDLEVBQUUsQ0FBQyxnRUFB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