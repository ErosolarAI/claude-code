afecac0853f3271c0cd5baa0f27d210d
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createErrorDetails = createErrorDetails;
exports.formatErrorForLogging = formatErrorForLogging;
exports.isRetryableError = isRetryableError;
exports.withRetry = withRetry;
var _asyncUtils = require("./asyncUtils.js");
const RETRYABLE_KEYWORDS = ['timeout', 'network', 'rate limit', 'too many requests', 'service unavailable'];
function deriveErrorCode(error) {
  if (error.name && error.name !== 'Error') {
    return error.name.toUpperCase();
  }
  const normalized = error.message.trim().replace(/[^\w]+/g, '_').replace(/^_+|_+$/g, '').toUpperCase();
  return normalized || undefined;
}
function createErrorDetails(error, context) {
  const timestamp = new Date().toISOString();
  if (error instanceof Error) {
    return {
      message: error.message,
      code: deriveErrorCode(error),
      context,
      stack: error.stack,
      timestamp
    };
  }
  return {
    message: String(error),
    context,
    timestamp
  };
}
function formatErrorForLogging(error, context) {
  const details = createErrorDetails(error, context);
  const parts = [`Error: ${details.message}`];
  if (context) {
    parts.push(`Context: ${JSON.stringify(context)}`);
  }
  parts.push(`Stack: ${details.stack ?? '(not available)'}`);
  parts.push(`Timestamp: ${details.timestamp}`);
  return parts.join('\n');
}
function isRetryableError(error) {
  if (error && typeof error === 'object' && 'retryable' in error) {
    const retryableFlag = error.retryable;
    if (typeof retryableFlag === 'boolean') {
      return retryableFlag;
    }
  }
  const message = error instanceof Error ? error.message : typeof error === 'string' ? error : '';
  if (!message) {
    return false;
  }
  const normalized = message.toLowerCase();
  return RETRYABLE_KEYWORDS.some(keyword => normalized.includes(keyword));
}
async function withRetry(operation, maxRetries = 3, delayMs = 100) {
  let attempts = 0;

  // eslint-disable-next-line no-constant-condition
  while (true) {
    try {
      return await operation();
    } catch (error) {
      if (!isRetryableError(error) || attempts >= maxRetries) {
        throw error;
      }
      attempts += 1;
      if (delayMs > 0) {
        await (0, _asyncUtils.sleep)(delayMs);
      }
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfYXN5bmNVdGlscyIsInJlcXVpcmUiLCJSRVRSWUFCTEVfS0VZV09SRFMiLCJkZXJpdmVFcnJvckNvZGUiLCJlcnJvciIsIm5hbWUiLCJ0b1VwcGVyQ2FzZSIsIm5vcm1hbGl6ZWQiLCJtZXNzYWdlIiwidHJpbSIsInJlcGxhY2UiLCJ1bmRlZmluZWQiLCJjcmVhdGVFcnJvckRldGFpbHMiLCJjb250ZXh0IiwidGltZXN0YW1wIiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwiRXJyb3IiLCJjb2RlIiwic3RhY2siLCJTdHJpbmciLCJmb3JtYXRFcnJvckZvckxvZ2dpbmciLCJkZXRhaWxzIiwicGFydHMiLCJwdXNoIiwiSlNPTiIsInN0cmluZ2lmeSIsImpvaW4iLCJpc1JldHJ5YWJsZUVycm9yIiwicmV0cnlhYmxlRmxhZyIsInJldHJ5YWJsZSIsInRvTG93ZXJDYXNlIiwic29tZSIsImtleXdvcmQiLCJpbmNsdWRlcyIsIndpdGhSZXRyeSIsIm9wZXJhdGlvbiIsIm1heFJldHJpZXMiLCJkZWxheU1zIiwiYXR0ZW1wdHMiLCJzbGVlcCJdLCJzb3VyY2VzIjpbImVycm9yVXRpbHMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc2xlZXAgfSBmcm9tICcuL2FzeW5jVXRpbHMuanMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEVycm9yRGV0YWlscyB7XG4gIG1lc3NhZ2U6IHN0cmluZztcbiAgY29kZT86IHN0cmluZztcbiAgY29udGV4dD86IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICBzdGFjaz86IHN0cmluZztcbiAgdGltZXN0YW1wOiBzdHJpbmc7XG59XG5cbmNvbnN0IFJFVFJZQUJMRV9LRVlXT1JEUyA9IFtcbiAgJ3RpbWVvdXQnLFxuICAnbmV0d29yaycsXG4gICdyYXRlIGxpbWl0JyxcbiAgJ3RvbyBtYW55IHJlcXVlc3RzJyxcbiAgJ3NlcnZpY2UgdW5hdmFpbGFibGUnLFxuXTtcblxuZnVuY3Rpb24gZGVyaXZlRXJyb3JDb2RlKGVycm9yOiBFcnJvcik6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gIGlmIChlcnJvci5uYW1lICYmIGVycm9yLm5hbWUgIT09ICdFcnJvcicpIHtcbiAgICByZXR1cm4gZXJyb3IubmFtZS50b1VwcGVyQ2FzZSgpO1xuICB9XG5cbiAgY29uc3Qgbm9ybWFsaXplZCA9IGVycm9yLm1lc3NhZ2VcbiAgICAudHJpbSgpXG4gICAgLnJlcGxhY2UoL1teXFx3XSsvZywgJ18nKVxuICAgIC5yZXBsYWNlKC9eXyt8XyskL2csICcnKVxuICAgIC50b1VwcGVyQ2FzZSgpO1xuXG4gIHJldHVybiBub3JtYWxpemVkIHx8IHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUVycm9yRGV0YWlscyhcbiAgZXJyb3I6IHVua25vd24sXG4gIGNvbnRleHQ/OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPlxuKTogRXJyb3JEZXRhaWxzIHtcbiAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuXG4gIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXG4gICAgICBjb2RlOiBkZXJpdmVFcnJvckNvZGUoZXJyb3IpLFxuICAgICAgY29udGV4dCxcbiAgICAgIHN0YWNrOiBlcnJvci5zdGFjayxcbiAgICAgIHRpbWVzdGFtcCxcbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBtZXNzYWdlOiBTdHJpbmcoZXJyb3IpLFxuICAgIGNvbnRleHQsXG4gICAgdGltZXN0YW1wLFxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0RXJyb3JGb3JMb2dnaW5nKFxuICBlcnJvcjogdW5rbm93bixcbiAgY29udGV4dD86IFJlY29yZDxzdHJpbmcsIHVua25vd24+XG4pOiBzdHJpbmcge1xuICBjb25zdCBkZXRhaWxzID0gY3JlYXRlRXJyb3JEZXRhaWxzKGVycm9yLCBjb250ZXh0KTtcbiAgY29uc3QgcGFydHMgPSBbYEVycm9yOiAke2RldGFpbHMubWVzc2FnZX1gXTtcblxuICBpZiAoY29udGV4dCkge1xuICAgIHBhcnRzLnB1c2goYENvbnRleHQ6ICR7SlNPTi5zdHJpbmdpZnkoY29udGV4dCl9YCk7XG4gIH1cblxuICBwYXJ0cy5wdXNoKGBTdGFjazogJHtkZXRhaWxzLnN0YWNrID8/ICcobm90IGF2YWlsYWJsZSknfWApO1xuICBwYXJ0cy5wdXNoKGBUaW1lc3RhbXA6ICR7ZGV0YWlscy50aW1lc3RhbXB9YCk7XG5cbiAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xcbicpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNSZXRyeWFibGVFcnJvcihlcnJvcjogdW5rbm93bik6IGJvb2xlYW4ge1xuICBpZiAoZXJyb3IgJiYgdHlwZW9mIGVycm9yID09PSAnb2JqZWN0JyAmJiAncmV0cnlhYmxlJyBpbiAoZXJyb3IgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pKSB7XG4gICAgY29uc3QgcmV0cnlhYmxlRmxhZyA9IChlcnJvciBhcyB7IHJldHJ5YWJsZT86IHVua25vd24gfSkucmV0cnlhYmxlO1xuICAgIGlmICh0eXBlb2YgcmV0cnlhYmxlRmxhZyA9PT0gJ2Jvb2xlYW4nKSB7XG4gICAgICByZXR1cm4gcmV0cnlhYmxlRmxhZztcbiAgICB9XG4gIH1cblxuICBjb25zdCBtZXNzYWdlID1cbiAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yXG4gICAgICA/IGVycm9yLm1lc3NhZ2VcbiAgICAgIDogdHlwZW9mIGVycm9yID09PSAnc3RyaW5nJ1xuICAgICAgICA/IGVycm9yXG4gICAgICAgIDogJyc7XG5cbiAgaWYgKCFtZXNzYWdlKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgY29uc3Qgbm9ybWFsaXplZCA9IG1lc3NhZ2UudG9Mb3dlckNhc2UoKTtcbiAgcmV0dXJuIFJFVFJZQUJMRV9LRVlXT1JEUy5zb21lKGtleXdvcmQgPT4gbm9ybWFsaXplZC5pbmNsdWRlcyhrZXl3b3JkKSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB3aXRoUmV0cnk8VD4oXG4gIG9wZXJhdGlvbjogKCkgPT4gUHJvbWlzZTxUPixcbiAgbWF4UmV0cmllczogbnVtYmVyID0gMyxcbiAgZGVsYXlNczogbnVtYmVyID0gMTAwXG4pOiBQcm9taXNlPFQ+IHtcbiAgbGV0IGF0dGVtcHRzID0gMDtcblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc3RhbnQtY29uZGl0aW9uXG4gIHdoaWxlICh0cnVlKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCBvcGVyYXRpb24oKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYgKCFpc1JldHJ5YWJsZUVycm9yKGVycm9yKSB8fCBhdHRlbXB0cyA+PSBtYXhSZXRyaWVzKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuXG4gICAgICBhdHRlbXB0cyArPSAxO1xuICAgICAgaWYgKGRlbGF5TXMgPiAwKSB7XG4gICAgICAgIGF3YWl0IHNsZWVwKGRlbGF5TXMpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSxJQUFBQSxXQUFBLEdBQUFDLE9BQUE7QUFVQSxNQUFNQyxrQkFBa0IsR0FBRyxDQUN6QixTQUFTLEVBQ1QsU0FBUyxFQUNULFlBQVksRUFDWixtQkFBbUIsRUFDbkIscUJBQXFCLENBQ3RCO0FBRUQsU0FBU0MsZUFBZUEsQ0FBQ0MsS0FBWSxFQUFzQjtFQUN6RCxJQUFJQSxLQUFLLENBQUNDLElBQUksSUFBSUQsS0FBSyxDQUFDQyxJQUFJLEtBQUssT0FBTyxFQUFFO0lBQ3hDLE9BQU9ELEtBQUssQ0FBQ0MsSUFBSSxDQUFDQyxXQUFXLENBQUMsQ0FBQztFQUNqQztFQUVBLE1BQU1DLFVBQVUsR0FBR0gsS0FBSyxDQUFDSSxPQUFPLENBQzdCQyxJQUFJLENBQUMsQ0FBQyxDQUNOQyxPQUFPLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxDQUN2QkEs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