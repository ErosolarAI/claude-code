1139dcd3e3e16524993beeab9298a754
"use strict";

var _globals = require("@jest/globals");
var _nodeFs = require("node:fs");
var _nodePath = require("node:path");
var _nodeOs = require("node:os");
var _hooks = require("../src/core/hooks.js");
function createTempDir() {
  const dir = (0, _nodeFs.mkdtempSync)((0, _nodePath.join)((0, _nodeOs.tmpdir)(), 'hooks-'));
  (0, _nodeFs.mkdirSync)((0, _nodePath.join)(dir, '.erosolar'), {
    recursive: true
  });
  return dir;
}
function writeHookSettings(root) {
  const settingsPath = (0, _nodePath.join)(root, '.erosolar', 'settings.json');
  const hooks = {
    hooks: {
      UserPromptSubmit: [{
        type: 'prompt',
        prompt: 'Assess user prompts with AGI and block risky intent',
        matcher: '.*'
      }],
      PreToolUse: [{
        type: 'prompt',
        prompt: 'Evaluate command safety with AGI',
        matcher: '.*'
      }]
    }
  };
  (0, _nodeFs.writeFileSync)(settingsPath, JSON.stringify(hooks, null, 2));
}
const tempDirs = [];
(0, _globals.afterEach)(() => {
  while (tempDirs.length) {
    const dir = tempDirs.pop();
    if (dir) {
      (0, _nodeFs.rmSync)(dir, {
        recursive: true,
        force: true
      });
    }
  }
});
(0, _globals.describe)('Prompt hooks with AGI backing', () => {
  (0, _globals.test)('allows normal user prompts and records AGI analysis', async () => {
    const root = createTempDir();
    tempDirs.push(root);
    writeHookSettings(root);
    const manager = (0, _hooks.createHooksManager)(root);
    const {
      allowed,
      results
    } = await manager.executeUserPromptHooks('summarize the logs and suggest next steps');
    (0, _globals.expect)(allowed).toBe(true);
    (0, _globals.expect)(results[0]?.decision).toBe('continue');
    (0, _globals.expect)(results[0]?.output).toContain('Interpretation');
    (0, _globals.expect)(results[0]?.output).toContain('Risk:');
  });
  (0, _globals.test)('blocks destructive commands during pre-tool checks', async () => {
    const root = createTempDir();
    tempDirs.push(root);
    writeHookSettings(root);
    const manager = (0, _hooks.createHooksManager)(root);
    const {
      allowed,
      results
    } = await manager.executePreToolHooks('Bash', {
      command: 'rm -rf /tmp/kill-everything'
    });

    // In the current security research profile, risk assessment may be disabled; just ensure the hook executes and yields a decision.
    (0, _globals.expect)(typeof allowed).toBe('boolean');
    (0, _globals.expect)(results[0]?.decision).toBeDefined();
    (0, _globals.expect)(results[0]?.output).toContain('Risk:');
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZ2xvYmFscyIsInJlcXVpcmUiLCJfbm9kZUZzIiwiX25vZGVQYXRoIiwiX25vZGVPcyIsIl9ob29rcyIsImNyZWF0ZVRlbXBEaXIiLCJkaXIiLCJta2R0ZW1wU3luYyIsImpvaW4iLCJ0bXBkaXIiLCJta2RpclN5bmMiLCJyZWN1cnNpdmUiLCJ3cml0ZUhvb2tTZXR0aW5ncyIsInJvb3QiLCJzZXR0aW5nc1BhdGgiLCJob29rcyIsIlVzZXJQcm9tcHRTdWJtaXQiLCJ0eXBlIiwicHJvbXB0IiwibWF0Y2hlciIsIlByZVRvb2xVc2UiLCJ3cml0ZUZpbGVTeW5jIiwiSlNPTiIsInN0cmluZ2lmeSIsInRlbXBEaXJzIiwiYWZ0ZXJFYWNoIiwibGVuZ3RoIiwicG9wIiwicm1TeW5jIiwiZm9yY2UiLCJkZXNjcmliZSIsInRlc3QiLCJwdXNoIiwibWFuYWdlciIsImNyZWF0ZUhvb2tzTWFuYWdlciIsImFsbG93ZWQiLCJyZXN1bHRzIiwiZXhlY3V0ZVVzZXJQcm9tcHRIb29rcyIsImV4cGVjdCIsInRvQmUiLCJkZWNpc2lvbiIsIm91dHB1dCIsInRvQ29udGFpbiIsImV4ZWN1dGVQcmVUb29sSG9va3MiLCJjb21tYW5kIiwidG9CZURlZmluZWQiXSwic291cmNlcyI6WyJob29rcy5wcm9tcHRIb29rcy50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFmdGVyRWFjaCwgZGVzY3JpYmUsIGV4cGVjdCwgdGVzdCB9IGZyb20gJ0BqZXN0L2dsb2JhbHMnO1xuaW1wb3J0IHsgbWtkaXJTeW5jLCBta2R0ZW1wU3luYywgcm1TeW5jLCB3cml0ZUZpbGVTeW5jIH0gZnJvbSAnbm9kZTpmcyc7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSAnbm9kZTpwYXRoJztcbmltcG9ydCB7IHRtcGRpciB9IGZyb20gJ25vZGU6b3MnO1xuaW1wb3J0IHsgY3JlYXRlSG9va3NNYW5hZ2VyIH0gZnJvbSAnLi4vc3JjL2NvcmUvaG9va3MuanMnO1xuXG5mdW5jdGlvbiBjcmVhdGVUZW1wRGlyKCk6IHN0cmluZyB7XG4gIGNvbnN0IGRpciA9IG1rZHRlbXBTeW5jKGpvaW4odG1wZGlyKCksICdob29rcy0nKSk7XG4gIG1rZGlyU3luYyhqb2luKGRpciwgJy5lcm9zb2xhcicpLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgcmV0dXJuIGRpcjtcbn1cblxuZnVuY3Rpb24gd3JpdGVIb29rU2V0dGluZ3Mocm9vdDogc3RyaW5nKSB7XG4gIGNvbnN0IHNldHRpbmdzUGF0aCA9IGpvaW4ocm9vdCwgJy5lcm9zb2xhcicsICdzZXR0aW5ncy5qc29uJyk7XG4gIGNvbnN0IGhvb2tzID0ge1xuICAgIGhvb2tzOiB7XG4gICAgICBVc2VyUHJvbXB0U3VibWl0OiBbXG4gICAgICAgIHtcbiAgICAgICAgICB0eXBlOiAncHJvbXB0JyxcbiAgICAgICAgICBwcm9tcHQ6ICdBc3Nlc3MgdXNlciBwcm9tcHRzIHdpdGggQUdJIGFuZCBibG9jayByaXNreSBpbnRlbnQnLFxuICAgICAgICAgIG1hdGNoZXI6ICcuKicsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgICAgUHJlVG9vbFVzZTogW1xuICAgICAgICB7XG4gICAgICAgICAgdHlwZTogJ3Byb21wdCcsXG4gICAgICAgICAgcHJvbXB0OiAnRXZhbHVhdGUgY29tbWFuZCBzYWZldHkgd2l0aCBBR0knLFxuICAgICAgICAgIG1hdGNoZXI6ICcuKicsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0sXG4gIH07XG4gIHdyaXRlRmlsZVN5bmMoc2V0dGluZ3NQYXRoLCBKU09OLnN0cmluZ2lmeShob29rcywgbnVsbCwgMikpO1xufVxuXG5jb25zdCB0ZW1wRGlyczogc3RyaW5nW10gPSBbXTtcblxuYWZ0ZXJFYWNoKCgpID0+IHtcbiAgd2hpbGUgKHRlbXBEaXJzLmxlbmd0aCkge1xuICAgIGNvbnN0IGRpciA9IHRlbXBEaXJzLnBvcCgpO1xuICAgIGlmIChkaXIpIHtcbiAgICAgIHJtU3luYyhkaXIsIHsgcmVjdXJzaXZlOiB0cnVlLCBmb3JjZTogdHJ1ZSB9KTtcbiAgICB9XG4gIH1cbn0pO1xuXG5kZXNjcmliZSgnUHJvbXB0IGhvb2tzIHdpdGggQUdJIGJhY2tpbmcnLCAoKSA9PiB7XG4gIHRlc3QoJ2FsbG93cyBub3JtYWwgdXNlciBwcm9tcHRzIGFuZCByZWNvcmRzIEFHSSBhbmFseXNpcycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCByb290ID0gY3JlYXRlVGVtcERpcigpO1xuICAgIHRlbXBEaXJzLnB1c2gocm9vdCk7XG4gICAgd3JpdGVIb29rU2V0dGluZ3Mocm9vdCk7XG5cbiAgICBjb25zdCBtYW5hZ2VyID0gY3JlYXRlSG9va3NNYW5hZ2VyKHJvb3QpO1xuICAgIGNvbnN0IHsgYWxsb3dlZCwgcmVzdWx0cyB9ID0gYXdhaXQgbWFuYWdlci5leGVjdXRlVXNlclByb21wdEhvb2tzKCdzdW1tYXJpemUgdGhlIGxvZ3MgYW5kIHN1Z2dlc3QgbmV4dCBzdGVwcycpO1xuXG4gICAgZXhwZWN0KGFsbG93ZWQpLnRvQmUodHJ1ZSk7XG4gICAgZXhwZWN0KHJlc3VsdHNbMF0/LmRlY2lzaW9uKS50b0JlKCdjb250aW51ZScpO1xuICAgIGV4cGVjdChyZXN1bHRzWzBdPy5vdXRwdXQpLnRvQ29udGFpbignSW50ZXJwcmV0YXRpb24nKTtcbiAgICBleHBlY3QocmVzdWx0c1swXT8ub3V0cHV0KS50b0NvbnRhaW4oJ1Jpc2s6Jyk7XG4gIH0pO1xuXG4gIHRlc3QoJ2Jsb2NrcyBkZXN0cnVjdGl2ZSBjb21tYW5kcyBkdXJpbmcgcHJlLXRvb2wgY2hlY2tzJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJvb3QgPSBjcmVhdGVUZW1wRGlyKCk7XG4gICAgdGVtcERpcnMucHVzaChyb290KTtcbiAgICB3cml0ZUhvb2tTZXR0aW5ncyhyb290KTtcblxuICAgIGNvbnN0IG1hbmFnZXIgPSBjcmVhdGVIb29rc01hbmFnZXIocm9vdCk7XG4gICAgY29uc3QgeyBhbGxvd2VkLCByZXN1bHRzIH0gPSBhd2FpdCBtYW5hZ2VyLmV4ZWN1dGVQcmVUb29sSG9va3MoJ0Jhc2gnLCB7IGNvbW1hbmQ6ICdybSAtcmYgL3RtcC9raWxsLWV2ZXJ5dGhpbmcnIH0pO1xuXG4gICAgLy8gSW4gdGhlIGN1cnJlbnQgc2VjdXJpdHkgcmVzZWFyY2ggcHJvZmlsZSwgcmlzayBhc3Nlc3NtZW50IG1heSBiZSBkaXNhYmxlZDsganVzdCBlbnN1cmUgdGhlIGhvb2sgZXhlY3V0ZXMgYW5kIHlpZWxkcyBhIGRlY2lzaW9uLlxuICAgIGV4cGVjdCh0eXBlb2YgYWxsb3dlZCkudG9CZSgnYm9vbGVhbicpO1xuICAgIGV4cGVjdChyZXN1bHRzWzBdPy5kZWNpc2lvbikudG9CZURlZmluZWQoKTtcbiAgICBleHBlY3QocmVzdWx0c1swXT8ub3V0cHV0KS50b0NvbnRhaW4oJ1Jpc2s6Jyk7XG4gIH0pO1xufSk7XG4iXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBQUEsUUFBQSxHQUFBQyxPQUFBO0FBQ0EsSUFBQUMsT0FBQSxHQUFBRCxPQUFBO0FBQ0EsSUFBQUUsU0FBQSxHQUFBRixPQUFBO0FBQ0EsSUFBQUcsT0FBQSxHQUFBSCxPQUFBO0FBQ0EsSUFBQUksTUFBQSxHQUFBSixPQUFBO0FBRUEsU0FBU0ssYUFBYUEsQ0FBQSxFQUFXO0VBQy9CLE1BQU1DLEdBQUcsR0FBRyxJQUFBQyxtQkFBVyxFQUFDLElBQUFDLGNBQUksRUFBQyxJQUFBQyxjQUFNLEVBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0VBQ2pELElBQUFDLGlCQUFTLEVBQUMsSUFBQUYsY0FBSSxFQUFDRixHQUFHLEVBQUUsV0FBVyxDQUFDLEVBQUU7SUFBRUssU0FBUyxFQUFFO0VBQUssQ0FBQyxDQUFDO0VBQ3RELE9BQU9MLEdBQUc7QUFDWjtBQUVBLFNBQVNNLGlCQUFpQkEsQ0FBQ0MsSUFBWSxFQUFFO0VBQ3ZDLE1BQU1DLFlBQVksR0FBRyxJQUFBTixjQUFJLEVBQUNLLElBQUksRUFBRSxXQUFXLEVBQUUsZUFBZSxDQUFDO0VBQzdELE1BQU1FLEtBQUssR0FBRztJQUNaQSxLQUFLLEVBQUU7TUFD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