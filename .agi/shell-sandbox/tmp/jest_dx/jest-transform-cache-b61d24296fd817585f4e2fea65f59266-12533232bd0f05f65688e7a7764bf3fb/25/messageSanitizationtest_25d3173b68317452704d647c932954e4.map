{"version":3,"names":["_globals","require","sanitizeMessageSequence","messages","sanitized","pendingToolCallIds","Set","message","role","toolCalls","length","tc","id","add","push","toolCallId","has","delete","clear","describe","it","content","name","expect","toHaveLength","map","m","toEqual","find","toBeUndefined","toBe"],"sources":["messageSanitization.test.ts"],"sourcesContent":["import { describe, expect, it } from '@jest/globals';\n\n/**\n * Test the message sanitization logic that prevents orphaned tool messages.\n * This replicates the sanitizeMessageSequence function logic for testing.\n */\n\ninterface TestMessage {\n  role: 'system' | 'user' | 'assistant' | 'tool';\n  content: string;\n  toolCalls?: { id: string; name: string }[];\n  toolCallId?: string;\n}\n\nfunction sanitizeMessageSequence(messages: TestMessage[]): TestMessage[] {\n  const sanitized: TestMessage[] = [];\n  const pendingToolCallIds = new Set<string>();\n\n  for (const message of messages) {\n    if (message.role === 'assistant' && message.toolCalls?.length) {\n      for (const tc of message.toolCalls) {\n        if (tc.id) pendingToolCallIds.add(tc.id);\n      }\n      sanitized.push(message);\n    } else if (message.role === 'tool') {\n      const toolCallId = message.toolCallId;\n      if (toolCallId && pendingToolCallIds.has(toolCallId)) {\n        pendingToolCallIds.delete(toolCallId);\n        sanitized.push(message);\n      }\n      // Orphaned tool messages are silently skipped\n    } else {\n      if (message.role === 'user') {\n        pendingToolCallIds.clear();\n      }\n      sanitized.push(message);\n    }\n  }\n\n  return sanitized;\n}\n\ndescribe('Message Sanitization - Orphaned Tool Messages', () => {\n  it('preserves valid tool message sequences', () => {\n    const messages: TestMessage[] = [\n      { role: 'user', content: 'Hello' },\n      { role: 'assistant', content: '', toolCalls: [{ id: 'call_1', name: 'read_file' }] },\n      { role: 'tool', content: 'file contents', toolCallId: 'call_1' },\n      { role: 'assistant', content: 'Done' },\n    ];\n\n    const sanitized = sanitizeMessageSequence(messages);\n    expect(sanitized).toHaveLength(4);\n    expect(sanitized.map(m => m.role)).toEqual(['user', 'assistant', 'tool', 'assistant']);\n  });\n\n  it('removes orphaned tool messages without preceding tool_calls', () => {\n    const messages: TestMessage[] = [\n      { role: 'user', content: 'Hello' },\n      { role: 'tool', content: 'orphaned result', toolCallId: 'call_orphan' }, // No preceding assistant with tool_calls\n      { role: 'assistant', content: 'Response' },\n    ];\n\n    const sanitized = sanitizeMessageSequence(messages);\n    expect(sanitized).toHaveLength(2);\n    expect(sanitized.map(m => m.role)).toEqual(['user', 'assistant']);\n    expect(sanitized.find(m => m.role === 'tool')).toBeUndefined();\n  });\n\n  it('removes tool messages with mismatched IDs', () => {\n    const messages: TestMessage[] = [\n      { role: 'user', content: 'Hello' },\n      { role: 'assistant', content: '', toolCalls: [{ id: 'call_1', name: 'read_file' }] },\n      { role: 'tool', content: 'wrong id', toolCallId: 'call_DIFFERENT' }, // Wrong ID\n      { role: 'tool', content: 'correct', toolCallId: 'call_1' }, // Correct ID\n    ];\n\n    const sanitized = sanitizeMessageSequence(messages);\n    expect(sanitized).toHaveLength(3);\n    expect(sanitized[2]?.content).toBe('correct');\n  });\n\n  it('handles multiple tool calls and responses', () => {\n    const messages: TestMessage[] = [\n      { role: 'user', content: 'Run two commands' },\n      { role: 'assistant', content: '', toolCalls: [\n        { id: 'call_1', name: 'cmd1' },\n        { id: 'call_2', name: 'cmd2' },\n      ]},\n      { role: 'tool', content: 'result 1', toolCallId: 'call_1' },\n      { role: 'tool', content: 'result 2', toolCallId: 'call_2' },\n      { role: 'assistant', content: 'Both done' },\n    ];\n\n    const sanitized = sanitizeMessageSequence(messages);\n    expect(sanitized).toHaveLength(5);\n  });\n\n  it('clears pending tool calls on new user message', () => {\n    const messages: TestMessage[] = [\n      { role: 'user', content: 'First question' },\n      { role: 'assistant', content: '', toolCalls: [{ id: 'call_1', name: 'search' }] },\n      // Missing tool response - context was compacted\n      { role: 'user', content: 'New question' }, // New turn clears pending\n      { role: 'tool', content: 'orphaned from old turn', toolCallId: 'call_1' }, // Should be skipped\n      { role: 'assistant', content: 'Answer' },\n    ];\n\n    const sanitized = sanitizeMessageSequence(messages);\n    expect(sanitized).toHaveLength(4);\n    expect(sanitized.map(m => m.role)).toEqual(['user', 'assistant', 'user', 'assistant']);\n  });\n\n  it('handles empty messages array', () => {\n    const sanitized = sanitizeMessageSequence([]);\n    expect(sanitized).toHaveLength(0);\n  });\n\n  it('preserves system messages', () => {\n    const messages: TestMessage[] = [\n      { role: 'system', content: 'You are helpful' },\n      { role: 'user', content: 'Hello' },\n      { role: 'assistant', content: 'Hi!' },\n    ];\n\n    const sanitized = sanitizeMessageSequence(messages);\n    expect(sanitized).toHaveLength(3);\n    expect(sanitized[0]?.role).toBe('system');\n  });\n\n  it('handles context compaction scenario - tool message after compaction', () => {\n    // Simulates what happens after context compaction removes the assistant message\n    // but leaves the tool response\n    const messages: TestMessage[] = [\n      { role: 'system', content: 'Context summary...' },\n      { role: 'tool', content: 'Result from compacted turn', toolCallId: 'old_call' },\n      { role: 'user', content: 'Continue' },\n      { role: 'assistant', content: 'OK' },\n    ];\n\n    const sanitized = sanitizeMessageSequence(messages);\n    expect(sanitized).toHaveLength(3);\n    expect(sanitized.find(m => m.role === 'tool')).toBeUndefined();\n  });\n});\n"],"mappings":"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","ignoreList":[]}