{"version":3,"names":["_getJestObj","mock","createNodeRuntime","jest","fn","Error","resolveProfileConfig","provider","model","temperature","maxTokens","systemPrompt","_globals","require","_agentController","makeFakeSession","sendImpl","profileConfig","createAgent","_selection","callbacks","history","send","loadHistory","h","getHistory","onToolCall","afterEach","process","env","AGI_AGENT_RUN_TIMEOUT_MS","describe","test","resolveSend","Promise","resolve","controller","AgentController","runtime","session","sinkRef","current","iterator","first","next","expect","value","type","toBe","cancel","rejects","toThrow","setTimeout"],"sources":["agentController.cancel.test.ts"],"sourcesContent":["import { describe, expect, test, afterEach, jest } from '@jest/globals';\n\n// Mock modules that rely on import.meta or heavy runtime wiring\njest.mock('../../src/runtime/node.js', () => ({\n  createNodeRuntime: jest.fn(() => {\n    throw new Error('createNodeRuntime should not be called in unit tests');\n  }),\n}));\n\njest.mock('../../src/config.js', () => ({\n  resolveProfileConfig: jest.fn(() => ({\n    provider: 'test-provider',\n    model: 'test-model',\n    temperature: 0,\n    maxTokens: 128,\n    systemPrompt: 'sys',\n  })),\n}));\n\nimport { AgentController } from '../../src/runtime/agentController.js';\nimport type { AgentSession } from '../../src/runtime/agentSession.js';\n\nfunction makeFakeSession(sendImpl: (message: string, allowTools: boolean) => Promise<void>): AgentSession {\n  return {\n    profileConfig: {\n      provider: 'test-provider',\n      model: 'test-model',\n      temperature: 0,\n      maxTokens: 128,\n      systemPrompt: 'sys',\n    },\n    createAgent: (_selection, callbacks) => {\n      let history: any[] = [];\n      return {\n        send: sendImpl,\n        loadHistory: (h: any[]) => {\n          history = h;\n        },\n        getHistory: () => history,\n        onToolCall: callbacks?.onToolCall,\n      } as any;\n    },\n  } as unknown as AgentSession;\n}\n\nafterEach(() => {\n  delete process.env.AGI_AGENT_RUN_TIMEOUT_MS;\n});\n\ndescribe('AgentController cancellation and timeout (core-first)', () => {\n  test('cancel stops an in-flight run and fails the stream', async () => {\n    let resolveSend: (() => void) | null = null;\n    const sendImpl = () =>\n      new Promise<void>((resolve) => {\n        resolveSend = resolve;\n      });\n\n    const controller = new AgentController({\n      runtime: { session: makeFakeSession(sendImpl) } as any,\n      sinkRef: { current: null },\n    });\n\n    const iterator = controller.send('hello');\n    const first = await iterator.next();\n    expect(first.value?.type).toBe('message.start');\n\n    controller.cancel('stop now');\n    await expect(iterator.next()).rejects.toThrow(/stop now/i);\n\n    resolveSend?.();\n  });\n\n  test('times out when run exceeds configured limit', async () => {\n    process.env.AGI_AGENT_RUN_TIMEOUT_MS = '10';\n    const sendImpl = () => new Promise<void>((resolve) => setTimeout(resolve, 50));\n\n    const controller = new AgentController({\n      runtime: { session: makeFakeSession(sendImpl) } as any,\n      sinkRef: { current: null },\n    });\n\n    const iterator = controller.send('hello');\n    const first = await iterator.next();\n    expect(first.value?.type).toBe('message.start');\n\n    await expect(iterator.next()).rejects.toThrow(/timed out/i);\n  });\n});\n"],"mappings":";;AAEA;AACAA,WAAA,GAAKC,IAAI,CAAC,2BAA2B,EAAE,OAAO;EAC5CC,iBAAiB,EAAEC,aAAI,CAACC,EAAE,CAAC,MAAM;IAC/B,MAAM,IAAIC,KAAK,CAAC,sDAAsD,CAAC;EACzE,CAAC;AACH,CAAC,CAAC,CAAC;AAEHL,WAAA,GAAKC,IAAI,CAAC,qBAAqB,EAAE,OAAO;EACtCK,oBAAoB,EAAEH,aAAI,CAACC,EAAE,CAAC,OAAO;IACnCG,QAAQ,EAAE,eAAe;IACzBC,KAAK,EAAE,YAAY;IACnBC,WAAW,EAAE,CAAC;IACdC,SAAS,EAAE,GAAG;IACdC,YAAY,EAAE;EAChB,CAAC,CAAC;AACJ,CAAC,CAAC,CAAC;AAjBH,IAAAC,QAAA,GAAAC,OAAA;AAmBA,IAAAC,gBAAA,GAAAD,OAAA;AAAuE,SAAAb,YAAA;EAAA;IAAAG;EAAA,IAAAU,OAAA;EAAAb,WAAA,GAAAA,CAAA,KAAAG,IAAA;EAAA,OAAAA,IAAA;AAAA;AAGvE,SAASY,eAAeA,CAACC,QAAiE,EAAgB;EACxG,OAAO;IACLC,aAAa,EAAE;MACbV,QAAQ,EAAE,eAAe;MACzBC,KAAK,EAAE,YAAY;MACnBC,WAAW,EAAE,CAAC;MACdC,SAAS,EAAE,GAAG;MACdC,YAAY,EAAE;IAChB,CAAC;IACDO,WAAW,EAAEA,CAACC,UAAU,EAAEC,SAAS,KAAK;MACtC,IAAIC,OAAc,GAAG,EAAE;MACvB,OAAO;QACLC,IAAI,EAAEN,QAAQ;QACdO,WAAW,EAAGC,CAAQ,IAAK;UACzBH,OAAO,GAAGG,CAAC;QACb,CAAC;QACDC,UAAU,EAAEA,CAAA,KAAMJ,OAAO;QACzBK,UAAU,EAAEN,SAAS,EAAEM;MACzB,CAAC;IACH;EACF,CAAC;AACH;AAEA,IAAAC,kBAAS,EAAC,MAAM;EACd,OAAOC,OAAO,CAACC,GAAG,CAACC,wBAAwB;AAC7C,CAAC,CAAC;AAEF,IAAAC,iBAAQ,EAAC,uDAAuD,EAAE,MAAM;EACtE,IAAAC,aAAI,EAAC,oDAAoD,EAAE,YAAY;IACrE,IAAIC,WAAgC,GAAG,IAAI;IAC3C,MAAMjB,QAAQ,GAAGA,CAAA,KACf,IAAIkB,OAAO,CAAQC,OAAO,IAAK;MAC7BF,WAAW,GAAGE,OAAO;IACvB,CAAC,CAAC;IAEJ,MAAMC,UAAU,GAAG,IAAIC,gCAAe,CAAC;MACrCC,OAAO,EAAE;QAAEC,OAAO,EAAExB,eAAe,CAACC,QAAQ;MAAE,CAAQ;MACtDwB,OAAO,EAAE;QAAEC,OAAO,EAAE;MAAK;IAC3B,CAAC,CAAC;IAEF,MAAMC,QAAQ,GAAGN,UAAU,CAACd,IAAI,CAAC,OAAO,CAAC;IACzC,MAAMqB,KAAK,GAAG,MAAMD,QAAQ,CAACE,IAAI,CAAC,CAAC;IACnC,IAAAC,eAAM,EAACF,KAAK,CAACG,KAAK,EAAEC,IAAI,CAAC,CAACC,IAAI,CAAC,eAAe,CAAC;IAE/CZ,UAAU,CAACa,MAAM,CAAC,UAAU,CAAC;IAC7B,MAAM,IAAAJ,eAAM,EAACH,QAAQ,CAACE,IAAI,CAAC,CAAC,CAAC,CAACM,OAAO,CAACC,OAAO,CAAC,WAAW,CAAC;IAE1DlB,WAAW,GAAG,CAAC;EACjB,CAAC,CAAC;EAEF,IAAAD,aAAI,EAAC,6CAA6C,EAAE,YAAY;IAC9DJ,OAAO,CAACC,GAAG,CAACC,wBAAwB,GAAG,IAAI;IAC3C,MAAMd,QAAQ,GAAGA,CAAA,KAAM,IAAIkB,OAAO,CAAQC,OAAO,IAAKiB,UAAU,CAACjB,OAAO,EAAE,EAAE,CAAC,CAAC;IAE9E,MAAMC,UAAU,GAAG,IAAIC,gCAAe,CAAC;MACrCC,OAAO,EAAE;QAAEC,OAAO,EAAExB,eAAe,CAACC,QAAQ;MAAE,CAAQ;MACtDwB,OAAO,EAAE;QAAEC,OAAO,EAAE;MAAK;IAC3B,CAAC,CAAC;IAEF,MAAMC,QAAQ,GAAGN,UAAU,CAACd,IAAI,CAAC,OAAO,CAAC;IACzC,MAAMqB,KAAK,GAAG,MAAMD,QAAQ,CAACE,IAAI,CAAC,CAAC;IACnC,IAAAC,eAAM,EAACF,KAAK,CAACG,KAAK,EAAEC,IAAI,CAAC,CAACC,IAAI,CAAC,eAAe,CAAC;IAE/C,MAAM,IAAAH,eAAM,EAACH,QAAQ,CAACE,IAAI,CAAC,CAAC,CAAC,CAACM,OAAO,CAACC,OAAO,CAAC,YAAY,CAAC;EAC7D,CAAC,CAAC;AACJ,CAAC,CAAC","ignoreList":[]}