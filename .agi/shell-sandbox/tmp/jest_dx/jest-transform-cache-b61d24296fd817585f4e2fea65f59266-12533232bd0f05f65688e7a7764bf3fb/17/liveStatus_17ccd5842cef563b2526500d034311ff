0b4ae8ff2c56cfc3e987f8f2b4c2010f
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.LiveStatusTracker = void 0;
class LiveStatusTracker {
  base = null;
  overrides = new Map();
  subscribers = new Set();
  subscribe(subscriber) {
    this.subscribers.add(subscriber);
    const current = this.currentState();
    if (current) {
      subscriber(current);
    }
    return () => {
      this.subscribers.delete(subscriber);
    };
  }
  setBase(text, options) {
    const keepStart = this.base && this.base.text === text ? this.base.startedAt : Date.now();
    this.base = {
      text,
      detail: options?.detail,
      startedAt: keepStart
    };
    this.emit();
  }
  pushOverride(id, text, options) {
    const existing = this.overrides.get(id);
    const startedAt = existing && existing.text === text ? existing.startedAt : Date.now();
    this.overrides.set(id, {
      text,
      detail: options?.detail,
      startedAt
    });
    this.emit();
    return () => this.clearOverride(id);
  }
  clearOverride(id) {
    this.overrides.delete(id);
    this.emit();
  }
  currentState() {
    if (this.overrides.size) {
      const last = Array.from(this.overrides.values()).pop();
      if (last) return last;
    }
    return this.base;
  }
  emit() {
    const state = this.currentState();
    if (!state) return;
    for (const sub of this.subscribers) {
      try {
        sub(state);
      } catch {
        // ignore subscriber errors
      }
    }
  }
}
exports.LiveStatusTracker = LiveStatusTracker;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJMaXZlU3RhdHVzVHJhY2tlciIsImJhc2UiLCJvdmVycmlkZXMiLCJNYXAiLCJzdWJzY3JpYmVycyIsIlNldCIsInN1YnNjcmliZSIsInN1YnNjcmliZXIiLCJhZGQiLCJjdXJyZW50IiwiY3VycmVudFN0YXRlIiwiZGVsZXRlIiwic2V0QmFzZSIsInRleHQiLCJvcHRpb25zIiwia2VlcFN0YXJ0Iiwic3RhcnRlZEF0IiwiRGF0ZSIsIm5vdyIsImRldGFpbCIsImVtaXQiLCJwdXNoT3ZlcnJpZGUiLCJpZCIsImV4aXN0aW5nIiwiZ2V0Iiwic2V0IiwiY2xlYXJPdmVycmlkZSIsInNpemUiLCJsYXN0IiwiQXJyYXkiLCJmcm9tIiwidmFsdWVzIiwicG9wIiwic3RhdGUiLCJzdWIiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsibGl2ZVN0YXR1cy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgaW50ZXJmYWNlIExpdmVTdGF0dXNTdGF0ZSB7XG4gIHRleHQ6IHN0cmluZztcbiAgZGV0YWlsPzogc3RyaW5nO1xuICBzdGFydGVkQXQ6IG51bWJlcjtcbn1cblxudHlwZSBTdWJzY3JpYmVyID0gKHN0YXRlOiBMaXZlU3RhdHVzU3RhdGUpID0+IHZvaWQ7XG5cbmV4cG9ydCBjbGFzcyBMaXZlU3RhdHVzVHJhY2tlciB7XG4gIHByaXZhdGUgYmFzZTogTGl2ZVN0YXR1c1N0YXRlIHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgb3ZlcnJpZGVzID0gbmV3IE1hcDxzdHJpbmcsIExpdmVTdGF0dXNTdGF0ZT4oKTtcbiAgcHJpdmF0ZSBzdWJzY3JpYmVycyA9IG5ldyBTZXQ8U3Vic2NyaWJlcj4oKTtcblxuICBzdWJzY3JpYmUoc3Vic2NyaWJlcjogU3Vic2NyaWJlcik6ICgpID0+IHZvaWQge1xuICAgIHRoaXMuc3Vic2NyaWJlcnMuYWRkKHN1YnNjcmliZXIpO1xuICAgIGNvbnN0IGN1cnJlbnQgPSB0aGlzLmN1cnJlbnRTdGF0ZSgpO1xuICAgIGlmIChjdXJyZW50KSB7XG4gICAgICBzdWJzY3JpYmVyKGN1cnJlbnQpO1xuICAgIH1cbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgdGhpcy5zdWJzY3JpYmVycy5kZWxldGUoc3Vic2NyaWJlcik7XG4gICAgfTtcbiAgfVxuXG4gIHNldEJhc2UodGV4dDogc3RyaW5nLCBvcHRpb25zPzogeyBkZXRhaWw/OiBzdHJpbmcgfSk6IHZvaWQge1xuICAgIGNvbnN0IGtlZXBTdGFydCA9IHRoaXMuYmFzZSAmJiB0aGlzLmJhc2UudGV4dCA9PT0gdGV4dCA/IHRoaXMuYmFzZS5zdGFydGVkQXQgOiBEYXRlLm5vdygpO1xuICAgIHRoaXMuYmFzZSA9IHsgdGV4dCwgZGV0YWlsOiBvcHRpb25zPy5kZXRhaWwsIHN0YXJ0ZWRBdDoga2VlcFN0YXJ0IH07XG4gICAgdGhpcy5lbWl0KCk7XG4gIH1cblxuICBwdXNoT3ZlcnJpZGUoaWQ6IHN0cmluZywgdGV4dDogc3RyaW5nLCBvcHRpb25zPzogeyBkZXRhaWw/OiBzdHJpbmcgfSk6ICgpID0+IHZvaWQge1xuICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5vdmVycmlkZXMuZ2V0KGlkKTtcbiAgICBjb25zdCBzdGFydGVkQXQgPSBleGlzdGluZyAmJiBleGlzdGluZy50ZXh0ID09PSB0ZXh0ID8gZXhpc3Rpbmcuc3RhcnRlZEF0IDogRGF0ZS5ub3coKTtcbiAgICB0aGlzLm92ZXJyaWRlcy5zZXQoaWQsIHsgdGV4dCwgZGV0YWlsOiBvcHRpb25zPy5kZXRhaWwsIHN0YXJ0ZWRBdCB9KTtcbiAgICB0aGlzLmVtaXQoKTtcbiAgICByZXR1cm4gKCkgPT4gdGhpcy5jbGVhck92ZXJyaWRlKGlkKTtcbiAgfVxuXG4gIGNsZWFyT3ZlcnJpZGUoaWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMub3ZlcnJpZGVzLmRlbGV0ZShpZCk7XG4gICAgdGhpcy5lbWl0KCk7XG4gIH1cblxuICBwcml2YXRlIGN1cnJlbnRTdGF0ZSgpOiBMaXZlU3RhdHVzU3RhdGUgfCBudWxsIHtcbiAgICBpZiAodGhpcy5vdmVycmlkZXMuc2l6ZSkge1xuICAgICAgY29uc3QgbGFzdCA9IEFycmF5LmZyb20odGhpcy5vdmVycmlkZXMudmFsdWVzKCkpLnBvcCgpO1xuICAgICAgaWYgKGxhc3QpIHJldHVybiBsYXN0O1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5iYXNlO1xuICB9XG5cbiAgcHJpdmF0ZSBlbWl0KCk6IHZvaWQge1xuICAgIGNvbnN0IHN0YXRlID0gdGhpcy5jdXJyZW50U3RhdGUoKTtcbiAgICBpZiAoIXN0YXRlKSByZXR1cm47XG4gICAgZm9yIChjb25zdCBzdWIgb2YgdGhpcy5zdWJzY3JpYmVycykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgc3ViKHN0YXRlKTtcbiAgICAgIH0gY2F0Y2gge1xuICAgICAgICAvLyBpZ25vcmUgc3Vic2NyaWJlciBlcnJvcnNcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBUU8sTUFBTUEsaUJBQWlCLENBQUM7RUFDckJDLElBQUksR0FBMkIsSUFBSTtFQUNuQ0MsU0FBUyxHQUFHLElBQUlDLEdBQUcsQ0FBMEIsQ0FBQztFQUM5Q0MsV0FBVyxHQUFHLElBQUlDLEdBQUcsQ0FBYSxDQUFDO0VBRTNDQyxTQUFTQSxDQUFDQyxVQUFzQixFQUFjO0lBQzVDLElBQUksQ0FBQ0gsV0FBVyxDQUFDSSxHQUFHLENBQUNELFVBQVUsQ0FBQztJQUNoQyxNQUFNRSxPQUFPLEdBQUcsSUFBSSxDQUFDQyxZQUFZLENBQUMsQ0FBQztJQUNuQyxJQUFJRCxPQUFPLEVBQUU7TUFDWEYsVUFBVSxDQUFDRSxPQUFPLENBQUM7SUFDckI7SUFDQSxPQUFPLE1BQU07TUFDWCxJQUFJLENBQUNMLFdBQVcsQ0FBQ08sTUFBTSxDQUFDSixVQUFVLENBQUM7SUFDckMsQ0FBQztFQUNIO0VBRUFLLE9BQU9BLENBQUNDLElBQVksRUFBRUMsT0FBNkIsRUFBUTtJQUN6RCxNQUFNQyxTQUFTLEdBQUcsSUFBSSxDQUFDZCxJQUFJLElBQUksSUFBSSxDQUFDQSxJQUFJLENBQUNZLElBQUksS0FBS0EsSUFBSSxHQUFHLElBQUksQ0FBQ1osSUFBSSxDQUFDZSxTQUFTLEdBQUdDLElBQUksQ0FBQ0MsR0FBRyxDQUFDLENBQUM7SUFDekYsSUFBSSxDQUFDakIsSUFBSSxHQUFHO01BQUVZLElBQUk7TUFBRU0sTUFBTSxFQUFFTCxPQUFPLEVBQUVLLE1BQU07TUFBRUgsU0FBUyxFQUFFRDtJQUFVLENBQUM7SUFDbkUsSUFBSSxDQUFDSyxJQUFJLENBQUMsQ0FBQztFQUNiO0VBRUFDLFlBQVlBLENBQUNDLEVBQVUsRUFBRVQsSUFBWSxFQUFFQyxPQUE2QixFQUFjO0lBQ2hGLE1BQU1TLFFBQVEsR0FBRyxJQUFJLENBQUNyQixTQUFTLENBQUNzQixHQUFHLENBQUNGLEVBQUUsQ0FBQztJQUN2QyxNQUFNTixTQUFTLEdBQUdPLFFBQVEsSUFBSUEsUUFBUSxDQUFDVixJQUFJLEtBQUtBLElBQUksR0FBR1UsUUFBUSxDQUFDUCxTQUFTLEdBQUdDLElBQUksQ0FBQ0MsR0FBRyxDQUFDLENBQUM7SUFDdEYsSUFBSSxDQUFDaEIsU0FBUyxDQUFDdUIsR0FBRyxDQUFDSCxFQUFFLEVBQUU7TUFBRVQsSUFBSTtNQUFFTSxNQUFNLEVBQUVMLE9BQU8sRUFBRUssTUFBTTtNQUFFSDtJQUFVLENBQUMsQ0FBQztJQUNwRSxJQUFJLENBQUNJLElBQUksQ0FBQyxDQUFDO0lBQ1gsT0FBTyxNQUFNLElBQUksQ0FBQ00sYUFBYSxDQUFDSixFQUFFLENBQUM7RUFDckM7RUFFQUksYUFBYUEsQ0FBQ0osRUFBVSxFQUFRO0lBQzlCLElBQUksQ0FBQ3BCLFNBQVMsQ0FBQ1MsTUFBTSxDQUFDVyxFQUFFLENBQUM7SUFDekIsSUFBSSxDQUFDRixJQUFJLENBQUMsQ0FBQztFQUNiO0VBRVFWLFlBQVlBLENBQUEsRUFBMkI7SUFDN0MsSUFBSSxJQUFJLENBQUNSLFNBQVMsQ0FBQ3lCLElBQUksRUFBRTtNQUN2QixNQUFNQyxJQUFJLEdBQUdDLEtBQUssQ0FBQ0MsSUFBSSxDQUFDLElBQUksQ0FBQzVCLFNBQVMsQ0FBQzZCLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQ0MsR0FBRyxDQUFDLENBQUM7TUFDdEQsSUFBSUosSUFBSSxFQUFFLE9BQU9BLElBQUk7SUFDdkI7SUFDQSxPQUFPLElBQUksQ0FBQzNCLElBQUk7RUFDbEI7RUFFUW1CLElBQUlBLENBQUEsRUFBUztJQUNuQixNQUFNYSxLQUFLLEdBQUcsSUFBSSxDQUFDdkIsWUFBWSxDQUFDLENBQUM7SUFDakMsSUFBSSxDQUFDdUIsS0FBSyxFQUFFO0lBQ1osS0FBSyxNQUFNQyxHQUFHLElBQUksSUFBSSxDQUFDOUIsV0FBVyxFQUFFO01BQ2xDLElBQUk7UUFDRjhCLEdBQUcsQ0FBQ0QsS0FBSyxDQUFDO01BQ1osQ0FBQyxDQUFDLE1BQU07UUFDTjtNQUFBO0lBRUo7RUFDRjtBQUNGO0FBQUNFLE9BQUEsQ0FBQW5DLGlCQUFBLEdBQUFBLGlCQUFBIiwiaWdub3JlTGlzdCI6W119