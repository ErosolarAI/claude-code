{"version":3,"names":["_nodeCrypto","require","_nodeFs","_nodePath","_sessionStorage","listSessions","profile","index","readIndex","entries","Object","values","filtered","filter","entry","sort","a","b","aTime","Date","parse","updatedAt","bTime","saveSessionSnapshot","options","ensureDirectory","Array","isArray","messages","Error","now","toISOString","existingId","id","summaryId","randomUUID","previous","summary","title","sanitizeTitle","buildDefaultTitle","provider","model","workspaceRoot","undefined","createdAt","messageCount","length","payload","scrollbackBuffer","writeFile","getSessionPath","JSON","stringify","writeIndex","loadSessionById","raw","readFile","parsed","deleteSession","getSessionStorage","deleteFile","saveAutosaveSnapshot","getAutosavePath","loadAutosaveSnapshot","clearAutosaveSnapshot","getIndexPath","ensureDir","getSessionsDir","join","root","path","content","value","trimmed","trim","slice","message","role","condensed","replace","toLocaleString","pruneOrphans","known","Set","keys","dir","file","readdirSync","endsWith","includes","has","candidate","stats","statSync","isFile"],"sources":["sessionStore.ts"],"sourcesContent":["import { randomUUID } from 'node:crypto';\nimport { readdirSync, statSync } from 'node:fs';\nimport { join } from 'node:path';\nimport type { ConversationMessage, ProviderId } from './types.js';\nimport type { ProfileName } from '../config.js';\nimport { getSessionStorage } from './sessionStorage.js';\n\nexport interface SessionSummary {\n  id: string;\n  title: string;\n  profile: ProfileName;\n  provider: ProviderId;\n  model: string;\n  createdAt: string;\n  updatedAt: string;\n  messageCount: number;\n  workspaceRoot?: string;\n}\n\nexport interface StoredSession extends SessionSummary {\n  messages: ConversationMessage[];\n  scrollbackBuffer?: string[]; // Optional scrollback history\n}\n\nexport interface SaveSessionOptions {\n  id?: string | null;\n  title?: string | null;\n  profile: ProfileName;\n  provider: ProviderId;\n  model: string;\n  workspaceRoot?: string | null;\n  messages: ConversationMessage[];\n  scrollbackBuffer?: string[]; // Optional scrollback history\n}\n\ninterface SessionIndex {\n  entries: Record<string, SessionSummary>;\n}\n\nexport function listSessions(profile?: ProfileName): SessionSummary[] {\n  const index = readIndex();\n  const entries = Object.values(index.entries);\n  const filtered = profile ? entries.filter((entry) => entry.profile === profile) : entries;\n  return filtered.sort((a, b) => {\n    const aTime = Date.parse(a.updatedAt ?? '') || 0;\n    const bTime = Date.parse(b.updatedAt ?? '') || 0;\n    return bTime - aTime;\n  });\n}\n\nexport function saveSessionSnapshot(options: SaveSessionOptions): SessionSummary {\n  ensureDirectory();\n  if (!Array.isArray(options.messages)) {\n    throw new Error('Session snapshots must include the entire message history array.');\n  }\n\n  const index = readIndex();\n  const now = new Date().toISOString();\n  const existingId = options.id ?? null;\n  const summaryId =\n    existingId && index.entries[existingId] ? existingId : randomUUID();\n  const previous = index.entries[summaryId];\n\n  const summary: SessionSummary = {\n    id: summaryId,\n    title: sanitizeTitle(options.title) ?? previous?.title ?? buildDefaultTitle(options.messages),\n    profile: options.profile,\n    provider: options.provider,\n    model: options.model,\n    workspaceRoot: options.workspaceRoot ?? previous?.workspaceRoot ?? undefined,\n    createdAt: previous?.createdAt ?? now,\n    updatedAt: now,\n    messageCount: options.messages.length,\n  };\n\n  const payload: StoredSession = {\n    ...summary,\n    messages: options.messages,\n    ...(options.scrollbackBuffer && { scrollbackBuffer: options.scrollbackBuffer }),\n  };\n\n  writeFile(getSessionPath(summaryId), JSON.stringify(payload, null, 2));\n  index.entries[summaryId] = summary;\n  writeIndex(index);\n  return summary;\n}\n\nexport function loadSessionById(id: string): StoredSession | null {\n  if (!id) {\n    return null;\n  }\n  const raw = readFile(getSessionPath(id));\n  if (!raw) return null;\n  try {\n    const parsed = JSON.parse(raw) as StoredSession;\n    return parsed;\n  } catch {\n    return null;\n  }\n}\n\nexport function deleteSession(id: string): boolean {\n  if (!id) {\n    return false;\n  }\n  const index = readIndex();\n  if (!index.entries[id]) {\n    return false;\n  }\n  getSessionStorage().deleteFile(getSessionPath(id));\n  delete index.entries[id];\n  writeIndex(index);\n  return true;\n}\n\nexport function saveAutosaveSnapshot(\n  profile: ProfileName,\n  options: Omit<SaveSessionOptions, 'profile'>\n): void {\n  ensureDirectory();\n  const payload: StoredSession = {\n    id: `autosave-${profile}`,\n    profile,\n    provider: options.provider,\n    model: options.model,\n    workspaceRoot: options.workspaceRoot ?? undefined,\n    createdAt: new Date().toISOString(),\n    updatedAt: new Date().toISOString(),\n    title: sanitizeTitle(options.title) ?? buildDefaultTitle(options.messages),\n    messageCount: options.messages.length,\n    messages: options.messages,\n  };\n  writeFile(getAutosavePath(profile), JSON.stringify(payload, null, 2));\n}\n\nexport function loadAutosaveSnapshot(profile: ProfileName): StoredSession | null {\n  const raw = readFile(getAutosavePath(profile));\n  if (!raw) return null;\n  try {\n    return JSON.parse(raw) as StoredSession;\n  } catch {\n    return null;\n  }\n}\n\nexport function clearAutosaveSnapshot(profile: ProfileName): void {\n  getSessionStorage().deleteFile(getAutosavePath(profile));\n}\n\nfunction readIndex(): SessionIndex {\n  ensureDirectory();\n  try {\n    const raw = readFile(getIndexPath());\n    const parsed = JSON.parse(raw) as SessionIndex;\n    if (!parsed || typeof parsed !== 'object' || typeof parsed.entries !== 'object') {\n      return { entries: {} };\n    }\n    return { entries: { ...parsed.entries } };\n  } catch {\n    return { entries: {} };\n  }\n}\n\nfunction writeIndex(index: SessionIndex): void {\n  ensureDirectory();\n  writeFile(getIndexPath(), JSON.stringify(index, null, 2));\n}\n\nfunction ensureDirectory(): void {\n  getSessionStorage().ensureDir(getSessionsDir());\n}\n\nfunction getSessionPath(id: string): string {\n  return join(getSessionsDir(), `${id}.json`);\n}\n\nfunction getAutosavePath(profile: ProfileName): string {\n  return join(getSessionsDir(), `${profile}-autosave.json`);\n}\n\nfunction getSessionsDir(): string {\n  return join(getSessionStorage().root, 'sessions');\n}\n\nfunction getIndexPath(): string {\n  return join(getSessionsDir(), 'index.json');\n}\n\nfunction readFile(path: string): string | null {\n  return getSessionStorage().readFile(path);\n}\n\nfunction writeFile(path: string, content: string): void {\n  return getSessionStorage().writeFile(path, content);\n}\n\nfunction sanitizeTitle(value: string | null | undefined): string | null {\n  if (typeof value !== 'string') {\n    return null;\n  }\n  const trimmed = value.trim();\n  if (!trimmed) {\n    return null;\n  }\n  return trimmed.slice(0, 160);\n}\n\nfunction buildDefaultTitle(messages: ConversationMessage[]): string {\n  for (const message of messages) {\n    if (message.role !== 'user') {\n      continue;\n    }\n    const condensed = message.content.trim().replace(/\\s+/g, ' ');\n    if (condensed) {\n      return condensed.slice(0, 160);\n    }\n  }\n  return `Session ${new Date().toLocaleString()}`;\n}\n\nfunction pruneOrphans(): void {\n  try {\n    ensureDirectory();\n    const index = readIndex();\n    const known = new Set(Object.keys(index.entries));\n    const dir = getSessionsDir();\n    for (const file of readdirSync(dir)) {\n      if (!file.endsWith('.json')) {\n        continue;\n      }\n      if (file === 'index.json' || file.includes('-autosave')) {\n        continue;\n      }\n      const id = file.slice(0, -5);\n      if (!known.has(id)) {\n        const candidate = join(dir, file);\n        const stats = statSync(candidate);\n        if (stats.isFile()) {\n          getSessionStorage().deleteFile(candidate);\n        }\n      }\n    }\n  } catch {\n    // best-effort cleanup\n  }\n}\n\npruneOrphans();\n"],"mappings":"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","ignoreList":[]}