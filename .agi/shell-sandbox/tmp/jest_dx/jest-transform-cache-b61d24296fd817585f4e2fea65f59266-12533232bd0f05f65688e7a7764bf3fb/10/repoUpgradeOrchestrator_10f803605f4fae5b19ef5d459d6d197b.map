{"version":3,"names":["_nodeFs","require","_nodePath","_unifiedOrchestrator","_parallelExecutor","DEFAULT_REWARD_WEIGHTS","exports","executionSuccess","testsPassed","staticAnalysis","codeQuality","blastRadius","selfAssessment","speedBonus","calculateRewardScore","signals","weights","score","totalWeight","key","weight","Object","entries","signal","extractRewardSignals","output","durationMs","baselineDurationMs","lower","toLowerCase","hasErrors","test","testMatch","match","failMatch","passed","parseInt","failed","total","speedRatio","Math","min","max","REPO_UPGRADE_MODE_DEFINITIONS","id","label","description","variants","variantGuidance","primary","parallelVariants","refiner","refinerBias","buildRepoWidePlan","workspaceRoot","additionalScopes","areas","scope","candidates","codemodCommands","validationCommands","extra","trim","slug","replace","push","modules","workspaceModules","detectWorkspaceModules","area","matches","some","candidate","existsSync","join","steps","buildDefaultSteps","length","pkgPath","workspaces","pkg","JSON","parse","readFileSync","parseWorkspaceField","seen","Set","pattern","paths","expandWorkspacePattern","relPath","has","add","cleanPath","name","split","filter","Boolean","pop","normalizedPath","value","Array","isArray","map","entry","record","packages","normalized","includes","target","base","baseDir","readdirSync","withFileTypes","isDirectory","RepoUpgradeOrchestrator","UnifiedOrchestrator","parallelExecutor","constructor","executor","getParallelExecutor","concurrency","ParallelExecutor","maxConcurrency","continueOnFailure","onTaskEvent","event","emit","type","timestamp","data","run","plan","options","mode","objective","modeDefinition","getModeDefinition","parallelModules","parallelModuleConcurrency","variantWorkspaceRoots","repoPolicy","undefined","results","findings","variantStats","primaryWins","refinerWins","ties","totalSteps","Date","now","moduleReports","runModulesInParallel","runModulesSequentially","baseReport","generateReport","halted","module","status","moduleReport","processModule","moduleCount","tasks","createTask","parallelizable","group","batchResult","execute","totalDurationMs","successCount","failureCount","parallelismAchieved","result","moduleId","taskId","find","m","step","outcome","runStep","updateVariantStats","winner","success","stepId","variant","variantResults","canRunParallel","variantPromises","safeExecuteVariant","previousResult","Promise","all","winnerVariant","pickWinner","recordOutcomeArtifacts","primaryScore","primarySuccess","refinerScore","refinerSuccess","intent","input","error","message","Error","String","summary","detail","execution","duration","command","notes","definition","stats","refinerScoreRaw","scoresClose","abs","bothSucceeded","prompt"],"sources":["repoUpgradeOrchestrator.ts"],"sourcesContent":["import { existsSync, readFileSync, readdirSync } from 'node:fs';\nimport { join } from 'node:path';\nimport { UnifiedOrchestrator, type ExecutionResult, type Finding, type OperationReport } from './unifiedOrchestrator.js';\nimport { ParallelExecutor, createTask, type ParallelTask } from './parallelExecutor.js';\n\nexport type RepoUpgradeMode = 'single-continuous' | 'dual-rl-continuous' | 'dual-rl-tournament';\nexport type UpgradeVariant = 'primary' | 'refiner';\n\n/**\n * Reward signal components for multi-objective RL scoring.\n * Each signal is normalized to [0, 1] range.\n */\nexport interface RewardSignals {\n  /** Did the execution complete without errors? (0 or 1) */\n  executionSuccess: number;\n  /** Did tests pass? (0-1, partial credit for some passing) */\n  testsPassed: number;\n  /** Did lint/type checks pass? (0-1) */\n  staticAnalysis: number;\n  /** Code quality metrics (complexity reduction, no new warnings) */\n  codeQuality: number;\n  /** How minimal/surgical were the changes? (inverse of blast radius) */\n  blastRadius: number;\n  /** Confidence from LLM self-assessment keywords */\n  selfAssessment: number;\n  /** Bonus for faster execution (relative to baseline) */\n  speedBonus: number;\n}\n\n/**\n * Weights for combining reward signals into final score.\n * Tuned for safe, high-quality upgrades.\n */\nexport interface RewardWeights {\n  executionSuccess: number;\n  testsPassed: number;\n  staticAnalysis: number;\n  codeQuality: number;\n  blastRadius: number;\n  selfAssessment: number;\n  speedBonus: number;\n}\n\nexport const DEFAULT_REWARD_WEIGHTS: RewardWeights = {\n  executionSuccess: 0.25,\n  testsPassed: 0.30,\n  staticAnalysis: 0.15,\n  codeQuality: 0.10,\n  blastRadius: 0.10,\n  selfAssessment: 0.05,\n  speedBonus: 0.05,\n};\n\n/**\n * Calculate composite reward score from individual signals.\n */\nexport function calculateRewardScore(\n  signals: Partial<RewardSignals>,\n  weights: RewardWeights = DEFAULT_REWARD_WEIGHTS\n): number {\n  let score = 0;\n  let totalWeight = 0;\n\n  for (const [key, weight] of Object.entries(weights)) {\n    const signal = signals[key as keyof RewardSignals];\n    if (typeof signal === 'number') {\n      score += signal * weight;\n      totalWeight += weight;\n    }\n  }\n\n  return totalWeight > 0 ? score / totalWeight : 0;\n}\n\n/**\n * Extract reward signals from execution output text.\n */\nexport function extractRewardSignals(\n  output: string,\n  durationMs: number,\n  baselineDurationMs = 60000\n): Partial<RewardSignals> {\n  const lower = output.toLowerCase();\n  const signals: Partial<RewardSignals> = {};\n\n  // Execution success - no error keywords\n  const hasErrors = /\\b(error|exception|failed|failure|fatal)\\b/i.test(output);\n  signals.executionSuccess = hasErrors ? 0 : 1;\n\n  // Tests passed - look for test result patterns\n  const testMatch = output.match(/(\\d+)\\s*(?:tests?\\s*)?pass(?:ed|ing)?/i);\n  const failMatch = output.match(/(\\d+)\\s*(?:tests?\\s*)?fail(?:ed|ing)?/i);\n  if (testMatch || failMatch) {\n    const passed = parseInt(testMatch?.[1] ?? '0', 10);\n    const failed = parseInt(failMatch?.[1] ?? '0', 10);\n    const total = passed + failed;\n    signals.testsPassed = total > 0 ? passed / total : (/pass|success|✓/i.test(lower) ? 1 : 0.5);\n  } else if (/all tests pass|tests passing|✓.*test/i.test(lower)) {\n    signals.testsPassed = 1;\n  }\n\n  // Static analysis - lint/type check patterns\n  if (/lint.*pass|no.*lint.*error|eslint.*clean|tsc.*success/i.test(lower)) {\n    signals.staticAnalysis = 1;\n  } else if (/lint.*warn|eslint.*warn/i.test(lower)) {\n    signals.staticAnalysis = 0.7;\n  } else if (/lint.*error|type.*error|eslint.*error/i.test(lower)) {\n    signals.staticAnalysis = 0.3;\n  }\n\n  // Self-assessment from confidence keywords\n  if (/confident|verified|validated|confirmed/i.test(lower)) {\n    signals.selfAssessment = 0.9;\n  } else if (/likely|probably|should work/i.test(lower)) {\n    signals.selfAssessment = 0.6;\n  } else if (/uncertain|unclear|might|may/i.test(lower)) {\n    signals.selfAssessment = 0.3;\n  }\n\n  // Speed bonus - faster than baseline gets bonus\n  if (durationMs > 0 && baselineDurationMs > 0) {\n    const speedRatio = baselineDurationMs / durationMs;\n    signals.speedBonus = Math.min(1, Math.max(0, (speedRatio - 0.5) / 1.5));\n  }\n\n  return signals;\n}\n\nexport interface RepoUpgradeModeDefinition {\n  id: RepoUpgradeMode;\n  label: string;\n  description: string;\n  /** Ordered list of variants to execute for this mode */\n  variants: UpgradeVariant[];\n  /** Guidance to inject into prompts per variant */\n  variantGuidance?: Partial<Record<UpgradeVariant, string>>;\n  /** Bias to apply to the refiner when scores are tied (encourages RL exploration) */\n  refinerBias?: number;\n  /** Enable parallel variant execution (requires isolated workspaces) */\n  parallelVariants?: boolean;\n}\n\nexport const REPO_UPGRADE_MODE_DEFINITIONS: Record<RepoUpgradeMode, RepoUpgradeModeDefinition> = {\n  'single-continuous': {\n    id: 'single-continuous',\n    label: 'Single continuous',\n    description: 'Single-pass deterministic execution focused on minimal blast radius.',\n    variants: ['primary'],\n    variantGuidance: {\n      primary: 'Plan and execute the best possible upgrade in one pass. Keep edits surgical and runnable.',\n    },\n    parallelVariants: false,\n  },\n  'dual-rl-continuous': {\n    id: 'dual-rl-continuous',\n    label: 'Dual-agent RL continuous',\n    description: 'Primary + refiner loop where the refiner competes to improve safety and quality. Refiner sees primary output.',\n    variants: ['primary', 'refiner'],\n    variantGuidance: {\n      primary: 'Primary pass sets the baseline plan and changes with conservative scope and runnable checks.',\n      refiner:\n        'RL refiner critiques the primary, fixes gaps, tightens safety, and only repeats steps if they materially improve the result.',\n    },\n    refinerBias: 0.05,\n    parallelVariants: false, // Sequential so refiner can see primary's work\n  },\n  'dual-rl-tournament': {\n    id: 'dual-rl-tournament',\n    label: 'Dual-agent RL tournament',\n    description: 'Primary and refiner compete in parallel with isolated workspaces. Best result wins per step.',\n    variants: ['primary', 'refiner'],\n    variantGuidance: {\n      primary: 'Execute the upgrade with focus on correctness and test coverage. You are competing against another agent.',\n      refiner:\n        'Execute the upgrade with focus on safety and minimal changes. You are competing against another agent.',\n    },\n    refinerBias: 0.03, // Lower bias since both start fresh\n    parallelVariants: true, // Run in parallel with git worktree isolation\n  },\n};\n\nexport type UpgradeStepIntent = 'analyze' | 'upgrade' | 'verify' | 'cleanup';\n\nexport interface RepoUpgradeStep {\n  id: string;\n  intent: UpgradeStepIntent;\n  description: string;\n  /** Optional instruction or prompt to feed into the executor */\n  prompt?: string;\n}\n\nexport interface RepoUpgradeModule {\n  id: string;\n  label: string;\n  description: string;\n  scope: string[];\n  /** Suggested codemod commands to run for this module (display only, not executed automatically). */\n  codemodCommands?: string[];\n  /** Suggested validation commands to run for this module (display only, not executed automatically). */\n  validationCommands?: string[];\n  steps: RepoUpgradeStep[];\n}\n\nexport interface RepoUpgradePlan {\n  modules: RepoUpgradeModule[];\n}\n\nexport interface UpgradeStepExecutionInput {\n  module: RepoUpgradeModule;\n  step: RepoUpgradeStep;\n  /** Which path we are taking: single-pass primary or the dual RL refiner */\n  variant: UpgradeVariant;\n  mode: RepoUpgradeMode;\n  previousResult?: UpgradeStepResult;\n  workspaceRoot?: string;\n  repoPolicy?: string;\n}\n\nexport interface UpgradeStepResult {\n  success: boolean;\n  summary: string;\n  detail?: string;\n  score?: number;\n  durationMs?: number;\n  execution?: ExecutionResult;\n  findings?: Finding[];\n  notes?: string[];\n}\n\nexport interface UpgradeStepOutcome {\n  stepId: string;\n  intent: UpgradeStepIntent;\n  description: string;\n  primary: UpgradeStepResult;\n  refiner?: UpgradeStepResult;\n  winner: UpgradeStepResult;\n  winnerVariant: UpgradeVariant;\n  status: 'completed' | 'failed';\n}\n\nexport interface UpgradeModuleReport {\n  id: string;\n  label: string;\n  scope: string[];\n  codemodCommands?: string[];\n  validationCommands?: string[];\n  steps: UpgradeStepOutcome[];\n  status: 'completed' | 'failed' | 'skipped';\n  validations?: ValidationRunResult[];\n}\n\nexport interface RepoUpgradeReport extends OperationReport {\n  mode: RepoUpgradeMode;\n  continueOnFailure: boolean;\n  modules: UpgradeModuleReport[];\n  validationArtifacts?: ValidationRunResult[];\n  /** True when validation commands were executed instead of just suggested */\n  validationsExecuted?: boolean;\n  variantStats: VariantWinStats;\n  /** Paths used per variant when running dual workspaces (for git/worktree integrations). */\n  variantWorkspaceRoots?: Partial<Record<UpgradeVariant, string>>;\n  /** Optional policy that guided the run (e.g., upgrade or change-management policy). */\n  repoPolicy?: string;\n}\n\nexport interface RepoUpgradeRunOptions {\n  objective?: string;\n  mode: RepoUpgradeMode;\n  continueOnFailure?: boolean;\n  /** Optional per-variant workspace roots when running dual RL with separate repos. */\n  variantWorkspaceRoots?: Partial<Record<UpgradeVariant, string>>;\n  /** Optional policy/guideline string to surface in prompts and reports. */\n  repoPolicy?: string;\n  /** Enable parallel module processing (default: false for safety). */\n  parallelModules?: boolean;\n  /** Maximum concurrent modules when parallel processing is enabled (default: 3). */\n  parallelModuleConcurrency?: number;\n  /** Enable parallel variant execution in dual-RL mode (default: true). */\n  parallelVariants?: boolean;\n}\n\nexport type UpgradeStepExecutor = (input: UpgradeStepExecutionInput) => Promise<UpgradeStepResult>;\n\nexport interface ValidationRunResult {\n  command: string;\n  success: boolean;\n  output: string;\n  error?: string;\n  durationMs: number;\n  skipped?: boolean;\n  reason?: string;\n}\n\nexport interface VariantWinStats {\n  primaryWins: number;\n  refinerWins: number;\n  /** Number of steps where scores were effectively tied and bias picked the winner */\n  ties: number;\n  totalSteps: number;\n}\n\n/**\n * Build a repo-wide upgrade plan using common directories. Falls back to a single\n * catch-all module when no known scopes are found.\n */\nexport function buildRepoWidePlan(workspaceRoot: string, additionalScopes: string[] = []): RepoUpgradePlan {\n  const areas: Array<{\n    id: string;\n    label: string;\n    description: string;\n    scope: string[];\n    candidates: string[];\n    codemodCommands?: string[];\n    validationCommands?: string[];\n  }> = [\n    {\n      id: 'source',\n      label: 'Source',\n      description: 'Core application and library code.',\n      scope: ['src/**/*', 'lib/**/*'],\n      candidates: ['src', 'lib'],\n      codemodCommands: ['npx jscodeshift -t <transform> src'],\n      validationCommands: ['npm run build', 'npm test'],\n    },\n    {\n      id: 'tests',\n      label: 'Tests',\n      description: 'Unit, integration, and smoke tests.',\n      scope: ['test/**/*', '__tests__/**/*'],\n      candidates: ['test', '__tests__'],\n      validationCommands: ['npm test -- --runInBand', 'npm run lint'],\n    },\n    {\n      id: 'docs',\n      label: 'Docs',\n      description: 'Documentation and guides.',\n      scope: ['docs/**/*', 'README.md'],\n      candidates: ['docs', 'README.md'],\n    },\n    {\n      id: 'scripts',\n      label: 'Tooling Scripts',\n      description: 'Build, migration, and maintenance scripts.',\n      scope: ['scripts/**/*'],\n      candidates: ['scripts'],\n      validationCommands: ['npm run lint -- scripts/**/*.ts'],\n    },\n    {\n      id: 'agents',\n      label: 'Agents',\n      description: 'Agent rules and behaviors.',\n      scope: ['agents/**/*'],\n      candidates: ['agents'],\n      validationCommands: ['npm run build'],\n    },\n    {\n      id: 'skills',\n      label: 'Skills',\n      description: 'Skill packs and reusable automation.',\n      scope: ['skills/**/*'],\n      candidates: ['skills'],\n      validationCommands: ['npm run build'],\n    },\n    {\n      id: 'examples',\n      label: 'Examples',\n      description: 'Example flows and templates.',\n      scope: ['examples/**/*'],\n      candidates: ['examples'],\n    },\n    {\n      id: 'configs',\n      label: 'Configuration',\n      description: 'Configuration and deployment settings.',\n      scope: ['config/**/*', '*.config.*', '*.rc', '*.json'],\n      candidates: ['config'],\n    },\n  ];\n\n  for (const extra of additionalScopes) {\n    if (!extra?.trim()) continue;\n    const slug = extra.replace(/[^\\w]/g, '-').toLowerCase() || 'custom';\n    areas.push({\n      id: `custom-${slug}`,\n      label: `Custom: ${extra}`,\n      description: `User-specified scope: ${extra}`,\n      scope: [`${extra}/**/*`],\n      candidates: [extra],\n    });\n  }\n\n  const modules: RepoUpgradeModule[] = [];\n  const workspaceModules = detectWorkspaceModules(workspaceRoot);\n  modules.push(...workspaceModules);\n\n  for (const area of areas) {\n    const matches = area.candidates.some((candidate) => existsSync(join(workspaceRoot, candidate)));\n    if (!matches) {\n      continue;\n    }\n    modules.push({\n      id: area.id,\n      label: area.label,\n      description: area.description,\n      scope: area.scope,\n      codemodCommands: area.codemodCommands,\n      validationCommands: area.validationCommands,\n      steps: buildDefaultSteps(area.id),\n    });\n  }\n\n  if (modules.length === 0) {\n    modules.push({\n      id: 'repo-wide',\n      label: 'Repository',\n      description: 'Fallback repo-wide upgrade module.',\n      scope: ['**/*'],\n      steps: buildDefaultSteps('repo'),\n    });\n  }\n\n  return { modules };\n}\n\nfunction detectWorkspaceModules(workspaceRoot: string): RepoUpgradeModule[] {\n  const pkgPath = join(workspaceRoot, 'package.json');\n  if (!existsSync(pkgPath)) {\n    return [];\n  }\n\n  let workspaces: string[] = [];\n  try {\n    const pkg = JSON.parse(readFileSync(pkgPath, 'utf8'));\n    workspaces = parseWorkspaceField(pkg?.workspaces);\n  } catch {\n    return [];\n  }\n\n  if (!workspaces.length) {\n    return [];\n  }\n\n  const modules: RepoUpgradeModule[] = [];\n  const seen = new Set<string>();\n\n  for (const pattern of workspaces) {\n    const paths = expandWorkspacePattern(workspaceRoot, pattern);\n    for (const relPath of paths) {\n      if (seen.has(relPath)) {\n        continue;\n      }\n      seen.add(relPath);\n\n      const cleanPath = relPath.replace(/\\/+$/, '');\n      const name = cleanPath.split('/').filter(Boolean).pop() ?? cleanPath;\n      const normalizedPath = cleanPath.replace(/[/\\\\]+/g, '-');\n      const slug = `workspace-${normalizedPath.replace(/[^\\w-]+/g, '-').replace(/-+/g, '-').toLowerCase() || 'default'}`;\n\n      modules.push({\n        id: slug,\n        label: `Workspace: ${name}`,\n        description: `Upgrade tasks scoped to workspace \"${name}\" (${cleanPath}).`,\n        scope: [`${cleanPath}/**/*`],\n        validationCommands: [\n          `npm test --workspace ${name} --if-present`,\n          `npm run lint --workspace ${name} --if-present`,\n        ],\n        steps: buildDefaultSteps(slug),\n      });\n    }\n  }\n\n  return modules;\n}\n\nfunction parseWorkspaceField(value: unknown): string[] {\n  if (Array.isArray(value)) {\n    return value.map((entry) => (typeof entry === 'string' ? entry.trim() : '')).filter(Boolean);\n  }\n  if (value && typeof value === 'object') {\n    const record = value as { packages?: unknown };\n    if (Array.isArray(record.packages)) {\n      return record.packages.map((entry) => (typeof entry === 'string' ? entry.trim() : '')).filter(Boolean);\n    }\n  }\n  return [];\n}\n\nfunction expandWorkspacePattern(workspaceRoot: string, pattern: string): string[] {\n  const normalized = pattern.trim();\n  if (!normalized) return [];\n\n  if (!normalized.includes('*')) {\n    const target = join(workspaceRoot, normalized);\n    return existsSync(target) ? [normalized] : [];\n  }\n\n  const base = normalized.split('*')[0]?.replace(/\\/+$/, '') ?? '';\n  if (!base) return [];\n\n  const baseDir = join(workspaceRoot, base);\n  if (!existsSync(baseDir)) return [];\n\n  try {\n    const entries = readdirSync(baseDir, { withFileTypes: true });\n    return entries.filter((entry) => entry.isDirectory()).map((entry) => `${base}/${entry.name}`);\n  } catch {\n    return [];\n  }\n}\n\nexport class RepoUpgradeOrchestrator extends UnifiedOrchestrator {\n  private readonly executor: UpgradeStepExecutor;\n  private variantWorkspaceRoots: Partial<Record<UpgradeVariant, string>> | undefined;\n  private repoPolicy: string | undefined;\n  private parallelExecutor: ParallelExecutor | null = null;\n\n  constructor(executor: UpgradeStepExecutor) {\n    super();\n    this.executor = executor;\n  }\n\n  /**\n   * Get or create a parallel executor instance\n   */\n  private getParallelExecutor(concurrency: number): ParallelExecutor {\n    if (!this.parallelExecutor) {\n      this.parallelExecutor = new ParallelExecutor({\n        maxConcurrency: concurrency,\n        continueOnFailure: true,\n        onTaskEvent: (event) => {\n          this.emit({\n            type: `parallel.${event.type}`,\n            timestamp: event.timestamp,\n            data: event.data,\n          });\n        },\n      });\n    }\n    return this.parallelExecutor;\n  }\n\n  /**\n   * Execute the repo-wide plan using either single continuous or dual RL continuous mode.\n   * Supports parallel module processing and parallel variant execution for improved performance.\n   */\n  async run(plan: RepoUpgradePlan, options: RepoUpgradeRunOptions): Promise<RepoUpgradeReport> {\n    const mode = options.mode;\n    const continueOnFailure = options.continueOnFailure ?? true;\n    const objective = options.objective ?? 'Repository-wide source code upgrade';\n    const modeDefinition = getModeDefinition(mode);\n    const parallelModules = options.parallelModules ?? false;\n    const parallelModuleConcurrency = options.parallelModuleConcurrency ?? 3;\n    const parallelVariants = options.parallelVariants ?? true;\n    this.variantWorkspaceRoots = options.variantWorkspaceRoots;\n    this.repoPolicy = options.repoPolicy ?? undefined;\n\n    // Reset state per run to keep reports clean\n    this.results = [];\n    this.findings = [];\n    this.parallelExecutor = null;\n\n    const variantStats: VariantWinStats = { primaryWins: 0, refinerWins: 0, ties: 0, totalSteps: 0 };\n\n    // Emit parallel mode info\n    this.emit({\n      type: 'upgrade.parallel.config',\n      timestamp: Date.now(),\n      data: {\n        parallelModules,\n        parallelModuleConcurrency,\n        parallelVariants,\n        mode,\n      },\n    });\n\n    let moduleReports: UpgradeModuleReport[];\n\n    if (parallelModules && plan.modules.length > 1) {\n      // PARALLEL MODULE PROCESSING\n      moduleReports = await this.runModulesInParallel(\n        plan.modules,\n        mode,\n        modeDefinition,\n        parallelModuleConcurrency,\n        parallelVariants,\n        continueOnFailure,\n        variantStats\n      );\n    } else {\n      // SEQUENTIAL MODULE PROCESSING (original behavior)\n      moduleReports = await this.runModulesSequentially(\n        plan.modules,\n        mode,\n        modeDefinition,\n        parallelVariants,\n        continueOnFailure,\n        variantStats\n      );\n    }\n\n    const baseReport = this.generateReport(objective);\n    return {\n      ...baseReport,\n      mode,\n      continueOnFailure,\n      modules: moduleReports,\n      variantStats,\n      variantWorkspaceRoots: this.variantWorkspaceRoots,\n      repoPolicy: this.repoPolicy,\n    };\n  }\n\n  /**\n   * Run modules sequentially (original behavior)\n   */\n  private async runModulesSequentially(\n    modules: RepoUpgradeModule[],\n    mode: RepoUpgradeMode,\n    modeDefinition: RepoUpgradeModeDefinition,\n    parallelVariants: boolean,\n    continueOnFailure: boolean,\n    variantStats: VariantWinStats\n  ): Promise<UpgradeModuleReport[]> {\n    const moduleReports: UpgradeModuleReport[] = [];\n    let halted = false;\n\n    for (const module of modules) {\n      if (halted) {\n        moduleReports.push({\n          id: module.id,\n          label: module.label,\n          scope: module.scope,\n          steps: [],\n          status: 'skipped',\n        });\n        continue;\n      }\n\n      const moduleReport = await this.processModule(module, mode, modeDefinition, parallelVariants, variantStats, continueOnFailure);\n      moduleReports.push(moduleReport);\n\n      if (moduleReport.status === 'failed' && !continueOnFailure) {\n        halted = true;\n      }\n    }\n\n    return moduleReports;\n  }\n\n  /**\n   * Run modules in parallel using the ParallelExecutor\n   */\n  private async runModulesInParallel(\n    modules: RepoUpgradeModule[],\n    mode: RepoUpgradeMode,\n    modeDefinition: RepoUpgradeModeDefinition,\n    concurrency: number,\n    parallelVariants: boolean,\n    continueOnFailure: boolean,\n    variantStats: VariantWinStats\n  ): Promise<UpgradeModuleReport[]> {\n    const executor = this.getParallelExecutor(concurrency);\n\n    this.emit({\n      type: 'upgrade.parallel.start',\n      timestamp: Date.now(),\n      data: { moduleCount: modules.length, concurrency },\n    });\n\n    // Create parallel tasks for each module\n    const tasks: ParallelTask<UpgradeModuleReport>[] = modules.map((module) =>\n      createTask(\n        `module:${module.id}`,\n        async () => this.processModule(module, mode, modeDefinition, parallelVariants, variantStats, continueOnFailure),\n        {\n          label: module.label,\n          parallelizable: true,\n          group: 'modules',\n        }\n      )\n    );\n\n    const batchResult = await executor.execute(tasks);\n\n    this.emit({\n      type: 'upgrade.parallel.complete',\n      timestamp: Date.now(),\n      data: {\n        totalDurationMs: batchResult.totalDurationMs,\n        successCount: batchResult.successCount,\n        failureCount: batchResult.failureCount,\n        parallelismAchieved: batchResult.parallelismAchieved,\n      },\n    });\n\n    // Extract results in order, handling failures\n    const moduleReports: UpgradeModuleReport[] = [];\n    for (const result of batchResult.results) {\n      if (result.status === 'completed' && result.result) {\n        moduleReports.push(result.result);\n      } else {\n        // Create a failed report for tasks that couldn't complete\n        const moduleId = result.taskId.replace('module:', '');\n        const module = modules.find((m) => m.id === moduleId);\n        moduleReports.push({\n          id: moduleId,\n          label: module?.label ?? moduleId,\n          scope: module?.scope ?? [],\n          steps: [],\n          status: 'failed',\n        });\n\n        if (!continueOnFailure) {\n          // Mark remaining as skipped\n          break;\n        }\n      }\n    }\n\n    return moduleReports;\n  }\n\n  /**\n   * Process a single module (can be called in parallel or sequentially)\n   */\n  private async processModule(\n    module: RepoUpgradeModule,\n    mode: RepoUpgradeMode,\n    modeDefinition: RepoUpgradeModeDefinition,\n    parallelVariants: boolean,\n    variantStats: VariantWinStats,\n    continueOnFailure = true\n  ): Promise<UpgradeModuleReport> {\n    this.emit({\n      type: 'upgrade.module.start',\n      timestamp: Date.now(),\n      data: { moduleId: module.id, label: module.label, scope: module.scope, mode },\n    });\n\n    const moduleReport: UpgradeModuleReport = {\n      id: module.id,\n      label: module.label,\n      scope: module.scope,\n      codemodCommands: module.codemodCommands,\n      validationCommands: module.validationCommands,\n      steps: [],\n      status: 'completed',\n    };\n\n    for (const step of module.steps) {\n      const outcome = await this.runStep(module, step, mode, parallelVariants);\n      moduleReport.steps.push(outcome);\n      this.updateVariantStats(variantStats, outcome, modeDefinition);\n\n      if (!outcome.winner.success) {\n        moduleReport.status = 'failed';\n        // Stop processing this module's steps if continueOnFailure is false\n        if (!continueOnFailure) {\n          break;\n        }\n      }\n    }\n\n    this.emit({\n      type: 'upgrade.module.complete',\n      timestamp: Date.now(),\n      data: { moduleId: module.id, status: moduleReport.status },\n    });\n\n    return moduleReport;\n  }\n\n  private async runStep(\n    module: RepoUpgradeModule,\n    step: RepoUpgradeStep,\n    mode: RepoUpgradeMode,\n    parallelVariants = true\n  ): Promise<UpgradeStepOutcome> {\n    const modeDefinition = getModeDefinition(mode);\n    this.emit({\n      type: 'upgrade.step.start',\n      timestamp: Date.now(),\n      data: { moduleId: module.id, stepId: step.id, variant: 'primary', mode, parallelVariants },\n    });\n\n    const variantResults: Partial<Record<UpgradeVariant, UpgradeStepResult>> = {};\n\n    // Determine if we can run variants in parallel\n    // Parallel is possible when:\n    // 1. parallelVariants is enabled\n    // 2. We have both primary and refiner variants\n    // 3. We have separate workspace roots for each variant\n    const canRunParallel =\n      parallelVariants &&\n      modeDefinition.variants.includes('refiner') &&\n      this.variantWorkspaceRoots?.refiner &&\n      this.variantWorkspaceRoots.refiner !== this.variantWorkspaceRoots.primary;\n\n    if (canRunParallel && modeDefinition.variants.length > 1) {\n      // PARALLEL VARIANT EXECUTION\n      this.emit({\n        type: 'upgrade.step.variants.parallel',\n        timestamp: Date.now(),\n        data: { moduleId: module.id, stepId: step.id, variants: modeDefinition.variants },\n      });\n\n      const variantPromises = modeDefinition.variants.map(async (variant) => {\n        const result = await this.safeExecuteVariant({\n          module,\n          step,\n          mode,\n          variant,\n          // In parallel mode, refiner doesn't get primary's result as it runs concurrently\n          previousResult: undefined,\n          workspaceRoot: this.variantWorkspaceRoots?.[variant] ?? this.variantWorkspaceRoots?.primary,\n          repoPolicy: this.repoPolicy,\n        });\n        return { variant, result };\n      });\n\n      const results = await Promise.all(variantPromises);\n      for (const { variant, result } of results) {\n        variantResults[variant] = result;\n      }\n    } else {\n      // SEQUENTIAL VARIANT EXECUTION (original behavior)\n      // Refiner gets primary's result for informed refinement\n      for (const variant of modeDefinition.variants) {\n        const previousResult = variant === 'refiner' ? variantResults.primary : undefined;\n        const result = await this.safeExecuteVariant({\n          module,\n          step,\n          mode,\n          variant,\n          previousResult,\n          workspaceRoot: this.variantWorkspaceRoots?.[variant] ?? this.variantWorkspaceRoots?.primary,\n          repoPolicy: this.repoPolicy,\n        });\n        variantResults[variant] = result;\n      }\n    }\n\n    const primary = variantResults.primary as UpgradeStepResult;\n    const refiner = variantResults.refiner;\n\n    const { winner, winnerVariant } = this.pickWinner(modeDefinition, primary, refiner);\n    this.recordOutcomeArtifacts(module, step, winner, winnerVariant);\n\n    this.emit({\n      type: 'upgrade.step.complete',\n      timestamp: Date.now(),\n      data: {\n        moduleId: module.id,\n        stepId: step.id,\n        variant: winnerVariant,\n        success: winner.success,\n        // Include outcome details for UI scoring\n        primaryScore: primary.score,\n        primarySuccess: primary.success,\n        refinerScore: refiner?.score,\n        refinerSuccess: refiner?.success,\n        winnerVariant,\n      },\n    });\n\n    return {\n      stepId: step.id,\n      intent: step.intent,\n      description: step.description,\n      primary,\n      refiner,\n      winner,\n      winnerVariant,\n      status: winner.success ? 'completed' : 'failed',\n    };\n  }\n\n  private async safeExecuteVariant(input: UpgradeStepExecutionInput): Promise<UpgradeStepResult> {\n    try {\n      return await this.executor(input);\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return {\n        success: false,\n        summary: 'Execution failed',\n        detail: message,\n        score: 0,\n        durationMs: 0,\n        execution: {\n          success: false,\n          output: 'Execution failed',\n          duration: 0,\n          command: `${input.module.id}/${input.step.id}/${input.variant}`,\n          error: message,\n        },\n        notes: ['Executor threw an error'],\n      };\n    }\n  }\n\n  private pickWinner(\n    definition: RepoUpgradeModeDefinition,\n    primary: UpgradeStepResult,\n    refiner?: UpgradeStepResult\n  ): { winner: UpgradeStepResult; winnerVariant: UpgradeVariant } {\n    if (!refiner || !definition.variants.includes('refiner')) {\n      return { winner: primary, winnerVariant: 'primary' };\n    }\n\n    if (refiner.success && !primary.success) {\n      return { winner: refiner, winnerVariant: 'refiner' };\n    }\n    if (primary.success && !refiner.success) {\n      return { winner: primary, winnerVariant: 'primary' };\n    }\n\n    const primaryScore = typeof primary.score === 'number' ? primary.score : 0;\n    const refinerScore = (typeof refiner.score === 'number' ? refiner.score : 0) + (definition.refinerBias ?? 0);\n\n    if (refinerScore > primaryScore) {\n      return { winner: refiner, winnerVariant: 'refiner' };\n    }\n    if (primaryScore > refinerScore) {\n      return { winner: primary, winnerVariant: 'primary' };\n    }\n\n    // Tie breaker: prefer refiner to encourage RL exploration\n    return { winner: refiner, winnerVariant: 'refiner' };\n  }\n\n  private recordOutcomeArtifacts(\n    module: RepoUpgradeModule,\n    step: RepoUpgradeStep,\n    result: UpgradeStepResult,\n    variant: 'primary' | 'refiner'\n  ): void {\n    if (result.findings?.length) {\n      this.findings.push(...result.findings);\n    }\n\n    const execution: ExecutionResult = result.execution ?? {\n      success: result.success,\n      output: result.summary,\n      duration: result.durationMs ?? 0,\n      command: `${module.id}/${step.id}/${variant}`,\n      error: result.success ? undefined : result.detail ?? result.summary,\n    };\n\n    // Ensure we only track a single winner record per step to keep reports clean\n    this.results.push(execution);\n  }\n\n  private updateVariantStats(\n    stats: VariantWinStats,\n    outcome: UpgradeStepOutcome,\n    modeDefinition: RepoUpgradeModeDefinition\n  ): void {\n    stats.totalSteps += 1;\n    if (outcome.winnerVariant === 'refiner') {\n      stats.refinerWins += 1;\n    } else {\n      stats.primaryWins += 1;\n    }\n\n    if (!outcome.refiner) {\n      return;\n    }\n\n    const primaryScore = typeof outcome.primary.score === 'number' ? outcome.primary.score : 0;\n    const refinerScoreRaw = typeof outcome.refiner.score === 'number' ? outcome.refiner.score : 0;\n    const refinerScore = refinerScoreRaw + (modeDefinition.refinerBias ?? 0);\n    const scoresClose = Math.abs(primaryScore - refinerScore) < 1e-6;\n    const bothSucceeded = outcome.primary.success && outcome.refiner.success;\n    if (bothSucceeded && scoresClose) {\n      stats.ties += 1;\n    }\n  }\n}\n\nfunction buildDefaultSteps(moduleId: string): RepoUpgradeStep[] {\n  return [\n    {\n      id: `${moduleId}-analyze`,\n      intent: 'analyze',\n      description: `Map the upgrade surface for ${moduleId}. Identify risky files and coupling.`,\n      prompt: 'Inventory files, dependencies, and breaking-change areas before upgrading.',\n    },\n    {\n      id: `${moduleId}-upgrade`,\n      intent: 'upgrade',\n      description: `Apply modular upgrades for ${moduleId} with minimal blast radius.`,\n      prompt: 'Execute codemods or targeted edits. Keep edits small, atomic, and well scoped.',\n    },\n    {\n      id: `${moduleId}-verify`,\n      intent: 'verify',\n      description: `Validate ${moduleId} after the upgrade.`,\n      prompt: 'Run tests/lint/health checks relevant to this scope. Summarize residual risks.',\n    },\n  ];\n}\n\nfunction getModeDefinition(mode: RepoUpgradeMode): RepoUpgradeModeDefinition {\n  return REPO_UPGRADE_MODE_DEFINITIONS[mode] ?? REPO_UPGRADE_MODE_DEFINITIONS['single-continuous'];\n}\n"],"mappings":"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","ignoreList":[]}