{"version":3,"names":["_asyncUtils","require","RETRYABLE_KEYWORDS","deriveErrorCode","error","name","toUpperCase","normalized","message","trim","replace","undefined","createErrorDetails","context","timestamp","Date","toISOString","Error","code","stack","String","formatErrorForLogging","details","parts","push","JSON","stringify","join","isRetryableError","retryableFlag","retryable","toLowerCase","some","keyword","includes","withRetry","operation","maxRetries","delayMs","attempts","sleep"],"sources":["errorUtils.ts"],"sourcesContent":["import { sleep } from './asyncUtils.js';\n\nexport interface ErrorDetails {\n  message: string;\n  code?: string;\n  context?: Record<string, unknown>;\n  stack?: string;\n  timestamp: string;\n}\n\nconst RETRYABLE_KEYWORDS = [\n  'timeout',\n  'network',\n  'rate limit',\n  'too many requests',\n  'service unavailable',\n];\n\nfunction deriveErrorCode(error: Error): string | undefined {\n  if (error.name && error.name !== 'Error') {\n    return error.name.toUpperCase();\n  }\n\n  const normalized = error.message\n    .trim()\n    .replace(/[^\\w]+/g, '_')\n    .replace(/^_+|_+$/g, '')\n    .toUpperCase();\n\n  return normalized || undefined;\n}\n\nexport function createErrorDetails(\n  error: unknown,\n  context?: Record<string, unknown>\n): ErrorDetails {\n  const timestamp = new Date().toISOString();\n\n  if (error instanceof Error) {\n    return {\n      message: error.message,\n      code: deriveErrorCode(error),\n      context,\n      stack: error.stack,\n      timestamp,\n    };\n  }\n\n  return {\n    message: String(error),\n    context,\n    timestamp,\n  };\n}\n\nexport function formatErrorForLogging(\n  error: unknown,\n  context?: Record<string, unknown>\n): string {\n  const details = createErrorDetails(error, context);\n  const parts = [`Error: ${details.message}`];\n\n  if (context) {\n    parts.push(`Context: ${JSON.stringify(context)}`);\n  }\n\n  parts.push(`Stack: ${details.stack ?? '(not available)'}`);\n  parts.push(`Timestamp: ${details.timestamp}`);\n\n  return parts.join('\\n');\n}\n\nexport function isRetryableError(error: unknown): boolean {\n  if (error && typeof error === 'object' && 'retryable' in (error as Record<string, unknown>)) {\n    const retryableFlag = (error as { retryable?: unknown }).retryable;\n    if (typeof retryableFlag === 'boolean') {\n      return retryableFlag;\n    }\n  }\n\n  const message =\n    error instanceof Error\n      ? error.message\n      : typeof error === 'string'\n        ? error\n        : '';\n\n  if (!message) {\n    return false;\n  }\n\n  const normalized = message.toLowerCase();\n  return RETRYABLE_KEYWORDS.some(keyword => normalized.includes(keyword));\n}\n\nexport async function withRetry<T>(\n  operation: () => Promise<T>,\n  maxRetries: number = 3,\n  delayMs: number = 100\n): Promise<T> {\n  let attempts = 0;\n\n  // eslint-disable-next-line no-constant-condition\n  while (true) {\n    try {\n      return await operation();\n    } catch (error) {\n      if (!isRetryableError(error) || attempts >= maxRetries) {\n        throw error;\n      }\n\n      attempts += 1;\n      if (delayMs > 0) {\n        await sleep(delayMs);\n      }\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}