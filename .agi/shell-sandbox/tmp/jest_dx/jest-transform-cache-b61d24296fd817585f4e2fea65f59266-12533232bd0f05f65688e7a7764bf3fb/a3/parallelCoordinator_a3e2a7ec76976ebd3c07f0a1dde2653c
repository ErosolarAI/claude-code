18326641a7d948a629f6b38abf532d12
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ParallelCoordinator = void 0;
var _parallelExecutor = require("./parallelExecutor.js");
class ParallelCoordinator {
  constructor(runnerFactory) {
    this.runnerFactory = runnerFactory ?? ((concurrency, emit) => new _parallelExecutor.ParallelExecutor({
      maxConcurrency: Math.max(1, concurrency),
      continueOnFailure: true,
      onTaskEvent: event => emit({
        type: `parallel.${event.type}`,
        timestamp: event.timestamp,
        data: event.data ?? {}
      })
    }));
  }
  async runModules(options, modules) {
    const {
      concurrency,
      emit,
      processModule
    } = options;
    const continueOnFailure = options.continueOnFailure;
    emit({
      type: 'upgrade.parallel.start',
      timestamp: Date.now(),
      data: {
        moduleCount: modules.length,
        concurrency
      }
    });
    const tasks = modules.map(module => (0, _parallelExecutor.createTask)(`module:${module.id}`, async () => processModule(module), {
      label: module.label,
      parallelizable: true,
      group: 'modules'
    }));
    const runner = this.runnerFactory(concurrency, emit);
    const batchResult = await runner.execute(tasks);
    emit({
      type: 'upgrade.parallel.complete',
      timestamp: Date.now(),
      data: {
        totalDurationMs: batchResult.totalDurationMs,
        successCount: batchResult.successCount,
        failureCount: batchResult.failureCount,
        parallelismAchieved: batchResult.parallelismAchieved
      }
    });
    const moduleReports = [];
    for (const result of batchResult.results) {
      if (result.status === 'completed' && result.result) {
        moduleReports.push(result.result);
      } else {
        const moduleId = result.taskId.replace('module:', '');
        const module = modules.find(m => m.id === moduleId);
        moduleReports.push({
          id: moduleId,
          label: module?.label ?? moduleId,
          scope: module?.scope ?? [],
          steps: [],
          status: 'failed'
        });
      }
    }
    if (!continueOnFailure) {
      const firstFailure = moduleReports.findIndex(report => report.status === 'failed');
      if (firstFailure >= 0) {
        return moduleReports.slice(0, firstFailure + 1);
      }
    }
    return moduleReports;
  }
}
exports.ParallelCoordinator = ParallelCoordinator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfcGFyYWxsZWxFeGVjdXRvciIsInJlcXVpcmUiLCJQYXJhbGxlbENvb3JkaW5hdG9yIiwiY29uc3RydWN0b3IiLCJydW5uZXJGYWN0b3J5IiwiY29uY3VycmVuY3kiLCJlbWl0IiwiUGFyYWxsZWxFeGVjdXRvciIsIm1heENvbmN1cnJlbmN5IiwiTWF0aCIsIm1heCIsImNvbnRpbnVlT25GYWlsdXJlIiwib25UYXNrRXZlbnQiLCJldmVudCIsInR5cGUiLCJ0aW1lc3RhbXAiLCJkYXRhIiwicnVuTW9kdWxlcyIsIm9wdGlvbnMiLCJtb2R1bGVzIiwicHJvY2Vzc01vZHVsZSIsIkRhdGUiLCJub3ciLCJtb2R1bGVDb3VudCIsImxlbmd0aCIsInRhc2tzIiwibWFwIiwibW9kdWxlIiwiY3JlYXRlVGFzayIsImlkIiwibGFiZWwiLCJwYXJhbGxlbGl6YWJsZSIsImdyb3VwIiwicnVubmVyIiwiYmF0Y2hSZXN1bHQiLCJleGVjdXRlIiwidG90YWxEdXJhdGlvbk1zIiwic3VjY2Vzc0NvdW50IiwiZmFpbHVyZUNvdW50IiwicGFyYWxsZWxpc21BY2hpZXZlZCIsIm1vZHVsZVJlcG9ydHMiLCJyZXN1bHQiLCJyZXN1bHRzIiwic3RhdHVzIiwicHVzaCIsIm1vZHVsZUlkIiwidGFza0lkIiwicmVwbGFjZSIsImZpbmQiLCJtIiwic2NvcGUiLCJzdGVwcyIsImZpcnN0RmFpbHVyZSIsImZpbmRJbmRleCIsInJlcG9ydCIsInNsaWNlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbInBhcmFsbGVsQ29vcmRpbmF0b3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGFyYWxsZWxFeGVjdXRvciwgY3JlYXRlVGFzaywgdHlwZSBQYXJhbGxlbFRhc2ssIHR5cGUgQmF0Y2hSZXN1bHQgfSBmcm9tICcuL3BhcmFsbGVsRXhlY3V0b3IuanMnO1xuaW1wb3J0IHR5cGUgeyBVcGdyYWRlTW9kdWxlUmVwb3J0LCBSZXBvVXBncmFkZU1vZGUsIFJlcG9VcGdyYWRlTW9kZURlZmluaXRpb24sIFZhcmlhbnRXaW5TdGF0cywgUmVwb1VwZ3JhZGVNb2R1bGUgfSBmcm9tICcuL3JlcG9VcGdyYWRlT3JjaGVzdHJhdG9yLmpzJztcblxuZXhwb3J0IGludGVyZmFjZSBQYXJhbGxlbENvb3JkaW5hdG9yT3B0aW9ucyB7XG4gIGNvbmN1cnJlbmN5OiBudW1iZXI7XG4gIG1vZGU6IFJlcG9VcGdyYWRlTW9kZTtcbiAgbW9kZURlZmluaXRpb246IFJlcG9VcGdyYWRlTW9kZURlZmluaXRpb247XG4gIHBhcmFsbGVsVmFyaWFudHM6IGJvb2xlYW47XG4gIGNvbnRpbnVlT25GYWlsdXJlOiBib29sZWFuO1xuICB2YXJpYW50U3RhdHM6IFZhcmlhbnRXaW5TdGF0cztcbiAgcHJvY2Vzc01vZHVsZTogKG1vZHVsZTogUmVwb1VwZ3JhZGVNb2R1bGUpID0+IFByb21pc2U8VXBncmFkZU1vZHVsZVJlcG9ydD47XG4gIGVtaXQ6IChldmVudDogeyB0eXBlOiBzdHJpbmc7IHRpbWVzdGFtcDogbnVtYmVyOyBkYXRhOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiB9KSA9PiB2b2lkO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBhcmFsbGVsUnVubmVyIHtcbiAgZXhlY3V0ZSh0YXNrczogUGFyYWxsZWxUYXNrPFVwZ3JhZGVNb2R1bGVSZXBvcnQ+W10pOiBQcm9taXNlPEJhdGNoUmVzdWx0PFVwZ3JhZGVNb2R1bGVSZXBvcnQ+Pjtcbn1cblxuZXhwb3J0IGNsYXNzIFBhcmFsbGVsQ29vcmRpbmF0b3Ige1xuICBwcml2YXRlIHJlYWRvbmx5IHJ1bm5lckZhY3Rvcnk6IChjb25jdXJyZW5jeTogbnVtYmVyLCBlbWl0OiBQYXJhbGxlbENvb3JkaW5hdG9yT3B0aW9uc1snZW1pdCddKSA9PiBQYXJhbGxlbFJ1bm5lcjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBydW5uZXJGYWN0b3J5PzogKGNvbmN1cnJlbmN5OiBudW1iZXIsIGVtaXQ6IFBhcmFsbGVsQ29vcmRpbmF0b3JPcHRpb25zWydlbWl0J10pID0+IFBhcmFsbGVsUnVubmVyXG4gICkge1xuICAgIHRoaXMucnVubmVyRmFjdG9yeSA9XG4gICAgICBydW5uZXJGYWN0b3J5ID8/XG4gICAgICAoKGNvbmN1cnJlbmN5LCBlbWl0KSA9PlxuICAgICAgICBuZXcgUGFyYWxsZWxFeGVjdXRvcih7XG4gICAgICAgICAgbWF4Q29uY3VycmVuY3k6IE1hdGgubWF4KDEsIGNvbmN1cnJlbmN5KSxcbiAgICAgICAgICBjb250aW51ZU9uRmFpbHVyZTogdHJ1ZSxcbiAgICAgICAgICBvblRhc2tFdmVudDogKGV2ZW50KSA9PlxuICAgICAgICAgICAgZW1pdCh7XG4gICAgICAgICAgICAgIHR5cGU6IGBwYXJhbGxlbC4ke2V2ZW50LnR5cGV9YCxcbiAgICAgICAgICAgICAgdGltZXN0YW1wOiBldmVudC50aW1lc3RhbXAsXG4gICAgICAgICAgICAgIGRhdGE6IGV2ZW50LmRhdGEgPz8ge30sXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgfSkpO1xuICB9XG5cbiAgYXN5bmMgcnVuTW9kdWxlcyhvcHRpb25zOiBQYXJhbGxlbENvb3JkaW5hdG9yT3B0aW9ucywgbW9kdWxlczogUmVwb1VwZ3JhZGVNb2R1bGVbXSk6IFByb21pc2U8VXBncmFkZU1vZHVsZVJlcG9ydFtdPiB7XG4gICAgY29uc3QgeyBjb25jdXJyZW5jeSwgZW1pdCwgcHJvY2Vzc01vZHVsZSB9ID0gb3B0aW9ucztcbiAgICBjb25zdCBjb250aW51ZU9uRmFpbHVyZSA9IG9wdGlvbnMuY29udGludWVPbkZhaWx1cmU7XG5cbiAgICBlbWl0KHtcbiAgICAgIHR5cGU6ICd1cGdyYWRlLnBhcmFsbGVsLnN0YXJ0JyxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIGRhdGE6IHsgbW9kdWxlQ291bnQ6IG1vZHVsZXMubGVuZ3RoLCBjb25jdXJyZW5jeSB9LFxuICAgIH0pO1xuXG4gICAgY29uc3QgdGFza3M6IFBhcmFsbGVsVGFzazxVcGdyYWRlTW9kdWxlUmVwb3J0PltdID0gbW9kdWxlcy5tYXAoKG1vZHVsZSkgPT5cbiAgICAgIGNyZWF0ZVRhc2soXG4gICAgICAgIGBtb2R1bGU6JHttb2R1bGUuaWR9YCxcbiAgICAgICAgYXN5bmMgKCkgPT4gcHJvY2Vzc01vZHVsZShtb2R1bGUpLFxuICAgICAgICB7XG4gICAgICAgICAgbGFiZWw6IG1vZHVsZS5sYWJlbCxcbiAgICAgICAgICBwYXJhbGxlbGl6YWJsZTogdHJ1ZSxcbiAgICAgICAgICBncm91cDogJ21vZHVsZXMnLFxuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcblxuICAgIGNvbnN0IHJ1bm5lciA9IHRoaXMucnVubmVyRmFjdG9yeShjb25jdXJyZW5jeSwgZW1pdCk7XG4gICAgY29uc3QgYmF0Y2hSZXN1bHQgPSBhd2FpdCBydW5uZXIuZXhlY3V0ZSh0YXNrcyk7XG5cbiAgICBlbWl0KHtcbiAgICAgIHR5cGU6ICd1cGdyYWRlLnBhcmFsbGVsLmNvbXBsZXRlJyxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgdG90YWxEdXJhdGlvbk1zOiBiYXRjaFJlc3VsdC50b3RhbER1cmF0aW9uTXMsXG4gICAgICAgIHN1Y2Nlc3NDb3VudDogYmF0Y2hSZXN1bHQuc3VjY2Vzc0NvdW50LFxuICAgICAgICBmYWlsdXJlQ291bnQ6IGJhdGNoUmVzdWx0LmZhaWx1cmVDb3VudCxcbiAgICAgICAgcGFyYWxsZWxpc21BY2hpZXZlZDogYmF0Y2hSZXN1bHQucGFyYWxsZWxpc21BY2hpZXZlZCxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBjb25zdCBtb2R1bGVSZXBvcnRzOiBVcGdyYWRlTW9kdWxlUmVwb3J0W10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IHJlc3VsdCBvZiBiYXRjaFJlc3VsdC5yZXN1bHRzKSB7XG4gICAgICBpZiAocmVzdWx0LnN0YXR1cyA9PT0gJ2NvbXBsZXRlZCcgJiYgcmVzdWx0LnJlc3VsdCkge1xuICAgICAgICBtb2R1bGVSZXBvcnRzLnB1c2gocmVzdWx0LnJlc3VsdCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBtb2R1bGVJZCA9IHJlc3VsdC50YXNrSWQucmVwbGFjZSgnbW9kdWxlOicsICcnKTtcbiAgICAgICAgY29uc3QgbW9kdWxlID0gbW9kdWxlcy5maW5kKChtKSA9PiBtLmlkID09PSBtb2R1bGVJZCk7XG4gICAgICAgIG1vZHVsZVJlcG9ydHMucHVzaCh7XG4gICAgICAgICAgaWQ6IG1vZHVsZUlkLFxuICAgICAgICAgIGxhYmVsOiBtb2R1bGU/LmxhYmVsID8/IG1vZHVsZUlkLFxuICAgICAgICAgIHNjb3BlOiBtb2R1bGU/LnNjb3BlID8/IFtdLFxuICAgICAgICAgIHN0ZXBzOiBbXSxcbiAgICAgICAgICBzdGF0dXM6ICdmYWlsZWQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIWNvbnRpbnVlT25GYWlsdXJlKSB7XG4gICAgICBjb25zdCBmaXJzdEZhaWx1cmUgPSBtb2R1bGVSZXBvcnRzLmZpbmRJbmRleCgocmVwb3J0KSA9PiByZXBvcnQuc3RhdHVzID09PSAnZmFpbGVkJyk7XG4gICAgICBpZiAoZmlyc3RGYWlsdXJlID49IDApIHtcbiAgICAgICAgcmV0dXJuIG1vZHVsZVJlcG9ydHMuc2xpY2UoMCwgZmlyc3RGYWlsdXJlICsgMSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG1vZHVsZVJlcG9ydHM7XG4gIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBQUEsaUJBQUEsR0FBQUMsT0FBQTtBQWtCTyxNQUFNQyxtQkFBbUIsQ0FBQztFQUcvQkMsV0FBV0EsQ0FDVEMsYUFBaUcsRUFDakc7SUFDQSxJQUFJLENBQUNBLGFBQWEsR0FDaEJBLGFBQWEsS0FDWixDQUFDQyxXQUFXLEVBQUVDLElBQUksS0FDakIsSUFBSUMsa0NBQWdCLENBQUM7TUFDbkJDLGNBQWMsRUFBRUMsSUFBSSxDQUFDQyxHQUFHLENBQUMsQ0FBQyxFQUFFTCxXQUFXLENBQUM7TUFDeENNLGlCQUFpQixFQUFFLElBQUk7TUFDdkJDLFdBQVcsRUFBR0MsS0FBSyxJQUNqQlAsSUFBSSxDQUFDO1FBQ0hRLElBQUksRUFBRSxZQUFZRCxLQUFLLENBQUNDLElBQUksRUFBRTtRQUM5QkMsU0FBUyxFQUFFRixLQUFLLENBQUNFLFNBQVM7UUFDMUJDLElBQUksRUFBRUgsS0FBSyxDQUFDRyxJQUFJLElBQUksQ0FBQztNQUN2QixDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7RUFDVDtFQUVBLE1BQU1DLFVBQVVBLENBQUNDLE9BQW1DLEVBQUVDLE9BQTRCLEVBQWtDO0lBQ2xILE1BQU07TUFBRWQsV0FBVztNQUFFQyxJQUFJO01BQUVjO0lBQWMsQ0FBQyxHQUFHRixPQUFPO0lBQ3BELE1BQU1QLGlCQUFpQixHQUFHTyxPQUFPLENBQUNQLGlCQUFpQjtJQUVuREwsSUFBSSxDQUFDO01BQ0hRLElBQUksRUFBRSx3QkFBd0I7TUFDOUJDLFNBQVMsRUFBRU0sSUFBSSxDQUFDQyxHQUFHLENBQUMsQ0FBQztNQUNyQk4sSUFBSSxFQUFFO1FBQUVPLFdBQVcsRUFBRUosT0FBTyxDQUFDSyxNQUFNO1FBQUVuQjtNQUFZO0lBQ25ELENBQUMsQ0FBQztJQUVGLE1BQU1vQixLQUEwQyxHQUFHTixPQUFPLENBQUNPLEdBQUcsQ0FBRUMsTUFBTSxJQUNwRSxJQUFBQyw0QkFBVSxFQUNSLFVBQVVELE1BQU0sQ0FBQ0UsRUFBRSxFQUFFLEVBQ3JCLFlBQVlULGFBQWEsQ0FBQ08sTUFBTSxDQUFDLEVBQ2pDO01BQ0VHLEtBQUssRUFBRUgsTUFBTSxDQUFDRyxLQUFLO01BQ25CQyxjQUFjLEVBQUUsSUFBSTtNQUNwQkMsS0FBSyxFQUFFO0lBQ1QsQ0FDRixDQUNGLENBQUM7SUFFRCxNQUFNQyxNQUFNLEdBQUcsSUFBSSxDQUFDN0IsYUFBYSxDQUFDQyxXQUFXLEVBQUVDLElBQUksQ0FBQztJQUNwRCxNQUFNNEIsV0FBVyxHQUFHLE1BQU1ELE1BQU0sQ0FBQ0UsT0FBTyxDQUFDVixLQUFLLENBQUM7SUFFL0NuQixJQUFJLENBQUM7TUFDSFEsSUFBSSxFQUFFLDJCQUEyQjtNQUNqQ0MsU0FBUyxFQUFFTSxJQUFJLENBQUNDLEdBQUcsQ0FBQyxDQUFDO01BQ3JCTixJQUFJLEVBQUU7UUFDSm9CLGVBQWUsRUFBRUYsV0FBVyxDQUFDRSxlQUFlO1FBQzVDQyxZQUFZLEVBQUVILFdBQVcsQ0FBQ0csWUFBWTtRQUN0Q0MsWUFBWSxFQUFFSixXQUFXLENBQUNJLFlBQVk7UUFDdENDLG1CQUFtQixFQUFFTCxXQUFXLENBQUNLO01BQ25DO0lBQ0YsQ0FBQyxDQUFDO0lBRUYsTUFBTUMsYUFBb0MsR0FBRyxFQUFFO0lBQy9DLEtBQUssTUFBTUMsTUFBTSxJQUFJUCxXQUFXLENBQUNRLE9BQU8sRUFBRTtNQUN4QyxJQUFJRCxNQUFNLENBQUNFLE1BQU0sS0FBSyxXQUFXLElBQUlGLE1BQU0sQ0FBQ0EsTUFBTSxFQUFFO1FBQ2xERCxhQUFhLENBQUNJLElBQUksQ0FBQ0gsTUFBTSxDQUFDQSxNQUFNLENBQUM7TUFDbkMsQ0FBQyxNQUFNO1FBQ0wsTUFBTUksUUFBUSxHQUFHSixNQUFNLENBQUNLLE1BQU0sQ0FBQ0MsT0FBTyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUM7UUFDckQsTUFBTXBCLE1BQU0sR0FBR1IsT0FBTyxDQUFDNkIsSUFBSSxDQUFFQyxDQUFDLElBQUtBLENBQUMsQ0FBQ3BCLEVBQUUsS0FBS2dCLFFBQVEsQ0FBQztRQUNyREwsYUFBYSxDQUFDSSxJQUFJLENBQUM7VUFDakJmLEVBQUUsRUFBRWdCLFFBQVE7VUFDWmYsS0FBSyxFQUFFSCxNQUFNLEVBQUVHLEtBQUssSUFBSWUsUUFBUTtVQUNoQ0ssS0FBSyxFQUFFdkIsTUFBTSxFQUFFdUIsS0FBSyxJQUFJLEVBQUU7VUFDMUJDLEtBQUssRUFBRSxFQUFFO1VBQ1RSLE1BQU0sRUFBRTtRQUNWLENBQUMsQ0FBQztNQUNKO0lBQ0Y7SUFFQSxJQUFJLENBQUNoQyxpQkFBaUIsRUFBRTtNQUN0QixNQUFNeUMsWUFBWSxHQUFHWixhQUFhLENBQUNhLFNBQVMsQ0FBRUMsTUFBTSxJQUFLQSxNQUFNLENBQUNYLE1BQU0sS0FBSyxRQUFRLENBQUM7TUFDcEYsSUFBSVMsWUFBWSxJQUFJLENBQUMsRUFBRTtRQUNyQixPQUFPWixhQUFhLENBQUNlLEtBQUssQ0FBQyxDQUFDLEVBQUVILFlBQVksR0FBRyxDQUFDLENBQUM7TUFDakQ7SUFDRjtJQUVBLE9BQU9aLGFBQWE7RUFDdEI7QUFDRjtBQUFDZ0IsT0FBQSxDQUFBdEQsbUJBQUEsR0FBQUEsbUJBQUEiLCJpZ25vcmVMaXN0IjpbXX0=