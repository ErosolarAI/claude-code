{"version":3,"names":["_parallelExecutor","require","ParallelCoordinator","constructor","runnerFactory","concurrency","emit","ParallelExecutor","maxConcurrency","Math","max","continueOnFailure","onTaskEvent","event","type","timestamp","data","runModules","options","modules","processModule","Date","now","moduleCount","length","tasks","map","module","createTask","id","label","parallelizable","group","runner","batchResult","execute","totalDurationMs","successCount","failureCount","parallelismAchieved","moduleReports","result","results","status","push","moduleId","taskId","replace","find","m","scope","steps","firstFailure","findIndex","report","slice","exports"],"sources":["parallelCoordinator.ts"],"sourcesContent":["import { ParallelExecutor, createTask, type ParallelTask, type BatchResult } from './parallelExecutor.js';\nimport type { UpgradeModuleReport, RepoUpgradeMode, RepoUpgradeModeDefinition, VariantWinStats, RepoUpgradeModule } from './repoUpgradeOrchestrator.js';\n\nexport interface ParallelCoordinatorOptions {\n  concurrency: number;\n  mode: RepoUpgradeMode;\n  modeDefinition: RepoUpgradeModeDefinition;\n  parallelVariants: boolean;\n  continueOnFailure: boolean;\n  variantStats: VariantWinStats;\n  processModule: (module: RepoUpgradeModule) => Promise<UpgradeModuleReport>;\n  emit: (event: { type: string; timestamp: number; data: Record<string, unknown> }) => void;\n}\n\nexport interface ParallelRunner {\n  execute(tasks: ParallelTask<UpgradeModuleReport>[]): Promise<BatchResult<UpgradeModuleReport>>;\n}\n\nexport class ParallelCoordinator {\n  private readonly runnerFactory: (concurrency: number, emit: ParallelCoordinatorOptions['emit']) => ParallelRunner;\n\n  constructor(\n    runnerFactory?: (concurrency: number, emit: ParallelCoordinatorOptions['emit']) => ParallelRunner\n  ) {\n    this.runnerFactory =\n      runnerFactory ??\n      ((concurrency, emit) =>\n        new ParallelExecutor({\n          maxConcurrency: Math.max(1, concurrency),\n          continueOnFailure: true,\n          onTaskEvent: (event) =>\n            emit({\n              type: `parallel.${event.type}`,\n              timestamp: event.timestamp,\n              data: event.data ?? {},\n            }),\n        }));\n  }\n\n  async runModules(options: ParallelCoordinatorOptions, modules: RepoUpgradeModule[]): Promise<UpgradeModuleReport[]> {\n    const { concurrency, emit, processModule } = options;\n    const continueOnFailure = options.continueOnFailure;\n\n    emit({\n      type: 'upgrade.parallel.start',\n      timestamp: Date.now(),\n      data: { moduleCount: modules.length, concurrency },\n    });\n\n    const tasks: ParallelTask<UpgradeModuleReport>[] = modules.map((module) =>\n      createTask(\n        `module:${module.id}`,\n        async () => processModule(module),\n        {\n          label: module.label,\n          parallelizable: true,\n          group: 'modules',\n        }\n      )\n    );\n\n    const runner = this.runnerFactory(concurrency, emit);\n    const batchResult = await runner.execute(tasks);\n\n    emit({\n      type: 'upgrade.parallel.complete',\n      timestamp: Date.now(),\n      data: {\n        totalDurationMs: batchResult.totalDurationMs,\n        successCount: batchResult.successCount,\n        failureCount: batchResult.failureCount,\n        parallelismAchieved: batchResult.parallelismAchieved,\n      },\n    });\n\n    const moduleReports: UpgradeModuleReport[] = [];\n    for (const result of batchResult.results) {\n      if (result.status === 'completed' && result.result) {\n        moduleReports.push(result.result);\n      } else {\n        const moduleId = result.taskId.replace('module:', '');\n        const module = modules.find((m) => m.id === moduleId);\n        moduleReports.push({\n          id: moduleId,\n          label: module?.label ?? moduleId,\n          scope: module?.scope ?? [],\n          steps: [],\n          status: 'failed',\n        });\n      }\n    }\n\n    if (!continueOnFailure) {\n      const firstFailure = moduleReports.findIndex((report) => report.status === 'failed');\n      if (firstFailure >= 0) {\n        return moduleReports.slice(0, firstFailure + 1);\n      }\n    }\n\n    return moduleReports;\n  }\n}\n"],"mappings":"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","ignoreList":[]}