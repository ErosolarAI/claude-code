be32464878e04581ca3bba51448d248e
"use strict";

var _globals = require("@jest/globals");
function _interopRequireWildcard(e, t) { if ("function" == typeof WeakMap) var r = new WeakMap(), n = new WeakMap(); return (_interopRequireWildcard = function (e, t) { if (!t && e && e.__esModule) return e; var o, i, f = { __proto__: null, default: e }; if (null === e || "object" != typeof e && "function" != typeof e) return f; if (o = t ? n : r) { if (o.has(e)) return o.get(e); o.set(e, f); } for (const t in e) "default" !== t && {}.hasOwnProperty.call(e, t) && ((i = (o = Object.defineProperty) && Object.getOwnPropertyDescriptor(e, t)) && (i.get || i.set) ? o(f, t, i) : f[t] = e[t]); return f; })(e, t); } /**
 * Real full-flow integration test.
 *
 * Uses the shared full-flow runner to drive the CLI with long-form,
 * human-style prompts and asserts that real provider usage and validated
 * completions occur. Only runs when RUN_REAL_LLM_TESTS=1 and a provider
 * key are present to avoid accidental live calls.
 */
const hasProviderKey = Boolean(process.env.ANTHROPIC_API_KEY) || Boolean(process.env.OPENAI_API_KEY) || Boolean(process.env.GOOGLE_GENAI_API_KEY);
const realTestsEnabled = process.env.RUN_REAL_LLM_TESTS === '1' && hasProviderKey;
function parsePrompts(defaultPrompts) {
  if (process.env.PROMPTS) {
    try {
      const parsed = JSON.parse(process.env.PROMPTS);
      if (Array.isArray(parsed) && parsed.every(p => typeof p === 'string')) {
        return parsed.map(p => p.trim()).filter(Boolean);
      }
    } catch {
      // fall back to default prompts
    }
  }
  return defaultPrompts;
}
(0, _globals.describe)('real full-flow CLI run', () => {
  (realTestsEnabled ? _globals.test : _globals.test.skip)('completes long-form prompts end-to-end with validation', async () => {
    _globals.jest.setTimeout(300_000); // allow up to 5 minutes for live provider

    const {
      DEFAULT_PROMPTS,
      runFullFlow,
      validateFullFlow
    } = await Promise.resolve().then(() => _interopRequireWildcard(require('../../scripts/full-flow-runner.js')));
    const prompts = parsePrompts(DEFAULT_PROMPTS);
    const result = await runFullFlow({
      prompts,
      profile: process.env.PROFILE?.trim() || 'agi-code',
      provider: process.env.PROVIDER?.trim(),
      model: process.env.MODEL?.trim(),
      sessionId: `real-flow-${Date.now()}`,
      requireReal: true
    });
    const summary = validateFullFlow(result, {
      minMessageChars: 120,
      requireUsage: true,
      rejectSimulation: true,
      minEvents: 2,
      requireRunCount: true
    });
    expect(summary.completedRuns).toBe(prompts.length);
    expect(summary.runsWithUsage).toBeGreaterThanOrEqual(prompts.length);
    expect(summary.session).toBeTruthy();
    expect(result.runs).toHaveLength(prompts.length);
    for (const run of result.runs) {
      expect(run.eventsSeen).toBeGreaterThanOrEqual(2);
    }
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZ2xvYmFscyIsInJlcXVpcmUiLCJfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZCIsImUiLCJ0IiwiV2Vha01hcCIsInIiLCJuIiwiX19lc01vZHVsZSIsIm8iLCJpIiwiZiIsIl9fcHJvdG9fXyIsImRlZmF1bHQiLCJoYXMiLCJnZXQiLCJzZXQiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImhhc1Byb3ZpZGVyS2V5IiwiQm9vbGVhbiIsInByb2Nlc3MiLCJlbnYiLCJBTlRIUk9QSUNfQVBJX0tFWSIsIk9QRU5BSV9BUElfS0VZIiwiR09PR0xFX0dFTkFJX0FQSV9LRVkiLCJyZWFsVGVzdHNFbmFibGVkIiwiUlVOX1JFQUxfTExNX1RFU1RTIiwicGFyc2VQcm9tcHRzIiwiZGVmYXVsdFByb21wdHMiLCJQUk9NUFRTIiwicGFyc2VkIiwiSlNPTiIsInBhcnNlIiwiQXJyYXkiLCJpc0FycmF5IiwiZXZlcnkiLCJwIiwibWFwIiwidHJpbSIsImZpbHRlciIsImRlc2NyaWJlIiwidGVzdCIsInNraXAiLCJqZXN0Iiwic2V0VGltZW91dCIsIkRFRkFVTFRfUFJPTVBUUyIsInJ1bkZ1bGxGbG93IiwidmFsaWRhdGVGdWxsRmxvdyIsIlByb21pc2UiLCJyZXNvbHZlIiwidGhlbiIsInByb21wdHMiLCJyZXN1bHQiLCJwcm9maWxlIiwiUFJPRklMRSIsInByb3ZpZGVyIiwiUFJPVklERVIiLCJtb2RlbCIsIk1PREVMIiwic2Vzc2lvbklkIiwiRGF0ZSIsIm5vdyIsInJlcXVpcmVSZWFsIiwic3VtbWFyeSIsIm1pbk1lc3NhZ2VDaGFycyIsInJlcXVpcmVVc2FnZSIsInJlamVjdFNpbXVsYXRpb24iLCJtaW5FdmVudHMiLCJyZXF1aXJlUnVuQ291bnQiLCJleHBlY3QiLCJjb21wbGV0ZWRSdW5zIiwidG9CZSIsImxlbmd0aCIsInJ1bnNXaXRoVXNhZ2UiLCJ0b0JlR3JlYXRlclRoYW5PckVxdWFsIiwic2Vzc2lvbiIsInRvQmVUcnV0aHkiLCJydW5zIiwidG9IYXZlTGVuZ3RoIiwicnVuIiwiZXZlbnRzU2VlbiJdLCJzb3VyY2VzIjpbInJlYWxGdWxsRmxvdy50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogUmVhbCBmdWxsLWZsb3cgaW50ZWdyYXRpb24gdGVzdC5cbiAqXG4gKiBVc2VzIHRoZSBzaGFyZWQgZnVsbC1mbG93IHJ1bm5lciB0byBkcml2ZSB0aGUgQ0xJIHdpdGggbG9uZy1mb3JtLFxuICogaHVtYW4tc3R5bGUgcHJvbXB0cyBhbmQgYXNzZXJ0cyB0aGF0IHJlYWwgcHJvdmlkZXIgdXNhZ2UgYW5kIHZhbGlkYXRlZFxuICogY29tcGxldGlvbnMgb2NjdXIuIE9ubHkgcnVucyB3aGVuIFJVTl9SRUFMX0xMTV9URVNUUz0xIGFuZCBhIHByb3ZpZGVyXG4gKiBrZXkgYXJlIHByZXNlbnQgdG8gYXZvaWQgYWNjaWRlbnRhbCBsaXZlIGNhbGxzLlxuICovXG5cbmltcG9ydCB7IGRlc2NyaWJlLCB0ZXN0LCBqZXN0IH0gZnJvbSAnQGplc3QvZ2xvYmFscyc7XG5cbmNvbnN0IGhhc1Byb3ZpZGVyS2V5ID1cbiAgQm9vbGVhbihwcm9jZXNzLmVudi5BTlRIUk9QSUNfQVBJX0tFWSkgfHxcbiAgQm9vbGVhbihwcm9jZXNzLmVudi5PUEVOQUlfQVBJX0tFWSkgfHxcbiAgQm9vbGVhbihwcm9jZXNzLmVudi5HT09HTEVfR0VOQUlfQVBJX0tFWSk7XG5cbmNvbnN0IHJlYWxUZXN0c0VuYWJsZWQgPSBwcm9jZXNzLmVudi5SVU5fUkVBTF9MTE1fVEVTVFMgPT09ICcxJyAmJiBoYXNQcm92aWRlcktleTtcblxuZnVuY3Rpb24gcGFyc2VQcm9tcHRzKGRlZmF1bHRQcm9tcHRzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcbiAgaWYgKHByb2Nlc3MuZW52LlBST01QVFMpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcGFyc2VkID0gSlNPTi5wYXJzZShwcm9jZXNzLmVudi5QUk9NUFRTKTtcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KHBhcnNlZCkgJiYgcGFyc2VkLmV2ZXJ5KChwKSA9PiB0eXBlb2YgcCA9PT0gJ3N0cmluZycpKSB7XG4gICAgICAgIHJldHVybiBwYXJzZWQubWFwKChwKSA9PiBwLnRyaW0oKSkuZmlsdGVyKEJvb2xlYW4pO1xuICAgICAgfVxuICAgIH0gY2F0Y2gge1xuICAgICAgLy8gZmFsbCBiYWNrIHRvIGRlZmF1bHQgcHJvbXB0c1xuICAgIH1cbiAgfVxuICByZXR1cm4gZGVmYXVsdFByb21wdHM7XG59XG5cbmRlc2NyaWJlKCdyZWFsIGZ1bGwtZmxvdyBDTEkgcnVuJywgKCkgPT4ge1xuICAocmVhbFRlc3RzRW5hYmxlZCA/IHRlc3QgOiB0ZXN0LnNraXApKCdjb21wbGV0ZXMgbG9uZy1mb3JtIHByb21wdHMgZW5kLXRvLWVuZCB3aXRoIHZhbGlkYXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgamVzdC5zZXRUaW1lb3V0KDMwMF8wMDApOyAvLyBhbGxvdyB1cCB0byA1IG1pbnV0ZXMgZm9yIGxpdmUgcHJvdmlkZXJcblxuICAgIGNvbnN0IHsgREVGQVVMVF9QUk9NUFRTLCBydW5GdWxsRmxvdywgdmFsaWRhdGVGdWxsRmxvdyB9ID0gYXdhaXQgaW1wb3J0KCcuLi8uLi9zY3JpcHRzL2Z1bGwtZmxvdy1ydW5uZXIuanMnKTtcbiAgICBjb25zdCBwcm9tcHRzID0gcGFyc2VQcm9tcHRzKERFRkFVTFRfUFJPTVBUUyk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBydW5GdWxsRmxvdyh7XG4gICAgICBwcm9tcHRzLFxuICAgICAgcHJvZmlsZTogcHJvY2Vzcy5lbnYuUFJPRklMRT8udHJpbSgpIHx8ICdhZ2ktY29kZScsXG4gICAgICBwcm92aWRlcjogcHJvY2Vzcy5lbnYuUFJPVklERVI/LnRyaW0oKSxcbiAgICAgIG1vZGVsOiBwcm9jZXNzLmVudi5NT0RFTD8udHJpbSgpLFxuICAgICAgc2Vzc2lvbklkOiBgcmVhbC1mbG93LSR7RGF0ZS5ub3coKX1gLFxuICAgICAgcmVxdWlyZVJlYWw6IHRydWUsXG4gICAgfSk7XG5cbiAgICBjb25zdCBzdW1tYXJ5ID0gdmFsaWRhdGVGdWxsRmxvdyhyZXN1bHQsIHtcbiAgICAgIG1pbk1lc3NhZ2VDaGFyczogMTIwLFxuICAgICAgcmVxdWlyZVVzYWdlOiB0cnVlLFxuICAgICAgcmVqZWN0U2ltdWxhdGlvbjogdHJ1ZSxcbiAgICAgIG1pbkV2ZW50czogMixcbiAgICAgIHJlcXVpcmVSdW5Db3VudDogdHJ1ZSxcbiAgICB9KTtcblxuICAgIGV4cGVjdChzdW1tYXJ5LmNvbXBsZXRlZFJ1bnMpLnRvQmUocHJvbXB0cy5sZW5ndGgpO1xuICAgIGV4cGVjdChzdW1tYXJ5LnJ1bnNXaXRoVXNhZ2UpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwocHJvbXB0cy5sZW5ndGgpO1xuICAgIGV4cGVjdChzdW1tYXJ5LnNlc3Npb24pLnRvQmVUcnV0aHkoKTtcbiAgICBleHBlY3QocmVzdWx0LnJ1bnMpLnRvSGF2ZUxlbmd0aChwcm9tcHRzLmxlbmd0aCk7XG4gICAgZm9yIChjb25zdCBydW4gb2YgcmVzdWx0LnJ1bnMpIHtcbiAgICAgIGV4cGVjdChydW4uZXZlbnRzU2VlbikudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCgyKTtcbiAgICB9XG4gIH0pO1xufSk7XG4iXSwibWFwcGluZ3MiOiI7O0FBU0EsSUFBQUEsUUFBQSxHQUFBQyxPQUFBO0FBQXFELFNBQUFDLHdCQUFBQyxDQUFBLEVBQUFDLENBQUEsNkJBQUFDLE9BQUEsTUFBQUMsQ0FBQSxPQUFBRCxPQUFBLElBQUFFLENBQUEsT0FBQUYsT0FBQSxZQUFBSCx1QkFBQSxZQUFBQSxDQUFBQyxDQUFBLEVBQUFDLENBQUEsU0FBQUEsQ0FBQSxJQUFBRCxDQUFBLElBQUFBLENBQUEsQ0FBQUssVUFBQSxTQUFBTCxDQUFBLE1BQUFNLENBQUEsRUFBQUMsQ0FBQSxFQUFBQyxDQUFBLEtBQUFDLFNBQUEsUUFBQUMsT0FBQSxFQUFBVixDQUFBLGlCQUFBQSxDQUFBLHVC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