{"version":3,"names":["_node","require","_agent","_debugLogger","_resilientProvider","_modelDiscovery","EventStream","queue","pending","closed","failure","push","value","resolve","done","close","undefined","fail","error","reject","next","length","shift","Promise","return","throw","err","Error","String","Symbol","asyncIterator","mergeToolObservers","primary","secondary","onToolStart","call","onToolResult","output","onToolProgress","progress","onToolError","onCacheHit","onToolWarning","warning","createControllerToolObserver","ref","emit","event","current","timestamp","Date","now","type","toolName","name","toolCallId","id","parameters","arguments","result","createAgentController","options","additionalObserver","sinkRef","observer","runtime","createNodeRuntime","profile","workspaceContext","workingDir","env","toolObserver","additionalModules","modules","AgentController","externalCallbacks","callbacks","activeSink","agent","cachedHistory","failedProviders","Set","MAX_FALLBACK_ATTEMPTS","runTimeoutMs","Number","parseInt","process","AGI_AGENT_RUN_TIMEOUT_MS","cancelActiveRunFn","constructor","dependencies","session","selection","buildInitialSelection","config","profileConfig","provider","model","temperature","maxTokens","systemPrompt","ensureAgent","createAgent","createAgentCallbacks","explainEdits","loadHistory","onAssistantMessage","content","metadata","handleAssistantMessage","onStreamChunk","chunk","emitDelta","emitReasoning","onUsage","usage","emitUsage","onContextPruned","removedCount","stats","onContextSquishing","message","onContextRecovery","attempt","maxAttempts","onContinueAfterRecovery","onMultilinePaste","summary","onEditExplanation","payload","handleEditExplanation","onRetrying","isGarbageContent","trimmed","trim","test","alphaCount","match","isFinal","logDebug","slice","emitError","inputTokens","outputTokens","totalTokens","explanation","files","suppressDisplay","elapsedMs","updateCachedHistory","getHistory","createSink","sink","clearSink","startAgentRun","runPromise","send","timer","timeoutPromise","_","setTimeout","unref","cancelled","cancelPromise","race","filter","Boolean","then","catch","errorObj","finally","clearTimeout","attemptFallbackWithError","attempts","isFallbackEligibleError","attemptFallback","cancelledByUser","clear","fallbackAttempts","caughtError","fallbackSucceeded","run","cancel","reason","switchModel","updateToolContext","getCapabilities","tools","toolRuntime","listProviderTools","manifestTools","map","tool","description","category","contractVersion","AGENT_CONTRACT_VERSION","toModelConfig","features","registerToolSuite","suiteId","suite","registerSuite","unregisterToolSuite","unregisterSuite","clearHistory","findFallbackProvider","configured","getConfiguredProviders","currentProvider","preferenceOrder","providerId","has","find","p","getLatestModelForProvider","emitFallbackEvent","fromProvider","fromModel","toProvider","toModel","fallback","getFallbackReason","add","getToolSuites","toolSuites","exports"],"sources":["agentController.ts"],"sourcesContent":["import type { ProfileName } from '../config.js';\nimport type { AgentSession, ModelSelection } from './agentSession.js';\nimport type { UniversalRuntime } from './universal.js';\nimport { createNodeRuntime, type NodeRuntimeOptions } from './node.js';\nimport type { CapabilityModule } from './agentHost.js';\nimport type { AgentCallbacks, AssistantMessageMetadata, EditExplanationPayload } from '../core/agent.js';\nimport type { ToolRuntimeObserver, ToolSuite } from '../core/toolRuntime.js';\nimport type { ConversationMessage, ProviderUsage, ProviderId } from '../core/types.js';\nimport type {\n  AgentEventUnion,\n  CapabilityManifest,\n  IAgentController,\n  ModelConfig,\n  ToolCapability,\n} from '../contracts/v1/agent.js';\nimport { AGENT_CONTRACT_VERSION } from '../contracts/v1/agent.js';\nimport { logDebug } from '../utils/debugLogger.js';\nimport { isFallbackEligibleError, getFallbackReason } from '../providers/resilientProvider.js';\nimport { getConfiguredProviders, getLatestModelForProvider } from '../core/modelDiscovery.js';\n\ninterface EventSinkRef {\n  current: EventStream<AgentEventUnion> | null;\n}\n\nclass EventStream<T> implements AsyncIterableIterator<T> {\n  private readonly queue: T[] = [];\n  private pending: { resolve: (value: IteratorResult<T>) => void; reject: (error: unknown) => void } | null = null;\n  private closed = false;\n  private failure: Error | null = null;\n\n  push(value: T): void {\n    if (this.closed || this.failure) {\n      return;\n    }\n    if (this.pending) {\n      this.pending.resolve({ value, done: false });\n      this.pending = null;\n      return;\n    }\n    this.queue.push(value);\n  }\n\n  close(): void {\n    if (this.closed || this.failure) {\n      return;\n    }\n    this.closed = true;\n    if (this.pending) {\n      this.pending.resolve({ value: undefined as unknown as T, done: true });\n      this.pending = null;\n    }\n  }\n\n  fail(error: Error): void {\n    if (this.closed || this.failure) {\n      return;\n    }\n    this.failure = error;\n    if (this.pending) {\n      this.pending.reject(error);\n      this.pending = null;\n    }\n  }\n\n  next(): Promise<IteratorResult<T>> {\n    if (this.queue.length) {\n      const value = this.queue.shift()!;\n      return Promise.resolve({ value, done: false });\n    }\n    if (this.failure) {\n      const error = this.failure;\n      this.failure = null;\n      return Promise.reject(error);\n    }\n    if (this.closed) {\n      return Promise.resolve({ value: undefined as unknown as T, done: true });\n    }\n    return new Promise<IteratorResult<T>>((resolve, reject) => {\n      this.pending = { resolve, reject };\n    });\n  }\n\n  return(): Promise<IteratorResult<T>> {\n    this.close();\n    return Promise.resolve({ value: undefined as unknown as T, done: true });\n  }\n\n  throw(error: unknown): Promise<IteratorResult<T>> {\n    const err = error instanceof Error ? error : new Error(String(error));\n    this.fail(err);\n    return Promise.reject(err);\n  }\n\n  [Symbol.asyncIterator](): AsyncIterableIterator<T> {\n    return this;\n  }\n}\n\nfunction mergeToolObservers(\n  primary: ToolRuntimeObserver,\n  secondary?: ToolRuntimeObserver\n): ToolRuntimeObserver {\n  if (!secondary) {\n    return primary;\n  }\n  return {\n    onToolStart(call) {\n      primary.onToolStart?.(call);\n      secondary.onToolStart?.(call);\n    },\n    onToolResult(call, output) {\n      primary.onToolResult?.(call, output);\n      secondary.onToolResult?.(call, output);\n    },\n    onToolProgress(call, progress) {\n      primary.onToolProgress?.(call, progress);\n      secondary.onToolProgress?.(call, progress);\n    },\n    onToolError(call, error) {\n      primary.onToolError?.(call, error);\n      secondary.onToolError?.(call, error);\n    },\n    onCacheHit(call) {\n      primary.onCacheHit?.(call);\n      secondary.onCacheHit?.(call);\n    },\n    onToolWarning(call, warning) {\n      primary.onToolWarning?.(call, warning);\n      secondary.onToolWarning?.(call, warning);\n    },\n  } satisfies ToolRuntimeObserver;\n}\n\nfunction createControllerToolObserver(ref: EventSinkRef): ToolRuntimeObserver {\n  const emit = (event: AgentEventUnion) => {\n    ref.current?.push(event);\n  };\n  const timestamp = () => Date.now();\n  return {\n    onToolStart(call) {\n      emit({\n        type: 'tool.start',\n        timestamp: timestamp(),\n        toolName: call.name,\n        toolCallId: call.id,\n        parameters: { ...call.arguments },\n      });\n    },\n    onToolResult(call, output) {\n      emit({\n        type: 'tool.complete',\n        timestamp: timestamp(),\n        toolName: call.name,\n        toolCallId: call.id,\n        result: output,\n      });\n    },\n    onToolError(call, error) {\n      emit({\n        type: 'tool.error',\n        timestamp: timestamp(),\n        toolName: call.name,\n        toolCallId: call.id,\n        error,\n      });\n    },\n  } satisfies ToolRuntimeObserver;\n}\n\ninterface AgentControllerDependencies {\n  runtime: UniversalRuntime;\n  sinkRef: EventSinkRef;\n  externalCallbacks?: AgentCallbacks;\n}\n\nexport interface AgentControllerCreateOptions extends Omit<NodeRuntimeOptions, 'toolObserver'> {\n  profile: ProfileName;\n  workspaceContext: string | null;\n  workingDir: string;\n  modules?: CapabilityModule[];\n  callbacks?: AgentCallbacks;\n  /** Skip provider discovery for faster startup (used in quick mode) */\n  skipProviderDiscovery?: boolean;\n}\n\nexport async function createAgentController(\n  options: AgentControllerCreateOptions,\n  additionalObserver?: ToolRuntimeObserver\n): Promise<AgentController> {\n  const sinkRef: EventSinkRef = { current: null };\n  const observer = createControllerToolObserver(sinkRef);\n  const runtime = await createNodeRuntime({\n    profile: options.profile,\n    workspaceContext: options.workspaceContext,\n    workingDir: options.workingDir,\n    env: options.env,\n    toolObserver: mergeToolObservers(observer, additionalObserver),\n    additionalModules: options.modules,\n  });\n  return new AgentController({ runtime, sinkRef, externalCallbacks: options.callbacks });\n}\n\nexport class AgentController implements IAgentController {\n  private readonly session: AgentSession;\n  private readonly sinkRef: EventSinkRef;\n  private readonly externalCallbacks: AgentCallbacks | undefined;\n  private activeSink: EventStream<AgentEventUnion> | null = null;\n  private agent: ReturnType<AgentSession['createAgent']> | null = null;\n  private cachedHistory: ConversationMessage[] = [];\n  private selection: ModelSelection;\n  /** Set of providers that have failed with non-retryable errors in this session */\n  private failedProviders: Set<ProviderId> = new Set();\n  /** Maximum fallback attempts per send() call */\n  private static readonly MAX_FALLBACK_ATTEMPTS = 3;\n  /** Optional timeout for a single agent run (ms); 0 disables */\n  private readonly runTimeoutMs: number =\n    Number.parseInt(process.env.AGI_AGENT_RUN_TIMEOUT_MS ?? '', 10) || 0;\n  /** Cancel hook for an in-flight run */\n  private cancelActiveRunFn: (() => void) | null = null;\n\n  constructor(dependencies: AgentControllerDependencies) {\n    this.session = dependencies.runtime.session;\n    this.sinkRef = dependencies.sinkRef;\n    this.externalCallbacks = dependencies.externalCallbacks;\n    this.selection = this.buildInitialSelection();\n  }\n\n  private buildInitialSelection(): ModelSelection {\n    const config = this.session.profileConfig;\n    return {\n      provider: config.provider,\n      model: config.model,\n      temperature: config.temperature,\n      maxTokens: config.maxTokens,\n      systemPrompt: config.systemPrompt,\n    } satisfies ModelSelection;\n  }\n\n  private ensureAgent(): ReturnType<AgentSession['createAgent']> {\n    if (this.agent) {\n      return this.agent;\n    }\n    const agent = this.session.createAgent(this.selection, this.createAgentCallbacks(), undefined, {\n      explainEdits: true,\n    });\n    if (this.cachedHistory.length) {\n      agent.loadHistory(this.cachedHistory);\n    }\n    this.agent = agent;\n    return agent;\n  }\n\n  private createAgentCallbacks(): AgentCallbacks {\n    return {\n      onAssistantMessage: (content, metadata) => {\n        this.handleAssistantMessage(content, metadata);\n        this.externalCallbacks?.onAssistantMessage?.(content, metadata);\n      },\n      onStreamChunk: (chunk, type) => {\n        if (type === 'content') {\n          // Content chunks go to message.delta for streaming display\n          this.emitDelta(chunk, false);\n        } else if (type === 'reasoning') {\n          // Reasoning chunks go to reasoning event for thought display\n          this.emitReasoning(chunk);\n        }\n        // Pass all chunks to external callbacks\n        this.externalCallbacks?.onStreamChunk?.(chunk, type);\n      },\n      onUsage: (usage) => {\n        this.emitUsage(usage);\n        this.externalCallbacks?.onUsage?.(usage);\n      },\n      onContextPruned: (removedCount, stats) => {\n        this.externalCallbacks?.onContextPruned?.(removedCount, stats);\n      },\n      onContextSquishing: (message) => {\n        this.externalCallbacks?.onContextSquishing?.(message);\n      },\n      onContextRecovery: (attempt, maxAttempts, message) => {\n        this.externalCallbacks?.onContextRecovery?.(attempt, maxAttempts, message);\n      },\n      onContinueAfterRecovery: () => {\n        this.externalCallbacks?.onContinueAfterRecovery?.();\n      },\n      onMultilinePaste: (summary, metadata) => {\n        this.externalCallbacks?.onMultilinePaste?.(summary, metadata);\n      },\n      onEditExplanation: (payload) => {\n        this.handleEditExplanation(payload);\n        this.externalCallbacks?.onEditExplanation?.(payload);\n      },\n      onRetrying: (attempt, maxAttempts, error) => {\n        // Emit delta event to show retry status\n        this.emitDelta(`[Retrying ${attempt}/${maxAttempts}: ${error.message}]`, false);\n        this.externalCallbacks?.onRetrying?.(attempt, maxAttempts, error);\n      },\n      // onBeforeFirstToolCall not needed - model's reasoning is now emitted as thought events\n    } satisfies AgentCallbacks;\n  }\n\n  /**\n   * Check if content looks like garbage/leaked reasoning fragments.\n   * Returns true if the content should be filtered out.\n   */\n  private isGarbageContent(content: string): boolean {\n    const trimmed = content.trim();\n    if (!trimmed) return true;\n\n    // Single or repeated punctuation/markdown artifacts\n    if (/^[)\\]}>*`'\".:,!?|│┃─━═\\s]+$/.test(trimmed)) return true;\n\n    // Just newlines or whitespace\n    if (/^[\\s\\n\\r]+$/.test(trimmed)) return true;\n\n    // Short fragments with high punctuation ratio (likely leaked formatting)\n    if (trimmed.length < 15) {\n      const alphaCount = (trimmed.match(/[a-zA-Z0-9]/g) || []).length;\n      if (alphaCount === 0) return true;\n      if (alphaCount / trimmed.length < 0.2) return true;\n    }\n\n    return false;\n  }\n\n  private emitDelta(content: string, isFinal: boolean): void {\n    logDebug(`[DEBUG controller] emitDelta called: content=\"${content?.slice(0, 50)}\", isFinal=${isFinal}, hasSink=${!!this.activeSink}`);\n    if (!content?.trim()) {\n      logDebug('[DEBUG controller] emitDelta: skipping empty content');\n      return;\n    }\n\n    // Filter out garbage/leaked reasoning fragments\n    if (this.isGarbageContent(content)) {\n      logDebug('[DEBUG controller] emitDelta: filtering garbage content');\n      return;\n    }\n\n    logDebug('[DEBUG controller] emitDelta: pushing to sink');\n    this.activeSink?.push({\n      type: 'message.delta',\n      timestamp: Date.now(),\n      content,\n      isFinal,\n    });\n  }\n\n  private emitError(message: string): void {\n    this.activeSink?.push({\n      type: 'error',\n      timestamp: Date.now(),\n      error: message,\n    });\n  }\n\n  private emitReasoning(content: string): void {\n    if (!content?.trim()) {\n      return;\n    }\n    // Filter out garbage/leaked formatting fragments in reasoning too\n    if (this.isGarbageContent(content)) {\n      return;\n    }\n    this.activeSink?.push({\n      type: 'reasoning',\n      timestamp: Date.now(),\n      content,\n    });\n  }\n\n  private emitUsage(usage: ProviderUsage | null | undefined): void {\n    if (!usage) {\n      return;\n    }\n    this.activeSink?.push({\n      type: 'usage',\n      timestamp: Date.now(),\n      inputTokens: usage.inputTokens,\n      outputTokens: usage.outputTokens,\n      totalTokens: usage.totalTokens,\n    });\n  }\n\n  private handleEditExplanation(payload: EditExplanationPayload): void {\n    if (!this.activeSink) {\n      return;\n    }\n    if (!payload.explanation?.trim()) {\n      return;\n    }\n    this.activeSink.push({\n      type: 'edit.explanation',\n      timestamp: Date.now(),\n      content: payload.explanation,\n      files: payload.files,\n      toolName: payload.toolName,\n      toolCallId: payload.toolCallId,\n    });\n  }\n\n  private handleAssistantMessage(content: string, metadata: AssistantMessageMetadata): void {\n    if (!this.activeSink) {\n      return;\n    }\n    if (!content.trim()) {\n      return;\n    }\n    if (metadata.suppressDisplay) {\n      return;\n    }\n    if (!metadata.isFinal) {\n      this.emitDelta(content, false);\n      return;\n    }\n    const elapsedMs = metadata.elapsedMs ?? 0;\n    this.activeSink.push({\n      type: 'message.complete',\n      timestamp: Date.now(),\n      content,\n      elapsedMs,\n    });\n    this.emitUsage(metadata.usage ?? null);\n  }\n\n  private updateCachedHistory(): void {\n    if (this.agent) {\n      this.cachedHistory = this.agent.getHistory();\n    }\n  }\n\n  private createSink(): EventStream<AgentEventUnion> {\n    const sink = new EventStream<AgentEventUnion>();\n    this.activeSink = sink;\n    this.sinkRef.current = sink;\n    return sink;\n  }\n\n  private clearSink(): void {\n    if (this.activeSink) {\n      this.activeSink = null;\n      this.sinkRef.current = null;\n    }\n  }\n\n  private startAgentRun(\n    agent: ReturnType<AgentSession['createAgent']>,\n    message: string,\n    sink: EventStream<AgentEventUnion>\n  ): Promise<void> {\n    sink.push({ type: 'message.start', timestamp: Date.now() });\n    const runPromise = agent.send(message, true);\n\n    let timer: NodeJS.Timeout | null = null;\n    const timeoutPromise =\n      this.runTimeoutMs > 0\n        ? new Promise<never>((_, reject) => {\n            timer = setTimeout(() => {\n              reject(new Error(`Agent run timed out after ${this.runTimeoutMs}ms`));\n            }, this.runTimeoutMs);\n            timer.unref?.();\n          })\n        : null;\n\n    let cancelled = false;\n    const cancelPromise = new Promise<never>((_, reject) => {\n      this.cancelActiveRunFn = () => {\n        cancelled = true;\n        reject(new Error('Agent run cancelled'));\n      };\n    });\n\n    return Promise.race([runPromise, cancelPromise, timeoutPromise].filter(Boolean) as Promise<unknown>[])\n      .then(() => {\n        this.updateCachedHistory();\n        sink.close();\n      })\n      .catch((error) => {\n        const errorObj = error instanceof Error ? error : new Error(String(error));\n        // Let caller decide on fallback; propagate error after marking sink failed\n        if (cancelled) {\n          sink.fail(errorObj);\n        } else {\n          sink.fail(errorObj);\n        }\n        throw errorObj;\n      })\n      .finally(() => {\n        if (timer) {\n          clearTimeout(timer);\n          timer = null;\n        }\n        this.cancelActiveRunFn = null;\n        if (this.sinkRef.current === sink) {\n          this.clearSink();\n        }\n      });\n  }\n\n  private async attemptFallbackWithError(errorObj: Error, attempts: number): Promise<boolean> {\n    if (!isFallbackEligibleError(errorObj)) return false;\n    if (attempts >= AgentController.MAX_FALLBACK_ATTEMPTS) return false;\n    logDebug(`[AgentController] Fallback-eligible error detected: ${errorObj.message}`);\n    return this.attemptFallback(errorObj);\n  }\n\n  async *send(message: string): AsyncIterableIterator<AgentEventUnion> {\n    if (this.activeSink) {\n      throw new Error('Agent runtime is already processing a message. Please wait for the current run to finish.');\n    }\n    let cancelledByUser = false;\n\n    // Reset failed providers at the start of each new message\n    // (providers might have recovered, quotas might have reset, etc.)\n    this.failedProviders.clear();\n\n    let fallbackAttempts = 0;\n\n    // Retry loop for fallback handling\n    while (fallbackAttempts < AgentController.MAX_FALLBACK_ATTEMPTS) {\n      const agent = this.ensureAgent();\n      const sink = this.createSink();\n      let caughtError: Error | null = null;\n      let fallbackSucceeded = false;\n\n      const run = this.startAgentRun(agent, message, sink).catch((error) => {\n        caughtError = error instanceof Error ? error : new Error(String(error));\n        if (/cancelled/i.test(caughtError.message)) {\n          cancelledByUser = true;\n        }\n      });\n\n      try {\n        for await (const event of sink) {\n          yield event;\n        }\n      } finally {\n        await run;\n      }\n\n      // Decide on fallback after run completion\n      if (caughtError) {\n        if (cancelledByUser) {\n          this.emitError(caughtError.message);\n          break;\n        }\n        fallbackSucceeded = await this.attemptFallbackWithError(caughtError, fallbackAttempts + 1);\n        if (!fallbackSucceeded) {\n          this.emitError(caughtError.message);\n          break;\n        }\n        fallbackAttempts++;\n        logDebug(\n          `[AgentController] Retrying with fallback provider (attempt ${fallbackAttempts}/${AgentController.MAX_FALLBACK_ATTEMPTS})`\n        );\n        continue;\n      }\n\n      // Successful run, exit loop\n      break;\n    }\n  }\n\n  /**\n   * Cancel an in-flight agent run, if any. This triggers a controlled failure on the stream.\n   */\n  cancel(reason = 'Cancelled by user'): void {\n    if (!this.activeSink) return;\n    this.cancelActiveRunFn?.();\n    this.activeSink.fail(new Error(reason));\n    this.clearSink();\n  }\n\n  async switchModel(config: ModelConfig): Promise<void> {\n    this.updateCachedHistory();\n    this.agent = null;\n    this.selection = {\n      provider: config.provider,\n      model: config.model,\n      temperature: config.temperature,\n      maxTokens: config.maxTokens,\n      systemPrompt: this.selection.systemPrompt,\n    } satisfies ModelSelection;\n    this.session.updateToolContext(this.selection);\n  }\n\n  getCapabilities(): CapabilityManifest {\n    const tools = this.session.toolRuntime.listProviderTools();\n    const manifestTools: ToolCapability[] = tools.map((tool) => ({\n      name: tool.name,\n      description: tool.description,\n      category: 'general',\n    }));\n    return {\n      contractVersion: AGENT_CONTRACT_VERSION,\n      profile: this.session.profile,\n      model: this.toModelConfig(this.selection),\n      tools: manifestTools,\n      features: ['streaming', 'tool-calls'],\n    } satisfies CapabilityManifest;\n  }\n\n  registerToolSuite(suiteId: string, suite: ToolSuite): void {\n    this.session.toolRuntime.registerSuite({ ...suite, id: suiteId });\n  }\n\n  unregisterToolSuite(suiteId: string): void {\n    this.session.toolRuntime.unregisterSuite(suiteId);\n  }\n\n  getHistory(): ConversationMessage[] {\n    if (this.agent) {\n      return this.agent.getHistory();\n    }\n    return [...this.cachedHistory];\n  }\n\n  clearHistory(): void {\n    this.cachedHistory = [];\n    this.agent?.clearHistory();\n  }\n\n  private toModelConfig(selection: ModelSelection): ModelConfig {\n    return {\n      provider: selection.provider,\n      model: selection.model,\n      temperature: selection.temperature,\n      maxTokens: selection.maxTokens,\n    } satisfies ModelConfig;\n  }\n\n  /**\n   * Find the next available provider for fallback.\n   * Excludes providers that have already failed in this session.\n   */\n  private findFallbackProvider(): { provider: ProviderId; model: string } | null {\n    const configured = getConfiguredProviders();\n    const currentProvider = this.selection.provider;\n\n    // Provider preference order (excluding current and failed)\n    const preferenceOrder: ProviderId[] = ['xai', 'anthropic', 'openai', 'google', 'deepseek', 'ollama'];\n\n    for (const providerId of preferenceOrder) {\n      // Skip current provider and already failed providers\n      if (providerId === currentProvider || this.failedProviders.has(providerId)) {\n        continue;\n      }\n\n      // Check if this provider is configured\n      const provider = configured.find(p => p.id === providerId);\n      if (provider) {\n        const model = getLatestModelForProvider(providerId);\n        if (model) {\n          return { provider: providerId, model };\n        }\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Emit a provider fallback event\n   */\n  private emitFallbackEvent(\n    fromProvider: string,\n    fromModel: string,\n    toProvider: string,\n    toModel: string,\n    reason: string,\n    error: string\n  ): void {\n    this.activeSink?.push({\n      type: 'provider.fallback',\n      timestamp: Date.now(),\n      fromProvider,\n      fromModel,\n      toProvider,\n      toModel,\n      reason,\n      error,\n    });\n  }\n\n  /**\n   * Attempt to switch to a fallback provider\n   */\n  private async attemptFallback(error: Error): Promise<boolean> {\n    const fallback = this.findFallbackProvider();\n    if (!fallback) {\n      logDebug('[AgentController] No fallback provider available');\n      return false;\n    }\n\n    const reason = getFallbackReason(error);\n    const fromProvider = this.selection.provider;\n    const fromModel = this.selection.model;\n\n    // Mark current provider as failed\n    this.failedProviders.add(fromProvider);\n\n    // Emit fallback event\n    this.emitFallbackEvent(\n      fromProvider,\n      fromModel,\n      fallback.provider,\n      fallback.model,\n      reason,\n      error.message\n    );\n\n    logDebug(`[AgentController] Falling back from ${fromProvider}/${fromModel} to ${fallback.provider}/${fallback.model}: ${reason}`);\n\n    // Switch to fallback provider\n    await this.switchModel({\n      provider: fallback.provider,\n      model: fallback.model,\n    });\n\n    return true;\n  }\n\n  getToolSuites(): ToolSuite[] {\n    return this.session.toolSuites;\n  }\n}\n"],"mappings":"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","ignoreList":[]}