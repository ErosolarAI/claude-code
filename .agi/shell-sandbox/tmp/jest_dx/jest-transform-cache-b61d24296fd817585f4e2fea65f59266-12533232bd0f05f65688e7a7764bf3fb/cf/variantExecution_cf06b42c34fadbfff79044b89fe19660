e321c80441136b4679893fa12d9fa7b3
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.canRunVariantsParallel = canRunVariantsParallel;
exports.executeVariants = executeVariants;
exports.resolveWorkspaceRoot = resolveWorkspaceRoot;
/**
 * Decide if variants can run safely in parallel.
 */
function canRunVariantsParallel(modeDefinition, context) {
  if (!context.parallelVariants) return false;
  if (!modeDefinition.variants.includes('refiner')) return false;
  const refinerRoot = context.variantWorkspaceRoots?.refiner;
  const primaryRoot = context.variantWorkspaceRoots?.primary;
  return Boolean(refinerRoot && primaryRoot && refinerRoot !== primaryRoot);
}

/**
 * Resolve the workspace root for a variant, falling back to the primary root.
 */
function resolveWorkspaceRoot(variant, context) {
  return context.variantWorkspaceRoots?.[variant] ?? context.variantWorkspaceRoots?.primary;
}

/**
 * Execute primary/refiner variants either in parallel or sequentially, preserving
 * the original behavior where refiner sees the primary result in sequential mode.
 */
async function executeVariants(params) {
  const {
    module,
    step,
    mode,
    modeDefinition,
    context,
    emit,
    executeVariant
  } = params;
  const results = {};
  const parallel = canRunVariantsParallel(modeDefinition, context);
  if (parallel && modeDefinition.variants.length > 1) {
    emit?.({
      type: 'upgrade.step.variants.parallel',
      timestamp: Date.now(),
      data: {
        moduleId: module.id,
        stepId: step.id,
        variants: modeDefinition.variants
      }
    });
    const promises = modeDefinition.variants.map(async variant => {
      const result = await executeVariant({
        module,
        step,
        mode,
        variant,
        previousResult: undefined,
        workspaceRoot: resolveWorkspaceRoot(variant, context),
        repoPolicy: context.repoPolicy
      });
      return {
        variant,
        result
      };
    });
    const resolved = await Promise.all(promises);
    for (const {
      variant,
      result
    } of resolved) {
      results[variant] = result;
    }
    return results;
  }
  for (const variant of modeDefinition.variants) {
    const previousResult = variant === 'refiner' ? results.primary : undefined;
    const result = await executeVariant({
      module,
      step,
      mode,
      variant,
      previousResult,
      workspaceRoot: resolveWorkspaceRoot(variant, context),
      repoPolicy: context.repoPolicy
    });
    results[variant] = result;
  }
  return results;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjYW5SdW5WYXJpYW50c1BhcmFsbGVsIiwibW9kZURlZmluaXRpb24iLCJjb250ZXh0IiwicGFyYWxsZWxWYXJpYW50cyIsInZhcmlhbnRzIiwiaW5jbHVkZXMiLCJyZWZpbmVyUm9vdCIsInZhcmlhbnRXb3Jrc3BhY2VSb290cyIsInJlZmluZXIiLCJwcmltYXJ5Um9vdCIsInByaW1hcnkiLCJCb29sZWFuIiwicmVzb2x2ZVdvcmtzcGFjZVJvb3QiLCJ2YXJpYW50IiwiZXhlY3V0ZVZhcmlhbnRzIiwicGFyYW1zIiwibW9kdWxlIiwic3RlcCIsIm1vZGUiLCJlbWl0IiwiZXhlY3V0ZVZhcmlhbnQiLCJyZXN1bHRzIiwicGFyYWxsZWwiLCJsZW5ndGgiLCJ0eXBlIiwidGltZXN0YW1wIiwiRGF0ZSIsIm5vdyIsImRhdGEiLCJtb2R1bGVJZCIsImlkIiwic3RlcElkIiwicHJvbWlzZXMiLCJtYXAiLCJyZXN1bHQiLCJwcmV2aW91c1Jlc3VsdCIsInVuZGVmaW5lZCIsIndvcmtzcGFjZVJvb3QiLCJyZXBvUG9saWN5IiwicmVzb2x2ZWQiLCJQcm9taXNlIiwiYWxsIl0sInNvdXJjZXMiOlsidmFyaWFudEV4ZWN1dGlvbi50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7XG4gIFJlcG9VcGdyYWRlTW9kZSxcbiAgUmVwb1VwZ3JhZGVNb2RlRGVmaW5pdGlvbixcbiAgUmVwb1VwZ3JhZGVNb2R1bGUsXG4gIFJlcG9VcGdyYWRlU3RlcCxcbiAgVXBncmFkZVN0ZXBFeGVjdXRpb25JbnB1dCxcbiAgVXBncmFkZVN0ZXBSZXN1bHQsXG4gIFVwZ3JhZGVWYXJpYW50LFxufSBmcm9tICcuL3JlcG9VcGdyYWRlT3JjaGVzdHJhdG9yLmpzJztcblxuZXhwb3J0IGludGVyZmFjZSBWYXJpYW50RXhlY3V0aW9uQ29udGV4dCB7XG4gIHBhcmFsbGVsVmFyaWFudHM6IGJvb2xlYW47XG4gIHZhcmlhbnRXb3Jrc3BhY2VSb290cz86IFBhcnRpYWw8UmVjb3JkPFVwZ3JhZGVWYXJpYW50LCBzdHJpbmc+PjtcbiAgcmVwb1BvbGljeT86IHN0cmluZztcbn1cblxuZXhwb3J0IHR5cGUgVmFyaWFudEV4ZWN1dG9yID0gKGlucHV0OiBVcGdyYWRlU3RlcEV4ZWN1dGlvbklucHV0KSA9PiBQcm9taXNlPFVwZ3JhZGVTdGVwUmVzdWx0PjtcblxuZXhwb3J0IGludGVyZmFjZSBFeGVjdXRlVmFyaWFudHNQYXJhbXMge1xuICBtb2R1bGU6IFJlcG9VcGdyYWRlTW9kdWxlO1xuICBzdGVwOiBSZXBvVXBncmFkZVN0ZXA7XG4gIG1vZGU6IFJlcG9VcGdyYWRlTW9kZTtcbiAgbW9kZURlZmluaXRpb246IFJlcG9VcGdyYWRlTW9kZURlZmluaXRpb247XG4gIGNvbnRleHQ6IFZhcmlhbnRFeGVjdXRpb25Db250ZXh0O1xuICBleGVjdXRlVmFyaWFudDogVmFyaWFudEV4ZWN1dG9yO1xuICBlbWl0PzogKGV2ZW50OiB7IHR5cGU6IHN0cmluZzsgdGltZXN0YW1wOiBudW1iZXI7IGRhdGE6IFJlY29yZDxzdHJpbmcsIHVua25vd24+IH0pID0+IHZvaWQ7XG59XG5cbi8qKlxuICogRGVjaWRlIGlmIHZhcmlhbnRzIGNhbiBydW4gc2FmZWx5IGluIHBhcmFsbGVsLlxuICovXG5leHBvcnQgZnVuY3Rpb24gY2FuUnVuVmFyaWFudHNQYXJhbGxlbChcbiAgbW9kZURlZmluaXRpb246IFJlcG9VcGdyYWRlTW9kZURlZmluaXRpb24sXG4gIGNvbnRleHQ6IFZhcmlhbnRFeGVjdXRpb25Db250ZXh0XG4pOiBib29sZWFuIHtcbiAgaWYgKCFjb250ZXh0LnBhcmFsbGVsVmFyaWFudHMpIHJldHVybiBmYWxzZTtcbiAgaWYgKCFtb2RlRGVmaW5pdGlvbi52YXJpYW50cy5pbmNsdWRlcygncmVmaW5lcicpKSByZXR1cm4gZmFsc2U7XG4gIGNvbnN0IHJlZmluZXJSb290ID0gY29udGV4dC52YXJpYW50V29ya3NwYWNlUm9vdHM/LnJlZmluZXI7XG4gIGNvbnN0IHByaW1hcnlSb290ID0gY29udGV4dC52YXJpYW50V29ya3NwYWNlUm9vdHM/LnByaW1hcnk7XG4gIHJldHVybiBCb29sZWFuKHJlZmluZXJSb290ICYmIHByaW1hcnlSb290ICYmIHJlZmluZXJSb290ICE9PSBwcmltYXJ5Um9vdCk7XG59XG5cbi8qKlxuICogUmVzb2x2ZSB0aGUgd29ya3NwYWNlIHJvb3QgZm9yIGEgdmFyaWFudCwgZmFsbGluZyBiYWNrIHRvIHRoZSBwcmltYXJ5IHJvb3QuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZXNvbHZlV29ya3NwYWNlUm9vdChcbiAgdmFyaWFudDogVXBncmFkZVZhcmlhbnQsXG4gIGNvbnRleHQ6IFZhcmlhbnRFeGVjdXRpb25Db250ZXh0XG4pOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICByZXR1cm4gY29udGV4dC52YXJpYW50V29ya3NwYWNlUm9vdHM/Llt2YXJpYW50XSA/PyBjb250ZXh0LnZhcmlhbnRXb3Jrc3BhY2VSb290cz8ucHJpbWFyeTtcbn1cblxuLyoqXG4gKiBFeGVjdXRlIHByaW1hcnkvcmVmaW5lciB2YXJpYW50cyBlaXRoZXIgaW4gcGFyYWxsZWwgb3Igc2VxdWVudGlhbGx5LCBwcmVzZXJ2aW5nXG4gKiB0aGUgb3JpZ2luYWwgYmVoYXZpb3Igd2hlcmUgcmVmaW5lciBzZWVzIHRoZSBwcmltYXJ5IHJlc3VsdCBpbiBzZXF1ZW50aWFsIG1vZGUuXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBleGVjdXRlVmFyaWFudHMocGFyYW1zOiBFeGVjdXRlVmFyaWFudHNQYXJhbXMpOiBQcm9taXNlPFxuICBQYXJ0aWFsPFJlY29yZDxVcGdyYWRlVmFyaWFudCwgVXBncmFkZVN0ZXBSZXN1bHQ+PlxuPiB7XG4gIGNvbnN0IHsgbW9kdWxlLCBzdGVwLCBtb2RlLCBtb2RlRGVmaW5pdGlvbiwgY29udGV4dCwgZW1pdCwgZXhlY3V0ZVZhcmlhbnQgfSA9IHBhcmFtcztcbiAgY29uc3QgcmVzdWx0czogUGFydGlhbDxSZWNvcmQ8VXBncmFkZVZhcmlhbnQsIFVwZ3JhZGVTdGVwUmVzdWx0Pj4gPSB7fTtcbiAgY29uc3QgcGFyYWxsZWwgPSBjYW5SdW5WYXJpYW50c1BhcmFsbGVsKG1vZGVEZWZpbml0aW9uLCBjb250ZXh0KTtcblxuICBpZiAocGFyYWxsZWwgJiYgbW9kZURlZmluaXRpb24udmFyaWFudHMubGVuZ3RoID4gMSkge1xuICAgIGVtaXQ/Lih7XG4gICAgICB0eXBlOiAndXBncmFkZS5zdGVwLnZhcmlhbnRzLnBhcmFsbGVsJyxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIGRhdGE6IHsgbW9kdWxlSWQ6IG1vZHVsZS5pZCwgc3RlcElkOiBzdGVwLmlkLCB2YXJpYW50czogbW9kZURlZmluaXRpb24udmFyaWFudHMgfSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHByb21pc2VzID0gbW9kZURlZmluaXRpb24udmFyaWFudHMubWFwKGFzeW5jICh2YXJpYW50KSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBleGVjdXRlVmFyaWFudCh7XG4gICAgICAgIG1vZHVsZSxcbiAgICAgICAgc3RlcCxcbiAgICAgICAgbW9kZSxcbiAgICAgICAgdmFyaWFudCxcbiAgICAgICAgcHJldmlvdXNSZXN1bHQ6IHVuZGVmaW5lZCxcbiAgICAgICAgd29ya3NwYWNlUm9vdDogcmVzb2x2ZVdvcmtzcGFjZVJvb3QodmFyaWFudCwgY29udGV4dCksXG4gICAgICAgIHJlcG9Qb2xpY3k6IGNvbnRleHQucmVwb1BvbGljeSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHsgdmFyaWFudCwgcmVzdWx0IH07XG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNvbHZlZCA9IGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgICBmb3IgKGNvbnN0IHsgdmFyaWFudCwgcmVzdWx0IH0gb2YgcmVzb2x2ZWQpIHtcbiAgICAgIHJlc3VsdHNbdmFyaWFudF0gPSByZXN1bHQ7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHRzO1xuICB9XG5cbiAgZm9yIChjb25zdCB2YXJpYW50IG9mIG1vZGVEZWZpbml0aW9uLnZhcmlhbnRzKSB7XG4gICAgY29uc3QgcHJldmlvdXNSZXN1bHQgPSB2YXJpYW50ID09PSAncmVmaW5lcicgPyByZXN1bHRzLnByaW1hcnkgOiB1bmRlZmluZWQ7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZXhlY3V0ZVZhcmlhbnQoe1xuICAgICAgbW9kdWxlLFxuICAgICAgc3RlcCxcbiAgICAgIG1vZGUsXG4gICAgICB2YXJpYW50LFxuICAgICAgcHJldmlvdXNSZXN1bHQsXG4gICAgICB3b3Jrc3BhY2VSb290OiByZXNvbHZlV29ya3NwYWNlUm9vdCh2YXJpYW50LCBjb250ZXh0KSxcbiAgICAgIHJlcG9Qb2xpY3k6IGNvbnRleHQucmVwb1BvbGljeSxcbiAgICB9KTtcbiAgICByZXN1bHRzW3ZhcmlhbnRdID0gcmVzdWx0O1xuICB9XG5cbiAgcmV0dXJuIHJlc3VsdHM7XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBNEJBO0FBQ0E7QUFDQTtBQUNPLFNBQVNBLHNCQUFzQkEsQ0FDcENDLGNBQXlDLEVBQ3pDQyxPQUFnQyxFQUN2QjtFQUNULElBQUksQ0FBQ0EsT0FBTyxDQUFDQyxnQkFBZ0IsRUFBRSxPQUFPLEtBQUs7RUFDM0MsSUFBSSxDQUFDRixjQUFjLENBQUNHLFFBQVEsQ0FBQ0MsUUFBUSxDQUFDLFNBQVMsQ0FBQyxFQUFFLE9BQU8sS0FBSztFQUM5RCxNQUFNQyxXQUFXLEdBQUdKLE9BQU8sQ0FBQ0sscUJBQXFCLEVBQUVDLE9BQU87RUFDMUQsTUFBTUMsV0FBVyxHQUFHUCxPQUFPLENBQUNLLHFCQUFxQixFQUFFRyxPQUFPO0VBQzFELE9BQU9DLE9BQU8sQ0FBQ0wsV0FBVyxJQUFJRyxXQUFXLElBQUlILFdBQVcsS0FBS0csV0FBVyxDQUFDO0FBQzNFOztBQUVBO0FBQ0E7QUFDQTtBQUNPLFNBQVNHLG9CQUFvQkEsQ0FDbENDLE9BQXVCLEVBQ3ZCWCxPQUFnQyxFQUNaO0VBQ3BCLE9BQU9BLE9BQU8sQ0FBQ0sscUJBQXFCLEdB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