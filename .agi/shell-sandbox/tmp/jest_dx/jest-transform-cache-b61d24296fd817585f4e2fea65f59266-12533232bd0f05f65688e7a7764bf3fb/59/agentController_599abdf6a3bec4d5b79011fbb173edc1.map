{"version":3,"names":["_node","require","_agent","_debugLogger","_resilientProvider","_modelDiscovery","EventStream","queue","pending","closed","failure","push","value","resolve","done","close","undefined","fail","error","reject","next","length","shift","Promise","return","throw","err","Error","String","Symbol","asyncIterator","mergeToolObservers","primary","secondary","onToolStart","call","onToolResult","output","onToolProgress","progress","onToolError","onCacheHit","onToolWarning","warning","createControllerToolObserver","ref","emit","event","current","timestamp","Date","now","type","toolName","name","toolCallId","id","parameters","arguments","result","createAgentController","options","additionalObserver","sinkRef","observer","runtime","createNodeRuntime","profile","workspaceContext","workingDir","env","toolObserver","additionalModules","modules","AgentController","externalCallbacks","callbacks","activeSink","agent","cachedHistory","failedProviders","Set","MAX_FALLBACK_ATTEMPTS","activeTimeout","inflightReject","constructor","dependencies","session","selection","buildInitialSelection","config","profileConfig","provider","model","temperature","maxTokens","systemPrompt","ensureAgent","createAgent","createAgentCallbacks","explainEdits","loadHistory","onRequestReceived","requestPreview","onAssistantMessage","content","metadata","handleAssistantMessage","onStreamChunk","chunk","emitDelta","emitReasoning","onUsage","usage","emitUsage","onContextPruned","removedCount","stats","onContextSquishing","message","onContextRecovery","attempt","maxAttempts","onContinueAfterRecovery","onMultilinePaste","summary","onEditExplanation","payload","handleEditExplanation","onRetrying","isGarbageContent","trimmed","trim","test","isFinal","emitError","inputTokens","outputTokens","totalTokens","explanation","files","suppressDisplay","elapsedMs","updateCachedHistory","getHistory","cancel","reason","rejectInflight","clearActiveTimeout","clearTimeout","send","clear","fallbackAttempts","sink","timeoutMsRaw","process","timeoutMs","Number","NaN","isNaN","setTimeout","caughtError","fallbackSucceeded","cancelRun","cancelPromise","_","run","race","then","catch","errorObj","cancelled","timedOut","isFallbackEligibleError","logDebug","attemptFallback","finally","switchModel","updateToolContext","getCapabilities","tools","toolRuntime","listProviderTools","manifestTools","map","tool","description","category","contractVersion","AGENT_CONTRACT_VERSION","toModelConfig","features","registerToolSuite","suiteId","suite","registerSuite","unregisterToolSuite","unregisterSuite","clearHistory","isProcessing","forceReset","sanitizeHistory","history","sanitized","i","msg","role","toolCalls","toolCallIds","tc","nextIdx","toolMsg","delete","orphanedId","orphanedCall","find","findFallbackProvider","configured","getConfiguredProviders","currentProvider","preferenceOrder","providerId","has","p","getLatestModelForProvider","emitFallbackEvent","fromProvider","fromModel","toProvider","toModel","fallback","getFallbackReason","add","getToolSuites","toolSuites","exports"],"sources":["agentController.ts"],"sourcesContent":["import type { ProfileName } from '../config.js';\nimport type { AgentSession, ModelSelection } from './agentSession.js';\nimport type { UniversalRuntime } from './universal.js';\nimport { createNodeRuntime, type NodeRuntimeOptions } from './node.js';\nimport type { CapabilityModule } from './agentHost.js';\nimport type { AgentCallbacks, AssistantMessageMetadata, EditExplanationPayload } from '../core/agent.js';\nimport type { ToolRuntimeObserver, ToolSuite } from '../core/toolRuntime.js';\nimport type { ConversationMessage, ProviderUsage, ProviderId } from '../core/types.js';\nimport type {\n  AgentEventUnion,\n  CapabilityManifest,\n  IAgentController,\n  ModelConfig,\n  ToolCapability,\n} from '../contracts/v1/agent.js';\nimport { AGENT_CONTRACT_VERSION } from '../contracts/v1/agent.js';\nimport { logDebug } from '../utils/debugLogger.js';\nimport { isFallbackEligibleError, getFallbackReason } from '../providers/resilientProvider.js';\nimport { getConfiguredProviders, getLatestModelForProvider } from '../core/modelDiscovery.js';\n\ninterface EventSinkRef {\n  current: EventStream<AgentEventUnion> | null;\n}\n\nclass EventStream<T> implements AsyncIterableIterator<T> {\n  private readonly queue: T[] = [];\n  private pending: { resolve: (value: IteratorResult<T>) => void; reject: (error: unknown) => void } | null = null;\n  private closed = false;\n  private failure: Error | null = null;\n\n  push(value: T): void {\n    if (this.closed || this.failure) {\n      return;\n    }\n    if (this.pending) {\n      this.pending.resolve({ value, done: false });\n      this.pending = null;\n      return;\n    }\n    this.queue.push(value);\n  }\n\n  close(): void {\n    if (this.closed || this.failure) {\n      return;\n    }\n    this.closed = true;\n    if (this.pending) {\n      this.pending.resolve({ value: undefined as unknown as T, done: true });\n      this.pending = null;\n    }\n  }\n\n  fail(error: Error): void {\n    if (this.closed || this.failure) {\n      return;\n    }\n    this.failure = error;\n    this.closed = true; // Mark as closed to prevent new pending promises\n    if (this.pending) {\n      this.pending.reject(error);\n      this.pending = null;\n    }\n  }\n\n  next(): Promise<IteratorResult<T>> {\n    if (this.queue.length) {\n      const value = this.queue.shift()!;\n      return Promise.resolve({ value, done: false });\n    }\n    if (this.failure) {\n      const error = this.failure;\n      this.failure = null;\n      return Promise.reject(error);\n    }\n    if (this.closed) {\n      return Promise.resolve({ value: undefined as unknown as T, done: true });\n    }\n    return new Promise<IteratorResult<T>>((resolve, reject) => {\n      this.pending = { resolve, reject };\n    });\n  }\n\n  return(): Promise<IteratorResult<T>> {\n    this.close();\n    return Promise.resolve({ value: undefined as unknown as T, done: true });\n  }\n\n  throw(error: unknown): Promise<IteratorResult<T>> {\n    const err = error instanceof Error ? error : new Error(String(error));\n    this.fail(err);\n    return Promise.reject(err);\n  }\n\n  [Symbol.asyncIterator](): AsyncIterableIterator<T> {\n    return this;\n  }\n}\n\nfunction mergeToolObservers(\n  primary: ToolRuntimeObserver,\n  secondary?: ToolRuntimeObserver\n): ToolRuntimeObserver {\n  if (!secondary) {\n    return primary;\n  }\n  return {\n    onToolStart(call) {\n      primary.onToolStart?.(call);\n      secondary.onToolStart?.(call);\n    },\n    onToolResult(call, output) {\n      primary.onToolResult?.(call, output);\n      secondary.onToolResult?.(call, output);\n    },\n    onToolProgress(call, progress) {\n      primary.onToolProgress?.(call, progress);\n      secondary.onToolProgress?.(call, progress);\n    },\n    onToolError(call, error) {\n      primary.onToolError?.(call, error);\n      secondary.onToolError?.(call, error);\n    },\n    onCacheHit(call) {\n      primary.onCacheHit?.(call);\n      secondary.onCacheHit?.(call);\n    },\n    onToolWarning(call, warning) {\n      primary.onToolWarning?.(call, warning);\n      secondary.onToolWarning?.(call, warning);\n    },\n  } satisfies ToolRuntimeObserver;\n}\n\nfunction createControllerToolObserver(ref: EventSinkRef): ToolRuntimeObserver {\n  const emit = (event: AgentEventUnion) => {\n    ref.current?.push(event);\n  };\n  const timestamp = () => Date.now();\n  return {\n    onToolStart(call) {\n      emit({\n        type: 'tool.start',\n        timestamp: timestamp(),\n        toolName: call.name,\n        toolCallId: call.id,\n        parameters: { ...call.arguments },\n      });\n    },\n    onToolResult(call, output) {\n      emit({\n        type: 'tool.complete',\n        timestamp: timestamp(),\n        toolName: call.name,\n        toolCallId: call.id,\n        result: output,\n      });\n    },\n    onToolError(call, error) {\n      emit({\n        type: 'tool.error',\n        timestamp: timestamp(),\n        toolName: call.name,\n        toolCallId: call.id,\n        error,\n      });\n    },\n  } satisfies ToolRuntimeObserver;\n}\n\ninterface AgentControllerDependencies {\n  runtime: UniversalRuntime;\n  sinkRef: EventSinkRef;\n  externalCallbacks?: AgentCallbacks;\n}\n\nexport interface AgentControllerCreateOptions extends Omit<NodeRuntimeOptions, 'toolObserver'> {\n  profile: ProfileName;\n  workspaceContext: string | null;\n  workingDir: string;\n  modules?: CapabilityModule[];\n  callbacks?: AgentCallbacks;\n  /** Skip provider discovery for faster startup (used in quick mode) */\n  skipProviderDiscovery?: boolean;\n}\n\nexport async function createAgentController(\n  options: AgentControllerCreateOptions,\n  additionalObserver?: ToolRuntimeObserver\n): Promise<AgentController> {\n  const sinkRef: EventSinkRef = { current: null };\n  const observer = createControllerToolObserver(sinkRef);\n  const runtime = await createNodeRuntime({\n    profile: options.profile,\n    workspaceContext: options.workspaceContext,\n    workingDir: options.workingDir,\n    env: options.env,\n    toolObserver: mergeToolObservers(observer, additionalObserver),\n    additionalModules: options.modules,\n  });\n  return new AgentController({ runtime, sinkRef, externalCallbacks: options.callbacks });\n}\n\nexport class AgentController implements IAgentController {\n  private readonly session: AgentSession;\n  private readonly sinkRef: EventSinkRef;\n  private readonly externalCallbacks: AgentCallbacks | undefined;\n  private activeSink: EventStream<AgentEventUnion> | null = null;\n  private agent: ReturnType<AgentSession['createAgent']> | null = null;\n  private cachedHistory: ConversationMessage[] = [];\n  private selection: ModelSelection;\n  /** Set of providers that have failed with non-retryable errors in this session */\n  private failedProviders: Set<ProviderId> = new Set();\n  /** Maximum fallback attempts per send() call */\n  private static readonly MAX_FALLBACK_ATTEMPTS = 3;\n  private activeTimeout: NodeJS.Timeout | null = null;\n  private inflightReject: ((error: Error) => void) | null = null;\n\n  constructor(dependencies: AgentControllerDependencies) {\n    this.session = dependencies.runtime.session;\n    this.sinkRef = dependencies.sinkRef;\n    this.externalCallbacks = dependencies.externalCallbacks;\n    this.selection = this.buildInitialSelection();\n  }\n\n  private buildInitialSelection(): ModelSelection {\n    const config = this.session.profileConfig;\n    return {\n      provider: config.provider,\n      model: config.model,\n      temperature: config.temperature,\n      maxTokens: config.maxTokens,\n      systemPrompt: config.systemPrompt,\n    } satisfies ModelSelection;\n  }\n\n  private ensureAgent(): ReturnType<AgentSession['createAgent']> {\n    if (this.agent) {\n      return this.agent;\n    }\n    const agent = this.session.createAgent(this.selection, this.createAgentCallbacks(), undefined, {\n      explainEdits: true,\n    });\n    if (this.cachedHistory.length) {\n      agent.loadHistory(this.cachedHistory);\n    }\n    this.agent = agent;\n    return agent;\n  }\n\n  private createAgentCallbacks(): AgentCallbacks {\n    return {\n      onRequestReceived: (requestPreview) => {\n        // Signal to UI that request was received - let model handle natural acknowledgment\n        // Don't emit verbatim echo - it's redundant and the model's response should acknowledge contextually\n        this.externalCallbacks?.onRequestReceived?.(requestPreview);\n      },\n      onAssistantMessage: (content, metadata) => {\n        this.handleAssistantMessage(content, metadata);\n        this.externalCallbacks?.onAssistantMessage?.(content, metadata);\n      },\n      onStreamChunk: (chunk, type) => {\n        if (type === 'content') {\n          // Content chunks go to message.delta for streaming display\n          this.emitDelta(chunk, false);\n        } else if (type === 'reasoning') {\n          // Reasoning chunks go to reasoning event for thought display\n          this.emitReasoning(chunk);\n        }\n        // Pass all chunks to external callbacks\n        this.externalCallbacks?.onStreamChunk?.(chunk, type);\n      },\n      onUsage: (usage) => {\n        this.emitUsage(usage);\n        this.externalCallbacks?.onUsage?.(usage);\n      },\n      onContextPruned: (removedCount, stats) => {\n        this.externalCallbacks?.onContextPruned?.(removedCount, stats);\n      },\n      onContextSquishing: (message) => {\n        this.externalCallbacks?.onContextSquishing?.(message);\n      },\n      onContextRecovery: (attempt, maxAttempts, message) => {\n        this.externalCallbacks?.onContextRecovery?.(attempt, maxAttempts, message);\n      },\n      onContinueAfterRecovery: () => {\n        this.externalCallbacks?.onContinueAfterRecovery?.();\n      },\n      onMultilinePaste: (summary, metadata) => {\n        this.externalCallbacks?.onMultilinePaste?.(summary, metadata);\n      },\n      onEditExplanation: (payload) => {\n        this.handleEditExplanation(payload);\n        this.externalCallbacks?.onEditExplanation?.(payload);\n      },\n      onRetrying: (attempt, maxAttempts, error) => {\n        // Emit delta event to show retry status\n        this.emitDelta(`[Retrying ${attempt}/${maxAttempts}: ${error.message}]`, false);\n        this.externalCallbacks?.onRetrying?.(attempt, maxAttempts, error);\n      },\n      // onBeforeFirstToolCall not needed - model's reasoning is now emitted as thought events\n    } satisfies AgentCallbacks;\n  }\n\n  /**\n   * Check if content looks like garbage/leaked reasoning fragments.\n   * Returns true if the content should be filtered out.\n   * NOTE: Keep this minimal to avoid suppressing legitimate short responses.\n   */\n  private isGarbageContent(content: string): boolean {\n    const trimmed = content.trim();\n    if (!trimmed) return true;\n\n    // Only filter pure punctuation/markdown artifacts\n    if (/^[)\\]}>*`'\".:,!?|│┃─━═\\s]+$/.test(trimmed)) return true;\n\n    // Just newlines or whitespace\n    if (/^[\\s\\n\\r]+$/.test(trimmed)) return true;\n\n    // Removed aggressive short fragment filtering - was suppressing legitimate content\n    return false;\n  }\n\n  private emitDelta(content: string, isFinal: boolean): void {\n    if (!content?.trim()) {\n      return;\n    }\n\n    // Filter out garbage/leaked reasoning fragments\n    if (this.isGarbageContent(content)) {\n      return;\n    }\n    this.activeSink?.push({\n      type: 'message.delta',\n      timestamp: Date.now(),\n      content,\n      isFinal,\n    });\n  }\n\n  private emitError(message: string): void {\n    this.activeSink?.push({\n      type: 'error',\n      timestamp: Date.now(),\n      error: message,\n    });\n  }\n\n  private emitReasoning(content: string): void {\n    if (!content?.trim()) {\n      return;\n    }\n    // Filter out garbage/leaked formatting fragments in reasoning too\n    if (this.isGarbageContent(content)) {\n      return;\n    }\n    this.activeSink?.push({\n      type: 'reasoning',\n      timestamp: Date.now(),\n      content,\n    });\n  }\n\n  private emitUsage(usage: ProviderUsage | null | undefined): void {\n    if (!usage) {\n      return;\n    }\n    this.activeSink?.push({\n      type: 'usage',\n      timestamp: Date.now(),\n      inputTokens: usage.inputTokens,\n      outputTokens: usage.outputTokens,\n      totalTokens: usage.totalTokens,\n    });\n  }\n\n  private handleEditExplanation(payload: EditExplanationPayload): void {\n    if (!this.activeSink) {\n      return;\n    }\n    if (!payload.explanation?.trim()) {\n      return;\n    }\n    this.activeSink.push({\n      type: 'edit.explanation',\n      timestamp: Date.now(),\n      content: payload.explanation,\n      files: payload.files,\n      toolName: payload.toolName,\n      toolCallId: payload.toolCallId,\n    });\n  }\n\n  private handleAssistantMessage(content: string, metadata: AssistantMessageMetadata): void {\n    if (!this.activeSink) {\n      return;\n    }\n    if (!content.trim()) {\n      return;\n    }\n    if (metadata.suppressDisplay) {\n      return;\n    }\n    if (!metadata.isFinal) {\n      this.emitDelta(content, false);\n      return;\n    }\n    const elapsedMs = metadata.elapsedMs ?? 0;\n    this.activeSink.push({\n      type: 'message.complete',\n      timestamp: Date.now(),\n      content,\n      elapsedMs,\n    });\n    this.emitUsage(metadata.usage ?? null);\n  }\n\n  private updateCachedHistory(): void {\n    if (this.agent) {\n      this.cachedHistory = this.agent.getHistory();\n    }\n  }\n\n  cancel(reason?: string): void {\n    if (!this.activeSink) {\n      return;\n    }\n    const error = new Error(reason ?? 'Run cancelled');\n    try {\n      (this.agent as any)?.cancel?.(reason);\n    } catch {\n      // ignore cancellation errors\n    }\n    this.rejectInflight(error);\n    this.activeSink.fail(error);\n    this.activeSink = null;\n    this.sinkRef.current = null;\n    this.clearActiveTimeout();\n  }\n\n  private clearActiveTimeout(): void {\n    if (this.activeTimeout) {\n      clearTimeout(this.activeTimeout);\n      this.activeTimeout = null;\n    }\n  }\n\n  private rejectInflight(error: Error): void {\n    if (this.inflightReject) {\n      this.inflightReject(error);\n      this.inflightReject = null;\n    }\n  }\n\n  async *send(message: string): AsyncIterableIterator<AgentEventUnion> {\n    if (this.activeSink) {\n      throw new Error('Agent runtime is already processing a message. Please wait for the current run to finish.');\n    }\n\n    // Reset failed providers at the start of each new message\n    // (providers might have recovered, quotas might have reset, etc.)\n    this.failedProviders.clear();\n\n    let fallbackAttempts = 0;\n\n    // Retry loop for fallback handling\n    while (fallbackAttempts < AgentController.MAX_FALLBACK_ATTEMPTS) {\n      const agent = this.ensureAgent();\n      const sink = new EventStream<AgentEventUnion>();\n      this.activeSink = sink;\n      this.sinkRef.current = sink;\n      sink.push({ type: 'message.start', timestamp: Date.now() });\n\n      const timeoutMsRaw = process.env['AGI_AGENT_RUN_TIMEOUT_MS'];\n      const timeoutMs = timeoutMsRaw ? Number(timeoutMsRaw) : NaN;\n      if (!Number.isNaN(timeoutMs) && timeoutMs > 0) {\n        this.activeTimeout = setTimeout(() => {\n          const err = new Error(`Run timed out after ${timeoutMs}ms`);\n          this.rejectInflight(err);\n          sink.fail(err);\n          try {\n            (this.agent as any)?.cancel?.('timeout');\n          } catch {\n            // ignore\n          }\n        }, timeoutMs);\n      }\n\n      let caughtError: Error | null = null;\n      let fallbackSucceeded = false;\n\n      let cancelRun: ((error: Error) => void) | null = null;\n      const cancelPromise = new Promise<never>((_, reject) => {\n        cancelRun = reject;\n      });\n      this.inflightReject = (error: Error) => {\n        cancelRun?.(error);\n      };\n\n      const run = Promise.race([\n        agent.send(message, true),\n        cancelPromise,\n      ])\n        .then(() => {\n          this.updateCachedHistory();\n          this.clearActiveTimeout();\n          sink.close();\n        })\n        .catch(async (error) => {\n          const errorObj = error instanceof Error ? error : new Error(String(error));\n          caughtError = errorObj;\n          this.clearActiveTimeout();\n\n          const cancelled = /cancel/i.test(errorObj.message);\n          const timedOut = /timed out/i.test(errorObj.message);\n          if (cancelled || timedOut) {\n            this.emitError(errorObj.message);\n            sink.fail(errorObj);\n            return;\n          }\n\n          // Check if this error is eligible for fallback\n          if (isFallbackEligibleError(error) && fallbackAttempts < AgentController.MAX_FALLBACK_ATTEMPTS - 1) {\n            logDebug(`[AgentController] Fallback-eligible error detected: ${errorObj.message}`);\n            fallbackSucceeded = await this.attemptFallback(errorObj);\n            if (fallbackSucceeded) {\n              // Close this sink without error - we'll retry with new provider\n              sink.close();\n              return;\n            }\n          }\n\n          // Not fallback-eligible or no fallback available - emit error and fail\n          this.emitError(errorObj.message);\n          sink.fail(errorObj);\n        })\n        .finally(() => {\n          this.clearActiveTimeout();\n          this.inflightReject = null;\n          if (this.activeSink === sink) {\n            this.activeSink = null;\n            this.sinkRef.current = null;\n          }\n        });\n\n      try {\n        for await (const event of sink) {\n          yield event;\n        }\n      } finally {\n        await run;\n      }\n\n      // If we successfully fell back, increment counter and continue loop\n      if (fallbackSucceeded && caughtError) {\n        fallbackAttempts++;\n        logDebug(`[AgentController] Retrying with fallback provider (attempt ${fallbackAttempts}/${AgentController.MAX_FALLBACK_ATTEMPTS})`);\n        continue;\n      }\n\n      // No fallback happened or it failed - exit loop\n      break;\n    }\n  }\n\n  async switchModel(config: ModelConfig): Promise<void> {\n    this.updateCachedHistory();\n    this.agent = null;\n    this.selection = {\n      provider: config.provider,\n      model: config.model,\n      temperature: config.temperature,\n      maxTokens: config.maxTokens,\n      systemPrompt: this.selection.systemPrompt,\n    } satisfies ModelSelection;\n    this.session.updateToolContext(this.selection);\n  }\n\n  getCapabilities(): CapabilityManifest {\n    const tools = this.session.toolRuntime.listProviderTools();\n    const manifestTools: ToolCapability[] = tools.map((tool) => ({\n      name: tool.name,\n      description: tool.description,\n      category: 'general',\n    }));\n    return {\n      contractVersion: AGENT_CONTRACT_VERSION,\n      profile: this.session.profile,\n      model: this.toModelConfig(this.selection),\n      tools: manifestTools,\n      features: ['streaming', 'tool-calls'],\n    } satisfies CapabilityManifest;\n  }\n\n  registerToolSuite(suiteId: string, suite: ToolSuite): void {\n    this.session.toolRuntime.registerSuite({ ...suite, id: suiteId });\n  }\n\n  unregisterToolSuite(suiteId: string): void {\n    this.session.toolRuntime.unregisterSuite(suiteId);\n  }\n\n  getHistory(): ConversationMessage[] {\n    if (this.agent) {\n      return this.agent.getHistory();\n    }\n    return [...this.cachedHistory];\n  }\n\n  clearHistory(): void {\n    this.cachedHistory = [];\n    this.agent?.clearHistory();\n  }\n\n  /**\n   * Check if the controller is currently processing a message.\n   */\n  isProcessing(): boolean {\n    return this.activeSink !== null;\n  }\n\n  /**\n   * Force-clear any lingering active state. Use this before starting a new\n   * operation (like attack tournament) to ensure clean state.\n   * This will close any active sink without waiting for completion.\n   */\n  forceReset(): void {\n    if (this.activeSink) {\n      try {\n        this.activeSink.close();\n      } catch {\n        // Ignore errors - sink may already be closed\n      }\n      this.activeSink = null;\n      this.sinkRef.current = null;\n    }\n  }\n\n  /**\n   * Sanitize history by fixing orphaned tool calls (tool_calls without corresponding tool results).\n   * This can happen when a run is interrupted mid-tool-execution.\n   * We add placeholder error results for any orphaned tool calls to keep history valid.\n   */\n  sanitizeHistory(): void {\n    const history = this.getHistory();\n    if (history.length === 0) return;\n\n    const sanitized: ConversationMessage[] = [];\n    for (let i = 0; i < history.length; i++) {\n      const msg = history[i];\n      sanitized.push(msg);\n\n      // Check if this is an assistant message with tool_calls\n      if (msg.role === 'assistant' && msg.toolCalls?.length) {\n        // Look ahead for tool results\n        const toolCallIds = new Set(msg.toolCalls.map(tc => tc.id));\n        let nextIdx = i + 1;\n\n        // Consume any following tool messages\n        while (nextIdx < history.length && history[nextIdx].role === 'tool') {\n          const toolMsg = history[nextIdx] as { role: 'tool'; toolCallId: string };\n          if (toolMsg.toolCallId) {\n            toolCallIds.delete(toolMsg.toolCallId);\n          }\n          sanitized.push(history[nextIdx]);\n          nextIdx++;\n        }\n\n        // Add placeholder results for any orphaned tool calls\n        for (const orphanedId of toolCallIds) {\n          const orphanedCall = msg.toolCalls.find(tc => tc.id === orphanedId);\n          const toolName = orphanedCall?.name ?? 'unknown';\n          sanitized.push({\n            role: 'tool',\n            name: toolName,\n            toolCallId: orphanedId,\n            content: `[Interrupted: ${toolName} execution was cancelled]`,\n          });\n        }\n\n        // Skip the tool messages we already processed\n        i = nextIdx - 1;\n      }\n    }\n\n    // Update both cached history and agent history\n    this.cachedHistory = sanitized;\n    if (this.agent) {\n      this.agent.loadHistory(sanitized);\n    }\n  }\n\n  private toModelConfig(selection: ModelSelection): ModelConfig {\n    return {\n      provider: selection.provider,\n      model: selection.model,\n      temperature: selection.temperature,\n      maxTokens: selection.maxTokens,\n    } satisfies ModelConfig;\n  }\n\n  /**\n   * Find the next available provider for fallback.\n   * Excludes providers that have already failed in this session.\n   */\n  private findFallbackProvider(): { provider: ProviderId; model: string } | null {\n    const configured = getConfiguredProviders();\n    const currentProvider = this.selection.provider;\n\n    // Provider preference order (excluding current and failed)\n    // deepseek-reasoner is default, grok (xai) is backup\n    const preferenceOrder: ProviderId[] = ['deepseek', 'xai'];\n\n    for (const providerId of preferenceOrder) {\n      // Skip current provider and already failed providers\n      if (providerId === currentProvider || this.failedProviders.has(providerId)) {\n        continue;\n      }\n\n      // Check if this provider is configured\n      const provider = configured.find(p => p.id === providerId);\n      if (provider) {\n        const model = getLatestModelForProvider(providerId);\n        if (model) {\n          return { provider: providerId, model };\n        }\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Emit a provider fallback event\n   */\n  private emitFallbackEvent(\n    fromProvider: string,\n    fromModel: string,\n    toProvider: string,\n    toModel: string,\n    reason: string,\n    error: string\n  ): void {\n    this.activeSink?.push({\n      type: 'provider.fallback',\n      timestamp: Date.now(),\n      fromProvider,\n      fromModel,\n      toProvider,\n      toModel,\n      reason,\n      error,\n    });\n  }\n\n  /**\n   * Attempt to switch to a fallback provider\n   */\n  private async attemptFallback(error: Error): Promise<boolean> {\n    const fallback = this.findFallbackProvider();\n    if (!fallback) {\n      logDebug('[AgentController] No fallback provider available');\n      return false;\n    }\n\n    const reason = getFallbackReason(error);\n    const fromProvider = this.selection.provider;\n    const fromModel = this.selection.model;\n\n    // Mark current provider as failed\n    this.failedProviders.add(fromProvider);\n\n    // Emit fallback event\n    this.emitFallbackEvent(\n      fromProvider,\n      fromModel,\n      fallback.provider,\n      fallback.model,\n      reason,\n      error.message\n    );\n\n    logDebug(`[AgentController] Falling back from ${fromProvider}/${fromModel} to ${fallback.provider}/${fallback.model}: ${reason}`);\n\n    // Switch to fallback provider\n    await this.switchModel({\n      provider: fallback.provider,\n      model: fallback.model,\n    });\n\n    return true;\n  }\n\n  getToolSuites(): ToolSuite[] {\n    return this.session.toolSuites;\n  }\n}\n"],"mappings":"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","ignoreList":[]}