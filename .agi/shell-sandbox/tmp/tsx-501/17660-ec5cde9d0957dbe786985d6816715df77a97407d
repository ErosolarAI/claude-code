{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{EventEmitter}from\"events\";let inputProtectionInstance=null;class InputProtection extends EventEmitter{static{__name(this,\"InputProtection\")}config;inputTimings=[];lastKeystroke=0;burstCounter=0;suspicionScore=0;blockedAttacks=0;sanitizedInputs=0;isInPasteMode=false;pasteStartTime=0;dangerousEscapes=[/\\x1b\\][0-9]+;/,/\\x1b[PX^_]/,/\\x1b\\[[\\d;]*[pls]/i,/\\x1b\\[\\?[\\d;]*[hl]/,/\\x1b\\[[\\d;]*n/,/\\x1b\\[[\\d;]*q/,/\\x1bP[^\\\\]*\\x1b\\\\/,/\\x1b\\]0;[^\\x07]*\\x07/,/\\x1b\\]52;/];dangerousControls=[0,1,2,3,4,5,6,7,14,15,16,17,18,19,20,21,22,23,24,25,26,28,29,30,31,127];unicodeAttacks=[{pattern:/\\u202E/,name:\"RTL override\"},{pattern:/\\u202D/,name:\"LTR override\"},{pattern:/\\u202A/,name:\"LTR embedding\"},{pattern:/\\u202B/,name:\"RTL embedding\"},{pattern:/\\u202C/,name:\"Pop direction\"},{pattern:/\\u2066/,name:\"LTR isolate\"},{pattern:/\\u2067/,name:\"RTL isolate\"},{pattern:/\\u2068/,name:\"First strong isolate\"},{pattern:/\\u2069/,name:\"Pop isolate\"},{pattern:/\\u200E/,name:\"LTR mark\"},{pattern:/\\u200F/,name:\"RTL mark\"},{pattern:/\\uFEFF/,name:\"BOM\"},{pattern:/[\\u200B-\\u200D]/,name:\"Zero-width chars\"}];constructor(config={}){super();this.config={maxCharactersPerSecond:config.maxCharactersPerSecond??500,maxPasteSize:config.maxPasteSize??1e5,maxBufferSize:config.maxBufferSize??5e5,detectTimingAttacks:config.detectTimingAttacks??true,minKeystrokeInterval:config.minKeystrokeInterval??5,maxBurstSize:config.maxBurstSize??1e3,strictMode:config.strictMode??false,verbose:config.verbose??false,onAttackDetected:config.onAttackDetected??(()=>{})}}validateInput(input,isPaste=false){const now=Date.now();let sanitized=input;let blocked=false;let reason;let attackType;let riskScore=0;this.inputTimings.push({timestamp:now,charCount:input.length});this.cleanOldTimings();if(isPaste&&input.length>this.config.maxPasteSize){riskScore+=30;if(this.config.strictMode){blocked=true;reason=`Paste size ${input.length} exceeds limit ${this.config.maxPasteSize}`;attackType=\"overflow_attempt\"}else{sanitized=input.slice(0,this.config.maxPasteSize);reason=`Truncated paste from ${input.length} to ${this.config.maxPasteSize}`}this.sanitizedInputs++}if(this.config.detectTimingAttacks&&!isPaste){const interval=now-this.lastKeystroke;if(interval>0&&interval<this.config.minKeystrokeInterval){this.suspicionScore+=5;riskScore+=10;if(this.suspicionScore>50){attackType=\"automated_injection\";reason=`Automated input detected (${Math.round(1e3/interval)} CPS)`;this.log(`Suspicion score: ${this.suspicionScore}, interval: ${interval}ms`)}}else{this.suspicionScore=Math.max(0,this.suspicionScore-1)}}this.lastKeystroke=now;const recentChars=this.getRecentCharCount(100);if(recentChars>this.config.maxBurstSize){this.burstCounter++;riskScore+=20;if(this.burstCounter>3){attackType=\"timing_burst\";reason=`Burst injection detected (${recentChars} chars in 100ms)`;if(this.config.strictMode){blocked=true}}}else{this.burstCounter=Math.max(0,this.burstCounter-1)}const escapeResult=this.checkEscapeSequences(sanitized);if(escapeResult.found){riskScore+=40;attackType=\"escape_injection\";reason=`Dangerous escape sequence: ${escapeResult.type}`;sanitized=escapeResult.sanitized;this.sanitizedInputs++;if(this.config.strictMode){blocked=true}}const controlResult=this.checkControlCharacters(sanitized);if(controlResult.found){riskScore+=15;if(!attackType){attackType=\"control_injection\";reason=`Control characters detected: ${controlResult.chars.join(\", \")}`}sanitized=controlResult.sanitized;this.sanitizedInputs++}const unicodeResult=this.checkUnicodeAttacks(sanitized);if(unicodeResult.found){riskScore+=30;if(!attackType){attackType=\"unicode_attack\";reason=`Unicode attack: ${unicodeResult.type}`}sanitized=unicodeResult.sanitized;this.sanitizedInputs++}const cps=this.calculateCPS();if(cps>this.config.maxCharactersPerSecond&&!isPaste){riskScore+=25;if(!attackType){attackType=\"automated_injection\";reason=`Rate limit exceeded: ${Math.round(cps)} CPS`}if(this.config.strictMode&&cps>this.config.maxCharactersPerSecond*2){blocked=true}}if(attackType&&riskScore>30){this.blockedAttacks++;this.config.onAttackDetected?.(attackType,reason||\"Unknown\");this.emit(\"attack_detected\",{type:attackType,reason,riskScore});this.log(`Attack detected: ${attackType} - ${reason} (risk: ${riskScore})`)}return{allowed:!blocked,sanitized:blocked?\"\":sanitized,blocked,reason,attackType,riskScore}}enterPasteMode(){this.isInPasteMode=true;this.pasteStartTime=Date.now();this.log(\"Entered paste mode\")}exitPasteMode(){const duration=Date.now()-this.pasteStartTime;this.isInPasteMode=false;this.log(`Exited paste mode (duration: ${duration}ms)`)}isPasting(){return this.isInPasteMode}validatePromptSubmission(prompt){let sanitized=prompt;let riskScore=0;let attackType;let reason;if(prompt.length>this.config.maxBufferSize){riskScore+=50;attackType=\"overflow_attempt\";reason=`Prompt exceeds buffer limit`;sanitized=prompt.slice(0,this.config.maxBufferSize)}const escapeResult=this.checkEscapeSequences(sanitized);if(escapeResult.found){riskScore+=30;sanitized=escapeResult.sanitized}const unicodeResult=this.checkUnicodeAttacks(sanitized);if(unicodeResult.found){riskScore+=20;sanitized=unicodeResult.sanitized}return{allowed:true,sanitized,blocked:false,reason,attackType,riskScore}}reset(){this.inputTimings=[];this.lastKeystroke=0;this.burstCounter=0;this.suspicionScore=0;this.isInPasteMode=false}getStats(){return{blockedAttacks:this.blockedAttacks,sanitizedInputs:this.sanitizedInputs,currentSuspicion:this.suspicionScore,currentCPS:this.calculateCPS()}}checkEscapeSequences(input){let sanitized=input;let found=false;let type;for(const pattern of this.dangerousEscapes){if(pattern.test(sanitized)){found=true;type=pattern.source;sanitized=sanitized.replace(new RegExp(pattern.source,\"g\"),\"\")}}return{found,type,sanitized}}checkControlCharacters(input){const foundChars=[];let sanitized=\"\";for(let i=0;i<input.length;i++){const code=input.charCodeAt(i);if(code===9||code===10||code===13){sanitized+=input[i];continue}if(this.dangerousControls.includes(code)){foundChars.push(`0x${code.toString(16).padStart(2,\"0\")}`);continue}sanitized+=input[i]}return{found:foundChars.length>0,chars:foundChars,sanitized}}checkUnicodeAttacks(input){let sanitized=input;let found=false;let type;for(const attack of this.unicodeAttacks){const pattern=typeof attack.pattern===\"string\"?new RegExp(attack.pattern.replace(/[.*+?^${}()|[\\]\\\\]/g,\"\\\\$&\"),\"g\"):attack.pattern;if(pattern.test(sanitized)){found=true;type=attack.name;sanitized=sanitized.replace(pattern,\"\")}}return{found,type,sanitized}}cleanOldTimings(){const cutoff=Date.now()-1e3;this.inputTimings=this.inputTimings.filter(t=>t.timestamp>cutoff)}getRecentCharCount(windowMs){const cutoff=Date.now()-windowMs;return this.inputTimings.filter(t=>t.timestamp>cutoff).reduce((sum,t)=>sum+t.charCount,0)}calculateCPS(){if(this.inputTimings.length<2)return 0;const now=Date.now();const windowMs=1e3;const cutoff=now-windowMs;const recentTimings=this.inputTimings.filter(t=>t.timestamp>cutoff);if(recentTimings.length===0)return 0;const totalChars=recentTimings.reduce((sum,t)=>sum+t.charCount,0);const timeSpan=now-recentTimings[0].timestamp;return timeSpan>0?totalChars/timeSpan*1e3:0}log(message){if(this.config.verbose||process.env[\"AGI_DEBUG\"]){console.error(`[InputProtection] ${message}`)}}}function initializeInputProtection(config){if(!inputProtectionInstance){inputProtectionInstance=new InputProtection(config)}return inputProtectionInstance}__name(initializeInputProtection,\"initializeInputProtection\");function getInputProtection(){return inputProtectionInstance}__name(getInputProtection,\"getInputProtection\");function validateChatInput(input,isPaste=false){const protection=inputProtectionInstance??new InputProtection;return protection.validateInput(input,isPaste)}__name(validateChatInput,\"validateChatInput\");function validatePromptSubmit(prompt){const protection=inputProtectionInstance??new InputProtection;return protection.validatePromptSubmission(prompt)}__name(validatePromptSubmit,\"validatePromptSubmit\");if(process.env[\"AGI_INPUT_PROTECTION\"]===\"1\"||process.env[\"AGI_PROTECTED_MODE\"]===\"1\"){initializeInputProtection({verbose:process.env[\"AGI_DEBUG\"]===\"1\"})}export{InputProtection,getInputProtection,initializeInputProtection,validateChatInput,validatePromptSubmit};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Volumes/4TB/GitHub/src/core/inputProtection.ts"],"sourcesContent":[null]}}